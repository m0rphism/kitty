open import Kitty.Modes

module Kitty.SubstRepr {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Data.List using (List; []; _âˆ·_)
import Data.List.Properties as ListP
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; subst)
open import Relation.Nullary using (Dec; yes; no)
open import Agda.Primitive using (Level; _âŠ”_)

open import Kitty.Prelude
import Kitty.Kit ğ•‹ as FKit

open Modes ğ•„

private variable
  â„“ â„“â‚ â„“â‚‚ â„“â‚ƒ â„“' â„“â‚' â„“â‚‚' â„“â‚ƒ' : Level
  m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
  M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
  Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

-- Binary Homotopy
infix 3 _~_
_~_ : âˆ€ {A : Set â„“â‚} {B : A â†’ Set â„“â‚‚} {C : (a : A) â†’ B a â†’ Set â„“â‚ƒ}
        (f g : (a : A) â†’ (b : B a) â†’ C a b)
      â†’ Set (â„“â‚ âŠ” â„“â‚‚ âŠ” â„“â‚ƒ)
Ï•â‚ ~ Ï•â‚‚ = âˆ€ m x â†’ Ï•â‚ m x â‰¡ Ï•â‚‚ m x

module DKit where
  open FKit using (Kit)
  open Kit â¦ƒ ... â¦„ using 
    ( VarMode/TermMode ; _âˆ‹/âŠ¢_
    ; id/mâ†’M ; mâ†’M/id ; id/mâ†’M/id
    ; id/` ; `/id ; id/`/id
    ; wk-id/` ) renaming (wk to wk-âŠ¢; _â€“â†’_ to _âŸ¦â€“â†’âŸ§_)

  data _â€“â†’_ â¦ƒ K : Kit â¦„ : List VarMode â†’ List VarMode â†’ Set where
    0â‚–   : [] â€“â†’ []
    id   : Âµ â€“â†’ Âµ
    â¦…_â¦†  : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“â†’ Âµ
    â¦…_â¦†â‚€ : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
    _âˆ¥_  : Âµâ‚ â€“â†’ Âµ â†’ Âµâ‚‚ â€“â†’ Âµ â†’ (Âµâ‚ â–·â–· Âµâ‚‚) â€“â†’ Âµ
    _âˆ¥â‚_  : Âµâ‚ â€“â†’ Âµ â†’ ([] â–· m) â€“â†’ Âµ â†’ (Âµâ‚ â–· m) â€“â†’ Âµ
    wk   : Âµ â€“â†’ (Âµ â–· m)
    _,â‚–_ : Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“â†’ Âµâ‚‚
    _â†‘_  : Âµâ‚ â€“â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“â†’ (Âµâ‚‚ â–· m)
    _âˆ˜_  : Âµâ‚‚ â€“â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚ â€“â†’ Âµâ‚ƒ

  _â€“[_]â†’_ : List VarMode â†’ Kit â†’ List VarMode â†’ Set
  Âµâ‚ â€“[ K ]â†’ Âµâ‚‚ = _â€“â†’_ â¦ƒ K â¦„ Âµâ‚ Âµâ‚‚

  module _ â¦ƒ K : Kit â¦„ where

    id' : Âµ â€“â†’ Âµ
    id' {[]}    = 0â‚–
    id' {Âµ â–· m} = id' â†‘ m

    0â‚–'  : [] â€“â†’ []
    0â‚–'  = id

    â¦…_â¦†' â¦…_â¦†'' : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“â†’ Âµ
    â¦… t â¦†'  = id ,â‚– t
    â¦… t â¦†'' = id âˆ¥ â¦… t â¦†â‚€

    â¦…_â¦†â‚€' : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
    â¦… t â¦†â‚€' = {!0â‚– âˆ¥â‚ !}

    _âˆ¥'_ : Âµâ‚ â€“â†’ Âµ â†’ Âµâ‚‚ â€“â†’ Âµ â†’ (Âµâ‚ â–·â–· Âµâ‚‚) â€“â†’ Âµ
    Ï•â‚ âˆ¥' Ï•â‚‚ = {!!}

    _âˆ¥â‚'_  : Âµâ‚ â€“â†’ Âµ â†’ ([] â–· m) â€“â†’ Âµ â†’ (Âµâ‚ â–· m) â€“â†’ Âµ
    Ï•â‚ âˆ¥â‚' Ï•â‚‚ = {!!} âˆ˜ (id ,â‚– {!!})
    -- Ï•â‚ âˆ¥â‚' Ï•â‚‚ = {!!} âˆ˜ (Ï•â‚ â†‘ _)

    _,â‚–'_ : Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“â†’ Âµâ‚‚
    Ï• ,â‚–' t = Ï• âˆ¥ â¦… t â¦†â‚€

    wk' : Âµ â€“â†’ (Âµ â–· m)
    wk' = {!id ,â‚– ?!}

    _â†‘'_  : Âµâ‚ â€“â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“â†’ (Âµâ‚‚ â–· m)
    -- Ï• â†‘' m = (wk âˆ˜ Ï•) âˆ¥â‚ (wk âˆ˜ â¦… id/` m {! !} â¦†â‚€)
    Ï• â†‘' m = {!Ï• ,â‚– ?!}
    -- Ï• â†‘' m = wk âˆ˜ (Ï• ,â‚– {!!})
    -- Ï• â†‘' m = (wk âˆ˜ Ï•) ,â‚– {!!}

module DKitSem where
  open FKit using (Kit)
  open Kit â¦ƒ ... â¦„ using 
    ( VarMode/TermMode ; _âˆ‹/âŠ¢_
    ; id/mâ†’M ; mâ†’M/id ; id/mâ†’M/id
    ; id/` ; `/id ; id/`/id
    ; wk-id/` ) renaming (wk to wk-âŠ¢; _â€“â†’_ to _âŸ¦â€“â†’âŸ§_)
  open import Data.List.Relation.Unary.Any using (here; there)

  data All {A : Set â„“â‚} (R : A â†’ Set â„“â‚‚) : List A â†’ Set â„“â‚‚ where
    [] : All R []
    _âˆ·_ : âˆ€ {x xs} â†’ R x â†’ All R xs â†’ All R (x âˆ· xs)

  _âŸ¦â€“â†’âŸ§'_ : â¦ƒ K : Kit â¦„ â†’ List VarMode â†’ List VarMode â†’ Set
  Âµâ‚ âŸ¦â€“â†’âŸ§' Âµâ‚‚ = All (Î» m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m) Âµâ‚

  âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ : â¦ƒ K : Kit â¦„ â†’ Âµâ‚ âŸ¦â€“â†’âŸ§' Âµâ‚‚ â†’ Âµâ‚ âŸ¦â€“â†’âŸ§ Âµâ‚‚
  âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ []      m ()
  âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ (t âˆ· Ï•) m (here refl) = t
  âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ (t âˆ· Ï•) m (there x)   = âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ Ï• m x

  data _â€“â†’_ â¦ƒ K : Kit â¦„ : List VarMode â†’ List VarMode â†’ Set where
    id    : Âµ â€“â†’ Âµ
    _âˆ˜_   : Âµâ‚‚ â€“â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚ â€“â†’ Âµâ‚ƒ
    _âˆ¥_   : Âµâ‚ â€“â†’ Âµ â†’ Âµâ‚‚ â€“â†’ Âµ â†’ (Âµâ‚ â–·â–· Âµâ‚‚) â€“â†’ Âµ
    wk    : Âµ â€“â†’ (Âµ â–·â–· Âµ')
    kw    : Âµ â€“â†’ (Âµ' â–·â–· Âµ)
    âŸ¦_âŸ§â»Â¹ : Âµâ‚ âŸ¦â€“â†’âŸ§' Âµâ‚‚ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ 
    -- wk    : âˆ€ Âµâ‚ Âµâ‚‚ â†’ Âµ â€“â†’ (Âµâ‚ â–·â–· Âµ â–·â–· Âµâ‚‚)

  -- 0â‚–    : [] â€“â†’ []
  -- _â†‘_  : â¦ƒ K : Kit â¦„ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ âˆ€ Âµ â†’ (Âµâ‚ â–·â–· Âµ) â€“â†’ (Âµâ‚‚ â–·â–· Âµ)
  -- _â†“_  : â¦ƒ K : Kit â¦„ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ âˆ€ Âµ â†’ (Âµ â–·â–· Âµâ‚) â€“â†’ (Âµ â–·â–· Âµâ‚‚)
  -- â¦…_â¦†â‚€ : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
  -- _,â‚–_ : Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“â†’ Âµâ‚‚
  -- â¦…_â¦†  : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“â†’ Âµ
  pattern 0â‚–       = id {Âµ = []}
  pattern â¦…_â¦†â‚€ t   = âŸ¦ t âˆ· [] âŸ§â»Â¹
  pattern _,â‚–_ Ï• t = Ï• âˆ¥ â¦… t â¦†â‚€
  pattern â¦…_â¦† t    = id ,â‚– t
  pattern _â†‘_ Ï• Âµ  = (wk âˆ˜ Ï•) âˆ¥ kw {Âµ = Âµ}
  pattern _â†“_ Ï• Âµ  = wk âˆ¥ (kw {Âµ' = Âµ} âˆ˜ Ï•)

  open FKit
  open import Kitty.Compose ğ•‹
  module _ (KT : KitTraversal) (KA : KitAssoc KT) (KAL : KitAssoc.KitAssocLemmas KT KA) where
    open KitTraversal KT
    open KitAssoc KT KA
    open KitAssocLemmas KAL

    module KIT = Kit â¦ƒ ... â¦„
    module CKIT = ComposeKit â¦ƒ ... â¦„

    âŸ¦_âŸ§ : â¦ƒ K : Kit â¦„ â¦ƒ CK : ComposeKit KT â¦ƒ K â¦„ â¦ƒ K â¦„ â¦ƒ K â¦„ â¦„ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚ âŸ¦â€“â†’âŸ§ Âµâ‚‚
    âŸ¦ id       âŸ§ = KIT.idâ‚–
    âŸ¦ Ï•â‚ âˆ˜ Ï•â‚‚  âŸ§ = âŸ¦ Ï•â‚ âŸ§ CKIT.âˆ˜â‚– âŸ¦ Ï•â‚‚ âŸ§
    âŸ¦ Ï•â‚ âˆ¥ Ï•â‚‚  âŸ§ = âŸ¦ Ï•â‚ âŸ§ KIT.âˆ¥ âŸ¦ Ï•â‚‚ âŸ§
    âŸ¦ âŸ¦ ts âŸ§â»Â¹ âŸ§ = âŸ¦â€“â†’âŸ§'â†’âŸ¦â€“â†’âŸ§ ts
    âŸ¦ wk       âŸ§ = KIT.wk'*
    âŸ¦ kw       âŸ§ = KIT.idâ‚–'

    module Lemmas â¦ƒ K : Kit â¦„ â¦ƒ CK : ComposeKit KT â¦ƒ K â¦„ â¦ƒ K â¦„ â¦ƒ K â¦„ â¦„ where
      âˆ¥0 : (Ï• : Âµâ‚ â€“â†’ []) â†’ âŸ¦ Ï• âˆ¥ 0â‚– âŸ§ ~ âŸ¦ Ï• âŸ§
      âˆ¥0 Ï• m x = refl

      0âˆ¥ : let s = subst (_âŸ¦â€“â†’âŸ§ _) (ListP.++-identityÊ³ Âµâ‚) in
           (Ï• : Âµâ‚ â€“â†’ []) â†’ s âŸ¦ 0â‚– âˆ¥ Ï• âŸ§ ~ âŸ¦ Ï• âŸ§
      0âˆ¥ {Âµâ‚ = Âµâ‚ â–· mâ‚} Ï• .mâ‚ (here refl) = {!!}
      0âˆ¥ {Âµâ‚ = Âµâ‚ â–· mâ‚} Ï• m (there x) = {!!}

      -- 0âˆ¥ : let s = subst (_â€“â†’ _) (ListP.++-identityÊ³ Âµâ‚) in
      --      (Ï• : Âµâ‚ â€“â†’ []) â†’ âŸ¦ s (0â‚– âˆ¥ Ï•) âŸ§ ~ âŸ¦ Ï• âŸ§
      -- 0âˆ¥ {Âµâ‚ = Âµâ‚ â–· mâ‚} Ï• .mâ‚ (here refl) = {!!}
      -- 0âˆ¥ {Âµâ‚ = Âµâ‚ â–· mâ‚} Ï• m (there x) = {!!}
      -- 0âˆ¥ Ï• m (here refl) = {!ref!}
      -- 0âˆ¥ Ï• m (there x) = {!!}

      -- TODO: probably easier to proof this in the semantic realm
      dist-âˆ˜-âˆ¥ : (Ï• : Âµ â€“â†’ Âµ') â†’ (Ï•â‚ : Âµâ‚ â€“â†’ Âµ) â†’ (Ï•â‚‚ : Âµâ‚‚ â€“â†’ Âµ)
          â†’ âŸ¦ Ï• âˆ˜ (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ§ ~ âŸ¦ (Ï• âˆ˜ Ï•â‚) âˆ¥ (Ï• âˆ˜ Ï•â‚‚) âŸ§ 
      -- dist-âˆ˜-âˆ¥ Ï• Ï•â‚ Ï•â‚‚ m x = {!x!}
      dist-âˆ˜-âˆ¥ {Âµâ‚ = .(_ â–· m)} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (here refl) = refl
      dist-âˆ˜-âˆ¥ {Âµâ‚ = .(_ â–· _)} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (there x) = {!dist-âˆ˜-âˆ¥ Ï• Ï•â‚ Ï•â‚‚ m x!}
      dist-âˆ˜-âˆ¥ {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚ â–· xâ‚} Ï• Ï•â‚ Ï•â‚‚ m x = {!!}

      -- pull in wk and then use lemma below (doesn't work, only works from left)
      lem : (Ï•â‚ : Âµâ‚ â€“â†’ Âµ) â†’ (Ï•â‚‚ : Âµâ‚‚ â€“â†’ Âµ)
          â†’ âŸ¦ (Ï•â‚ âˆ¥ Ï•â‚‚) âˆ˜ wk {Âµ' = Âµâ‚‚} âŸ§ ~ âŸ¦ Ï•â‚ âŸ§ 
      lem Ï•â‚ Ï•â‚‚ m (here refl) = {!refl!}
      lem Ï•â‚ Ï•â‚‚ m (there x) = {!!}

      -- lem' : (Ï• : (Âµâ‚ â–·â–· Âµâ‚‚) â€“â†’ Âµ)
      --      â†’ âŸ¦ Ï• âˆ˜ wk {Âµ' = Âµâ‚‚} âŸ§ ~ âŸ¦ id {Âµâ‚} âŸ§ 
      -- lem' Ï• m (here refl) = {!refl!}
      -- lem' Ï• m (there x) = {!!}

    simp : â¦ƒ K : Kit â¦„ â†’ Âµâ‚ â€“â†’ Âµâ‚‚ â†’ Âµâ‚ â€“â†’ Âµâ‚‚
    simp (Ï•â‚ âˆ˜ id) = Ï•â‚
    simp (Ï•â‚ âˆ˜ (Ï•â‚‚ âˆ˜ Ï•â‚ƒ)) = {!!}
    simp (Ï•â‚ âˆ˜ (Ï•â‚‚ âˆ¥ Ï•â‚ƒ)) = (Ï•â‚ âˆ˜ Ï•â‚‚) âˆ¥ (Ï•â‚ âˆ˜ Ï•â‚ƒ)
    simp (Ï•â‚ âˆ˜ âŸ¦ ts âŸ§â»Â¹) = {!!}
    simp (Ï•â‚ âˆ˜ wk) = {!!}
    simp (Ï•â‚ âˆ˜ kw) = {!!}
    simp (Ï•â‚ âˆ¥ Ï•â‚‚) = {!!}
    simp Ï•         = Ï•

open import Kitty.Kit ğ•‹
open import Kitty.Compose ğ•‹
module _ (KT : KitTraversal) (KA : KitAssoc KT) (KAL : KitAssoc.KitAssocLemmas KT KA) where
  open KitTraversal KT
  open KitAssoc KT KA
  open KitAssocLemmas KAL

  open Kit â¦ƒ ... â¦„
  open ComposeKit â¦ƒ ... â¦„ renaming (_âˆ˜â‚–_ to _âˆ˜_)
  open import Data.List.Relation.Unary.Any using (here; there)

  module Lemmas â¦ƒ K : Kit â¦„ â¦ƒ CK : ComposeKit KT â¦ƒ K â¦„ â¦ƒ K â¦„ â¦ƒ K â¦„ â¦„ where
    dist-âˆ˜-âˆ¥â‚› : (Ï• : Âµ â†’â‚› Âµ') â†’ (Ï•â‚ : Âµâ‚ â†’â‚› Âµ) â†’ (Ï•â‚‚ : Âµâ‚‚ â†’â‚› Âµ)
        â†’ Ï• â‚›âˆ˜â‚› (Ï•â‚ âˆ¥â‚› Ï•â‚‚) ~ (Ï• â‚›âˆ˜â‚› Ï•â‚) âˆ¥â‚› (Ï• â‚›âˆ˜â‚› Ï•â‚‚)
    dist-âˆ˜-âˆ¥â‚› {Âµâ‚ = Âµâ‚ â–· xâ‚} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (here refl) = refl
    dist-âˆ˜-âˆ¥â‚› {Âµâ‚ = Âµâ‚ â–· xâ‚} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (there x)   = dist-âˆ˜-âˆ¥â‚› Ï• (Î» _ x â†’ Ï•â‚ _ (there x)) Ï•â‚‚ _ x
    dist-âˆ˜-âˆ¥â‚› {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚ â–· xâ‚} Ï• Ï•â‚ Ï•â‚‚ m (here refl) = refl
    dist-âˆ˜-âˆ¥â‚› {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚ â–· xâ‚} Ï• Ï•â‚ Ï•â‚‚ m (there x)   = dist-âˆ˜-âˆ¥â‚› Ï• Ï•â‚ (Î» _ x â†’ Ï•â‚‚ _ (there x)) _ x

    dist-âˆ˜-âˆ¥ : (Ï• : Âµ â€“â†’ Âµ') â†’ (Ï•â‚ : Âµâ‚ â€“â†’ Âµ) â†’ (Ï•â‚‚ : Âµâ‚‚ â€“â†’ Âµ)
        â†’ Ï• âˆ˜ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (Ï• âˆ˜ Ï•â‚) âˆ¥ (Ï• âˆ˜ Ï•â‚‚)
    dist-âˆ˜-âˆ¥ Ï• Ï•â‚ Ï•â‚‚ m x = {!x!}
    -- dist-âˆ˜-âˆ¥ {Âµâ‚ = .(_ â–· m)} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (here refl) = refl
    -- dist-âˆ˜-âˆ¥ {Âµâ‚ = .(_ â–· _)} {Âµâ‚‚ = []} Ï• Ï•â‚ Ï•â‚‚ m (there x) = {!dist-âˆ˜-âˆ¥ Ï• Ï•â‚ Ï•â‚‚ m x!}
    -- dist-âˆ˜-âˆ¥ {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚ â–· xâ‚} Ï• Ï•â‚ Ï•â‚‚ m x = {!!}
