open import Kitty.Term.Modes

module Kitty.Term.MultiSub {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Data.List.Properties using (++-assoc)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; cong; congâ‚‚; subst; substâ‚‚; sym; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Data.List using (List; []; _âˆ·_; _++_)
open import Data.Unit using (âŠ¤; tt)
open import Level using (_âŠ”_)

open import Kitty.Term.Prelude
open import Kitty.Util.Star
open import Kitty.Term.Kit ğ•‹
open import Kitty.Util.SubstProperties

open Modes ğ•„
open Terms ğ•‹
open import Kitty.Term.Sub ğ•‹
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws â¦ƒ â€¦ â¦„
open Kit â¦ƒ â€¦ â¦„

private
  variable
    m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
    M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
    Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

_â€“[_]â†’*_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ â†’ List VarMode â†’ (_ : List Kit) â†’ List VarMode â†’ Set _
Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ = Star (Î» ğ•‚ x y â†’ y â€“[ ğ•‚ ]â†’ x) ğ•‚s Âµâ‚‚ Âµâ‚

infix   4  _~*_
data _~*_ â¦ƒ ğ•Š : Sub â¦„ {Âµâ‚} : âˆ€ {ğ•‚s} {Âµâ‚‚} (Ï•sâ‚ Ï•sâ‚‚ : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) â†’ Set where
  ~*-[] : [] ~* []
  ~*-âˆ·  : âˆ€ {ğ•‚ ğ•‚s} {Ï•â‚ Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚ƒ} {Ï•sâ‚ Ï•sâ‚‚ : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚}
    â†’ let instance _ = ğ•‚ in
      Ï•â‚ ~ Ï•â‚‚
    â†’ Ï•sâ‚ ~* Ï•sâ‚‚
    â†’ (Ï•â‚ âˆ· Ï•sâ‚) ~* (Ï•â‚‚ âˆ· Ï•sâ‚‚)

infixl  11  _â†‘*'_
_â†‘*'_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ')
f â†‘*' []      = f
f â†‘*' (Âµ â–· m) = f â†‘*' Âµ â†‘ m

~-cong-â†‘*'' : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
  Ï• ~ Ï•' â†’
  (Ï• â†‘*' Âµ) ~ (Ï•' â†‘*' Âµ)
~-cong-â†‘*'' {Âµ = []}    Ï•~Ï•' = Ï•~Ï•'
~-cong-â†‘*'' {Âµ = Âµ â–· m} Ï•~Ï•' = ~-cong-â†‘' (~-cong-â†‘*'' Ï•~Ï•')

-- open import Data.List.Relation.Unary.Any using (here; there)
-- ~-cong-â†‘'x : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
--   Ï• ~ Ï•' â†’
--   (Ï• â†‘ m) ~ (Ï•' â†‘ m)
-- ~-cong-â†‘'x â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x@(here refl) =
--   `/id â¦ƒ ğ•‚â‚ â¦„ (x & (Ï•  â†‘ m))              â‰¡âŸ¨ cong `/id (&-â†‘-here Ï•) âŸ©
--   `/id â¦ƒ ğ•‚â‚ â¦„ (id/` (here refl))          â‰¡âŸ¨ id/`/id (here refl) âŸ©
--   ` here refl                             â‰¡âŸ¨ sym (id/`/id (here refl)) âŸ©
--   `/id â¦ƒ ğ•‚â‚‚ â¦„ (id/` (here refl))          â‰¡âŸ¨ sym (cong `/id (&-â†‘-here Ï•')) âŸ©
--   `/id â¦ƒ ğ•‚â‚‚ â¦„ (x & (Ï•' â†‘ m))              âˆ
-- ~-cong-â†‘'x â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x@(there y) =
--   `/id â¦ƒ ğ•‚â‚ â¦„ (x & (Ï•  â†‘ m))              â‰¡âŸ¨ cong `/id (&-â†‘-there Ï• y) âŸ©
--   `/id â¦ƒ ğ•‚â‚ â¦„ (wk m (y & Ï•))              â‰¡âŸ¨ {!cong (Î» â–  â†’ `/id (wk m â– ))!} âŸ©
--   `/id â¦ƒ ğ•‚â‚‚ â¦„ (wk m (y & Ï•'))             â‰¡âŸ¨ sym (cong `/id (&-â†‘-there Ï•' y)) âŸ©
--   `/id â¦ƒ ğ•‚â‚‚ â¦„ (x & (Ï•' â†‘ m))              âˆ



-- ~-cong-â†‘*'' : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
--   Ï• ~ Ï•' â†’
--   (Ï• â†‘*' Âµ) ~ (Ï•' â†‘*' Âµ)
-- ~-cong-â†‘*'' {Âµ = []}    Ï•~Ï•' = Ï•~Ï•'
-- ~-cong-â†‘*'' {Âµ = Âµ â–· m} Ï•~Ï•' = ~-cong-â†‘' (~-cong-â†‘*'' Ï•~Ï•')

â†‘*'~â†‘* : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} Âµ â†’ Ï• â†‘*' Âµ ~ Ï• â†‘* Âµ
â†‘*'~â†‘* â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï•} [] mx x =
  `/id (x & Ï• â†‘*' []) â‰¡âŸ¨âŸ©
  `/id (x & Ï•)        â‰¡âŸ¨ sym (â†‘*-[] Ï• _ x) âŸ©
  `/id (x & Ï• â†‘*  [])  âˆ
â†‘*'~â†‘* â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï•} (Âµ â–· m) mx x =
  `/id (x & Ï• â†‘*' (Âµ â–· m))  â‰¡âŸ¨âŸ©
  `/id (x & Ï• â†‘*' Âµ â†‘ m)    â‰¡âŸ¨ ~-cong-â†‘' (â†‘*'~â†‘* Âµ) _ x âŸ©
  `/id (x & Ï• â†‘*  Âµ â†‘ m)    â‰¡âŸ¨ sym (â†‘*-â–· Âµ m Ï• _ x) âŸ©
  `/id (x & Ï• â†‘*  (Âµ â–· m))  âˆ

infixl  11  _â†‘**_
_â†‘**_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚s : List Kit} â†’ Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµ' ++ Âµâ‚) â€“[ ğ•‚s ]â†’* (Âµ' ++ Âµâ‚‚)
[] â†‘** Âµ' = []
(_âˆ·_ {b = ğ•‚} f fs) â†‘** Âµ' = (_â†‘*'_ â¦ƒ ğ•‚ = ğ•‚ â¦„ f Âµ') âˆ· (fs â†‘** Âµ')

-- infixl  11  _â†‘**_
-- _â†‘**_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚s : List Kit} â†’ Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµ' ++ Âµâ‚) â€“[ ğ•‚s ]â†’* (Âµ' ++ Âµâ‚‚)
-- [] â†‘** Âµ' = []
-- (_âˆ·_ {b = ğ•‚} f fs) â†‘** Âµ' = (_â†‘*_ â¦ƒ ğ•‚ = ğ•‚ â¦„ f Âµ') âˆ· (fs â†‘** Âµ')

-- -- See â†‘**-[]
-- â†‘**-neutral :
--   âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ {ğ•‚s : List Kit}
--   â†’ (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚)
--   â†’ fs â†‘** [] ~* fs
-- â†‘**-neutral {ğ•‚s = []}     []       = ~*-[]
-- â†‘**-neutral {ğ•‚s = ğ•‚ âˆ· ğ•‚s} (f âˆ· fs) = ~*-âˆ· (â†‘*-[] f) (â†‘**-neutral fs) where instance _ = ğ•‚

-- dist-â†‘*-â–·â–· :
--   âˆ€ {{ğ•‚ : Kit}} Âµ' Âµ''
--   â†’ (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
--   â†’ let sub = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--     f â†‘* Âµ' â†‘* Âµ'' â‰¡ sub (f â†‘* (Âµ' â–·â–· Âµ''))
-- dist-â†‘*-â–·â–· {Âµâ‚} {Âµâ‚‚} Âµ' []        f = refl
-- dist-â†‘*-â–·â–· {Âµâ‚} {Âµâ‚‚} {{ğ•‚}} Âµ' (Âµ'' â–· m) f =
--   let sub = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
--                                (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
--   let sub'' = substâ‚‚ (Î» x y â†’ (x â–· m) â€“[ ğ•‚ ]â†’ (y â–· m)) (++-assoc Âµ'' Âµ' Âµâ‚)
--                                                        (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--   let sub' = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (++-assoc Âµ'' Âµ' Âµâ‚)
--                                 (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--   f â†‘* Âµ' â†‘* (Âµ'' â–· m)         â‰¡âŸ¨âŸ©
--   f â†‘* Âµ' â†‘* Âµ'' â†‘ m           â‰¡âŸ¨ cong (_â†‘ m) (dist-â†‘*-â–·â–· Âµ' Âµ'' f) âŸ©
--   sub' (f â†‘* (Âµ' â–·â–· Âµ'')) â†‘ m  â‰¡âŸ¨ dist-substâ‚‚ (Î» â–  â†’ _â†‘_ â¦ƒ ğ•‚ â¦„ â–  m) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) (f â†‘* (Âµ' â–·â–· Âµ'')) âŸ©
--   sub'' (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m) â‰¡âŸ¨ comm-substâ‚‚ (_â–· m) (_â–· m) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m) âŸ©
--   sub (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m)   â‰¡âŸ¨âŸ©
--   sub (f â†‘* (Âµ' â–·â–· (Âµ'' â–· m))) âˆ

-- dist-â†‘**-â–·â–· :
--   âˆ€ {ğ•‚s : List Kit} Âµ' Âµ''
--   â†’ (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚)
--   â†’ let sub = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--     f â†‘** Âµ' â†‘** Âµ'' â‰¡ sub (f â†‘** (Âµ' â–·â–· Âµ''))
-- dist-â†‘**-â–·â–· {Âµâ‚} {Âµâ‚‚} {ğ•‚s = ğ•‚s} Âµ' []        f =
--   f â†‘** Âµ' â†‘** []  â‰¡âŸ¨ â†‘**-neutral (f â†‘** Âµ') âŸ©
--   f â†‘** Âµ'         â‰¡âŸ¨âŸ©
--   f â†‘** (Âµ' â–·â–· []) âˆ
-- dist-â†‘**-â–·â–· {Âµâ‚} {.Âµâ‚} Âµ' (Âµ'' â–· m) []       = subst-[]-flip (Î» ğ•‚s Âµâ‚‚ Âµâ‚ â†’ Âµâ‚ â€“[ ğ•‚s ]â†’ Âµâ‚‚) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
-- dist-â†‘**-â–·â–· {Âµâ‚} {Âµâ‚‚} {ğ•‚ âˆ· ğ•‚s}  Âµ' (Âµ'' â–· m) (_âˆ·_ {x = .Âµâ‚‚} {y = y} f fs) =
--   let sub = substâ‚‚ (_â€“[ ğ•‚ âˆ· ğ•‚s ]â†’*_) (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚)
--                                      (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚‚) in
--   let subâ‚ = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' y))
--                                 (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
--   let subâ‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
--                                   (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' y)) in
--   let instance _ = ğ•‚ in
--   (f âˆ· fs) â†‘** Âµ' â†‘** (Âµ'' â–· m)                                       â‰¡âŸ¨âŸ©
--   (f â†‘* Âµ' â†‘* Âµ'' â†‘ m) âˆ· (fs â†‘** Âµ' â†‘** (Âµ'' â–· m))                    â‰¡âŸ¨ congâ‚‚ _âˆ·_ (dist-â†‘*-â–·â–· Âµ' (Âµ'' â–· m) f)
--                                                                                    (dist-â†‘**-â–·â–· Âµ' (Âµ'' â–· m) fs) âŸ©
--   (subâ‚ (f â†‘* (Âµ' â–·â–· (Âµ'' â–· m)))) âˆ· (subâ‚‚ (fs â†‘** (Âµ' â–·â–· (Âµ'' â–· m)))) â‰¡âŸ¨ sym (subst-âˆ·-flipped
--                                                                            (Î» ğ•‚s Âµâ‚‚ Âµâ‚ â†’ Âµâ‚ â€“[ ğ•‚s ]â†’ Âµâ‚‚)
--                                                                            (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚‚)
--                                                                            (++-assoc (Âµ'' â–· m) Âµ' y)
--                                                                            (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚)) âŸ©
--   sub ((f â†‘* (Âµ' â–·â–· (Âµ'' â–· m))) âˆ· (fs â†‘** (Âµ' â–·â–· (Âµ'' â–· m))))         â‰¡âŸ¨âŸ©
--   sub ((f âˆ· fs) â†‘** (Âµ' â–·â–· (Âµ'' â–· m)))                                âˆ

module TraversalOps (_â‹¯_ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ ğ•Š : Sub â¦„ {Âµâ‚} {Âµâ‚‚} {M} â†’ Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ Í¾ ğ•Š ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M) where
  infixl  8 _â‹¯*_
  _â‹¯*_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ M} â†’
        Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M
  t â‹¯* fs = fold-star' (Î» ğ•‚ _ _ t f â†’ _â‹¯_ {{ğ•‚}} t f) t fs

  _â‰ˆâ‚“_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚} â†’ (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) â†’ (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚) â†’ Set
  _â‰ˆâ‚“_ {Âµâ‚ = Âµâ‚} f g = âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m) â†’ (` x) â‹¯* (f â†‘** Âµâ‚') â‰¡ (` x) â‹¯* (g â†‘** Âµâ‚')

  _â‰ˆâ‚œ_ : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚} â†’ (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) â†’ (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚) â†’ Set
  _â‰ˆâ‚œ_ {Âµâ‚ = Âµâ‚} f g = âˆ€ {Âµâ‚'} {M} (t : (Âµâ‚ â–·â–· Âµâ‚') âŠ¢ M) â†’ t â‹¯* (f â†‘** Âµâ‚') â‰¡ t â‹¯* (g â†‘** Âµâ‚')

  subst-â‹¯ :
    âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ Âµâ‚' Âµâ‚‚'}
      (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {M} (t : Âµâ‚' âŠ¢ M)
    â†’ (Âµâ‚â‰¡Âµâ‚' : Âµâ‚ â‰¡ Âµâ‚')
    â†’ (Âµâ‚‚â‰¡Âµâ‚‚' : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ let subâŠ¢â‚‚â»Â¹ = subst (_âŠ¢ _) (sym Âµâ‚‚â‰¡Âµâ‚‚') in
      let subâŠ¢â‚â»Â¹ = subst (_âŠ¢ M) (sym Âµâ‚â‰¡Âµâ‚') in
      let subâ†’â‚â‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) Âµâ‚â‰¡Âµâ‚' Âµâ‚‚â‰¡Âµâ‚‚' in
      subâŠ¢â‚‚â»Â¹ (t â‹¯* subâ†’â‚â‚‚ f) â‰¡
      subâŠ¢â‚â»Â¹ t â‹¯* f
  subst-â‹¯ f M refl refl = refl

  -- â†‘**-[]' : âˆ€ â¦ƒ ğ•Š : Sub â¦„ {ğ•‚s : List Kit} {Âµâ‚} {Âµâ‚‚} (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {m} (x : Âµâ‚ âˆ‹ m)
  --       â†’ (` x) â‹¯* fs â†‘** [] â‰¡ (` x) â‹¯* fs
  -- â†‘**-[]' = Star-indÊ³
  --   {P = Î» {ğ•‚s} {Âµâ‚‚} {Âµâ‚} fs â†’ âˆ€ {m} (x : Âµâ‚ âˆ‹ m) â†’ (` x) â‹¯* fs â†‘** [] â‰¡ (` x) â‹¯* fs}
  --   (Î» { [] x â†’ refl })
  --   Î» {ğ•‚s} {ğ•‚} fs f IH x â†’ let instance _ = ğ•‚ in
  --     (` x) â‹¯* (fs âˆ·Ê³ f) â†‘** []           â‰¡âŸ¨ {!!} âŸ©
  --     (` x) â‹¯* ((fs â†‘** []) âˆ·Ê³ (f â†‘* [])) â‰¡âŸ¨ sym (fold-star'-âˆ·Ê³ _ (` x) (fs â†‘** []) (f â†‘* [])) âŸ©
  --     (` x) â‹¯ (f â†‘* []) â‹¯* (fs â†‘** [])    â‰¡âŸ¨ {!!} âŸ©
  --     (` x) â‹¯ f â‹¯* (fs â†‘** [])            â‰¡âŸ¨ {!IH!} âŸ©
  --     (` x) â‹¯ f â‹¯* fs                     â‰¡âŸ¨ fold-star'-âˆ·Ê³ _ (` x) fs f âŸ©
  --     (` x) â‹¯* (fs âˆ·Ê³ f)                  âˆ


--   lemy :
--     âˆ€ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ Âµ' Âµ''}
--       (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) m (x : (Âµâ‚ â–·â–· Âµ' â–·â–· Âµ'') âˆ‹ m)
--     â†’ let subâ‚ = subst (_âˆ‹ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
--       let subâ‚‚ = subst (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--     ((` x) â‹¯* ((f â†‘** Âµ') â†‘** Âµ'')) â‰¡ subâ‚‚ ((` subâ‚ x) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))
--   lemy {ğ•‚s = ğ•‚s} {Âµâ‚} {Âµâ‚‚} {Âµ'} {Âµ''} f m x =
--     let subâˆ‹â‚â»Â¹ = subst (_âˆ‹ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
--     let subâŠ¢â‚‚ = subst (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--     let subâŠ¢â‚‚â»Â¹ = subst (_âŠ¢ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
--     let subâŠ¢â‚â»Â¹ = subst (_âŠ¢ mâ†’M m) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
--     let subâ†’â‚â‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
--     ((` x) â‹¯* (f â†‘** Âµ' â†‘** Âµ''))                         â‰¡âŸ¨ sym (cancel-substâ‚‚ (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) _) âŸ©
--     subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* (f â†‘** Âµ' â†‘** Âµ'')))         â‰¡âŸ¨ cong (Î» â–  â†’ subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* â– ))) (dist-â†‘**-â–·â–· Âµ' Âµ'' f) âŸ©
--     subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* subâ†’â‚â‚‚ (f â†‘** (Âµ' â–·â–· Âµ'')))) â‰¡âŸ¨ cong subâŠ¢â‚‚ (subst-â‹¯ (f â†‘** (Âµ' â–·â–· Âµ'')) (` x)
--                                                                                  (++-assoc Âµ'' Âµ' Âµâ‚)
--                                                                                  (++-assoc Âµ'' Âµ' Âµâ‚‚)) âŸ©
--     subâŠ¢â‚‚ ((subâŠ¢â‚â»Â¹ (` x)) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))        â‰¡âŸ¨ cong subâŠ¢â‚‚ (cong (_â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))
--                                                             (sym (dist-subst {F = (_âˆ‹ _)} {G = (_âŠ¢ _)} `_
--                                                               (sym (++-assoc Âµ'' Âµ' Âµâ‚)) x))) âŸ©
--     subâŠ¢â‚‚ ((` subâˆ‹â‚â»Â¹ x) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))          âˆ

--   â‰ˆâ†‘** :
--     âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚}
--       (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚)
--     â†’ (âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m)
--         â†’ ((` x) â‹¯* (f â†‘** Âµâ‚')) â‰¡ ((` x) â‹¯* (g â†‘** Âµâ‚')))
--     â†’ (âˆ€ {Âµâ‚'} {Âµâ‚''} {m} (x : (Âµâ‚ â–·â–· Âµâ‚' â–·â–· Âµâ‚'') âˆ‹ m)
--         â†’ ((` x) â‹¯* ((f â†‘** Âµâ‚') â†‘** Âµâ‚'')) â‰¡ ((` x) â‹¯* ((g â†‘** Âµâ‚') â†‘** Âµâ‚'')))
--   â‰ˆâ†‘** {ğ•‚sâ‚} {ğ•‚sâ‚‚} {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚} f g f~g {Âµâ‚' = Âµâ‚'} {Âµâ‚'' = Âµâ‚''} x =
--     let subâ‚ = subst (_âˆ‹ _) (sym (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚)) in
--     let subâ‚‚ = subst (_âŠ¢ _) (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚‚) in
--     ((` x) â‹¯* ((f â†‘** Âµâ‚') â†‘** Âµâ‚'')) â‰¡âŸ¨ lemy f _ x âŸ©
--     subâ‚‚ ((` subâ‚ x) â‹¯* (f â†‘** (Âµâ‚' â–·â–· Âµâ‚''))) â‰¡âŸ¨ cong subâ‚‚ (f~g {Âµâ‚' â–·â–· Âµâ‚''} (subst (_âˆ‹ _) (sym (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚)) x) ) âŸ©
--     subâ‚‚ ((` subâ‚ x) â‹¯* (g â†‘** (Âµâ‚' â–·â–· Âµâ‚''))) â‰¡âŸ¨ sym (lemy g _ x)  âŸ©
--     ((` x) â‹¯* ((g â†‘** Âµâ‚') â†‘** Âµâ‚'')) âˆ

open import Data.Unit using (âŠ¤; tt)
module TraversalOps' (_â‹¯_ : âŠ¤ â†’ âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ ğ•Š : Sub â¦„ {Âµâ‚} {Âµâ‚‚} {M} â†’ Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ Í¾ ğ•Š ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M) where
  open TraversalOps (_â‹¯_ tt) public

instance
  kit-[] : List Kit
  kit-[] = []

  kit-âˆ· : {{ğ•‚ : Kit}} â†’ {{ğ•‚s : List Kit}} â†’ List Kit
  kit-âˆ· {{ğ•‚}} {{ğ•‚s}} = ğ•‚ âˆ· ğ•‚s
