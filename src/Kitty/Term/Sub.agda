open import Kitty.Term.Modes

module Kitty.Term.Sub {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Data.List using (List; [])
open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Level using (Level; _âŠ”_; 0â„“)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Data.List.Relation.Unary.Any using (here; there)
open import Kitty.Term.Prelude
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_)
open import Data.Sum using (injâ‚; injâ‚‚; _âŠ_)
open import Function using (_$_)

open Modes ğ•„
open Terms ğ•‹

open import Kitty.Term.Kit ğ•‹ using (Kit; _âˆ‹/âŠ¢[_]_)

open Kit â¦ƒ â€¦ â¦„ hiding (_,â‚–_; _â†‘_; _â†‘*_; _â€“â†’_; ~-cong-â†‘; ~-cong-â†‘*; _âˆ¥_; â¦…_â¦†; _â†“)

record Sub : Setâ‚ where
  field
    _â€“[_]â†’_ : List VarMode â†’ Kit â†’ List VarMode â†’ Set

    []â‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ [] â€“[ ğ•‚ ]â†’ []
    _,â‚–_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚
    wkâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    wkâ‚–* : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ)
    _â†‘_  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    _â†‘*_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ')
    id   : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµ} â†’ Âµ â€“[ ğ•‚ ]â†’ Âµ
    []*  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚‚} â†’ [] â€“[ ğ•‚ ]â†’ Âµâ‚‚
    _â†“   : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚
    _âˆ¥_  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â€“[ ğ•‚ ]â†’ Âµ)
    â¦…_â¦†  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m} â†’ Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“[ ğ•‚ ]â†’ Âµ

    apâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m)

  -- Renaming/Substitution

  _â€“â†’_ : â¦ƒ ğ•‚ : Kit â¦„ â†’ List VarMode â†’ List VarMode â†’ Set
  _â€“â†’_ â¦ƒ ğ•‚ â¦„ Âµâ‚ Âµâ‚‚ = Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

  -- Extensional Equality

  _~_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set
  Ï•â‚ ~ Ï•â‚‚ = âˆ€ m x â†’ apâ‚– Ï•â‚ m x â‰¡ apâ‚– Ï•â‚‚ m x

  ~-refl :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~ f
  ~-refl a b = refl

  ~-sym :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~ g
    â†’ g ~ f
  ~-sym f~g a b = sym (f~g a b)

  ~-trans :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} 
    â†’ f ~ g
    â†’ g ~ h
    â†’ f ~ h
  ~-trans f~g g~h a b = trans (f~g a b) (g~h a b)

  data Invert-Ï• â¦ƒ ğ•‚ â¦„ {Âµâ‚‚} : {Âµâ‚ : List VarMode} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set where
    Ï•~[]* : âˆ€ {Ï•} â†’
      Ï• ~ []* â†’
      Invert-Ï• Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚ Ï•} â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      Ï• ~ (Ï•' ,â‚– x/t) â†’
      Invert-Ï• Ï•

  data Invert-Ï•' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Set where
    Ï•~[]* :
      (eq : Âµâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•' Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚} â†’
      (eq : Âµâ‚ â‰¡ Âµâ‚' â–· mâ‚) â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Invert-Ï•' Ï•

  invert-Ï•'â†’Ï• : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  invert-Ï•'â†’Ï• (Ï•~[]* refl Ï•~) = Ï•~[]* Ï•~
  invert-Ï•'â†’Ï• (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

record SubWithLaws : Setâ‚ where
  open Sub â¦ƒ â€¦ â¦„
  field
    â¦ƒ SubWithLaws-Sub â¦„ : Sub

    apâ‚–-,â‚–-here : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
                  â†’ apâ‚– (Ï• ,â‚– x/t) _ (here refl) â‰¡ x/t
    apâ‚–-,â‚–-there : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m) {m'} (x : Âµâ‚ âˆ‹ m')
                   â†’ apâ‚– (Ï• ,â‚– x/t) _ (there x) â‰¡ apâ‚– Ï• _ x

    apâ‚–-wkâ‚–-wk : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
                 â†’ apâ‚– (wkâ‚– m Ï•) _ x â‰¡ wk _ (apâ‚– Ï• _ x)

    apâ‚–-â†“ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
      â†’ apâ‚– (Ï• â†“) _ x â‰¡ apâ‚– Ï• _ (there x)

    wkâ‚–*-[] : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* [] Ï• ~ Ï•
    wkâ‚–*-â–· : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* (Âµ â–· m) Ï• ~ wkâ‚– m (wkâ‚–* Âµ Ï•)

    â†‘-,â‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) m
      â†’ (Ï• â†‘ m) ~ (wkâ‚– m Ï• ,â‚– id/` _ (here refl))

    â†‘*-[]  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* []) ~ Ï•

    â†‘*-â–·  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* (Âµ â–· m)) ~ ((Ï• â†‘* Âµ) â†‘ m)

    id-[] : âˆ€ â¦ƒ ğ•‚ : Kit â¦„
      â†’ id {[]} ~ []â‚–

    id-â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m}
      â†’ id {Âµ â–· m} ~ (id {Âµ} â†‘ m)

    []*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„
      â†’ []* {[]} ~ []â‚–

    []*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m}
      â†’ []* {Âµ â–· m} ~ wkâ‚– m ([]* {Âµ})

    â†“-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
      â†’ ((Ï• ,â‚– x/t) â†“) ~ Ï•

    âˆ¥-[] : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµ} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : [] â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ Ï•â‚

    âˆ¥-â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµâ‚‚ Âµ m} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : (Âµâ‚‚ â–· m) â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ subst (_â€“[ ğ•‚ ]â†’ Âµ) (sym (++-assoc ([] â–· m) Âµâ‚‚ Âµâ‚)) ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– Ï•â‚‚ _ (here refl))

    â¦…â¦†-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m} (x/t : Âµ âˆ‹/âŠ¢ id/mâ†’M m) â†’
      â¦… x/t â¦† ~ (id ,â‚– x/t)

    invert' : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï•' Ï•

  invert : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï• Ï•
  invert Ï• = invert-Ï•'â†’Ï• (invert' Ï•)

  -- id-â†‘* : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ}
  --     â†’ id {Âµ} ~ subst (Î» â–  â†’ â–  â€“[ ğ•‚ ]â†’ â– ) (++-identityÊ³ Âµ) ([]â‚– â†‘* Âµ)
  -- id-â†‘* {Âµ = []} = ~-trans id-[] (~-sym (â†‘*-[] []â‚–))
  -- id-â†‘* {Âµ = Âµ â–· x} = {!!}

  -- Weakening preserves Homotopy

  ~-cong-wk : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚– m Ï• ~ wkâ‚– m Ï•'
  ~-cong-wk {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x =
    apâ‚– (wkâ‚– _ Ï•) mx x  â‰¡âŸ¨ apâ‚–-wkâ‚–-wk Ï• x âŸ©
    wk _ (apâ‚– Ï• mx x)   â‰¡âŸ¨ cong (wk _) (Ï•~Ï•' mx x) âŸ©
    wk _ (apâ‚– Ï•' mx x)  â‰¡âŸ¨ sym (apâ‚–-wkâ‚–-wk Ï•' x)âŸ©
    apâ‚– (wkâ‚– _ Ï•') mx x âˆ

  -- ~-cong-wk* : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
  --   Ï• ~ Ï•' â†’
  --   wkâ‚–* Âµ Ï• ~ wkâ‚–* Âµ Ï•'
  -- ~-cong-wk* {Âµ = []}    Ï•~Ï•' = Ï•~Ï•'
  -- ~-cong-wk* {Âµ = Âµ â–· m} Ï•~Ï•' = ~-cong-wk (~-cong-wk* Ï•~Ï•')

  -- Lifting preserves Homotopy

  ~-cong-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m) â†’
    Ï• ~ Ï•' â†’
    (Ï• ,â‚– x/t) ~ (Ï•' ,â‚– x/t)
  ~-cong-,â‚– {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {.mx} {Ï•} {Ï•'} x/t Ï•~Ï•' mx (here refl) =
    apâ‚– (Ï• ,â‚– x/t) mx (here refl)  â‰¡âŸ¨ apâ‚–-,â‚–-here Ï• x/t âŸ©
    x/t                            â‰¡âŸ¨ sym (apâ‚–-,â‚–-here Ï•' x/t) âŸ©
    apâ‚– (Ï•' ,â‚– x/t) mx (here refl) âˆ
  ~-cong-,â‚– {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} x/t Ï•~Ï•' mx (there x) =
    apâ‚– (Ï• ,â‚– x/t) mx (there x)  â‰¡âŸ¨ apâ‚–-,â‚–-there Ï• x/t x âŸ©
    apâ‚– Ï• mx x                   â‰¡âŸ¨ Ï•~Ï•' mx x âŸ©
    apâ‚– Ï•' mx x                  â‰¡âŸ¨ sym (apâ‚–-,â‚–-there Ï•' x/t x) âŸ©
    apâ‚– (Ï•' ,â‚– x/t) mx (there x) âˆ

  -- ~-cong-â†‘ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
  --   Ï• ~ Ï•' â†’
  --   (Ï• â†‘ m) ~ (Ï•' â†‘ m)
  -- ~-cong-â†‘ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' = ~-cong-,â‚– _ (~-cong-wk Ï•~Ï•')

  -- ~-cong-â†‘* : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
  --   Ï• ~ Ï•' â†’
  --   (Ï• â†‘* Âµ) ~ (Ï•' â†‘* Âµ)
  -- ~-cong-â†‘* {Âµ = []}    Ï•~Ï•' = Ï•~Ï•'
  -- ~-cong-â†‘* {Âµ = Âµ â–· m} {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' = ~-cong-â†‘ (~-cong-â†‘* Ï•~Ï•')

  -- Identity


  -- idâ‚–' : Âµ â€“â†’ (Âµ' â–·â–· Âµ )
  -- idâ‚–' _ x = id/` _ (âˆˆ-â–·â–·â‚— x)  where
  --   âˆˆ-â–·â–·â‚— : Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- idâ‚–'' : âˆ€ {Âµ Âµ' Âµ''} â†’ Âµ â€“â†’ (Âµ' â–·â–· Âµ â–·â–· Âµ'')
  -- idâ‚–'' {Âµ} {Âµ'} {Âµ''} _ x = wk* {Âµ' = Âµ''} _ (id/` _ (âˆˆ-â–·â–·â‚— x))  where
  --   âˆˆ-â–·â–·â‚— :  âˆ€ {Âµ} {Âµ'} â†’ Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- Lifted identity is identity

  -- TODO: However now this holds definitionally...

  -- idâ†‘~id : âˆ€ m Âµ â†’ idâ‚– {Âµ = Âµ} â†‘ m ~ idâ‚– {Âµ = Âµ â–· m}
  -- idâ†‘~id m Âµ _ (here _)  = refl
  -- idâ†‘~id m Âµ _ (there x) = wk-id/` m x

  -- idâ†‘*~id : âˆ€ Âµ' Âµ â†’ idâ‚– {Âµ = Âµ} â†‘* Âµ' ~ idâ‚– {Âµ = Âµ â–·â–· Âµ'}
  -- idâ†‘*~id []       Âµ = ~-refl
  -- idâ†‘*~id (Âµ' â–· m) Âµ =
  --   idâ‚– â†‘* Âµ' â†‘ m  ~âŸ¨ ~-cong-â†‘ (idâ†‘*~id Âµ' Âµ) âŸ©
  --   idâ‚– â†‘ m        ~âŸ¨ idâ†‘~id _ _ âŸ©
  --   idâ‚–            ~âˆ

  -- Empty Substitution

  apâ‚–-[]â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {m} x â†’ apâ‚– []â‚– m x â‰¡ id/` m x
  apâ‚–-[]â‚– ()

  apâ‚–-[]â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ (Ï• : [] â€“[ ğ•‚ ]â†’ []) â†’ Ï• ~ []â‚–
  apâ‚–-[]â‚–' Ï• m ()

  -- -- Singleton renaming/substitution

  -- -- Singleton renaming/substitution for terms with 1 free variable.
  -- -- Allows the term to be substituted to have arbitrary free variables.
  -- -- This is useful for things like pattern inverting in combination with `_âˆ¥_`,
  -- -- where a inverting substitution needs to be built up piece by piece.
  -- â¦…_â¦†â‚€ : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
  -- â¦… v â¦†â‚€ = emptyâ‚– ,â‚– v

  -- -- â¦…_â¦†' : (Âµ â–·â–· Âµ') âˆ‹/âŠ¢ mâ†’[m/M] m â†’ (Âµ â–· m â–·â–· Âµ') â€“â†’ (Âµ â–·â–· Âµ')
  -- -- â¦… v â¦†' = idâ‚–'' âˆ¥ â¦… v â¦†â‚€ âˆ¥ idâ‚–''
  -- -- â¦… v â¦†' = {!!} âˆ¥ â¦… v â¦†â‚€ âˆ¥ {!!}
  -- -- -- â¦… v â¦†' = (idâ‚– âˆ¥ â¦… v â¦†â‚€) â†‘* _

-- Functions as Substitutions

module Functional where

  module Functional-Sub where
    _â€“[_]â†’_ : List VarMode â†’ Kit â†’ List VarMode â†’ Set
    _â€“[_]â†’_ = Î» Âµâ‚ ğ•‚ Âµâ‚‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ m)

    []â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ} â†’ [] â€“[ ğ•‚ ]â†’ Âµ
    []â‚– _ ()

    _,â‚–_ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµâ‚‚ m} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚
    (Ï• ,â‚– t) _ (here refl) = t
    (Ï• ,â‚– t) _ (there x)   = Ï• _ x

    wkâ‚– : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    wkâ‚– m Ï• mx x = wk (id/mâ†’M mx) (Ï• mx x)

    wkâ‚–* : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ)
    wkâ‚–* []      Ï• = Ï•
    wkâ‚–* (Âµ â–· m) Ï• = wkâ‚– m (wkâ‚–* Âµ Ï•)

    _â†‘_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    Ï• â†‘ m = wkâ‚– m Ï• ,â‚– id/` _ (here refl)

    _â†‘*_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ')
    Ï• â†‘* []       = Ï•
    Ï• â†‘* (Âµ' â–· m) = (Ï• â†‘* Âµ') â†‘ m

    id : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµ} â†’ Âµ â€“[ ğ•‚ ]â†’ Âµ
    id = id/`

    _â†“ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ ((Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
    (Ï• â†“) _ x = Ï• _ (there x)

    _âˆ¥_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â€“[ ğ•‚ ]â†’ Âµ)
    _âˆ¥_            {Âµâ‚‚ = []}    Ïƒâ‚ Ïƒâ‚‚ = Ïƒâ‚
    _âˆ¥_ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚ â–· m} {Âµ} Ïƒâ‚ Ïƒâ‚‚ = subst (_â€“[ ğ•‚ ]â†’ Âµ) (sym (++-assoc ([] â–· m) Âµâ‚‚ Âµâ‚)) ((Ïƒâ‚ âˆ¥ (Ïƒâ‚‚ â†“)) ,â‚– Ïƒâ‚‚ _ (here refl))

    â¦…_â¦† : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµ m} â†’ Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“[ ğ•‚ ]â†’ Âµ
    â¦… v â¦† = idâ‚– ,â‚– v

    apâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m)
    apâ‚– Ï• = Ï•

    instance
      Sub-â†’ : Sub
      Sub-â†’ = record
        { _â€“[_]â†’_      = _â€“[_]â†’_
        ; []â‚–          = []â‚–
        ; _,â‚–_         = _,â‚–_
        ; wkâ‚–          = wkâ‚–
        ; wkâ‚–*         = wkâ‚–*
        ; _â†‘_          = _â†‘_
        ; _â†‘*_         = _â†‘*_
        ; id           = id
        ; []*          = []â‚–
        ; _â†“           = _â†“
        ; _âˆ¥_          = _âˆ¥_
        ; â¦…_â¦†          = â¦…_â¦†
        ; apâ‚–          = apâ‚–
        }

  module Functional-Sub-With-Laws where
    open Sub Functional-Sub.Sub-â†’

    id-â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m}
      â†’ id {Âµ â–· m} ~ (id {Âµ} â†‘ m)
    id-â–· m (here refl) = refl
    id-â–· m (there x) = sym (wk-id/` _ x)

    invert' : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï•' Ï•
    invert' {Âµâ‚ = []}      Ï• = Ï•~[]* refl (Î» m ())
    invert' {Âµâ‚ = Âµâ‚ â–· mâ‚} Ï• = Ï•~,â‚– refl (Ï• â†“) (Ï• _ (here refl)) Î» where
      m (here refl) â†’ refl
      m (there x) â†’ refl

    instance
      SubWithLaws-â†’ : SubWithLaws
      SubWithLaws-â†’ = record
        { apâ‚–-,â‚–-here  = Î» Ï• x/t â†’ refl
        ; apâ‚–-,â‚–-there = Î» Ï• x/t x â†’ refl
        ; apâ‚–-wkâ‚–-wk   = Î» Ï• x â†’ refl
        ; apâ‚–-â†“        = Î» Ï• x â†’ refl
        ; wkâ‚–*-[]      = Î» Ï• m x â†’ refl
        ; wkâ‚–*-â–·       = Î» Âµ m Ï• mx x â†’ refl
        ; â†‘-,â‚–         = Î» Ï• m mx x â†’ refl
        ; â†‘*-[]        = Î» Ï• m x â†’ refl
        ; â†‘*-â–·         = Î» Âµ m Ï• mâ‚ x â†’ refl
        ; id-[]        = Î» m ()
        ; id-â–·         = id-â–·
        ; []*-[]       = Î» m x â†’ refl
        ; []*-â–·        = Î» m ()
        ; â†“-,â‚–         = Î» Ï• x/t m x â†’ refl
        ; âˆ¥-[]         = Î» Ï•â‚ Ï•â‚‚ m x â†’ refl
        ; âˆ¥-â–·          = Î» Ï•â‚ Ï•â‚‚ m x â†’ refl
        ; â¦…â¦†-,â‚–        = Î» x/t m x â†’ refl
        ; invert'      = invert'
        }

-- -- Lists as Substitutions

-- open import Data.List.Relation.Unary.All

-- ap-all : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ All (Î» mâ‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ mâ‚) Âµâ‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m)
-- ap-all (x/t âˆ· Ï•) m (here refl) = x/t
-- ap-all (x/t âˆ· Ï•) m (there x) = ap-all Ï• m x

-- instance
--   Sub-All : Sub
--   Sub._â€“[_]â†’_      Sub-All = Î» Âµâ‚ ğ•‚ Âµâ‚‚ â†’ All (Î» mâ‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ mâ‚) Âµâ‚
--   Sub.[]â‚–          Sub-All = []
--   Sub._,â‚–_         Sub-All = Î» Ï• x/t â†’ x/t âˆ· Ï•
--   Sub.wkâ‚–          Sub-All = Î» m Ï• â†’ map (wk _) Ï•
--   Sub.apâ‚–          Sub-All = ap-all
--   Sub.apâ‚–-,â‚–-here  Sub-All = Î» Ï• x/t â†’ refl
--   Sub.apâ‚–-,â‚–-there Sub-All = Î» Ï• x/t x â†’ refl
--   Sub.apâ‚–-wkâ‚–-wk   Sub-All = Î» Ï• x/t â†’ {!!}

-- -- Syntax as Substitutions

-- data _â€“[_]â†’_ : List VarMode â†’ Kit â†’ List VarMode â†’ Set where
--   []â‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ [] â€“[ ğ•‚ ]â†’ []
--   _,â‚–_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚
--   wkâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)

-- ap : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m)
-- ap (Ï• ,â‚– x/t) m (here refl) = x/t
-- ap (Ï• ,â‚– x/t) m (there x) = ap Ï• m x
-- ap (wkâ‚– m' Ï•) m x = wk _ (ap Ï• m x)

-- instance
--   Sub-Sub : Sub
--   Sub._â€“[_]â†’_      Sub-Sub = _â€“[_]â†’_
--   Sub.[]â‚–          Sub-Sub = []â‚–
--   Sub._,â‚–_         Sub-Sub = _,â‚–_
--   Sub.wkâ‚–          Sub-Sub = wkâ‚–
--   Sub.apâ‚–          Sub-Sub = ap
--   Sub.apâ‚–-,â‚–-here  Sub-Sub = Î» Ï• x/t â†’ refl
--   Sub.apâ‚–-,â‚–-there Sub-Sub = Î» Ï• x/t x â†’ refl
--   Sub.apâ‚–-wkâ‚–-wk   Sub-Sub = Î» Ï• x/t â†’ refl
