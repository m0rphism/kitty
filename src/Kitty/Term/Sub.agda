open import Kitty.Term.Terms

module Kitty.Term.Sub (ğ•‹ : Terms) where

open import Level renaming (suc to lsuc)
open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open Terms ğ•‹
open Kit â¦ƒ â€¦ â¦„
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„

private variable
  _âˆ‹/âŠ¢_ _âˆ‹/âŠ¢â‚_ _âˆ‹/âŠ¢â‚‚_ _âˆ‹/âŠ¢â‚ƒ_ : VarScoped

record Sub â„“ : Set (lsuc â„“) where
  infixl  12  _,â‚–_
  infixl  11  _â†‘_  _â†‘*_
  infixl  9  _âˆ¥_
  infixl  8  _&_
  infix   4  _~_  _~'_

  field
    _â€“[_]â†’_ : SortCtx â†’ Kit _âˆ‹/âŠ¢_ â†’ SortCtx â†’ Set â„“

    []â‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ â†’ [] â€“[ ğ•‚ ]â†’ []
    _,â‚–_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s â†’ (Sâ‚ â–· s) â€“[ ğ•‚ ]â†’ Sâ‚‚
    wkâ‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} s â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–· s)
    wkâ‚–* : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–·â–· S)
    _â†‘_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ âˆ€ s â†’ (Sâ‚ â–· s) â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–· s)
    _â†‘*_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ âˆ€ S' â†’ (Sâ‚ â–·â–· S') â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–·â–· S')
    id   : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S} â†’ S â€“[ ğ•‚ ]â†’ S
    []*  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚‚} â†’ [] â€“[ ğ•‚ ]â†’ Sâ‚‚
    _â†“   : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} â†’ (Sâ‚ â–· s) â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚
    -- TODO: we might want this also to be Kit-heterogenous, to allow for talking about
    -- parallel compositions of two unknown, potentially different Kits.
    _âˆ¥_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ Sâ‚‚ S} â†’ (Sâ‚ â€“[ ğ•‚ ]â†’ S) â†’ (Sâ‚‚ â€“[ ğ•‚ ]â†’ S) â†’ ((Sâ‚ â–·â–· Sâ‚‚) â€“[ ğ•‚ ]â†’ S)
    â¦…_â¦†  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s} â†’ S âˆ‹/âŠ¢ s â†’ (S â–· s) â€“[ ğ•‚ ]â†’ S
    -- Singleton renaming/substitution for terms with 1 free variable.
    -- Allows the term to be substituted to have arbitrary free variables.
    -- This is useful for things like pattern matching in combination with `_âˆ¥_`,
    -- where a matching substitution needs to be built up piece by piece.
    â¦…_â¦†â‚€ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s} â†’ S âˆ‹/âŠ¢ s â†’ ([] â–· s) â€“[ ğ•‚ ]â†’ S

    _&_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} â†’ Sâ‚ âˆ‹ s â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚‚ âˆ‹/âŠ¢ s

    Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Sâ‚} {Sâ‚‚} â†’ Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚

  -- Renaming/Substitution

  _â€“â†’_ : â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ â†’ SortCtx â†’ SortCtx â†’ Set â„“
  _â€“â†’_ â¦ƒ ğ•‚ â¦„ Sâ‚ Sâ‚‚ = Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚

  -- Extensional Equality

  -- Unused, because when we use it, we get horrible, horrible names....
  module Heterogeneous-~
      {â„“}
      (P : âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} (ğ•‚ : Kit _âˆ‹/âŠ¢_) â†’ Set â„“)
      (R : âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
             (Ï•â‚ : P ğ•‚â‚) (Ï•â‚‚ : P ğ•‚â‚‚) â†’ Set)
      (R-refl : âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Ï• : P ğ•‚} â†’ R Ï• Ï•)
      (R-sym  : âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
                  {Ï•â‚ : P ğ•‚â‚} {Ï•â‚‚ : P ğ•‚â‚‚}
                â†’ R Ï•â‚ Ï•â‚‚ â†’ R Ï•â‚‚ Ï•â‚)
      (R-trans : âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} {_âˆ‹/âŠ¢â‚‚_ : VarScoped} {_âˆ‹/âŠ¢â‚ƒ_ : VarScoped}
                   â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„
                   {Ï•â‚ : P ğ•‚â‚} {Ï•â‚‚ : P ğ•‚â‚‚} {Ï•â‚ƒ : P ğ•‚â‚ƒ}
                â†’ R Ï•â‚ Ï•â‚‚ â†’ R Ï•â‚‚ Ï•â‚ƒ â†’ R Ï•â‚ Ï•â‚ƒ)
      where

    record _~_ {_âˆ‹/âŠ¢â‚_ : VarScoped} {_âˆ‹/âŠ¢â‚‚_ : VarScoped}
               â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
               (Ï•â‚ : P ğ•‚â‚) (Ï•â‚‚ : P ğ•‚â‚‚) : Set where
      constructor mk-~
      field
        use-~ : R Ï•â‚ Ï•â‚‚
    open _~_

    ~-refl :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {f : P ğ•‚}
      â†’ f ~ f
    ~-refl = mk-~ R-refl

    ~-sym :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚}
      â†’ f ~ g
      â†’ g ~ f
    ~-sym f~g = mk-~ (R-sym (use-~ f~g))

    ~-trans :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ f ~ g
      â†’ g ~ h
      â†’ f ~ h
    ~-trans f~g g~h = mk-~ (R-trans (use-~ f~g) (use-~ g~h))

    infix  3 _~âˆ
    infixr 2 _~âŸ¨âŸ©_ step-~ step-~Ë˜ step-~â‰¡
    infix  1 begin~_

    private variable
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : P ğ•‚

    begin~_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚}
      â†’ f ~ g â†’ f ~ g
    begin~_ xâ‰¡y = xâ‰¡y

    _~âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚}
      â†’ f ~ g â†’ f ~ g
    _ ~âŸ¨âŸ© x~y = x~y

    step-~ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ g ~ h â†’ f ~ g â†’ f ~ h
    step-~ f g~h f~g = ~-trans f~g g~h

    step-~Ë˜ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ g ~ h â†’ g ~ f â†’ f ~ h
    step-~Ë˜ _ g~h g~f = ~-trans (~-sym g~f) g~h

    step-~â‰¡ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚} {h : P ğ•‚â‚‚}
      â†’ g ~ h â†’ f â‰¡ g â†’ f ~ h
    step-~â‰¡ f g~h fâ‰¡g = ~-trans (subst (f ~_) fâ‰¡g ~-refl ) g~h

    _~âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : P ğ•‚)
      â†’ f ~ f
    _~âˆ _ = ~-refl

    syntax step-~  f g~h f~g = f ~âŸ¨ f~g âŸ© g~h
    syntax step-~â‰¡  f g~h fâ‰¡g = f ~â‰¡âŸ¨ fâ‰¡g âŸ© g~h
    syntax step-~Ë˜ f g~h g~f = f ~Ë˜âŸ¨ g~f âŸ© g~h

  infix  4  _~â‚œ_

  _~â‚œ_ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {S} {s} â†’ S âˆ‹/âŠ¢[ ğ•‚â‚ ] s â†’ S âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s â†’ Set
  _~â‚œ_ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {S} {s} x/tâ‚ x/tâ‚‚ =
    `/id x/tâ‚ â‰¡ `/id x/tâ‚‚
  -- _~â‚œ_ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {S} {s} x/tâ‚ x/tâ‚‚ =
  --   let eq = mâ†’M/id (id/mâ†’M â¦ƒ ğ•‚â‚ â¦„ m) â‰¡âŸ¨ id/mâ†’M/id m âŸ©
  --            mâ†’M m                    â‰¡âŸ¨ sym (id/mâ†’M/id m) âŸ©
  --            mâ†’M/id (id/mâ†’M â¦ƒ ğ•‚â‚‚ â¦„ m) âˆ
  --   in x/tâ‚ ~â‚œ[ eq ] x/tâ‚‚

  -- module Test where
  --   module Terms-~ {S} {m} where
  --     open Heterogeneous-~ (Î» ğ•‚ â†’ S âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ m) _~â‚œ_ refl sym trans public
  --       renaming (_~_ to _~áµ—_)
  --   open Terms-~
  --   test : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S} {m} (Ï• : S âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ m) â†’ Ï• ~áµ— Ï•
  --   test Ï• =
  --     Ï• ~âŸ¨ {!!} âŸ©
  --     Ï• ~âˆ


  -- Helps with inferring Ï•â‚ and Ï•â‚‚ from implicits
  record _~_ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) (Ï•â‚‚ : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) : Set where
    constructor mk-~
    field
      use-~ : âˆ€ s (x : _ âˆ‹ s) â†’ x & Ï•â‚ ~â‚œ x & Ï•â‚‚
  open _~_ public

  -- Helps with inferring Ï•â‚ and Ï•â‚‚ from implicits
  record _~'_ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï•â‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (Ï•â‚‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) : Set where
    constructor mk-~'
    field
      use-~' : âˆ€ s (x : _ âˆ‹ s) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚
  open _~'_ public

  -- _~_ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} â†’ Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚ â†’ Set
  -- Ï•â‚ ~ Ï•â‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ x & Ï•â‚ ~â‚œ x & Ï•â‚‚
  -- -- Ï•â‚ ~ Ï•â‚‚ = âˆ€ s x â†’ `/id (& Ï•â‚ s x) â‰¡ `/id (& Ï•â‚‚ s x)

  -- _~'_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Set
  -- Ï•â‚ ~' Ï•â‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚

  ~â†’~' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Ï•â‚ Ï•â‚‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
         â†’ Ï•â‚ ~ Ï•â‚‚
         â†’ Ï•â‚ ~' Ï•â‚‚
  ~â†’~' Ï•â‚~Ï•â‚‚ = mk-~' (Î» s x â†’ `/id-injective (use-~ Ï•â‚~Ï•â‚‚ s x))

  ~'â†’~ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Ï•â‚ Ï•â‚‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
         â†’ Ï•â‚ ~' Ï•â‚‚
         â†’ Ï•â‚ ~ Ï•â‚‚
  ~'â†’~ Ï•â‚~'Ï•â‚‚ = mk-~ (Î» s x â†’ cong `/id (use-~' Ï•â‚~'Ï•â‚‚ s x))

  use-~-hom :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Ï•â‚ Ï•â‚‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
    â†’ Ï•â‚ ~ Ï•â‚‚
    â†’ (âˆ€ s (x : _ âˆ‹ s) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚)
  use-~-hom Ï•â‚~Ï•â‚‚ = use-~' (~â†’~' Ï•â‚~Ï•â‚‚)

  ~â‚œ-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S} {s} {x/t : S âˆ‹/âŠ¢[ ğ•‚ ] s}
    â†’ x/t ~â‚œ x/t
  ~â‚œ-refl = cong (`/id) refl

  ~â‚“-refl :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {S} {s} {x : S âˆ‹ s}
    â†’ id/` â¦ƒ ğ•‚â‚ â¦„ x ~â‚œ id/` â¦ƒ ğ•‚â‚‚ â¦„ x
  ~â‚“-refl â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {x = x} =
    `/id â¦ƒ ğ•‚â‚ â¦„ (id/` x) â‰¡âŸ¨ id/`/id â¦ƒ ğ•‚â‚ â¦„ x âŸ©
    ` x                  â‰¡âŸ¨ sym (id/`/id â¦ƒ ğ•‚â‚‚ â¦„ x) âŸ©
    `/id â¦ƒ ğ•‚â‚‚ â¦„ (id/` x) âˆ

  ~-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {f : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
    â†’ f ~ f
  ~-refl = mk-~ (Î» a b â†’ refl)

  ~-sym :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
    â†’ f ~ g
    â†’ g ~ f
  ~-sym f~g = mk-~ (Î» a b â†’ sym (use-~ f~g a b))

  ~-trans :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ {Sâ‚} {Sâ‚‚} {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} {h : Sâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚‚}
    â†’ f ~ g
    â†’ g ~ h
    â†’ f ~ h
  ~-trans f~g g~h = mk-~ (Î» a b â†’ trans (use-~ f~g a b) (use-~ g~h a b))

  ~-cong-subst-Sâ‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚'} {Sâ‚‚} {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} (eq : Sâ‚ â‰¡ Sâ‚')
    â†’ f ~ g
    â†’ subst (_â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) eq f ~ subst (_â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) eq g
  ~-cong-subst-Sâ‚ refl f~g = f~g

  ~-cong-subst-Sâ‚‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} {Sâ‚‚'} {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} (eq : Sâ‚‚ â‰¡ Sâ‚‚')
    â†’ f ~ g
    â†’ subst (Sâ‚ â€“[ ğ•‚â‚ ]â†’_) eq f ~ subst (Sâ‚ â€“[ ğ•‚â‚‚ ]â†’_) eq g
  ~-cong-subst-Sâ‚‚ refl f~g = f~g

  ~-cong-substâ‚‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚'} {Sâ‚‚} {Sâ‚‚'} {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} (eqâ‚ : Sâ‚ â‰¡ Sâ‚') (eqâ‚‚ : Sâ‚‚ â‰¡ Sâ‚‚')
    â†’ f ~ g
    â†’ substâ‚‚ (_â€“[ ğ•‚â‚ ]â†’_) eqâ‚ eqâ‚‚ f ~ substâ‚‚ (_â€“[ ğ•‚â‚‚ ]â†’_) eqâ‚ eqâ‚‚ g
  ~-cong-substâ‚‚ refl refl f~g = f~g

  module ~-Reasoning where

    infix  3 _~âˆ
    infixr 2 _~âŸ¨âŸ©_ step-~ step-~Ë˜ step-~â‰¡
    infix  1 begin~_

    private variable
      Sâ‚ Sâ‚‚ Sâ‚ƒ : SortCtx
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚

    begin~_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
      â†’ f ~ g â†’ f ~ g
    begin~_ xâ‰¡y = xâ‰¡y

    _~âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
      â†’ f ~ g â†’ f ~ g
    _ ~âŸ¨âŸ© x~y = x~y

    step-~ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} {h : Sâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚‚}
      â†’ g ~ h â†’ f ~ g â†’ f ~ h
    step-~ f g~h f~g = ~-trans f~g g~h

    step-~Ë˜ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) {g : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} {h : Sâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚‚}
      â†’ g ~ h â†’ g ~ f â†’ f ~ h
    step-~Ë˜ _ g~h g~f = ~-trans (~-sym g~f) g~h

    step-~â‰¡ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) {g : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {h : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
      â†’ g ~ h â†’ f â‰¡ g â†’ f ~ h
    step-~â‰¡ f g~h fâ‰¡g = ~-trans (subst (f ~_) fâ‰¡g ~-refl ) g~h

    _~âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ f ~ f
    _~âˆ _ = ~-refl

    syntax step-~  f g~h f~g = f ~âŸ¨ f~g âŸ© g~h
    syntax step-~â‰¡  f g~h fâ‰¡g = f ~â‰¡âŸ¨ fâ‰¡g âŸ© g~h
    syntax step-~Ë˜ f g~h g~f = f ~Ë˜âŸ¨ g~f âŸ© g~h

  ~'-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {f : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
    â†’ f ~' f
  ~'-refl = mk-~' Î» a b â†’ refl

  ~'-sym :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {f g : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
    â†’ f ~' g
    â†’ g ~' f
  ~'-sym f~'g = mk-~' Î» a b â†’ sym (use-~' f~'g a b)

  ~'-trans :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {f g h : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} 
    â†’ f ~' g
    â†’ g ~' h
    â†’ f ~' h
  ~'-trans f~'g g~'h = mk-~' Î» a b â†’ trans (use-~' f~'g a b) (use-~' g~'h a b)

  ~'-cong-subst-Sâ‚ :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚'} {Sâ‚‚} {f g : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} (eq : Sâ‚ â‰¡ Sâ‚')
    â†’ f ~' g
    â†’ subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) eq f ~' subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) eq g
  ~'-cong-subst-Sâ‚ refl f~'g = f~'g

  ~'-cong-subst-Sâ‚‚ :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Sâ‚‚'} {f g : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} (eq : Sâ‚‚ â‰¡ Sâ‚‚')
    â†’ f ~' g
    â†’ subst (Sâ‚ â€“[ ğ•‚ ]â†’_) eq f ~' subst (Sâ‚ â€“[ ğ•‚ ]â†’_) eq g
  ~'-cong-subst-Sâ‚‚ refl f~'g = f~'g

  module ~'-Reasoning where

    infix  3 _~'âˆ
    infixr 2 _~'âŸ¨âŸ©_ step-~' step-~'Ë˜ step-~'â‰¡
    infix  1 begin~'_

    private variable
      Sâ‚ Sâ‚‚ Sâ‚ƒ : SortCtx
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚

    begin~'_ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {f g : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
      â†’ f ~' g â†’ f ~' g
    begin~'_ xâ‰¡y = xâ‰¡y

    _~'âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g} : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ f ~' g â†’ f ~' g
    _ ~'âŸ¨âŸ© x~'y = x~'y

    step-~' :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ g ~' h â†’ f ~' g â†’ f ~' h
    step-~' _ g~'h f~'g = ~'-trans f~'g g~'h

    step-~'Ë˜ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ g ~' h â†’ g ~' f â†’ f ~' h
    step-~'Ë˜ _ g~'h g~'f = ~'-trans (~'-sym g~'f) g~'h

    step-~'â‰¡ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ g ~' h â†’ f â‰¡ g â†’ f ~' h
    step-~'â‰¡ f g~'h fâ‰¡g = ~'-trans (subst (f ~'_) fâ‰¡g ~'-refl ) g~'h

    _~'âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ f ~' f
    _~'âˆ _ = ~'-refl

    syntax step-~'  f g~'h f~'g = f ~'âŸ¨ f~'g âŸ© g~'h
    syntax step-~'â‰¡  f g~'h fâ‰¡g = f ~'â‰¡âŸ¨ fâ‰¡g âŸ© g~'h
    syntax step-~'Ë˜ f g~'h g~'f = f ~'Ë˜âŸ¨ g~'f âŸ© g~'h

  data Invert-Ï• â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚‚} : {Sâ‚ : SortCtx} â†’ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Set â„“ where
    Ï•~[]* : âˆ€ {Ï•} â†’
      Ï• ~ []* â†’
      Invert-Ï• Ï•
    Ï•~,â‚– : âˆ€ {Sâ‚' sâ‚ Ï•} â†’
      (Ï•' : Sâ‚' â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
      (x/t : Sâ‚‚ âˆ‹/âŠ¢ sâ‚) â†’
      Ï• ~ (Ï•' ,â‚– x/t) â†’
      Invert-Ï• Ï•

  data Invert-Ï•' â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) : Set â„“ where
    Ï•~[]* :
      (eq : Sâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•' Ï•
    Ï•~,â‚– : âˆ€ {Sâ‚' sâ‚} â†’
      (eq : Sâ‚ â‰¡ Sâ‚' â–· sâ‚) â†’
      (Ï•' : Sâ‚' â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
      (x/t : Sâ‚‚ âˆ‹/âŠ¢ sâ‚) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Invert-Ï•' Ï•

  data Invert-Ï•'-Rec â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ â†’ Set â„“ where
    Ï•~[]* :
      (eq : Sâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•'-Rec Ï• (sub []*)
    Ï•~,â‚– : âˆ€ {Sâ‚' sâ‚} â†’
      (eq : Sâ‚ â‰¡ Sâ‚' â–· sâ‚) â†’
      (Ï•' : Sâ‚' â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
      (x/t : Sâ‚‚ âˆ‹/âŠ¢ sâ‚) â†’
      (Ï•'' : Sâ‚' â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
      Invert-Ï•'-Rec Ï•' Ï•'' â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Ï• ~ sub (Ï•'' ,â‚– x/t) â†’
      Invert-Ï•'-Rec Ï• (sub (Ï•'' ,â‚– x/t))

  invert-Ï•'â†’Ï• : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  invert-Ï•'â†’Ï• (Ï•~[]* refl Ï•~) = Ï•~[]* Ï•~
  invert-Ï•'â†’Ï• (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

  -- -- requires dependent subst
  -- invert-Ï•'â†’Ï•' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  -- invert-Ï•'â†’Ï•' {Sâ‚} {Sâ‚‚} {Ï•} (Ï•~[]* Sâ‚â‰¡[] Ï•~) = {!substâ‚‚ (Î» â–  â– ' â†’ Invert-Ï• {Sâ‚ = â– } â– ') ? ? {!Ï•~[]* Ï•~!}!}
  -- invert-Ï•'â†’Ï•' (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

_â€“[_Í¾_]â†’_ : âˆ€ {â„“} â†’ SortCtx â†’ Kit _âˆ‹/âŠ¢_ â†’ Sub â„“ â†’ SortCtx â†’ Set â„“
_â€“[_Í¾_]â†’_ Sâ‚ ğ•‚ ğ•Š Sâ‚‚ = Sub._â€“[_]â†’_ ğ•Š Sâ‚ ğ•‚ Sâ‚‚

record SubWithLaws â„“ : Set (lsuc â„“) where
  field
    â¦ƒ SubWithLaws-Sub â¦„ : Sub â„“

  open Sub SubWithLaws-Sub

  field

    &-,â‚–-here : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s)
                  â†’ here refl & (Ï• ,â‚– x/t) â‰¡ x/t
    &-,â‚–-there : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s) {s'} (x : Sâ‚ âˆ‹ s')
                   â†’ there x & (Ï• ,â‚– x/t) â‰¡ x & Ï•

    &-wkâ‚–-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {s'} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x : Sâ‚ âˆ‹ s')
                 â†’ x & wkâ‚– s Ï• â‰¡ wk s (x & Ï•)

    &-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {s'} (Ï• : (Sâ‚ â–· s) â€“[ ğ•‚ ]â†’ Sâ‚‚) (x : Sâ‚ âˆ‹ s')
      â†’ x & (Ï• â†“) â‰¡ there x & Ï•

    wkâ‚–*-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ wkâ‚–* [] Ï• ~ Ï•
    wkâ‚–*-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S s (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ wkâ‚–* (S â–· s) Ï• ~ wkâ‚– s (wkâ‚–* S Ï•)

    â†‘-,â‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) s
      â†’ (Ï• â†‘ s) ~ (wkâ‚– s Ï• ,â‚– id/` (here refl))

    â†‘*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ (Ï• â†‘* []) ~ Ï•

    â†‘*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S s (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
      â†’ (Ï• â†‘* (S â–· s)) ~ ((Ï• â†‘* S) â†‘ s)

    id-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â†’ id {S = []} ~ []â‚–

    id-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s}
      â†’ id {S = S â–· s} ~ (id {S = S} â†‘ s)

    []*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â†’ []* {Sâ‚‚ = []} ~ []â‚–

    []*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s}
      â†’ []* {Sâ‚‚ = S â–· s} ~ wkâ‚– s ([]* {Sâ‚‚ = S})

    â†“-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s)
      â†’ ((Ï• ,â‚– x/t) â†“) ~ Ï•

    âˆ¥-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ S} â†’ (Ï•â‚ : Sâ‚ â€“[ ğ•‚ ]â†’ S) â†’ (Ï•â‚‚ : [] â€“[ ğ•‚ ]â†’ S)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ Ï•â‚

    âˆ¥-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ Sâ‚‚ S s} â†’ (Ï•â‚ : Sâ‚ â€“[ ğ•‚ ]â†’ S) â†’ (Ï•â‚‚ : (Sâ‚‚ â–· s) â€“[ ğ•‚ ]â†’ S)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚))

    â¦…â¦†-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s} (x/t : S âˆ‹/âŠ¢ s) â†’
      â¦… x/t â¦† ~ (id ,â‚– x/t)

    â¦…â¦†â‚€-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S s} (x/t : S âˆ‹/âŠ¢ s) â†’
      â¦… x/t â¦†â‚€ ~ ([]* ,â‚– x/t)

    invert' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ Invert-Ï•' Ï•

    &-Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Sâ‚} {Sâ‚‚} {s} (Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) (x : Sâ‚ âˆ‹ s)
            â†’ x & (Î¹-â†’ Ï•) â‰¡ Î¹-âˆ‹/âŠ¢ (x & Ï•)

  open ~-Reasoning

  ~-Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚)
          â†’ Î¹-â†’ Ï• ~ Ï•
  ~-Î¹-â†’ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ â¦„ {Sâ‚} {Sâ‚‚} Ï• = mk-~ Î» s x â†’
    `/id (x & Î¹-â†’ Ï•)     â‰¡âŸ¨ cong `/id (&-Î¹-â†’ Ï• x) âŸ©
    `/id (Î¹-âˆ‹/âŠ¢ (x & Ï•)) â‰¡âŸ¨ sym (Î¹-`/id (x & Ï•)) âŸ©
    `/id (x & Ï•)         âˆ

  &-id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S} {s} (x : S âˆ‹ s)
           â†’ x & id {S = S} â‰¡ id/` x
  &-id â¦ƒ ğ•‚ â¦„ {S â–· s'} {s} x@(here refl) =
    x & (id {S = S â–· s'})              â‰¡âŸ¨ use-~-hom id-â–· s' x âŸ©
    x & (id {S = S} â†‘ s')              â‰¡âŸ¨ use-~-hom (â†‘-,â‚– id s') _ x âŸ©
    x & (wkâ‚– _ (id {S = S}) ,â‚– id/` x) â‰¡âŸ¨ &-,â‚–-here (wkâ‚– _ (id {S = S})) (id/` x) âŸ©
    id/` x                             âˆ
  &-id â¦ƒ ğ•‚ â¦„ {S â–· s'} {s} (there x) =
    there x & (id {S = S â–· s'})                        â‰¡âŸ¨ use-~-hom id-â–· _ (there x) âŸ©
    there x & (id {S = S} â†‘ s')                        â‰¡âŸ¨ use-~-hom (â†‘-,â‚– id s') _ (there x) âŸ©
    there x & (wkâ‚– _ (id {S = S}) ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-there (wkâ‚– _ (id {S = S})) (id/` (here refl)) x âŸ©
    x & (wkâ‚– _ (id {S = S}))                           â‰¡âŸ¨ &-wkâ‚–-wk id x âŸ©
    wk s' (x & id {S = S})                             â‰¡âŸ¨ cong (wk s') (&-id x) âŸ©
    wk s' (id/` x)                                     â‰¡âŸ¨ wk-id/` s' x âŸ©
    id/` (there x)                                     âˆ

  -- id-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {S S'}
  --   â†’ id {S â–·â–· S'} ~ (id {S} â†‘* S')
  -- id-â–·â–· {S' = []} = ~-sym (â†‘*-[] id)
  -- id-â–·â–· {S' = S' â–· s} = ~-trans {!id-â–·â–·!} (~-trans {!id-â–·!} (~-sym (â†‘*-â–· S' s id)))

  &-â†‘-here :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
    â†’ here refl & (Ï• â†‘ s) â‰¡ id/` (here refl)
  &-â†‘-here â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {s} Ï• =
    here refl & (Ï• â†‘ s)                       â‰¡âŸ¨ use-~-hom (â†‘-,â‚– Ï• s) s (here refl) âŸ©
    here refl & (wkâ‚– s Ï• ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-here (wkâ‚– s Ï•) _ âŸ©
    id/` (here refl)                          âˆ

  &-â†‘-there :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {s'} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x : Sâ‚ âˆ‹ s')
    â†’ there x & (Ï• â†‘ s) â‰¡ wk s (x & Ï•)
  &-â†‘-there â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {s} {s'} Ï• x =
    there x & (Ï• â†‘ s)                       â‰¡âŸ¨ use-~-hom (â†‘-,â‚– Ï• s) s' (there x) âŸ©
    there x & (wkâ‚– s Ï• ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-there (wkâ‚– s Ï•) _ x âŸ©
    x & wkâ‚– s Ï•                             â‰¡âŸ¨ &-wkâ‚–-wk Ï• x âŸ©
    wk s (x & Ï•)                            âˆ

  -- Weakening preserves Homotopy

  ~'-cong-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’
    Ï• ~' Ï•' â†’
    wkâ‚– s Ï• ~' wkâ‚– s Ï•'
  ~'-cong-wk {Sâ‚ = Sâ‚} {Sâ‚‚} {s} {Ï•} {Ï•'} Ï•~Ï•' = mk-~' Î» sx x â†’
    x & wkâ‚– _ Ï•   â‰¡âŸ¨ &-wkâ‚–-wk Ï• x âŸ©
    wk _ (x & Ï•)  â‰¡âŸ¨ cong (wk _) (use-~' Ï•~Ï•' sx x) âŸ©
    wk _ (x & Ï•') â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï•' x) âŸ©
    x & wkâ‚– _ Ï•'  âˆ

  ~-cong-wk' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚– s Ï• ~ wkâ‚– s Ï•'
  ~-cong-wk' Ï•~Ï•' = ~'â†’~ (~'-cong-wk (~â†’~' Ï•~Ï•'))

  ~-cong-wk*' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {S} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚–* S Ï• ~ wkâ‚–* S Ï•'
  ~-cong-wk*' {S = []} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* [] Ï•  ~âŸ¨ wkâ‚–*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (wkâ‚–*-[] Ï•') âŸ©
    wkâ‚–* [] Ï•' ~âˆ
  ~-cong-wk*' {S = S â–· s} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* (S â–· s) Ï•    ~âŸ¨ wkâ‚–*-â–· S s Ï• âŸ©
    wkâ‚– s (wkâ‚–* S Ï•)  ~âŸ¨ ~-cong-wk' (~-cong-wk*' Ï•~Ï•') âŸ©
    wkâ‚– s (wkâ‚–* S Ï•') ~âŸ¨ ~-sym (wkâ‚–*-â–· S s Ï•') âŸ©
    wkâ‚–* (S â–· s) Ï•'   ~âˆ

  -- Lifting preserves Homotopy

  ~-cong-,â‚– : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} {s}
    {Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
    {x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] s} {x/t' : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s} â†’
    Ï• ~ Ï•' â†’
    x/t ~â‚œ x/t' â†’
    (Ï• ,â‚– x/t) ~ (Ï•' ,â‚– x/t')
  ~-cong-,â‚– {Sâ‚ = Sâ‚} {Sâ‚‚} {_} {Ï•} {Ï•'} {x/t} {x/t'} Ï•~Ï•' x/tâ‰¡x/t' = mk-~ Î» where
    sx x@(here refl) â†’
      `/id (x & (Ï• ,â‚– x/t))   â‰¡âŸ¨ cong (`/id) (&-,â‚–-here Ï• x/t) âŸ©
      `/id x/t                â‰¡âŸ¨ x/tâ‰¡x/t' âŸ©
      `/id x/t'               â‰¡âŸ¨ cong (`/id) (sym (&-,â‚–-here Ï•' x/t')) âŸ©
      `/id (x & (Ï•' ,â‚– x/t')) âˆ
    sx x@(there y) â†’
      `/id (x & (Ï• ,â‚– x/t))   â‰¡âŸ¨ cong (`/id) (&-,â‚–-there Ï• x/t y) âŸ©
      `/id (y & Ï•)            â‰¡âŸ¨ use-~ Ï•~Ï•' sx y âŸ©
      `/id (y & Ï•')           â‰¡âŸ¨ cong (`/id) (sym (&-,â‚–-there Ï•' x/t' y)) âŸ©
      `/id (x & (Ï•' ,â‚– x/t')) âˆ

  ~'-cong-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï• Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {x/t x/t' : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s} â†’
    Ï• ~' Ï•' â†’
    x/t â‰¡ x/t' â†’
    (Ï• ,â‚– x/t) ~' (Ï•' ,â‚– x/t')
  ~'-cong-,â‚– Ï•~Ï•' x/tâ‰¡x/t' = ~â†’~' (~-cong-,â‚– (~'â†’~ Ï•~Ï•') (cong (`/id) x/tâ‰¡x/t'))

  ~-cong-â†“ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï• : (Sâ‚ â–· s) â€“[ ğ•‚â‚ ]â†’ Sâ‚‚} {Ï•' : (Sâ‚ â–· s) â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†“) ~ (Ï•' â†“)
  ~-cong-â†“ â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï•} {Ï•'} Ï•~Ï•' = mk-~ Î» sx x â†’
    `/id (x & (Ï•  â†“))   â‰¡âŸ¨ cong (`/id) (&-â†“ Ï• x) âŸ©
    `/id (there x & Ï• ) â‰¡âŸ¨ use-~ Ï•~Ï•' sx (there x) âŸ©
    `/id (there x & Ï•') â‰¡âŸ¨ cong (`/id) (sym (&-â†“ Ï•' x)) âŸ©
    `/id (x & (Ï•' â†“))   âˆ

  ~-cong-âˆ¥ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Sâ‚â‚} {Sâ‚â‚‚} {Sâ‚‚}
      {Ï•â‚  : Sâ‚â‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚}
      {Ï•â‚' : Sâ‚â‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
      {Ï•â‚‚  : Sâ‚â‚‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚}
      {Ï•â‚‚' : Sâ‚â‚‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚}
    â†’ Ï•â‚ ~ Ï•â‚'
    â†’ Ï•â‚‚ ~ Ï•â‚‚'
    â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (Ï•â‚' âˆ¥ Ï•â‚‚')
  ~-cong-âˆ¥ {Sâ‚â‚ = Sâ‚â‚} {[]}      {Sâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    (Ï•â‚ âˆ¥ Ï•â‚‚)   ~âŸ¨ âˆ¥-[] Ï•â‚ Ï•â‚‚ âŸ©
    Ï•â‚          ~âŸ¨ Ï•â‚~Ï•â‚' âŸ©
    Ï•â‚'         ~âŸ¨ ~-sym (âˆ¥-[] Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ
  ~-cong-âˆ¥ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚ â–· s} {Sâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    let subâ‚ = subst (_â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) (sym (++-assoc ([] â–· s) Sâ‚â‚‚ Sâ‚â‚)) in
    let subâ‚‚ = subst (_â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) (sym (++-assoc ([] â–· s) Sâ‚â‚‚ Sâ‚â‚)) in
    (Ï•â‚ âˆ¥ Ï•â‚‚)                                      ~âŸ¨ âˆ¥-â–· Ï•â‚ Ï•â‚‚ âŸ©
    subâ‚ ((Ï•â‚  âˆ¥ (Ï•â‚‚  â†“)) ,â‚– (here refl & Ï•â‚‚)) ~âŸ¨ ~-cong-subst-Sâ‚ (sym (++-assoc ([] â–· s) Sâ‚â‚‚ Sâ‚â‚))
                                                      (~-cong-,â‚– (~-cong-âˆ¥ Ï•â‚~Ï•â‚' (~-cong-â†“ Ï•â‚‚~Ï•â‚‚'))
                                                                 (use-~ Ï•â‚‚~Ï•â‚‚' _ (here refl))) âŸ©
    subâ‚‚ ((Ï•â‚' âˆ¥ (Ï•â‚‚' â†“)) ,â‚– (here refl & Ï•â‚‚')) ~âŸ¨ ~-sym (âˆ¥-â–· Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ

  invert : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ Invert-Ï• Ï•
  invert Ï• = invert-Ï•'â†’Ï• (invert' Ï•)

  invert'-rec : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ Î£[ Ï•' âˆˆ Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚ ] Invert-Ï•'-Rec Ï• Ï•' Ã— Ï• ~ Ï•'
  invert'-rec Ï• with invert Ï•
  ... | Ï•~[]* Ï•~[] = []* , Ï•~[]* refl Ï•~[] , Ï•~[]
  ... | Ï•~,â‚– Ï•' x/t Ï•~Ï•',x/t with invert'-rec Ï•'
  ...   | Ï•'' , inv , Ï•'~Ï•'' = let Ï•~Ï•'',x/t = ~-trans Ï•~Ï•',x/t (~-cong-,â‚– Ï•'~Ï•'' refl) in
                               (Ï•'' ,â‚– x/t) , Ï•~,â‚– refl Ï•' x/t Ï•'' inv Ï•~Ï•',x/t Ï•~Ï•'',x/t , Ï•~Ï•'',x/t

  ~-cong-â†‘' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {s} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘ s) ~ (Ï•' â†‘ s)
  ~-cong-â†‘' {Sâ‚ = Sâ‚} {Sâ‚‚} {s} {Ï•} {Ï•'} Ï•~Ï•' =
    (Ï• â†‘ s)                         ~âŸ¨ â†‘-,â‚– Ï• s âŸ©
    (wkâ‚– _ Ï•  ,â‚– id/` (here refl))  ~âŸ¨ ~-cong-,â‚– (~-cong-wk' Ï•~Ï•') ~â‚“-refl âŸ©
    (wkâ‚– _ Ï•' ,â‚– id/` (here refl))  ~âŸ¨ ~-sym (â†‘-,â‚– Ï•' s) âŸ©
    (Ï•' â†‘ s)                        ~âˆ

  ~-cong-â†‘*' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} {S} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {Ï•' : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘* S) ~ (Ï•' â†‘* S)
  ~-cong-â†‘*' {S = []}    {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* [])  ~âŸ¨ â†‘*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (â†‘*-[] Ï•') âŸ©
    (Ï•' â†‘* []) ~âˆ
  ~-cong-â†‘*' {S = S â–· s} {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* (S â–· s))  ~âŸ¨ â†‘*-â–· S s Ï• âŸ©
    (Ï• â†‘* S) â†‘ s    ~âŸ¨ ~-cong-â†‘' (~-cong-â†‘*' Ï•~Ï•') âŸ©
    (Ï•' â†‘* S) â†‘ s   ~âŸ¨ ~-sym (â†‘*-â–· S s Ï•') âŸ©
    (Ï•' â†‘* (S â–· s)) ~âˆ

  dist-wk-,â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} s {s'} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s') â†’
    wkâ‚– s (Ï• ,â‚– x/t) ~' (wkâ‚– s Ï• ,â‚– Kit.wk ğ•‚ _ x/t)
  dist-wk-,â‚–' â¦ƒ ğ•‚ â¦„ s Ï• x/t = mk-~' Î» where
    sx (here refl) â†’
      here refl & (wkâ‚– s (Ï• ,â‚– x/t))    â‰¡âŸ¨ &-wkâ‚–-wk (Ï• ,â‚– x/t) (here refl) âŸ©
      wk s (here refl & (Ï• ,â‚– x/t))     â‰¡âŸ¨ cong (wk s) (&-,â‚–-here Ï• x/t) âŸ©
      wk s x/t                          â‰¡âŸ¨ sym (&-,â‚–-here (wkâ‚– s Ï•) (wk s x/t)) âŸ©
      here refl & (wkâ‚– s Ï• ,â‚– wk s x/t) âˆ
    sx (there x) â†’
      there x & (wkâ‚– _ (Ï• ,â‚– x/t))    â‰¡âŸ¨ &-wkâ‚–-wk (Ï• ,â‚– x/t) (there x) âŸ©
      wk _ (there x & (Ï• ,â‚– x/t))     â‰¡âŸ¨ cong (wk _) (&-,â‚–-there Ï• x/t x) âŸ©
      wk _ (x & Ï•)                    â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï• x) âŸ©
      x & (wkâ‚– _ Ï•)                   â‰¡âŸ¨ sym (&-,â‚–-there (wkâ‚– s Ï•) (wk _ x/t) x) âŸ©
      there x & (wkâ‚– _ Ï• ,â‚– wk _ x/t) âˆ

  dist-wk-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} s {s'} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s') â†’
    wkâ‚– s (Ï• ,â‚– x/t) ~ (wkâ‚– s Ï• ,â‚– Kit.wk ğ•‚ _ x/t)
  dist-wk-,â‚– s Ï• x/t = ~'â†’~ (dist-wk-,â‚–' s Ï• x/t)

  dist-wk*-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S {s'} (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s') â†’
    wkâ‚–* S (Ï• ,â‚– x/t) ~ (wkâ‚–* S Ï• ,â‚– wk* _ x/t)
  dist-wk*-,â‚– []      Ï• x/t =
    wkâ‚–* [] (Ï• ,â‚– x/t)       ~âŸ¨ wkâ‚–*-[] (Ï• ,â‚– x/t) âŸ©
    Ï• ,â‚– x/t                 ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-[] Ï•)) refl âŸ©
    (wkâ‚–* [] Ï• ,â‚– x/t)       ~âŸ¨âŸ©
    (wkâ‚–* [] Ï• ,â‚– wk* _ x/t) ~âˆ
  dist-wk*-,â‚– (S â–· s) Ï• x/t =
    wkâ‚–* (S â–· s) (Ï• ,â‚– x/t)                ~âŸ¨ wkâ‚–*-â–· S s (Ï• ,â‚– x/t) âŸ©
    wkâ‚– s (wkâ‚–* S (Ï• ,â‚– x/t))              ~âŸ¨ ~-cong-wk' (dist-wk*-,â‚– S Ï• x/t) âŸ©
    wkâ‚– s (wkâ‚–* S Ï• ,â‚– wk* _ x/t)          ~âŸ¨ dist-wk-,â‚– s (wkâ‚–* S Ï•) (wk* _ x/t) âŸ©
    (wkâ‚– s (wkâ‚–* S Ï•) ,â‚– wk s (wk* S x/t)) ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-â–· S s Ï•)) refl âŸ©
    (wkâ‚–* (S â–· s) Ï• ,â‚– wk* _ x/t)          ~âˆ

  open import Kitty.Util.SubstProperties

  wkâ‚–*-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S S' (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)  â†’
    let sub = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc S S' Sâ‚‚) in
    wkâ‚–* S (wkâ‚–* S' Ï•) ~ sub (wkâ‚–* (S' â–·â–· S) Ï•)
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} [] S' Ï• =
    let sub = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc [] S' Sâ‚‚) in
    wkâ‚–* [] (wkâ‚–* S' Ï•)     ~âŸ¨ wkâ‚–*-[] (wkâ‚–* S' Ï•) âŸ©
    wkâ‚–* S' Ï•               ~âŸ¨âŸ©
    sub (wkâ‚–* (S' â–·â–· []) Ï•) ~âˆ
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} (S â–· s) S' Ï• =
    let sub = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc (S â–· s) S' Sâ‚‚) in
    let sub' = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc S S' Sâ‚‚) in
    wkâ‚–* (S â–· s) (wkâ‚–* S' Ï•)        ~âŸ¨ wkâ‚–*-â–· S s (wkâ‚–* S' Ï•) âŸ©
    wkâ‚– s (wkâ‚–* S (wkâ‚–* S' Ï•))      ~âŸ¨ ~-cong-wk' (wkâ‚–*-â–·â–· S S' Ï•) âŸ©
    wkâ‚– s (sub' (wkâ‚–* (S' â–·â–· S) Ï•)) ~â‰¡âŸ¨ dist-subst' (_â–· s) (wkâ‚– s) (++-assoc S S' Sâ‚‚) (++-assoc (S â–· s) S' Sâ‚‚) (wkâ‚–* (S' â–·â–· S) Ï•) âŸ©
    sub (wkâ‚– s (wkâ‚–* (S' â–·â–· S) Ï•))  ~âŸ¨ ~-cong-subst-Sâ‚‚ (++-assoc (S â–· s) S' Sâ‚‚) (~-sym (wkâ‚–*-â–· (S' â–·â–· S) s Ï•)) âŸ©
    sub (wkâ‚–* (S' â–·â–· (S â–· s)) Ï•)    ~âˆ

  wkâ‚–-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚} {Sâ‚‚} S s (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)  â†’
    let sub = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc S ([] â–· s) Sâ‚‚) in
    wkâ‚–* S (wkâ‚– s Ï•) ~ sub (wkâ‚–* (([] â–· s) â–·â–· S) Ï•)
  wkâ‚–-â–·â–· â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} S s Ï• =
    let sub = subst (Sâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc S ([] â–· s) Sâ‚‚) in
    wkâ‚–* S (wkâ‚– s Ï•)             ~âŸ¨ ~-cong-wk*' (~-cong-wk' (~-sym (wkâ‚–*-[] Ï•))) âŸ©
    wkâ‚–* S (wkâ‚– s (wkâ‚–* [] Ï•))   ~âŸ¨ ~-cong-wk*' (~-sym (wkâ‚–*-â–· [] s Ï•)) âŸ©
    wkâ‚–* S (wkâ‚–* ([] â–· s) Ï•)     ~âŸ¨ wkâ‚–*-â–·â–· S ([] â–· s) Ï• âŸ©
    sub (wkâ‚–* (([] â–· s) â–·â–· S) Ï•) ~âˆ

  dist-wk-â†“' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ Sâ‚‚ s s'} â†’ (Ï• : (Sâ‚ â–· s') â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    wkâ‚– s (Ï• â†“) ~' (wkâ‚– s Ï• â†“)
  dist-wk-â†“' â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {s} {s'} Ï• = mk-~' Î» sx x â†’
    x & (wkâ‚– s (Ï• â†“))   â‰¡âŸ¨ &-wkâ‚–-wk (Ï• â†“) x âŸ©
    wk s (x & (Ï• â†“))    â‰¡âŸ¨ cong (wk s) (&-â†“ Ï• x) âŸ©
    wk s (there x & Ï•)  â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï• (there x)) âŸ©
    there x & (wkâ‚– s Ï•) â‰¡âŸ¨ sym (&-â†“ (wkâ‚– s Ï•) x) âŸ©
    x & (wkâ‚– s Ï• â†“)     âˆ

  dist-wk-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ Sâ‚‚ s s'} â†’ (Ï• : (Sâ‚ â–· s') â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    wkâ‚– s (Ï• â†“) ~ (wkâ‚– s Ï• â†“)
  dist-wk-â†“ Ï• = ~'â†’~ (dist-wk-â†“' Ï•)

  dist-wk*-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚ Sâ‚‚ S s'} â†’ (Ï• : (Sâ‚ â–· s') â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    wkâ‚–* S (Ï• â†“) ~ (wkâ‚–* S Ï• â†“)
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {S = []}    {s'} Ï• =
    wkâ‚–* [] (Ï• â†“)        ~âŸ¨ wkâ‚–*-[] (Ï• â†“) âŸ©
    (Ï• â†“)                ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-[] Ï•)) âŸ©
    (wkâ‚–* [] Ï• â†“)        ~âˆ
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Sâ‚} {Sâ‚‚} {S = S â–· s} {s'} Ï• =
    wkâ‚–* (S â–· s) (Ï• â†“)   ~âŸ¨ wkâ‚–*-â–· S s (Ï• â†“) âŸ©
    wkâ‚– s (wkâ‚–* S (Ï• â†“)) ~âŸ¨ ~-cong-wk' (dist-wk*-â†“ Ï•) âŸ©
    wkâ‚– s (wkâ‚–* S Ï• â†“)   ~âŸ¨ dist-wk-â†“ (wkâ‚–* S Ï•) âŸ©
    (wkâ‚– s (wkâ‚–* S Ï•) â†“) ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-â–· S s Ï•)) âŸ©
    (wkâ‚–* (S â–· s) Ï• â†“)   ~âˆ

  âˆ¥-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚â‚ Sâ‚â‚‚ Sâ‚‚} s â†’ (Ï•â‚ : Sâ‚â‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ (Ï•â‚‚ : Sâ‚â‚‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    wkâ‚– s (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚– s Ï•â‚ âˆ¥ wkâ‚– s Ï•â‚‚)
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {[]} {Sâ‚‚} s Ï•â‚ Ï•â‚‚ =
    wkâ‚– s (Ï•â‚ âˆ¥ Ï•â‚‚)        ~âŸ¨ ~-cong-wk' (âˆ¥-[] Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– s Ï•â‚               ~âŸ¨ ~-sym (âˆ¥-[] (wkâ‚– s Ï•â‚) (wkâ‚– s Ï•â‚‚)) âŸ©
    (wkâ‚– s Ï•â‚ âˆ¥ wkâ‚– s Ï•â‚‚)  ~âˆ
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚ â–· sâ‚‚} {Sâ‚‚} s Ï•â‚ Ï•â‚‚ =
    let sub = subst (_â€“[ ğ•‚ ]â†’ Sâ‚‚) (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚)) in
    let sub' = subst (_â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–· s)) (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚)) in
    wkâ‚– s (Ï•â‚ âˆ¥ Ï•â‚‚)                                              ~âŸ¨ ~-cong-wk' (âˆ¥-â–· Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– s (sub ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)))              ~â‰¡âŸ¨ dist-subst {F = _â€“[ ğ•‚ ]â†’ Sâ‚‚} {G = _â€“[ ğ•‚ ]â†’ (Sâ‚‚ â–· s)}
                                                                                    (wkâ‚– s) (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚))
                                                                                    ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)) âŸ©
    sub' (wkâ‚– s ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)))             ~âŸ¨ ~-cong-subst-Sâ‚ (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚))
                                                                        (dist-wk-,â‚– s (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) (here refl & Ï•â‚‚)) âŸ©
    sub' (wkâ‚– s (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– wk s (here refl & Ï•â‚‚))          ~â‰¡âŸ¨ cong (Î» â–  â†’ sub' (wkâ‚– s (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– â– ))
                                                                          (sym (&-wkâ‚–-wk Ï•â‚‚ (here refl))) âŸ© 
    sub' (wkâ‚– s (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– s Ï•â‚‚)))       ~âŸ¨ ~-cong-subst-Sâ‚ (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚))
                                                                        (~-cong-,â‚– (âˆ¥-wk s Ï•â‚ (Ï•â‚‚ â†“)) refl) âŸ©
    sub' ((wkâ‚– s Ï•â‚ âˆ¥ wkâ‚– s (Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– s Ï•â‚‚))) ~âŸ¨ ~-cong-subst-Sâ‚ (sym (++-assoc ([] â–· sâ‚‚) Sâ‚â‚‚ Sâ‚â‚))
                                                                        (~-cong-,â‚– (~-cong-âˆ¥ ~-refl (dist-wk-â†“ Ï•â‚‚)) refl) âŸ©
    sub' ((wkâ‚– s Ï•â‚ âˆ¥ (wkâ‚– s Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– s Ï•â‚‚))) ~âŸ¨ ~-sym (âˆ¥-â–· (wkâ‚– s Ï•â‚) (wkâ‚– s Ï•â‚‚)) âŸ©
    (wkâ‚– s Ï•â‚ âˆ¥ wkâ‚– s Ï•â‚‚) ~âˆ

  âˆ¥-wk* : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚â‚ Sâ‚â‚‚ Sâ‚‚} S â†’ (Ï•â‚ : Sâ‚â‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ (Ï•â‚‚ : Sâ‚â‚‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    wkâ‚–* S (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚–* S Ï•â‚ âˆ¥ wkâ‚–* S Ï•â‚‚)
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚} {Sâ‚‚} []      Ï•â‚ Ï•â‚‚ =
    wkâ‚–* [] (Ï•â‚ âˆ¥ Ï•â‚‚)         ~âŸ¨ wkâ‚–*-[] (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    (Ï•â‚ âˆ¥ Ï•â‚‚)                 ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-[] Ï•â‚) (wkâ‚–*-[] Ï•â‚‚)) âŸ©
    (wkâ‚–* [] Ï•â‚ âˆ¥ wkâ‚–* [] Ï•â‚‚) ~âˆ
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚} {Sâ‚‚} (S â–· s) Ï•â‚ Ï•â‚‚ =
    wkâ‚–* (S â–· s) (Ï•â‚ âˆ¥ Ï•â‚‚)                  ~âŸ¨ wkâ‚–*-â–· S s (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    wkâ‚– s (wkâ‚–* S (Ï•â‚ âˆ¥ Ï•â‚‚))                ~âŸ¨ ~-cong-wk' (âˆ¥-wk* S Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– s (wkâ‚–* S Ï•â‚ âˆ¥ wkâ‚–* S Ï•â‚‚)           ~âŸ¨ âˆ¥-wk s (wkâ‚–* S Ï•â‚) (wkâ‚–* S Ï•â‚‚) âŸ©
    (wkâ‚– s (wkâ‚–* S Ï•â‚) âˆ¥ wkâ‚– s (wkâ‚–* S Ï•â‚‚)) ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-â–· S s Ï•â‚) (wkâ‚–*-â–· S s Ï•â‚‚)) âŸ©
    (wkâ‚–* (S â–· s) Ï•â‚ âˆ¥ wkâ‚–* (S â–· s) Ï•â‚‚)     ~âˆ

  âˆ¥-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚â‚ Sâ‚â‚‚ Sâ‚‚ s} â†’ (Ï•â‚ : Sâ‚â‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ (Ï•â‚‚ : (Sâ‚â‚‚ â–· s) â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    (Ï•â‚ âˆ¥ Ï•â‚‚) â†“ ~ Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)
  âˆ¥-â†“ â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚} {Sâ‚‚} {s} Ï•â‚ Ï•â‚‚ = mk-~ Î» sx x â†’
    `/id (x & ((Ï•â‚ âˆ¥ Ï•â‚‚) â†“))                           â‰¡âŸ¨ cong `/id (&-â†“ (Ï•â‚ âˆ¥ Ï•â‚‚) x) âŸ©
    `/id (there x & (Ï•â‚ âˆ¥ Ï•â‚‚))                         â‰¡âŸ¨ use-~ (âˆ¥-â–· Ï•â‚ Ï•â‚‚) _ (there x) âŸ©
    `/id (there x & (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)) â‰¡âŸ¨ cong `/id (&-,â‚–-there (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) _ x) âŸ©
    `/id (x & Ï•â‚ âˆ¥ (Ï•â‚‚ â†“))                             âˆ

  &-âˆ¥-here : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Sâ‚â‚ Sâ‚â‚‚ Sâ‚‚ s} â†’ (Ï•â‚ : Sâ‚â‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’ (Ï•â‚‚ : (Sâ‚â‚‚ â–· s) â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    here refl & (Ï•â‚ âˆ¥ Ï•â‚‚) â‰¡ here refl & Ï•â‚‚
  &-âˆ¥-here â¦ƒ ğ•‚ â¦„ {Sâ‚â‚} {Sâ‚â‚‚} {Sâ‚‚} {s} Ï•â‚ Ï•â‚‚ =
    here refl & (Ï•â‚ âˆ¥ Ï•â‚‚)                         â‰¡âŸ¨ use-~-hom (âˆ¥-â–· Ï•â‚ Ï•â‚‚) _ (here refl) âŸ©
    here refl & (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚) â‰¡âŸ¨ &-,â‚–-here (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) (here refl & Ï•â‚‚) âŸ©
    here refl & Ï•â‚‚                                âˆ


  -- Identity


  -- idâ‚–' : S â€“â†’ (S' â–·â–· S )
  -- idâ‚–' _ x = id/` (âˆˆ-â–·â–·â‚— x)  where
  --   âˆˆ-â–·â–·â‚— : S âˆ‹ s â†’ (S' â–·â–· S) âˆ‹ s
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- idâ‚–'' : âˆ€ {S S' S''} â†’ S â€“â†’ (S' â–·â–· S â–·â–· S'')
  -- idâ‚–'' {S} {S'} {S''} _ x = wk* {S' = S''} _ (id/` (âˆˆ-â–·â–·â‚— x))  where
  --   âˆˆ-â–·â–·â‚— :  âˆ€ {S} {S'} â†’ S âˆ‹ s â†’ (S' â–·â–· S) âˆ‹ s
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- Lifted identity is identity

  idâ†‘~id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ s S â†’ id {S = S} â†‘ s ~ id {S = S â–· s}
  idâ†‘~id s S = mk-~ Î» where
    _ x@(here refl) â†’
      `/id (x & id {S = S} â†‘ s) â‰¡âŸ¨ cong `/id (&-â†‘-here id) âŸ©
      `/id (id/` (here refl))   â‰¡âŸ¨ cong `/id (sym (&-id x)) âŸ©
      `/id (x & id {S = S â–· s}) âˆ
    _ x@(there y) â†’
      `/id (x & id {S = S} â†‘ s)    â‰¡âŸ¨ cong `/id (&-â†‘-there id y) âŸ©
      `/id (wk _ (y & id {S = S})) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (wk _ â– )) (&-id y) âŸ©
      `/id (wk _ (id/` y))         â‰¡âŸ¨ cong `/id (wk-id/` _ y) âŸ©
      `/id (id/` x)                â‰¡âŸ¨ cong `/id (sym (&-id x)) âŸ©
      `/id (x & id {S = S â–· s})    âˆ

  idâ†‘*~id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ S' S â†’ id {S = S} â†‘* S' ~ id {S = S â–·â–· S'}
  idâ†‘*~id []       S = â†‘*-[] id
  idâ†‘*~id (S' â–· s) S =
    id â†‘* (S' â–· s) ~âŸ¨ â†‘*-â–· S' s id âŸ©
    id â†‘* S' â†‘ s   ~âŸ¨ ~-cong-â†‘' (idâ†‘*~id S' S) âŸ©
    id â†‘ s         ~âŸ¨ idâ†‘~id _ _ âŸ©
    id             ~âˆ

  -- Empty Substitution

  &-[]â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {s} (x : _ âˆ‹ s) â†’ x & []â‚– â‰¡ id/` x
  &-[]â‚– ()

  &-[]â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (Ï• : [] â€“[ ğ•‚ ]â†’ []) â†’ Ï• ~ []â‚–
  &-[]â‚–' Ï• = mk-~ Î» s ()

  -- -- Singleton renaming/substitution

  -- -- Singleton renaming/substitution for terms with 1 free variable.
  -- -- Allows the term to be substituted to have arbitrary free variables.
  -- -- This is useful for things like pattern inverting in combination with `_âˆ¥_`,
  -- -- where a inverting substitution needs to be built up piece by piece.
  -- â¦…_â¦†â‚€ : S âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ S
  -- â¦… v â¦†â‚€ = emptyâ‚– ,â‚– v

  -- -- â¦…_â¦†' : (S â–·â–· S') âˆ‹/âŠ¢ mâ†’[m/M] m â†’ (S â–· m â–·â–· S') â€“â†’ (S â–·â–· S')
  -- -- â¦… v â¦†' = idâ‚–'' âˆ¥ â¦… v â¦†â‚€ âˆ¥ idâ‚–''
  -- -- â¦… v â¦†' = {!!} âˆ¥ â¦… v â¦†â‚€ âˆ¥ {!!}
  -- -- -- â¦… v â¦†' = (idâ‚– âˆ¥ â¦… v â¦†â‚€) â†‘* _
