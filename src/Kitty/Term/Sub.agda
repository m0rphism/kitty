open import Kitty.Term.Modes

module Kitty.Term.Sub {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Data.List using (List; [])
open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Level using (Level; _âŠ”_; 0â„“)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Data.List.Relation.Unary.Any using (here; there)
open import Kitty.Term.Prelude
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Data.Sum using (injâ‚; injâ‚‚; _âŠ_)
open import Function using (_$_)

open Modes ğ•„
open Terms ğ•‹

open import Kitty.Term.Kit ğ•‹ using (Kit; _âˆ‹/âŠ¢[_]_)

open Kit â¦ƒ â€¦ â¦„ hiding (_,â‚–_; _â†‘_; _â†‘*_; _â€“â†’_; ~-cong-â†‘; ~-cong-â†‘*; _âˆ¥_; â¦…_â¦†; _â†“)

record Sub : Setâ‚ where
  field
    _â€“[_]â†’_ : List VarMode â†’ Kit â†’ List VarMode â†’ Set

    []â‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ [] â€“[ ğ•‚ ]â†’ []
    _,â‚–_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚
    wkâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    wkâ‚–* : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ)
    _â†‘_  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    _â†‘*_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ')
    id   : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµ} â†’ Âµ â€“[ ğ•‚ ]â†’ Âµ
    []*  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚‚} â†’ [] â€“[ ğ•‚ ]â†’ Âµâ‚‚
    _â†“   : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚
    _âˆ¥_  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â€“[ ğ•‚ ]â†’ Âµ)
    â¦…_â¦†  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµ m} â†’ Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“[ ğ•‚ ]â†’ Âµ

    apâ‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ (âˆ€ m â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m)

  -- Renaming/Substitution

  _â€“â†’_ : â¦ƒ ğ•‚ : Kit â¦„ â†’ List VarMode â†’ List VarMode â†’ Set
  _â€“â†’_ â¦ƒ ğ•‚ â¦„ Âµâ‚ Âµâ‚‚ = Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

  -- Extensional Equality

  _~_ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set
  Ï•â‚ ~ Ï•â‚‚ = âˆ€ m x â†’ apâ‚– Ï•â‚ m x â‰¡ apâ‚– Ï•â‚‚ m x

  ~-refl :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~ f
  ~-refl a b = refl

  ~-sym :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~ g
    â†’ g ~ f
  ~-sym f~g a b = sym (f~g a b)

  ~-trans :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} 
    â†’ f ~ g
    â†’ g ~ h
    â†’ f ~ h
  ~-trans f~g g~h a b = trans (f~g a b) (g~h a b)

  ~-cong-subst-Âµâ‚ :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚'} {Âµâ‚‚} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚ â‰¡ Âµâ‚')
    â†’ f ~ g
    â†’ subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) eq f ~ subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) eq g
  ~-cong-subst-Âµâ‚ refl f~g = f~g

  ~-cong-subst-Âµâ‚‚ :
    âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚‚'} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ f ~ g
    â†’ subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) eq f ~ subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) eq g
  ~-cong-subst-Âµâ‚‚ refl f~g = f~g

  module ~-Reasoning where

    infix  3 _~âˆ
    infixr 2 _~âŸ¨âŸ©_ step-~ step-~Ë˜ step-~â‰¡
    infix  1 begin~_

    private variable
      Âµâ‚ Âµâ‚‚ Âµâ‚ƒ : List VarMode
      â¦ƒ ğ•‚ â¦„ : Kit
      f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

    begin~_ :
      âˆ€ â¦ƒ ğ•‚ â¦„ {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
      â†’ f ~ g â†’ f ~ g
    begin~_ xâ‰¡y = xâ‰¡y

    _~âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚ â¦„ (f {g} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ f ~ g â†’ f ~ g
    _ ~âŸ¨âŸ© x~y = x~y

    step-~ :
      âˆ€ â¦ƒ ğ•‚ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~ h â†’ f ~ g â†’ f ~ h
    step-~ _ g~h f~g = ~-trans f~g g~h

    step-~Ë˜ :
      âˆ€ â¦ƒ ğ•‚ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~ h â†’ g ~ f â†’ f ~ h
    step-~Ë˜ _ g~h g~f = ~-trans (~-sym g~f) g~h

    step-~â‰¡ :
      âˆ€ â¦ƒ ğ•‚ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~ h â†’ f â‰¡ g â†’ f ~ h
    step-~â‰¡ f g~h fâ‰¡g = ~-trans (subst (f ~_) fâ‰¡g ~-refl ) g~h

    _~âˆ :
      âˆ€ â¦ƒ ğ•‚ â¦„ (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ f ~ f
    _~âˆ _ = ~-refl

    syntax step-~  f g~h f~g = f ~âŸ¨ f~g âŸ© g~h
    syntax step-~â‰¡  f g~h fâ‰¡g = f ~â‰¡âŸ¨ fâ‰¡g âŸ© g~h
    syntax step-~Ë˜ f g~h g~f = f ~Ë˜âŸ¨ g~f âŸ© g~h

  data Invert-Ï• â¦ƒ ğ•‚ â¦„ {Âµâ‚‚} : {Âµâ‚ : List VarMode} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set where
    Ï•~[]* : âˆ€ {Ï•} â†’
      Ï• ~ []* â†’
      Invert-Ï• Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚ Ï•} â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      Ï• ~ (Ï•' ,â‚– x/t) â†’
      Invert-Ï• Ï•

  data Invert-Ï•' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Set where
    Ï•~[]* :
      (eq : Âµâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•' Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚} â†’
      (eq : Âµâ‚ â‰¡ Âµâ‚' â–· mâ‚) â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Invert-Ï•' Ï•

  data Invert-Ï•'-Rec â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set where
    Ï•~[]* :
      (eq : Âµâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•'-Rec Ï• (sub []*)
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚} â†’
      (eq : Âµâ‚ â‰¡ Âµâ‚' â–· mâ‚) â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      (Ï•'' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      Invert-Ï•'-Rec Ï•' Ï•'' â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Ï• ~ sub (Ï•'' ,â‚– x/t) â†’
      Invert-Ï•'-Rec Ï• (sub (Ï•'' ,â‚– x/t))

  invert-Ï•'â†’Ï• : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  invert-Ï•'â†’Ï• (Ï•~[]* refl Ï•~) = Ï•~[]* Ï•~
  invert-Ï•'â†’Ï• (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

  -- requires dependent subst
  -- invert-Ï•'â†’Ï•' : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  -- invert-Ï•'â†’Ï•' {Âµâ‚} {Âµâ‚‚} {Ï•} (Ï•~[]* Âµâ‚â‰¡[] Ï•~) = {!substâ‚‚ (Î» â–  â– ' â†’ Invert-Ï• {Âµâ‚ = â– } â– ') ? ? {!Ï•~[]* Ï•~!}!}
  -- invert-Ï•'â†’Ï•' (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

record SubWithLaws : Setâ‚ where
  open Sub â¦ƒ â€¦ â¦„
  field
    â¦ƒ SubWithLaws-Sub â¦„ : Sub

    apâ‚–-,â‚–-here : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
                  â†’ apâ‚– (Ï• ,â‚– x/t) _ (here refl) â‰¡ x/t
    apâ‚–-,â‚–-there : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m) {m'} (x : Âµâ‚ âˆ‹ m')
                   â†’ apâ‚– (Ï• ,â‚– x/t) _ (there x) â‰¡ apâ‚– Ï• _ x

    apâ‚–-wkâ‚–-wk : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
                 â†’ apâ‚– (wkâ‚– m Ï•) _ x â‰¡ wk _ (apâ‚– Ï• _ x)

    apâ‚–-â†“ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
      â†’ apâ‚– (Ï• â†“) _ x â‰¡ apâ‚– Ï• _ (there x)

    wkâ‚–*-[] : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* [] Ï• ~ Ï•
    wkâ‚–*-â–· : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* (Âµ â–· m) Ï• ~ wkâ‚– m (wkâ‚–* Âµ Ï•)

    â†‘-,â‚–  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) m
      â†’ (Ï• â†‘ m) ~ (wkâ‚– m Ï• ,â‚– id/` _ (here refl))

    â†‘*-[]  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* []) ~ Ï•

    â†‘*-â–·  : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* (Âµ â–· m)) ~ ((Ï• â†‘* Âµ) â†‘ m)

    id-[] : âˆ€ â¦ƒ ğ•‚ : Kit â¦„
      â†’ id {[]} ~ []â‚–

    id-â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m}
      â†’ id {Âµ â–· m} ~ (id {Âµ} â†‘ m)

    []*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„
      â†’ []* {[]} ~ []â‚–

    []*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m}
      â†’ []* {Âµ â–· m} ~ wkâ‚– m ([]* {Âµ})

    â†“-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
      â†’ ((Ï• ,â‚– x/t) â†“) ~ Ï•

    âˆ¥-[] : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµ} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : [] â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ Ï•â‚

    âˆ¥-â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚ Âµâ‚‚ Âµ m} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : (Âµâ‚‚ â–· m) â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ subst (_â€“[ ğ•‚ ]â†’ Âµ) (sym (++-assoc ([] â–· m) Âµâ‚‚ Âµâ‚)) ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– Ï•â‚‚ _ (here refl))

    â¦…â¦†-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ m} (x/t : Âµ âˆ‹/âŠ¢ id/mâ†’M m) â†’
      â¦… x/t â¦† ~ (id ,â‚– x/t)

    invert' : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï•' Ï•

  open ~-Reasoning

  -- id-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ Âµ'}
  --   â†’ id {Âµ â–·â–· Âµ'} ~ (id {Âµ} â†‘* Âµ')
  -- id-â–·â–· {Âµ' = []} = ~-sym (â†‘*-[] id)
  -- id-â–·â–· {Âµ' = Âµ' â–· m} = ~-trans {!id-â–·â–·!} (~-trans {!id-â–·!} (~-sym (â†‘*-â–· Âµ' m id)))

  -- Weakening preserves Homotopy

  ~-cong-wk : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚– m Ï• ~ wkâ‚– m Ï•'
  ~-cong-wk {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x =
    apâ‚– (wkâ‚– _ Ï•) mx x  â‰¡âŸ¨ apâ‚–-wkâ‚–-wk Ï• x âŸ©
    wk _ (apâ‚– Ï• mx x)   â‰¡âŸ¨ cong (wk _) (Ï•~Ï•' mx x) âŸ©
    wk _ (apâ‚– Ï•' mx x)  â‰¡âŸ¨ sym (apâ‚–-wkâ‚–-wk Ï•' x)âŸ©
    apâ‚– (wkâ‚– _ Ï•') mx x âˆ

  ~-cong-wk* : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚–* Âµ Ï• ~ wkâ‚–* Âµ Ï•'
  ~-cong-wk* {Âµ = []} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* [] Ï•  ~âŸ¨ wkâ‚–*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (wkâ‚–*-[] Ï•') âŸ©
    wkâ‚–* [] Ï•' ~âˆ
  ~-cong-wk* {Âµ = Âµ â–· m} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* (Âµ â–· m) Ï•    ~âŸ¨ wkâ‚–*-â–· Âµ m Ï• âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•)  ~âŸ¨ ~-cong-wk (~-cong-wk* Ï•~Ï•') âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•') ~âŸ¨ ~-sym (wkâ‚–*-â–· Âµ m Ï•') âŸ©
    wkâ‚–* (Âµ â–· m) Ï•' ~âˆ

  -- Lifting preserves Homotopy

  ~-cong-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {x/t x/t' : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m} â†’
    Ï• ~ Ï•' â†’
    x/t â‰¡ x/t' â†’
    (Ï• ,â‚– x/t) ~ (Ï•' ,â‚– x/t')
  ~-cong-,â‚– {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {.mx} {Ï•} {Ï•'} {x/t} {x/t'} Ï•~Ï•' x/tâ‰¡x/t' mx (here refl) =
    apâ‚– (Ï• ,â‚– x/t) mx (here refl)  â‰¡âŸ¨ apâ‚–-,â‚–-here Ï• x/t âŸ©
    x/t                            â‰¡âŸ¨ x/tâ‰¡x/t' âŸ©
    x/t'                           â‰¡âŸ¨ sym (apâ‚–-,â‚–-here Ï•' x/t') âŸ©
    apâ‚– (Ï•' ,â‚– x/t') mx (here refl) âˆ
  ~-cong-,â‚– {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} {x/t} {x/t'} Ï•~Ï•' x/tâ‰¡x/t' mx (there x) =
    apâ‚– (Ï• ,â‚– x/t) mx (there x)  â‰¡âŸ¨ apâ‚–-,â‚–-there Ï• x/t x âŸ©
    apâ‚– Ï• mx x                   â‰¡âŸ¨ Ï•~Ï•' mx x âŸ©
    apâ‚– Ï•' mx x                  â‰¡âŸ¨ sym (apâ‚–-,â‚–-there Ï•' x/t' x) âŸ©
    apâ‚– (Ï•' ,â‚– x/t') mx (there x) âˆ

  ~-cong-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†“) ~ (Ï•' â†“)
  ~-cong-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x =
    apâ‚– (Ï•  â†“) mx x     â‰¡âŸ¨ apâ‚–-â†“ Ï• x âŸ©
    apâ‚– Ï•  mx (there x) â‰¡âŸ¨ Ï•~Ï•' mx (there x) âŸ©
    apâ‚– Ï•' mx (there x) â‰¡âŸ¨ sym (apâ‚–-â†“ Ï•' x) âŸ©
    apâ‚– (Ï•' â†“) mx x     âˆ

  ~-cong-âˆ¥ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} {Ï•â‚ Ï•â‚' : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•â‚‚ Ï•â‚‚' : Âµâ‚â‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï•â‚ ~ Ï•â‚' â†’
    Ï•â‚‚ ~ Ï•â‚‚' â†’
    (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (Ï•â‚' âˆ¥ Ï•â‚‚')
  ~-cong-âˆ¥ {Âµâ‚â‚ = Âµâ‚â‚} {[]}      {Âµâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    (Ï•â‚ âˆ¥ Ï•â‚‚)   ~âŸ¨ âˆ¥-[] Ï•â‚ Ï•â‚‚ âŸ©
    Ï•â‚          ~âŸ¨ Ï•â‚~Ï•â‚' âŸ©
    Ï•â‚'         ~âŸ¨ ~-sym (âˆ¥-[] Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ
  ~-cong-âˆ¥ â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚ â–· m} {Âµâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym (++-assoc ([] â–· m) Âµâ‚â‚‚ Âµâ‚â‚)) in
    (Ï•â‚ âˆ¥ Ï•â‚‚)                                      ~âŸ¨ âˆ¥-â–· Ï•â‚ Ï•â‚‚ âŸ©
    sub ((Ï•â‚  âˆ¥ (Ï•â‚‚  â†“)) ,â‚– apâ‚– Ï•â‚‚  _ (here refl)) ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· m) Âµâ‚â‚‚ Âµâ‚â‚))
                                                      (~-cong-,â‚– (~-cong-âˆ¥ Ï•â‚~Ï•â‚' (~-cong-â†“ Ï•â‚‚~Ï•â‚‚'))
                                                                 (Ï•â‚‚~Ï•â‚‚' _ (here refl))) âŸ©
    sub ((Ï•â‚' âˆ¥ (Ï•â‚‚' â†“)) ,â‚– apâ‚– Ï•â‚‚' _ (here refl)) ~âŸ¨ ~-sym (âˆ¥-â–· Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ

  invert : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï• Ï•
  invert Ï• = invert-Ï•'â†’Ï• (invert' Ï•)

  invert'-rec : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Î£[ Ï•' âˆˆ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ ] Invert-Ï•'-Rec Ï• Ï•' Ã— Ï• ~ Ï•'
  invert'-rec Ï• with invert Ï•
  ... | Ï•~[]* Ï•~[] = []* , Ï•~[]* refl Ï•~[] , Ï•~[]
  ... | Ï•~,â‚– Ï•' x/t Ï•~Ï•',x/t with invert'-rec Ï•'
  ...   | Ï•'' , inv , Ï•'~Ï•'' = let Ï•~Ï•'',x/t = ~-trans Ï•~Ï•',x/t (~-cong-,â‚– Ï•'~Ï•'' refl) in
                               (Ï•'' ,â‚– x/t) , Ï•~,â‚– refl Ï•' x/t Ï•'' inv Ï•~Ï•',x/t Ï•~Ï•'',x/t , Ï•~Ï•'',x/t

  ~-cong-â†‘ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘ m) ~ (Ï•' â†‘ m)
  ~-cong-â†‘ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' =
    (Ï• â†‘ m)                           ~âŸ¨ â†‘-,â‚– Ï• m âŸ©
    (wkâ‚– _ Ï• ,â‚– id/` _ (here refl))   ~âŸ¨ ~-cong-,â‚– (~-cong-wk Ï•~Ï•') refl âŸ©
    (wkâ‚– _ Ï•' ,â‚– id/` _ (here refl))  ~âŸ¨ ~-sym (â†‘-,â‚– Ï•' m) âŸ©
    (Ï•' â†‘ m)                          ~âˆ

  ~-cong-â†‘* : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• Ï•' : Âµâ‚ â€“â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘* Âµ) ~ (Ï•' â†‘* Âµ)
  ~-cong-â†‘* {Âµ = []}    {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* [])  ~âŸ¨ â†‘*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (â†‘*-[] Ï•') âŸ©
    (Ï•' â†‘* []) ~âˆ
  ~-cong-â†‘* {Âµ = Âµ â–· m} {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* (Âµ â–· m))  ~âŸ¨ â†‘*-â–· Âµ m Ï• âŸ©
    (Ï• â†‘* Âµ) â†‘ m    ~âŸ¨ ~-cong-â†‘ (~-cong-â†‘* Ï•~Ï•') âŸ©
    (Ï•' â†‘* Âµ) â†‘ m   ~âŸ¨ ~-sym (â†‘*-â–· Âµ m Ï•') âŸ©
    (Ï•' â†‘* (Âµ â–· m)) ~âˆ


  dist-wk-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} m {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m') â†’
    wkâ‚– m (Ï• ,â‚– x/t) ~ (wkâ‚– m Ï• ,â‚– Kit.wk ğ•‚ _ x/t)
  dist-wk-,â‚– â¦ƒ ğ•‚ â¦„ m Ï• x/t mx (here refl) =
    apâ‚– (wkâ‚– m (Ï• ,â‚– x/t)) _ (here refl)     â‰¡âŸ¨ apâ‚–-wkâ‚–-wk (Ï• ,â‚– x/t) (here refl) âŸ©
    wk _ (apâ‚– (Ï• ,â‚– x/t) _ (here refl))      â‰¡âŸ¨ cong (wk _) (apâ‚–-,â‚–-here Ï• x/t) âŸ©
    wk _ x/t                                 â‰¡âŸ¨ sym (apâ‚–-,â‚–-here (wkâ‚– m Ï•) (wk _ x/t)) âŸ©
    apâ‚– (wkâ‚– m Ï• ,â‚– wk _ x/t) _ (here refl) âˆ
  dist-wk-,â‚– m Ï• x/t mx (there x) =
    apâ‚– (wkâ‚– _ (Ï• ,â‚– x/t)) _ (there x)    â‰¡âŸ¨ apâ‚–-wkâ‚–-wk (Ï• ,â‚– x/t) (there x) âŸ©
    wk _ (apâ‚– (Ï• ,â‚– x/t) _ (there x))     â‰¡âŸ¨ cong (wk _) (apâ‚–-,â‚–-there Ï• x/t x) âŸ©
    wk _ (apâ‚– Ï• _ x)                      â‰¡âŸ¨ sym (apâ‚–-wkâ‚–-wk Ï• x) âŸ©
    apâ‚– (wkâ‚– _ Ï•) _ x                     â‰¡âŸ¨ sym (apâ‚–-,â‚–-there (wkâ‚– m Ï•) (wk _ x/t) x) âŸ©
    apâ‚– (wkâ‚– _ Ï• ,â‚– wk _ x/t) _ (there x) âˆ

  dist-wk*-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} Âµ {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m') â†’
    wkâ‚–* Âµ (Ï• ,â‚– x/t) ~ (wkâ‚–* Âµ Ï• ,â‚– wk* _ x/t)
  dist-wk*-,â‚– []      Ï• x/t =
    wkâ‚–* [] (Ï• ,â‚– x/t)       ~âŸ¨ wkâ‚–*-[] (Ï• ,â‚– x/t) âŸ©
    Ï• ,â‚– x/t                 ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-[] Ï•)) refl âŸ©
    (wkâ‚–* [] Ï• ,â‚– x/t)       ~âŸ¨âŸ©
    (wkâ‚–* [] Ï• ,â‚– wk* _ x/t) ~âˆ
  dist-wk*-,â‚– (Âµ â–· m) Ï• x/t =
    wkâ‚–* (Âµ â–· m) (Ï• ,â‚– x/t)                ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï• ,â‚– x/t) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï• ,â‚– x/t))              ~âŸ¨ ~-cong-wk (dist-wk*-,â‚– Âµ Ï• x/t) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï• ,â‚– wk* _ x/t)          ~âŸ¨ dist-wk-,â‚– m (wkâ‚–* Âµ Ï•) (wk* _ x/t) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•) ,â‚– wk _ (wk* _ x/t)) ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-â–· Âµ m Ï•)) refl âŸ©
    (wkâ‚–* (Âµ â–· m) Ï• ,â‚– wk* _ x/t)          ~âˆ

  open import Kitty.Util.SubstProperties

  wkâ‚–*-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} Âµ Âµ' (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)  â†’
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ Âµ' Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚–* Âµ' Ï•) ~ sub (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•)
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} [] Âµ' Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc [] Âµ' Âµâ‚‚) in
    wkâ‚–* [] (wkâ‚–* Âµ' Ï•)     ~âŸ¨ wkâ‚–*-[] (wkâ‚–* Âµ' Ï•) âŸ©
    wkâ‚–* Âµ' Ï•               ~âŸ¨âŸ©
    sub (wkâ‚–* (Âµ' â–·â–· []) Ï•) ~âˆ
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Âµ â–· m) Âµ' Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) in
    let sub' = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ Âµ' Âµâ‚‚) in
    wkâ‚–* (Âµ â–· m) (wkâ‚–* Âµ' Ï•)        ~âŸ¨ wkâ‚–*-â–· Âµ m (wkâ‚–* Âµ' Ï•) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (wkâ‚–* Âµ' Ï•))      ~âŸ¨ ~-cong-wk (wkâ‚–*-â–·â–· Âµ Âµ' Ï•) âŸ©
    wkâ‚– m (sub' (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•)) ~â‰¡âŸ¨ dist-subst' (_â–· m) (wkâ‚– m) (++-assoc Âµ Âµ' Âµâ‚‚) (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•) âŸ©
    sub (wkâ‚– m (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•))  ~âŸ¨ ~-cong-subst-Âµâ‚‚ (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) (~-sym (wkâ‚–*-â–· (Âµ' â–·â–· Âµ) m Ï•)) âŸ©
    sub (wkâ‚–* (Âµ' â–·â–· (Âµ â–· m)) Ï•)    ~âˆ

  wkâ‚–-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)  â†’
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ ([] â–· m) Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚– m Ï•) ~ sub (wkâ‚–* (([] â–· m) â–·â–· Âµ) Ï•)
  wkâ‚–-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ ([] â–· m) Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚– m Ï•)             ~âŸ¨ ~-cong-wk* (~-cong-wk (~-sym (wkâ‚–*-[] Ï•))) âŸ©
    wkâ‚–* Âµ (wkâ‚– m (wkâ‚–* [] Ï•))   ~âŸ¨ ~-cong-wk* (~-sym (wkâ‚–*-â–· [] m Ï•)) âŸ©
    wkâ‚–* Âµ (wkâ‚–* ([] â–· m) Ï•)     ~âŸ¨ wkâ‚–*-â–·â–· Âµ ([] â–· m) Ï• âŸ©
    sub (wkâ‚–* (([] â–· m) â–·â–· Âµ) Ï•) ~âˆ

  dist-wk-â†“ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ m m'} â†’ (Ï• : (Âµâ‚ â–· m') â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚– m (Ï• â†“) ~ (wkâ‚– m Ï• â†“)
  dist-wk-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} Ï• mx x =
    apâ‚– (wkâ‚– m (Ï• â†“)) mx x     â‰¡âŸ¨ apâ‚–-wkâ‚–-wk (Ï• â†“) x âŸ©
    wk _ (apâ‚– (Ï• â†“) mx x)      â‰¡âŸ¨ cong (wk _) (apâ‚–-â†“ Ï• x) âŸ©
    wk _ (apâ‚– Ï• mx (there x))  â‰¡âŸ¨ sym (apâ‚–-wkâ‚–-wk Ï• (there x)) âŸ©
    apâ‚– (wkâ‚– m Ï•) mx (there x) â‰¡âŸ¨ sym (apâ‚–-â†“ (wkâ‚– m Ï•) x) âŸ©
    apâ‚– (wkâ‚– m Ï• â†“) mx x       âˆ

  dist-wk*-â†“ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµ m'} â†’ (Ï• : (Âµâ‚ â–· m') â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚–* Âµ (Ï• â†“) ~ (wkâ‚–* Âµ Ï• â†“)
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ = []}    {m'} Ï• =
    wkâ‚–* [] (Ï• â†“) ~âŸ¨ wkâ‚–*-[] (Ï• â†“) âŸ©
    (Ï• â†“)         ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-[] Ï•)) âŸ©
    (wkâ‚–* [] Ï• â†“) ~âˆ
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ = Âµ â–· m} {m'} Ï• =
    wkâ‚–* (Âµ â–· m) (Ï• â†“) ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï• â†“) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï• â†“)) ~âŸ¨ ~-cong-wk (dist-wk*-â†“ Ï•) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï• â†“)   ~âŸ¨ dist-wk-â†“ (wkâ‚–* Âµ Ï•) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•) â†“) ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-â–· Âµ m Ï•)) âŸ©
    (wkâ‚–* (Âµ â–· m) Ï• â†“) ~âˆ

  âˆ¥-wk : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚} m â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : Âµâ‚â‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚)
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {[]} {Âµâ‚‚} m Ï•â‚ Ï•â‚‚ =
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚)        ~âŸ¨ ~-cong-wk (âˆ¥-[] Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m Ï•â‚               ~âŸ¨ ~-sym (âˆ¥-[] (wkâ‚– m Ï•â‚) (wkâ‚– m Ï•â‚‚)) âŸ©
    (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚)  ~âˆ
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚ â–· mâ‚‚} {Âµâ‚‚} m Ï•â‚ Ï•â‚‚ =
    let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚)) in
    let sub' = subst (_â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚)) in
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚)                                                  ~âŸ¨ ~-cong-wk (âˆ¥-â–· Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m (sub ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– Ï•â‚‚ _ (here refl)))              ~â‰¡âŸ¨ dist-subst {F = _â€“[ ğ•‚ ]â†’ Âµâ‚‚} {G = _â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)}
                                                                                    (wkâ‚– m) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                                    ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– Ï•â‚‚ _ (here refl)) âŸ©
    sub' (wkâ‚– m ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– Ï•â‚‚ _ (here refl)))             ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (dist-wk-,â‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) (apâ‚– Ï•â‚‚ _ (here refl))) âŸ©
    sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– wk _ (apâ‚– Ï•â‚‚ _ (here refl)))        ~â‰¡âŸ¨ cong (Î» â–  â†’ sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– â– ))
                                                                         (sym (apâ‚–-wkâ‚–-wk Ï•â‚‚ (here refl))) âŸ© 
    sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– apâ‚– (wkâ‚– m Ï•â‚‚) _ (here refl))       ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (~-cong-,â‚– (âˆ¥-wk m Ï•â‚ (Ï•â‚‚ â†“)) refl) âŸ©
    sub' ((wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m (Ï•â‚‚ â†“)) ,â‚– apâ‚– (wkâ‚– m Ï•â‚‚) _ (here refl)) ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (~-cong-,â‚– (~-cong-âˆ¥ ~-refl (dist-wk-â†“ Ï•â‚‚)) refl) âŸ©
    sub' ((wkâ‚– m Ï•â‚ âˆ¥ (wkâ‚– m Ï•â‚‚ â†“)) ,â‚– apâ‚– (wkâ‚– m Ï•â‚‚) _ (here refl)) ~âŸ¨ ~-sym (âˆ¥-â–· (wkâ‚– m Ï•â‚) (wkâ‚– m Ï•â‚‚)) âŸ©
    (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚) ~âˆ

  âˆ¥-wk* : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚} Âµ â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : Âµâ‚â‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚–* Âµ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚–* Âµ Ï•â‚ âˆ¥ wkâ‚–* Âµ Ï•â‚‚)
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} []      Ï•â‚ Ï•â‚‚ =
    wkâ‚–* [] (Ï•â‚ âˆ¥ Ï•â‚‚)         ~âŸ¨ wkâ‚–*-[] (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    (Ï•â‚ âˆ¥ Ï•â‚‚)                 ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-[] Ï•â‚) (wkâ‚–*-[] Ï•â‚‚)) âŸ©
    (wkâ‚–* [] Ï•â‚ âˆ¥ wkâ‚–* [] Ï•â‚‚) ~âˆ
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} (Âµ â–· m) Ï•â‚ Ï•â‚‚ =
    wkâ‚–* (Âµ â–· m) (Ï•â‚ âˆ¥ Ï•â‚‚)                  ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï•â‚ âˆ¥ Ï•â‚‚))                ~âŸ¨ ~-cong-wk (âˆ¥-wk* Âµ Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•â‚ âˆ¥ wkâ‚–* Âµ Ï•â‚‚)           ~âŸ¨ âˆ¥-wk m (wkâ‚–* Âµ Ï•â‚) (wkâ‚–* Âµ Ï•â‚‚) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•â‚) âˆ¥ wkâ‚– m (wkâ‚–* Âµ Ï•â‚‚)) ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-â–· Âµ m Ï•â‚) (wkâ‚–*-â–· Âµ m Ï•â‚‚)) âŸ©
    (wkâ‚–* (Âµ â–· m) Ï•â‚ âˆ¥ wkâ‚–* (Âµ â–· m) Ï•â‚‚)     ~âˆ

  -- Identity


  -- idâ‚–' : Âµ â€“â†’ (Âµ' â–·â–· Âµ )
  -- idâ‚–' _ x = id/` _ (âˆˆ-â–·â–·â‚— x)  where
  --   âˆˆ-â–·â–·â‚— : Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- idâ‚–'' : âˆ€ {Âµ Âµ' Âµ''} â†’ Âµ â€“â†’ (Âµ' â–·â–· Âµ â–·â–· Âµ'')
  -- idâ‚–'' {Âµ} {Âµ'} {Âµ''} _ x = wk* {Âµ' = Âµ''} _ (id/` _ (âˆˆ-â–·â–·â‚— x))  where
  --   âˆˆ-â–·â–·â‚— :  âˆ€ {Âµ} {Âµ'} â†’ Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- Lifted identity is identity

  -- TODO: However now this holds definitionally...

  -- idâ†‘~id : âˆ€ m Âµ â†’ idâ‚– {Âµ = Âµ} â†‘ m ~ idâ‚– {Âµ = Âµ â–· m}
  -- idâ†‘~id m Âµ _ (here _)  = refl
  -- idâ†‘~id m Âµ _ (there x) = wk-id/` m x

  -- idâ†‘*~id : âˆ€ Âµ' Âµ â†’ idâ‚– {Âµ = Âµ} â†‘* Âµ' ~ idâ‚– {Âµ = Âµ â–·â–· Âµ'}
  -- idâ†‘*~id []       Âµ = ~-refl
  -- idâ†‘*~id (Âµ' â–· m) Âµ =
  --   idâ‚– â†‘* Âµ' â†‘ m  ~âŸ¨ ~-cong-â†‘ (idâ†‘*~id Âµ' Âµ) âŸ©
  --   idâ‚– â†‘ m        ~âŸ¨ idâ†‘~id _ _ âŸ©
  --   idâ‚–            ~âˆ

  -- Empty Substitution

  apâ‚–-[]â‚– : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {m} x â†’ apâ‚– []â‚– m x â‰¡ id/` m x
  apâ‚–-[]â‚– ()

  apâ‚–-[]â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ (Ï• : [] â€“[ ğ•‚ ]â†’ []) â†’ Ï• ~ []â‚–
  apâ‚–-[]â‚–' Ï• m ()

  -- -- Singleton renaming/substitution

  -- -- Singleton renaming/substitution for terms with 1 free variable.
  -- -- Allows the term to be substituted to have arbitrary free variables.
  -- -- This is useful for things like pattern inverting in combination with `_âˆ¥_`,
  -- -- where a inverting substitution needs to be built up piece by piece.
  -- â¦…_â¦†â‚€ : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
  -- â¦… v â¦†â‚€ = emptyâ‚– ,â‚– v

  -- -- â¦…_â¦†' : (Âµ â–·â–· Âµ') âˆ‹/âŠ¢ mâ†’[m/M] m â†’ (Âµ â–· m â–·â–· Âµ') â€“â†’ (Âµ â–·â–· Âµ')
  -- -- â¦… v â¦†' = idâ‚–'' âˆ¥ â¦… v â¦†â‚€ âˆ¥ idâ‚–''
  -- -- â¦… v â¦†' = {!!} âˆ¥ â¦… v â¦†â‚€ âˆ¥ {!!}
  -- -- -- â¦… v â¦†' = (idâ‚– âˆ¥ â¦… v â¦†â‚€) â†‘* _
