open import Kitty.Term.Modes

module Kitty.Term.Sub {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Level renaming (suc to lsuc)
open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open Modes ğ•„
open Terms ğ•‹
open Kit â¦ƒ â€¦ â¦„
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„

private variable
  KitMode KitModeâ‚ KitModeâ‚‚ : Set
  _âˆ‹/âŠ¢_ _âˆ‹/âŠ¢â‚_ _âˆ‹/âŠ¢â‚‚_ _âˆ‹/âŠ¢â‚ƒ_ : List VarMode â†’ KitMode â†’ Set

record Sub â„“ : Set (lsuc â„“) where
  infixl  12  _,â‚–_
  infixl  11  _â†‘_  _â†‘*_
  infixl  9  _âˆ¥_
  infixl  8  _&_
  infix   4  _~_  _~'_

  field
    _â€“[_]â†’_ : List VarMode â†’ Kit _âˆ‹/âŠ¢_ â†’ List VarMode â†’ Set â„“

    []â‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ â†’ [] â€“[ ğ•‚ ]â†’ []
    _,â‚–_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚
    wkâ‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    wkâ‚–* : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ)
    _â†‘_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ m â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)
    _â†‘*_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–·â–· Âµ')
    id   : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ} â†’ Âµ â€“[ ğ•‚ ]â†’ Âµ
    []*  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚‚} â†’ [] â€“[ ğ•‚ ]â†’ Âµâ‚‚
    _â†“   : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚
    -- TODO: we might want this also to be Kit-heterogenous, to allow for talking about
    -- parallel compositions of two unknown, potentially different Kits.
    _âˆ¥_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â€“[ ğ•‚ ]â†’ Âµ)
    â¦…_â¦†  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m} â†’ Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ (Âµ â–· m) â€“[ ğ•‚ ]â†’ Âµ
    -- Singleton renaming/substitution for terms with 1 free variable.
    -- Allows the term to be substituted to have arbitrary free variables.
    -- This is useful for things like pattern matching in combination with `_âˆ¥_`,
    -- where a matching substitution needs to be built up piece by piece.
    â¦…_â¦†â‚€ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m} â†’ Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“[ ğ•‚ ]â†’ Âµ

    _&_  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ âˆ‹ m â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M m

    Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚

  -- Renaming/Substitution

  _â€“â†’_ : â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ â†’ List VarMode â†’ List VarMode â†’ Set â„“
  _â€“â†’_ â¦ƒ ğ•‚ â¦„ Âµâ‚ Âµâ‚‚ = Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

  -- Extensional Equality

  -- Unused, because when we use it, we get horrible, horrible names....
  module Heterogeneous-~
      {â„“}
      (P : âˆ€ {M} {_âˆ‹/âŠ¢_ : Scoped M} (ğ•‚ : Kit _âˆ‹/âŠ¢_) â†’ Set â„“)
      (R : âˆ€ {Mâ‚ Mâ‚‚} {_âˆ‹/âŠ¢â‚_ : Scoped Mâ‚} {_âˆ‹/âŠ¢â‚‚_ : Scoped Mâ‚‚} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
             (Ï•â‚ : P ğ•‚â‚) (Ï•â‚‚ : P ğ•‚â‚‚) â†’ Set)
      (R-refl : âˆ€ {M} {_âˆ‹/âŠ¢_ : Scoped M} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Ï• : P ğ•‚} â†’ R Ï• Ï•)
      (R-sym  : âˆ€ {Mâ‚ Mâ‚‚} {_âˆ‹/âŠ¢â‚_ : Scoped Mâ‚} {_âˆ‹/âŠ¢â‚‚_ : Scoped Mâ‚‚} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
                  {Ï•â‚ : P ğ•‚â‚} {Ï•â‚‚ : P ğ•‚â‚‚}
                â†’ R Ï•â‚ Ï•â‚‚ â†’ R Ï•â‚‚ Ï•â‚)
      (R-trans : âˆ€ {Mâ‚ Mâ‚‚ Mâ‚ƒ} {_âˆ‹/âŠ¢â‚_ : Scoped Mâ‚} {_âˆ‹/âŠ¢â‚‚_ : Scoped Mâ‚‚} {_âˆ‹/âŠ¢â‚ƒ_ : Scoped Mâ‚ƒ}
                   â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„
                   {Ï•â‚ : P ğ•‚â‚} {Ï•â‚‚ : P ğ•‚â‚‚} {Ï•â‚ƒ : P ğ•‚â‚ƒ}
                â†’ R Ï•â‚ Ï•â‚‚ â†’ R Ï•â‚‚ Ï•â‚ƒ â†’ R Ï•â‚ Ï•â‚ƒ)
      where

    record _~_ {Mâ‚ Mâ‚‚} {_âˆ‹/âŠ¢â‚_ : Scoped Mâ‚} {_âˆ‹/âŠ¢â‚‚_ : Scoped Mâ‚‚} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (Ï•â‚ : P ğ•‚â‚) (Ï•â‚‚ : P ğ•‚â‚‚) : Set where
      constructor mk-~
      field
        use-~ : R Ï•â‚ Ï•â‚‚
    open _~_

    ~-refl :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {f : P ğ•‚}
      â†’ f ~ f
    ~-refl = mk-~ R-refl

    ~-sym :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚}
      â†’ f ~ g
      â†’ g ~ f
    ~-sym f~g = mk-~ (R-sym (use-~ f~g))

    ~-trans :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ f ~ g
      â†’ g ~ h
      â†’ f ~ h
    ~-trans f~g g~h = mk-~ (R-trans (use-~ f~g) (use-~ g~h))

    infix  3 _~âˆ
    infixr 2 _~âŸ¨âŸ©_ step-~ step-~Ë˜ step-~â‰¡
    infix  1 begin~_

    private variable
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : P ğ•‚

    begin~_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : P ğ•‚â‚} {g : P ğ•‚â‚‚}
      â†’ f ~ g â†’ f ~ g
    begin~_ xâ‰¡y = xâ‰¡y

    _~âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚}
      â†’ f ~ g â†’ f ~ g
    _ ~âŸ¨âŸ© x~y = x~y

    step-~ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ g ~ h â†’ f ~ g â†’ f ~ h
    step-~ f g~h f~g = ~-trans f~g g~h

    step-~Ë˜ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚‚} {h : P ğ•‚â‚ƒ}
      â†’ g ~ h â†’ g ~ f â†’ f ~ h
    step-~Ë˜ _ g~h g~f = ~-trans (~-sym g~f) g~h

    step-~â‰¡ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : P ğ•‚â‚) {g : P ğ•‚â‚} {h : P ğ•‚â‚‚}
      â†’ g ~ h â†’ f â‰¡ g â†’ f ~ h
    step-~â‰¡ f g~h fâ‰¡g = ~-trans (subst (f ~_) fâ‰¡g ~-refl ) g~h

    _~âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : P ğ•‚)
      â†’ f ~ f
    _~âˆ _ = ~-refl

    syntax step-~  f g~h f~g = f ~âŸ¨ f~g âŸ© g~h
    syntax step-~â‰¡  f g~h fâ‰¡g = f ~â‰¡âŸ¨ fâ‰¡g âŸ© g~h
    syntax step-~Ë˜ f g~h g~f = f ~Ë˜âŸ¨ g~f âŸ© g~h

  infix  4  _~â‚œ_

  _~â‚œ_ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµ} {m} â†’ Âµ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m â†’ Âµ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m â†’ Set
  _~â‚œ_ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Âµ} {m} x/tâ‚ x/tâ‚‚ =
    `/id x/tâ‚ â‰¡ `/id x/tâ‚‚
  -- _~â‚œ_ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Âµ} {m} x/tâ‚ x/tâ‚‚ =
  --   let eq = mâ†’M/id (id/mâ†’M â¦ƒ ğ•‚â‚ â¦„ m) â‰¡âŸ¨ id/mâ†’M/id m âŸ©
  --            mâ†’M m                    â‰¡âŸ¨ sym (id/mâ†’M/id m) âŸ©
  --            mâ†’M/id (id/mâ†’M â¦ƒ ğ•‚â‚‚ â¦„ m) âˆ
  --   in x/tâ‚ ~â‚œ[ eq ] x/tâ‚‚

  -- module Test where
  --   module Terms-~ {Âµ} {m} where
  --     open Heterogeneous-~ (Î» ğ•‚ â†’ Âµ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ m) _~â‚œ_ refl sym trans public
  --       renaming (_~_ to _~áµ—_)
  --   open Terms-~
  --   test : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ} {m} (Ï• : Âµ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M â¦ƒ ğ•‚ â¦„ m) â†’ Ï• ~áµ— Ï•
  --   test Ï• =
  --     Ï• ~âŸ¨ {!!} âŸ©
  --     Ï• ~âˆ


  -- Helps with inferring Ï•â‚ and Ï•â‚‚ from implicits
  record _~_ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) : Set where
    constructor mk-~
    field
      use-~ : âˆ€ m (x : _ âˆ‹ m) â†’ x & Ï•â‚ ~â‚œ x & Ï•â‚‚
  open _~_ public

  -- Helps with inferring Ï•â‚ and Ï•â‚‚ from implicits
  record _~'_ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Set where
    constructor mk-~'
    field
      use-~' : âˆ€ m (x : _ âˆ‹ m) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚
  open _~'_ public

  -- _~_ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚ â†’ Set
  -- Ï•â‚ ~ Ï•â‚‚ = âˆ€ m (x : _ âˆ‹ m) â†’ x & Ï•â‚ ~â‚œ x & Ï•â‚‚
  -- -- Ï•â‚ ~ Ï•â‚‚ = âˆ€ m x â†’ `/id (& Ï•â‚ m x) â‰¡ `/id (& Ï•â‚‚ m x)

  -- _~'_ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set
  -- Ï•â‚ ~' Ï•â‚‚ = âˆ€ m (x : _ âˆ‹ m) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚

  ~â†’~' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï•â‚ Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
         â†’ Ï•â‚ ~ Ï•â‚‚
         â†’ Ï•â‚ ~' Ï•â‚‚
  ~â†’~' Ï•â‚~Ï•â‚‚ = mk-~' (Î» m x â†’ `/id-injective (use-~ Ï•â‚~Ï•â‚‚ m x))

  ~'â†’~ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï•â‚ Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
         â†’ Ï•â‚ ~' Ï•â‚‚
         â†’ Ï•â‚ ~ Ï•â‚‚
  ~'â†’~ Ï•â‚~'Ï•â‚‚ = mk-~ (Î» m x â†’ cong `/id (use-~' Ï•â‚~'Ï•â‚‚ m x))

  use-~-hom :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï•â‚ Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ Ï•â‚ ~ Ï•â‚‚
    â†’ (âˆ€ m (x : _ âˆ‹ m) â†’ x & Ï•â‚ â‰¡ x & Ï•â‚‚)
  use-~-hom Ï•â‚~Ï•â‚‚ = use-~' (~â†’~' Ï•â‚~Ï•â‚‚)

  ~â‚œ-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ} {m} {x/t : Âµ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m}
    â†’ x/t ~â‚œ x/t
  ~â‚œ-refl = cong (`/id) refl

  ~â‚“-refl :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµ} {m} {x : Âµ âˆ‹ m}
    â†’ id/` â¦ƒ ğ•‚â‚ â¦„ x ~â‚œ id/` â¦ƒ ğ•‚â‚‚ â¦„ x
  ~â‚“-refl â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {x = x} =
    `/id â¦ƒ ğ•‚â‚ â¦„ (id/` x) â‰¡âŸ¨ id/`/id â¦ƒ ğ•‚â‚ â¦„ x âŸ©
    ` x                  â‰¡âŸ¨ sym (id/`/id â¦ƒ ğ•‚â‚‚ â¦„ x) âŸ©
    `/id â¦ƒ ğ•‚â‚‚ â¦„ (id/` x) âˆ

  ~-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~ f
  ~-refl = mk-~ (Î» a b â†’ refl)

  ~-sym :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
    â†’ f ~ g
    â†’ g ~ f
  ~-sym f~g = mk-~ (Î» a b â†’ sym (use-~ f~g a b))

  ~-trans :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} {h : Âµâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Âµâ‚‚}
    â†’ f ~ g
    â†’ g ~ h
    â†’ f ~ h
  ~-trans f~g g~h = mk-~ (Î» a b â†’ trans (use-~ f~g a b) (use-~ g~h a b))

  ~-cong-subst-Âµâ‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚'} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚ â‰¡ Âµâ‚')
    â†’ f ~ g
    â†’ subst (_â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) eq f ~ subst (_â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) eq g
  ~-cong-subst-Âµâ‚ refl f~g = f~g

  ~-cong-subst-Âµâ‚‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚‚'} {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ f ~ g
    â†’ subst (Âµâ‚ â€“[ ğ•‚â‚ ]â†’_) eq f ~ subst (Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’_) eq g
  ~-cong-subst-Âµâ‚‚ refl f~g = f~g

  ~-cong-substâ‚‚ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚'} {Âµâ‚‚} {Âµâ‚‚'} {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} (eqâ‚ : Âµâ‚ â‰¡ Âµâ‚') (eqâ‚‚ : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ f ~ g
    â†’ substâ‚‚ (_â€“[ ğ•‚â‚ ]â†’_) eqâ‚ eqâ‚‚ f ~ substâ‚‚ (_â€“[ ğ•‚â‚‚ ]â†’_) eqâ‚ eqâ‚‚ g
  ~-cong-substâ‚‚ refl refl f~g = f~g

  module ~-Reasoning where

    infix  3 _~âˆ
    infixr 2 _~âŸ¨âŸ©_ step-~ step-~Ë˜ step-~â‰¡
    infix  1 begin~_

    private variable
      Âµâ‚ Âµâ‚‚ Âµâ‚ƒ : List VarMode
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

    begin~_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
      â†’ f ~ g â†’ f ~ g
    begin~_ xâ‰¡y = xâ‰¡y

    _~âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
      â†’ f ~ g â†’ f ~ g
    _ ~âŸ¨âŸ© x~y = x~y

    step-~ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} {h : Âµâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Âµâ‚‚}
      â†’ g ~ h â†’ f ~ g â†’ f ~ h
    step-~ f g~h f~g = ~-trans f~g g~h

    step-~Ë˜ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„ (f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) {g : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} {h : Âµâ‚ â€“[ ğ•‚â‚ƒ ]â†’ Âµâ‚‚}
      â†’ g ~ h â†’ g ~ f â†’ f ~ h
    step-~Ë˜ _ g~h g~f = ~-trans (~-sym g~f) g~h

    step-~â‰¡ :
      âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ (f : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) {g : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {h : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
      â†’ g ~ h â†’ f â‰¡ g â†’ f ~ h
    step-~â‰¡ f g~h fâ‰¡g = ~-trans (subst (f ~_) fâ‰¡g ~-refl ) g~h

    _~âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ f ~ f
    _~âˆ _ = ~-refl

    syntax step-~  f g~h f~g = f ~âŸ¨ f~g âŸ© g~h
    syntax step-~â‰¡  f g~h fâ‰¡g = f ~â‰¡âŸ¨ fâ‰¡g âŸ© g~h
    syntax step-~Ë˜ f g~h g~f = f ~Ë˜âŸ¨ g~f âŸ© g~h

  ~'-refl :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~' f
  ~'-refl = mk-~' Î» a b â†’ refl

  ~'-sym :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
    â†’ f ~' g
    â†’ g ~' f
  ~'-sym f~'g = mk-~' Î» a b â†’ sym (use-~' f~'g a b)

  ~'-trans :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} 
    â†’ f ~' g
    â†’ g ~' h
    â†’ f ~' h
  ~'-trans f~'g g~'h = mk-~' Î» a b â†’ trans (use-~' f~'g a b) (use-~' g~'h a b)

  ~'-cong-subst-Âµâ‚ :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚'} {Âµâ‚‚} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚ â‰¡ Âµâ‚')
    â†’ f ~' g
    â†’ subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) eq f ~' subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) eq g
  ~'-cong-subst-Âµâ‚ refl f~'g = f~'g

  ~'-cong-subst-Âµâ‚‚ :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚‚'} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} (eq : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ f ~' g
    â†’ subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) eq f ~' subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) eq g
  ~'-cong-subst-Âµâ‚‚ refl f~'g = f~'g

  module ~'-Reasoning where

    infix  3 _~'âˆ
    infixr 2 _~'âŸ¨âŸ©_ step-~' step-~'Ë˜ step-~'â‰¡
    infix  1 begin~'_

    private variable
      Âµâ‚ Âµâ‚‚ Âµâ‚ƒ : List VarMode
      â¦ƒ ğ•‚ â¦„ : Kit _âˆ‹/âŠ¢_
      f g h : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚

    begin~'_ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
      â†’ f ~' g â†’ f ~' g
    begin~'_ xâ‰¡y = xâ‰¡y

    _~'âŸ¨âŸ©_ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ f ~' g â†’ f ~' g
    _ ~'âŸ¨âŸ© x~'y = x~'y

    step-~' :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~' h â†’ f ~' g â†’ f ~' h
    step-~' _ g~'h f~'g = ~'-trans f~'g g~'h

    step-~'Ë˜ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~' h â†’ g ~' f â†’ f ~' h
    step-~'Ë˜ _ g~'h g~'f = ~'-trans (~'-sym g~'f) g~'h

    step-~'â‰¡ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f {g h} : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ g ~' h â†’ f â‰¡ g â†’ f ~' h
    step-~'â‰¡ f g~'h fâ‰¡g = ~'-trans (subst (f ~'_) fâ‰¡g ~'-refl ) g~'h

    _~'âˆ :
      âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ f ~' f
    _~'âˆ _ = ~'-refl

    syntax step-~'  f g~'h f~'g = f ~'âŸ¨ f~'g âŸ© g~'h
    syntax step-~'â‰¡  f g~'h fâ‰¡g = f ~'â‰¡âŸ¨ fâ‰¡g âŸ© g~'h
    syntax step-~'Ë˜ f g~'h g~'f = f ~'Ë˜âŸ¨ g~'f âŸ© g~'h

  data Invert-Ï• â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚‚} : {Âµâ‚ : List VarMode} â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set â„“ where
    Ï•~[]* : âˆ€ {Ï•} â†’
      Ï• ~ []* â†’
      Invert-Ï• Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚ Ï•} â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      Ï• ~ (Ï•' ,â‚– x/t) â†’
      Invert-Ï• Ï•

  data Invert-Ï•' â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Set â„“ where
    Ï•~[]* :
      (eq : Âµâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•' Ï•
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚} â†’
      (eq : Âµâ‚ â‰¡ Âµâ‚' â–· mâ‚) â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Invert-Ï•' Ï•

  data Invert-Ï•'-Rec â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Set â„“ where
    Ï•~[]* :
      (eq : Âµâ‚ â‰¡ []) â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub []* â†’
      Invert-Ï•'-Rec Ï• (sub []*)
    Ï•~,â‚– : âˆ€ {Âµâ‚' mâ‚} â†’
      (eq : Âµâ‚ â‰¡ Âµâ‚' â–· mâ‚) â†’
      (Ï•' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      (x/t : Âµâ‚‚ âˆ‹/âŠ¢ id/mâ†’M mâ‚) â†’
      (Ï•'' : Âµâ‚' â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
      Invert-Ï•'-Rec Ï•' Ï•'' â†’
      let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym eq) in
      Ï• ~ sub (Ï•' ,â‚– x/t) â†’
      Ï• ~ sub (Ï•'' ,â‚– x/t) â†’
      Invert-Ï•'-Rec Ï• (sub (Ï•'' ,â‚– x/t))

  invert-Ï•'â†’Ï• : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  invert-Ï•'â†’Ï• (Ï•~[]* refl Ï•~) = Ï•~[]* Ï•~
  invert-Ï•'â†’Ï• (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

  -- -- requires dependent subst
  -- invert-Ï•'â†’Ï•' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’ Invert-Ï•' Ï• â†’ Invert-Ï• Ï•
  -- invert-Ï•'â†’Ï•' {Âµâ‚} {Âµâ‚‚} {Ï•} (Ï•~[]* Âµâ‚â‰¡[] Ï•~) = {!substâ‚‚ (Î» â–  â– ' â†’ Invert-Ï• {Âµâ‚ = â– } â– ') ? ? {!Ï•~[]* Ï•~!}!}
  -- invert-Ï•'â†’Ï•' (Ï•~,â‚– refl Ï•' x/t Ï•~) = Ï•~,â‚– Ï•' x/t Ï•~

_â€“[_Í¾_]â†’_ : âˆ€ {â„“} â†’ List VarMode â†’ Kit _âˆ‹/âŠ¢_ â†’ Sub â„“ â†’ List VarMode â†’ Set â„“
_â€“[_Í¾_]â†’_ Âµâ‚ ğ•‚ ğ•Š Âµâ‚‚ = Sub._â€“[_]â†’_ ğ•Š Âµâ‚ ğ•‚ Âµâ‚‚

record SubWithLaws â„“ : Set (lsuc â„“) where
  field
    â¦ƒ SubWithLaws-Sub â¦„ : Sub â„“

  open Sub SubWithLaws-Sub

  field

    &-,â‚–-here : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
                  â†’ here refl & (Ï• ,â‚– x/t) â‰¡ x/t
    &-,â‚–-there : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m) {m'} (x : Âµâ‚ âˆ‹ m')
                   â†’ there x & (Ï• ,â‚– x/t) â‰¡ x & Ï•

    &-wkâ‚–-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
                 â†’ x & wkâ‚– m Ï• â‰¡ wk m (x & Ï•)

    &-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : (Âµâ‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
      â†’ x & (Ï• â†“) â‰¡ there x & Ï•

    wkâ‚–*-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* [] Ï• ~ Ï•
    wkâ‚–*-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ wkâ‚–* (Âµ â–· m) Ï• ~ wkâ‚– m (wkâ‚–* Âµ Ï•)

    â†‘-,â‚–  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) m
      â†’ (Ï• â†‘ m) ~ (wkâ‚– m Ï• ,â‚– id/` (here refl))

    â†‘*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* []) ~ Ï•

    â†‘*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (Ï• â†‘* (Âµ â–· m)) ~ ((Ï• â†‘* Âµ) â†‘ m)

    id-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â†’ id {Âµ = []} ~ []â‚–

    id-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m}
      â†’ id {Âµ = Âµ â–· m} ~ (id {Âµ = Âµ} â†‘ m)

    []*-[]  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â†’ []* {Âµâ‚‚ = []} ~ []â‚–

    []*-â–·  : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m}
      â†’ []* {Âµâ‚‚ = Âµ â–· m} ~ wkâ‚– m ([]* {Âµâ‚‚ = Âµ})

    â†“-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
      â†’ ((Ï• ,â‚– x/t) â†“) ~ Ï•

    âˆ¥-[] : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµ} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : [] â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ Ï•â‚

    âˆ¥-â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚ Âµ m} â†’ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµ) â†’ (Ï•â‚‚ : (Âµâ‚‚ â–· m) â€“[ ğ•‚ ]â†’ Âµ)
      â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚))

    â¦…â¦†-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m} (x/t : Âµ âˆ‹/âŠ¢ id/mâ†’M m) â†’
      â¦… x/t â¦† ~ (id ,â‚– x/t)

    â¦…â¦†â‚€-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ m} (x/t : Âµ âˆ‹/âŠ¢ id/mâ†’M m) â†’
      â¦… x/t â¦†â‚€ ~ ([]* ,â‚– x/t)

    invert' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï•' Ï•

    &-Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m)
            â†’ x & (Î¹-â†’ Ï•) â‰¡ Î¹-âˆ‹/âŠ¢ (x & Ï•)

  open ~-Reasoning

  ~-Î¹-â†’ : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
          â†’ Î¹-â†’ Ï• ~ Ï•
  ~-Î¹-â†’ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} Ï• = mk-~ Î» m x â†’
    `/id (x & Î¹-â†’ Ï•)     â‰¡âŸ¨ cong `/id (&-Î¹-â†’ Ï• x) âŸ©
    `/id (Î¹-âˆ‹/âŠ¢ (x & Ï•)) â‰¡âŸ¨ sym (Î¹-`/id (x & Ï•)) âŸ©
    `/id (x & Ï•)         âˆ

  &-id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ} {m} (x : Âµ âˆ‹ m)
           â†’ x & id {Âµ = Âµ} â‰¡ id/` x
  &-id â¦ƒ ğ•‚ â¦„ {Âµ â–· m'} {m} x@(here refl) =
    x & (id {Âµ = Âµ â–· m'})              â‰¡âŸ¨ use-~-hom id-â–· m' x âŸ©
    x & (id {Âµ = Âµ} â†‘ m')              â‰¡âŸ¨ use-~-hom (â†‘-,â‚– id m') _ x âŸ©
    x & (wkâ‚– _ (id {Âµ = Âµ}) ,â‚– id/` x) â‰¡âŸ¨ &-,â‚–-here (wkâ‚– _ (id {Âµ = Âµ})) (id/` x) âŸ©
    id/` x                             âˆ
  &-id â¦ƒ ğ•‚ â¦„ {Âµ â–· m'} {m} (there x) =
    there x & (id {Âµ = Âµ â–· m'})                        â‰¡âŸ¨ use-~-hom id-â–· _ (there x) âŸ©
    there x & (id {Âµ = Âµ} â†‘ m')                        â‰¡âŸ¨ use-~-hom (â†‘-,â‚– id m') _ (there x) âŸ©
    there x & (wkâ‚– _ (id {Âµ = Âµ}) ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-there (wkâ‚– _ (id {Âµ = Âµ})) (id/` (here refl)) x âŸ©
    x & (wkâ‚– _ (id {Âµ = Âµ}))                           â‰¡âŸ¨ &-wkâ‚–-wk id x âŸ©
    wk m' (x & id {Âµ = Âµ})                             â‰¡âŸ¨ cong (wk m') (&-id x) âŸ©
    wk m' (id/` x)                                     â‰¡âŸ¨ wk-id/` m' x âŸ©
    id/` (there x)                                     âˆ

  -- id-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ Âµ'}
  --   â†’ id {Âµ â–·â–· Âµ'} ~ (id {Âµ} â†‘* Âµ')
  -- id-â–·â–· {Âµ' = []} = ~-sym (â†‘*-[] id)
  -- id-â–·â–· {Âµ' = Âµ' â–· m} = ~-trans {!id-â–·â–·!} (~-trans {!id-â–·!} (~-sym (â†‘*-â–· Âµ' m id)))

  &-â†‘-here :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
    â†’ here refl & (Ï• â†‘ m) â‰¡ id/` (here refl)
  &-â†‘-here â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• =
    here refl & (Ï• â†‘ m)                       â‰¡âŸ¨ use-~-hom (â†‘-,â‚– Ï• m) m (here refl) âŸ©
    here refl & (wkâ‚– m Ï• ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-here (wkâ‚– m Ï•) _ âŸ©
    id/` (here refl)                          âˆ

  &-â†‘-there :
    âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x : Âµâ‚ âˆ‹ m')
    â†’ there x & (Ï• â†‘ m) â‰¡ wk m (x & Ï•)
  &-â†‘-there â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} Ï• x =
    there x & (Ï• â†‘ m)                       â‰¡âŸ¨ use-~-hom (â†‘-,â‚– Ï• m) m' (there x) âŸ©
    there x & (wkâ‚– m Ï• ,â‚– id/` (here refl)) â‰¡âŸ¨ &-,â‚–-there (wkâ‚– m Ï•) _ x âŸ©
    x & wkâ‚– m Ï•                             â‰¡âŸ¨ &-wkâ‚–-wk Ï• x âŸ©
    wk m (x & Ï•)                            âˆ

  -- Weakening preserves Homotopy

  ~'-cong-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~' Ï•' â†’
    wkâ‚– m Ï• ~' wkâ‚– m Ï•'
  ~'-cong-wk {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' = mk-~' Î» mx x â†’
    x & wkâ‚– _ Ï•   â‰¡âŸ¨ &-wkâ‚–-wk Ï• x âŸ©
    wk _ (x & Ï•)  â‰¡âŸ¨ cong (wk _) (use-~' Ï•~Ï•' mx x) âŸ©
    wk _ (x & Ï•') â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï•' x) âŸ©
    x & wkâ‚– _ Ï•'  âˆ

  ~-cong-wk' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚– m Ï• ~ wkâ‚– m Ï•'
  ~-cong-wk' Ï•~Ï•' = ~'â†’~ (~'-cong-wk (~â†’~' Ï•~Ï•'))

  ~-cong-wk*' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    wkâ‚–* Âµ Ï• ~ wkâ‚–* Âµ Ï•'
  ~-cong-wk*' {Âµ = []} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* [] Ï•  ~âŸ¨ wkâ‚–*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (wkâ‚–*-[] Ï•') âŸ©
    wkâ‚–* [] Ï•' ~âˆ
  ~-cong-wk*' {Âµ = Âµ â–· m} {Ï•} {Ï•'} Ï•~Ï•' =
    wkâ‚–* (Âµ â–· m) Ï•    ~âŸ¨ wkâ‚–*-â–· Âµ m Ï• âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•)  ~âŸ¨ ~-cong-wk' (~-cong-wk*' Ï•~Ï•') âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•') ~âŸ¨ ~-sym (wkâ‚–*-â–· Âµ m Ï•') âŸ©
    wkâ‚–* (Âµ â–· m) Ï•'   ~âˆ

  -- Lifting preserves Homotopy

  ~-cong-,â‚– : âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} {m}
    {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
    {x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m} {x/t' : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m} â†’
    Ï• ~ Ï•' â†’
    x/t ~â‚œ x/t' â†’
    (Ï• ,â‚– x/t) ~ (Ï•' ,â‚– x/t')
  ~-cong-,â‚– {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {_} {Ï•} {Ï•'} {x/t} {x/t'} Ï•~Ï•' x/tâ‰¡x/t' = mk-~ Î» where
    mx x@(here refl) â†’
      `/id (x & (Ï• ,â‚– x/t))   â‰¡âŸ¨ cong (`/id) (&-,â‚–-here Ï• x/t) âŸ©
      `/id x/t                â‰¡âŸ¨ x/tâ‰¡x/t' âŸ©
      `/id x/t'               â‰¡âŸ¨ cong (`/id) (sym (&-,â‚–-here Ï•' x/t')) âŸ©
      `/id (x & (Ï•' ,â‚– x/t')) âˆ
    mx x@(there y) â†’
      `/id (x & (Ï• ,â‚– x/t))   â‰¡âŸ¨ cong (`/id) (&-,â‚–-there Ï• x/t y) âŸ©
      `/id (y & Ï•)            â‰¡âŸ¨ use-~ Ï•~Ï•' mx y âŸ©
      `/id (y & Ï•')           â‰¡âŸ¨ cong (`/id) (sym (&-,â‚–-there Ï•' x/t' y)) âŸ©
      `/id (x & (Ï•' ,â‚– x/t')) âˆ

  ~'-cong-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {x/t x/t' : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m} â†’
    Ï• ~' Ï•' â†’
    x/t â‰¡ x/t' â†’
    (Ï• ,â‚– x/t) ~' (Ï•' ,â‚– x/t')
  ~'-cong-,â‚– Ï•~Ï•' x/tâ‰¡x/t' = ~â†’~' (~-cong-,â‚– (~'â†’~ Ï•~Ï•') (cong (`/id) x/tâ‰¡x/t'))

  ~-cong-â†“ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• : (Âµâ‚ â–· m) â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : (Âµâ‚ â–· m) â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†“) ~ (Ï•' â†“)
  ~-cong-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' = mk-~ Î» mx x â†’
    `/id (x & (Ï•  â†“))   â‰¡âŸ¨ cong (`/id) (&-â†“ Ï• x) âŸ©
    `/id (there x & Ï• ) â‰¡âŸ¨ use-~ Ï•~Ï•' mx (there x) âŸ©
    `/id (there x & Ï•') â‰¡âŸ¨ cong (`/id) (sym (&-â†“ Ï•' x)) âŸ©
    `/id (x & (Ï•' â†“))   âˆ

  ~-cong-âˆ¥ :
    âˆ€ â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚}
      {Ï•â‚  : Âµâ‚â‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚}
      {Ï•â‚' : Âµâ‚â‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
      {Ï•â‚‚  : Âµâ‚â‚‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚}
      {Ï•â‚‚' : Âµâ‚â‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
    â†’ Ï•â‚ ~ Ï•â‚'
    â†’ Ï•â‚‚ ~ Ï•â‚‚'
    â†’ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (Ï•â‚' âˆ¥ Ï•â‚‚')
  ~-cong-âˆ¥ {Âµâ‚â‚ = Âµâ‚â‚} {[]}      {Âµâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    (Ï•â‚ âˆ¥ Ï•â‚‚)   ~âŸ¨ âˆ¥-[] Ï•â‚ Ï•â‚‚ âŸ©
    Ï•â‚          ~âŸ¨ Ï•â‚~Ï•â‚' âŸ©
    Ï•â‚'         ~âŸ¨ ~-sym (âˆ¥-[] Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ
  ~-cong-âˆ¥ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚ â–· m} {Âµâ‚‚} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' =
    let subâ‚ = subst (_â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (sym (++-assoc ([] â–· m) Âµâ‚â‚‚ Âµâ‚â‚)) in
    let subâ‚‚ = subst (_â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (sym (++-assoc ([] â–· m) Âµâ‚â‚‚ Âµâ‚â‚)) in
    (Ï•â‚ âˆ¥ Ï•â‚‚)                                      ~âŸ¨ âˆ¥-â–· Ï•â‚ Ï•â‚‚ âŸ©
    subâ‚ ((Ï•â‚  âˆ¥ (Ï•â‚‚  â†“)) ,â‚– (here refl & Ï•â‚‚)) ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· m) Âµâ‚â‚‚ Âµâ‚â‚))
                                                      (~-cong-,â‚– (~-cong-âˆ¥ Ï•â‚~Ï•â‚' (~-cong-â†“ Ï•â‚‚~Ï•â‚‚'))
                                                                 (use-~ Ï•â‚‚~Ï•â‚‚' _ (here refl))) âŸ©
    subâ‚‚ ((Ï•â‚' âˆ¥ (Ï•â‚‚' â†“)) ,â‚– (here refl & Ï•â‚‚')) ~âŸ¨ ~-sym (âˆ¥-â–· Ï•â‚' Ï•â‚‚') âŸ©
    (Ï•â‚' âˆ¥ Ï•â‚‚') ~âˆ

  invert : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Invert-Ï• Ï•
  invert Ï• = invert-Ï•'â†’Ï• (invert' Ï•)

  invert'-rec : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ Î£[ Ï•' âˆˆ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ ] Invert-Ï•'-Rec Ï• Ï•' Ã— Ï• ~ Ï•'
  invert'-rec Ï• with invert Ï•
  ... | Ï•~[]* Ï•~[] = []* , Ï•~[]* refl Ï•~[] , Ï•~[]
  ... | Ï•~,â‚– Ï•' x/t Ï•~Ï•',x/t with invert'-rec Ï•'
  ...   | Ï•'' , inv , Ï•'~Ï•'' = let Ï•~Ï•'',x/t = ~-trans Ï•~Ï•',x/t (~-cong-,â‚– Ï•'~Ï•'' refl) in
                               (Ï•'' ,â‚– x/t) , Ï•~,â‚– refl Ï•' x/t Ï•'' inv Ï•~Ï•',x/t Ï•~Ï•'',x/t , Ï•~Ï•'',x/t

  ~-cong-â†‘' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘ m) ~ (Ï•' â†‘ m)
  ~-cong-â†‘' {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' =
    (Ï• â†‘ m)                         ~âŸ¨ â†‘-,â‚– Ï• m âŸ©
    (wkâ‚– _ Ï•  ,â‚– id/` (here refl))  ~âŸ¨ ~-cong-,â‚– (~-cong-wk' Ï•~Ï•') ~â‚“-refl âŸ©
    (wkâ‚– _ Ï•' ,â‚– id/` (here refl))  ~âŸ¨ ~-sym (â†‘-,â‚– Ï•' m) âŸ©
    (Ï•' â†‘ m)                        ~âˆ

  ~-cong-â†‘*' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Ï• ~ Ï•' â†’
    (Ï• â†‘* Âµ) ~ (Ï•' â†‘* Âµ)
  ~-cong-â†‘*' {Âµ = []}    {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* [])  ~âŸ¨ â†‘*-[] Ï• âŸ©
    Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
    Ï•'         ~âŸ¨ ~-sym (â†‘*-[] Ï•') âŸ©
    (Ï•' â†‘* []) ~âˆ
  ~-cong-â†‘*' {Âµ = Âµ â–· m} {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
    (Ï• â†‘* (Âµ â–· m))  ~âŸ¨ â†‘*-â–· Âµ m Ï• âŸ©
    (Ï• â†‘* Âµ) â†‘ m    ~âŸ¨ ~-cong-â†‘' (~-cong-â†‘*' Ï•~Ï•') âŸ©
    (Ï•' â†‘* Âµ) â†‘ m   ~âŸ¨ ~-sym (â†‘*-â–· Âµ m Ï•') âŸ©
    (Ï•' â†‘* (Âµ â–· m)) ~âˆ

  dist-wk-,â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} m {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m') â†’
    wkâ‚– m (Ï• ,â‚– x/t) ~' (wkâ‚– m Ï• ,â‚– Kit.wk ğ•‚ _ x/t)
  dist-wk-,â‚–' â¦ƒ ğ•‚ â¦„ m Ï• x/t = mk-~' Î» where
    mx (here refl) â†’
      here refl & (wkâ‚– m (Ï• ,â‚– x/t))    â‰¡âŸ¨ &-wkâ‚–-wk (Ï• ,â‚– x/t) (here refl) âŸ©
      wk m (here refl & (Ï• ,â‚– x/t))     â‰¡âŸ¨ cong (wk m) (&-,â‚–-here Ï• x/t) âŸ©
      wk m x/t                          â‰¡âŸ¨ sym (&-,â‚–-here (wkâ‚– m Ï•) (wk m x/t)) âŸ©
      here refl & (wkâ‚– m Ï• ,â‚– wk m x/t) âˆ
    mx (there x) â†’
      there x & (wkâ‚– _ (Ï• ,â‚– x/t))    â‰¡âŸ¨ &-wkâ‚–-wk (Ï• ,â‚– x/t) (there x) âŸ©
      wk _ (there x & (Ï• ,â‚– x/t))     â‰¡âŸ¨ cong (wk _) (&-,â‚–-there Ï• x/t x) âŸ©
      wk _ (x & Ï•)                    â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï• x) âŸ©
      x & (wkâ‚– _ Ï•)                   â‰¡âŸ¨ sym (&-,â‚–-there (wkâ‚– m Ï•) (wk _ x/t) x) âŸ©
      there x & (wkâ‚– _ Ï• ,â‚– wk _ x/t) âˆ

  dist-wk-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} m {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m') â†’
    wkâ‚– m (Ï• ,â‚– x/t) ~ (wkâ‚– m Ï• ,â‚– Kit.wk ğ•‚ _ x/t)
  dist-wk-,â‚– m Ï• x/t = ~'â†’~ (dist-wk-,â‚–' m Ï• x/t)

  dist-wk*-,â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ {m'} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m') â†’
    wkâ‚–* Âµ (Ï• ,â‚– x/t) ~ (wkâ‚–* Âµ Ï• ,â‚– wk* _ x/t)
  dist-wk*-,â‚– []      Ï• x/t =
    wkâ‚–* [] (Ï• ,â‚– x/t)       ~âŸ¨ wkâ‚–*-[] (Ï• ,â‚– x/t) âŸ©
    Ï• ,â‚– x/t                 ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-[] Ï•)) refl âŸ©
    (wkâ‚–* [] Ï• ,â‚– x/t)       ~âŸ¨âŸ©
    (wkâ‚–* [] Ï• ,â‚– wk* _ x/t) ~âˆ
  dist-wk*-,â‚– (Âµ â–· m) Ï• x/t =
    wkâ‚–* (Âµ â–· m) (Ï• ,â‚– x/t)                ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï• ,â‚– x/t) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï• ,â‚– x/t))              ~âŸ¨ ~-cong-wk' (dist-wk*-,â‚– Âµ Ï• x/t) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï• ,â‚– wk* _ x/t)          ~âŸ¨ dist-wk-,â‚– m (wkâ‚–* Âµ Ï•) (wk* _ x/t) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•) ,â‚– wk m (wk* Âµ x/t)) ~âŸ¨ ~-cong-,â‚– (~-sym (wkâ‚–*-â–· Âµ m Ï•)) refl âŸ©
    (wkâ‚–* (Âµ â–· m) Ï• ,â‚– wk* _ x/t)          ~âˆ

  open import Kitty.Util.SubstProperties

  wkâ‚–*-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ Âµ' (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)  â†’
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ Âµ' Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚–* Âµ' Ï•) ~ sub (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•)
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} [] Âµ' Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc [] Âµ' Âµâ‚‚) in
    wkâ‚–* [] (wkâ‚–* Âµ' Ï•)     ~âŸ¨ wkâ‚–*-[] (wkâ‚–* Âµ' Ï•) âŸ©
    wkâ‚–* Âµ' Ï•               ~âŸ¨âŸ©
    sub (wkâ‚–* (Âµ' â–·â–· []) Ï•) ~âˆ
  wkâ‚–*-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Âµ â–· m) Âµ' Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) in
    let sub' = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ Âµ' Âµâ‚‚) in
    wkâ‚–* (Âµ â–· m) (wkâ‚–* Âµ' Ï•)        ~âŸ¨ wkâ‚–*-â–· Âµ m (wkâ‚–* Âµ' Ï•) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (wkâ‚–* Âµ' Ï•))      ~âŸ¨ ~-cong-wk' (wkâ‚–*-â–·â–· Âµ Âµ' Ï•) âŸ©
    wkâ‚– m (sub' (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•)) ~â‰¡âŸ¨ dist-subst' (_â–· m) (wkâ‚– m) (++-assoc Âµ Âµ' Âµâ‚‚) (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•) âŸ©
    sub (wkâ‚– m (wkâ‚–* (Âµ' â–·â–· Âµ) Ï•))  ~âŸ¨ ~-cong-subst-Âµâ‚‚ (++-assoc (Âµ â–· m) Âµ' Âµâ‚‚) (~-sym (wkâ‚–*-â–· (Âµ' â–·â–· Âµ) m Ï•)) âŸ©
    sub (wkâ‚–* (Âµ' â–·â–· (Âµ â–· m)) Ï•)    ~âˆ

  wkâ‚–-â–·â–· : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)  â†’
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ ([] â–· m) Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚– m Ï•) ~ sub (wkâ‚–* (([] â–· m) â–·â–· Âµ) Ï•)
  wkâ‚–-â–·â–· â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} Âµ m Ï• =
    let sub = subst (Âµâ‚ â€“[ ğ•‚ ]â†’_) (++-assoc Âµ ([] â–· m) Âµâ‚‚) in
    wkâ‚–* Âµ (wkâ‚– m Ï•)             ~âŸ¨ ~-cong-wk*' (~-cong-wk' (~-sym (wkâ‚–*-[] Ï•))) âŸ©
    wkâ‚–* Âµ (wkâ‚– m (wkâ‚–* [] Ï•))   ~âŸ¨ ~-cong-wk*' (~-sym (wkâ‚–*-â–· [] m Ï•)) âŸ©
    wkâ‚–* Âµ (wkâ‚–* ([] â–· m) Ï•)     ~âŸ¨ wkâ‚–*-â–·â–· Âµ ([] â–· m) Ï• âŸ©
    sub (wkâ‚–* (([] â–· m) â–·â–· Âµ) Ï•) ~âˆ

  dist-wk-â†“' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚ m m'} â†’ (Ï• : (Âµâ‚ â–· m') â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚– m (Ï• â†“) ~' (wkâ‚– m Ï• â†“)
  dist-wk-â†“' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {m'} Ï• = mk-~' Î» mx x â†’
    x & (wkâ‚– m (Ï• â†“))   â‰¡âŸ¨ &-wkâ‚–-wk (Ï• â†“) x âŸ©
    wk m (x & (Ï• â†“))    â‰¡âŸ¨ cong (wk m) (&-â†“ Ï• x) âŸ©
    wk m (there x & Ï•)  â‰¡âŸ¨ sym (&-wkâ‚–-wk Ï• (there x)) âŸ©
    there x & (wkâ‚– m Ï•) â‰¡âŸ¨ sym (&-â†“ (wkâ‚– m Ï•) x) âŸ©
    x & (wkâ‚– m Ï• â†“)     âˆ

  dist-wk-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚ m m'} â†’ (Ï• : (Âµâ‚ â–· m') â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚– m (Ï• â†“) ~ (wkâ‚– m Ï• â†“)
  dist-wk-â†“ Ï• = ~'â†’~ (dist-wk-â†“' Ï•)

  dist-wk*-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚ Âµ m'} â†’ (Ï• : (Âµâ‚ â–· m') â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚–* Âµ (Ï• â†“) ~ (wkâ‚–* Âµ Ï• â†“)
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ = []}    {m'} Ï• =
    wkâ‚–* [] (Ï• â†“)        ~âŸ¨ wkâ‚–*-[] (Ï• â†“) âŸ©
    (Ï• â†“)                ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-[] Ï•)) âŸ©
    (wkâ‚–* [] Ï• â†“)        ~âˆ
  dist-wk*-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµ = Âµ â–· m} {m'} Ï• =
    wkâ‚–* (Âµ â–· m) (Ï• â†“)   ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï• â†“) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï• â†“)) ~âŸ¨ ~-cong-wk' (dist-wk*-â†“ Ï•) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï• â†“)   ~âŸ¨ dist-wk-â†“ (wkâ‚–* Âµ Ï•) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•) â†“) ~âŸ¨ ~-cong-â†“ (~-sym (wkâ‚–*-â–· Âµ m Ï•)) âŸ©
    (wkâ‚–* (Âµ â–· m) Ï• â†“)   ~âˆ

  âˆ¥-wk : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚} m â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : Âµâ‚â‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚)
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {[]} {Âµâ‚‚} m Ï•â‚ Ï•â‚‚ =
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚)        ~âŸ¨ ~-cong-wk' (âˆ¥-[] Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m Ï•â‚               ~âŸ¨ ~-sym (âˆ¥-[] (wkâ‚– m Ï•â‚) (wkâ‚– m Ï•â‚‚)) âŸ©
    (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚)  ~âˆ
  âˆ¥-wk â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚ â–· mâ‚‚} {Âµâ‚‚} m Ï•â‚ Ï•â‚‚ =
    let sub = subst (_â€“[ ğ•‚ ]â†’ Âµâ‚‚) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚)) in
    let sub' = subst (_â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚)) in
    wkâ‚– m (Ï•â‚ âˆ¥ Ï•â‚‚)                                              ~âŸ¨ ~-cong-wk' (âˆ¥-â–· Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m (sub ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)))              ~â‰¡âŸ¨ dist-subst {F = _â€“[ ğ•‚ ]â†’ Âµâ‚‚} {G = _â€“[ ğ•‚ ]â†’ (Âµâ‚‚ â–· m)}
                                                                                    (wkâ‚– m) (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                                    ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)) âŸ©
    sub' (wkâ‚– m ((Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)))             ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (dist-wk-,â‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) (here refl & Ï•â‚‚)) âŸ©
    sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– wk m (here refl & Ï•â‚‚))          ~â‰¡âŸ¨ cong (Î» â–  â†’ sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– â– ))
                                                                          (sym (&-wkâ‚–-wk Ï•â‚‚ (here refl))) âŸ© 
    sub' (wkâ‚– m (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– m Ï•â‚‚)))       ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (~-cong-,â‚– (âˆ¥-wk m Ï•â‚ (Ï•â‚‚ â†“)) refl) âŸ©
    sub' ((wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m (Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– m Ï•â‚‚))) ~âŸ¨ ~-cong-subst-Âµâ‚ (sym (++-assoc ([] â–· mâ‚‚) Âµâ‚â‚‚ Âµâ‚â‚))
                                                                        (~-cong-,â‚– (~-cong-âˆ¥ ~-refl (dist-wk-â†“ Ï•â‚‚)) refl) âŸ©
    sub' ((wkâ‚– m Ï•â‚ âˆ¥ (wkâ‚– m Ï•â‚‚ â†“)) ,â‚– (here refl & (wkâ‚– m Ï•â‚‚))) ~âŸ¨ ~-sym (âˆ¥-â–· (wkâ‚– m Ï•â‚) (wkâ‚– m Ï•â‚‚)) âŸ©
    (wkâ‚– m Ï•â‚ âˆ¥ wkâ‚– m Ï•â‚‚) ~âˆ

  âˆ¥-wk* : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚} Âµ â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : Âµâ‚â‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    wkâ‚–* Âµ (Ï•â‚ âˆ¥ Ï•â‚‚) ~ (wkâ‚–* Âµ Ï•â‚ âˆ¥ wkâ‚–* Âµ Ï•â‚‚)
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} []      Ï•â‚ Ï•â‚‚ =
    wkâ‚–* [] (Ï•â‚ âˆ¥ Ï•â‚‚)         ~âŸ¨ wkâ‚–*-[] (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    (Ï•â‚ âˆ¥ Ï•â‚‚)                 ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-[] Ï•â‚) (wkâ‚–*-[] Ï•â‚‚)) âŸ©
    (wkâ‚–* [] Ï•â‚ âˆ¥ wkâ‚–* [] Ï•â‚‚) ~âˆ
  âˆ¥-wk* â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} (Âµ â–· m) Ï•â‚ Ï•â‚‚ =
    wkâ‚–* (Âµ â–· m) (Ï•â‚ âˆ¥ Ï•â‚‚)                  ~âŸ¨ wkâ‚–*-â–· Âµ m (Ï•â‚ âˆ¥ Ï•â‚‚) âŸ©
    wkâ‚– m (wkâ‚–* Âµ (Ï•â‚ âˆ¥ Ï•â‚‚))                ~âŸ¨ ~-cong-wk' (âˆ¥-wk* Âµ Ï•â‚ Ï•â‚‚) âŸ©
    wkâ‚– m (wkâ‚–* Âµ Ï•â‚ âˆ¥ wkâ‚–* Âµ Ï•â‚‚)           ~âŸ¨ âˆ¥-wk m (wkâ‚–* Âµ Ï•â‚) (wkâ‚–* Âµ Ï•â‚‚) âŸ©
    (wkâ‚– m (wkâ‚–* Âµ Ï•â‚) âˆ¥ wkâ‚– m (wkâ‚–* Âµ Ï•â‚‚)) ~âŸ¨ ~-sym (~-cong-âˆ¥ (wkâ‚–*-â–· Âµ m Ï•â‚) (wkâ‚–*-â–· Âµ m Ï•â‚‚)) âŸ©
    (wkâ‚–* (Âµ â–· m) Ï•â‚ âˆ¥ wkâ‚–* (Âµ â–· m) Ï•â‚‚)     ~âˆ

  âˆ¥-â†“ : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚ m} â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : (Âµâ‚â‚‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    (Ï•â‚ âˆ¥ Ï•â‚‚) â†“ ~ Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)
  âˆ¥-â†“ â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} {m} Ï•â‚ Ï•â‚‚ = mk-~ Î» mx x â†’
    `/id (x & ((Ï•â‚ âˆ¥ Ï•â‚‚) â†“))                           â‰¡âŸ¨ cong `/id (&-â†“ (Ï•â‚ âˆ¥ Ï•â‚‚) x) âŸ©
    `/id (there x & (Ï•â‚ âˆ¥ Ï•â‚‚))                         â‰¡âŸ¨ use-~ (âˆ¥-â–· Ï•â‚ Ï•â‚‚) _ (there x) âŸ©
    `/id (there x & (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚)) â‰¡âŸ¨ cong `/id (&-,â‚–-there (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) _ x) âŸ©
    `/id (x & Ï•â‚ âˆ¥ (Ï•â‚‚ â†“))                             âˆ

  &-âˆ¥-here : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚â‚ Âµâ‚â‚‚ Âµâ‚‚ m} â†’ (Ï•â‚ : Âµâ‚â‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’ (Ï•â‚‚ : (Âµâ‚â‚‚ â–· m) â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    here refl & (Ï•â‚ âˆ¥ Ï•â‚‚) â‰¡ here refl & Ï•â‚‚
  &-âˆ¥-here â¦ƒ ğ•‚ â¦„ {Âµâ‚â‚} {Âµâ‚â‚‚} {Âµâ‚‚} {m} Ï•â‚ Ï•â‚‚ =
    here refl & (Ï•â‚ âˆ¥ Ï•â‚‚)                         â‰¡âŸ¨ use-~-hom (âˆ¥-â–· Ï•â‚ Ï•â‚‚) _ (here refl) âŸ©
    here refl & (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) ,â‚– (here refl & Ï•â‚‚) â‰¡âŸ¨ &-,â‚–-here (Ï•â‚ âˆ¥ (Ï•â‚‚ â†“)) (here refl & Ï•â‚‚) âŸ©
    here refl & Ï•â‚‚                                âˆ


  -- Identity


  -- idâ‚–' : Âµ â€“â†’ (Âµ' â–·â–· Âµ )
  -- idâ‚–' _ x = id/` (âˆˆ-â–·â–·â‚— x)  where
  --   âˆˆ-â–·â–·â‚— : Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- idâ‚–'' : âˆ€ {Âµ Âµ' Âµ''} â†’ Âµ â€“â†’ (Âµ' â–·â–· Âµ â–·â–· Âµ'')
  -- idâ‚–'' {Âµ} {Âµ'} {Âµ''} _ x = wk* {Âµ' = Âµ''} _ (id/` (âˆˆ-â–·â–·â‚— x))  where
  --   âˆˆ-â–·â–·â‚— :  âˆ€ {Âµ} {Âµ'} â†’ Âµ âˆ‹ m â†’ (Âµ' â–·â–· Âµ) âˆ‹ m
  --   âˆˆ-â–·â–·â‚— (here px) = here px
  --   âˆˆ-â–·â–·â‚— (there x) = there (âˆˆ-â–·â–·â‚— x)

  -- Lifted identity is identity

  idâ†‘~id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ m Âµ â†’ id {Âµ = Âµ} â†‘ m ~ id {Âµ = Âµ â–· m}
  idâ†‘~id m Âµ = mk-~ Î» where
    _ x@(here refl) â†’
      `/id (x & id {Âµ = Âµ} â†‘ m) â‰¡âŸ¨ cong `/id (&-â†‘-here id) âŸ©
      `/id (id/` (here refl))   â‰¡âŸ¨ cong `/id (sym (&-id x)) âŸ©
      `/id (x & id {Âµ = Âµ â–· m}) âˆ
    _ x@(there y) â†’
      `/id (x & id {Âµ = Âµ} â†‘ m)    â‰¡âŸ¨ cong `/id (&-â†‘-there id y) âŸ©
      `/id (wk _ (y & id {Âµ = Âµ})) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (wk _ â– )) (&-id y) âŸ©
      `/id (wk _ (id/` y))         â‰¡âŸ¨ cong `/id (wk-id/` _ y) âŸ©
      `/id (id/` x)                â‰¡âŸ¨ cong `/id (sym (&-id x)) âŸ©
      `/id (x & id {Âµ = Âµ â–· m})    âˆ

  idâ†‘*~id : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ Âµ' Âµ â†’ id {Âµ = Âµ} â†‘* Âµ' ~ id {Âµ = Âµ â–·â–· Âµ'}
  idâ†‘*~id []       Âµ = â†‘*-[] id
  idâ†‘*~id (Âµ' â–· m) Âµ =
    id â†‘* (Âµ' â–· m) ~âŸ¨ â†‘*-â–· Âµ' m id âŸ©
    id â†‘* Âµ' â†‘ m   ~âŸ¨ ~-cong-â†‘' (idâ†‘*~id Âµ' Âµ) âŸ©
    id â†‘ m         ~âŸ¨ idâ†‘~id _ _ âŸ©
    id             ~âˆ

  -- Empty Substitution

  &-[]â‚– : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ {m} (x : _ âˆ‹ m) â†’ x & []â‚– â‰¡ id/` x
  &-[]â‚– ()

  &-[]â‚–' : âˆ€ â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„ (Ï• : [] â€“[ ğ•‚ ]â†’ []) â†’ Ï• ~ []â‚–
  &-[]â‚–' Ï• = mk-~ Î» m ()

  -- -- Singleton renaming/substitution

  -- -- Singleton renaming/substitution for terms with 1 free variable.
  -- -- Allows the term to be substituted to have arbitrary free variables.
  -- -- This is useful for things like pattern inverting in combination with `_âˆ¥_`,
  -- -- where a inverting substitution needs to be built up piece by piece.
  -- â¦…_â¦†â‚€ : Âµ âˆ‹/âŠ¢ id/mâ†’M m â†’ ([] â–· m) â€“â†’ Âµ
  -- â¦… v â¦†â‚€ = emptyâ‚– ,â‚– v

  -- -- â¦…_â¦†' : (Âµ â–·â–· Âµ') âˆ‹/âŠ¢ mâ†’[m/M] m â†’ (Âµ â–· m â–·â–· Âµ') â€“â†’ (Âµ â–·â–· Âµ')
  -- -- â¦… v â¦†' = idâ‚–'' âˆ¥ â¦… v â¦†â‚€ âˆ¥ idâ‚–''
  -- -- â¦… v â¦†' = {!!} âˆ¥ â¦… v â¦†â‚€ âˆ¥ {!!}
  -- -- -- â¦… v â¦†' = (idâ‚– âˆ¥ â¦… v â¦†â‚€) â†‘* _
