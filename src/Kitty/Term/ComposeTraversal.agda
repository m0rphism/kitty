open import Kitty.Term.Modes
open import Kitty.Term.Traversal using (Traversal; KitHomotopy)
import Kitty.Term.Sub

module Kitty.Term.ComposeTraversal {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) (T : Traversal ğ•‹) (H : KitHomotopy ğ•‹ T) (ğ•Š : Kitty.Term.Sub.SubWithLaws ğ•‹) where

open import Data.List using (List; []; _âˆ·_)
open import Data.List.Membership.Propositional using (_âˆˆ_)
open import Data.List.Relation.Unary.Any using (here; there)
open import Level using (Level; _âŠ”_) renaming (suc to lsuc; zero to lzero)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; trans; cong; congâ‚‚; subst; module â‰¡-Reasoning)
open import Relation.Nullary using (Â¬_)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open import Kitty.Term.ComposeKit ğ•‹ T H ğ•Š
open import Kitty.Util.SubstProperties

open Modes ğ•„
open Terms ğ•‹
open Traversal T
open KitHomotopy H
open Kit â¦ƒ â€¦ â¦„
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws â¦ƒ â€¦ â¦„
open ~-Reasoning
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„

private instance
  _ = kitáµ£
  _ = kitâ‚›
  _ = ckitáµ£
  _ = ğ•Š

private variable
  m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
  M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
  Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

open ComposeKit â¦ƒ â€¦ â¦„

dist-â†‘-â¦…â¦†-Â· :
  âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
    â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
    â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚ ğ•‚ â¦„
    {Âµâ‚ Âµâ‚‚ m} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) â†’
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
  (â¦… x/t â¦† Â·[ Câ‚ ] Ï•) ~ ((Ï• â†‘ m) Â·[ Câ‚‚ ] â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†)
dist-â†‘-â¦…â¦†-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} x/t Ï• mx x@(here refl) =
  let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
  let sub' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
  let sub'' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
  let subâ‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (sym (Î¹-id/mâ†’M m)) in
  apâ‚– (â¦… x/t â¦† Â·[ Câ‚ ] Ï•) _ x                               â‰¡âŸ¨ ap/â‹¯-Â·â‚– â¦… x/t â¦† Ï• x âŸ©
  sub (apâ‚– â¦… x/t â¦† _ x ap/â‹¯ Ï•)                              â‰¡âŸ¨ cong (Î» â–  â†’ sub (â–  ap/â‹¯ Ï•)) (â¦…â¦†-,â‚– x/t _ x) âŸ©
  sub (apâ‚– (id ,â‚– x/t) _ x ap/â‹¯ Ï•)                          â‰¡âŸ¨ cong (Î» â–  â†’ sub (â–  ap/â‹¯ Ï•)) (apâ‚–-,â‚–-here id x/t) âŸ©
  sub (x/t ap/â‹¯ Ï•)                                          â‰¡âŸ¨ sym (cancel-subst' (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) (sub (x/t ap/â‹¯ Ï•))) âŸ©
  sub'' (subâ‚ (sub (x/t ap/â‹¯ Ï•)))                           â‰¡âŸ¨ cong sub'' (sym (Î¹-âˆ‹/âŠ¢-id refl _)) âŸ©
  sub'' (Î¹-âˆ‹/âŠ¢ (sub (x/t ap/â‹¯ Ï•)))                          â‰¡âŸ¨ cong (Î» â–  â†’ sub'' (Î¹-âˆ‹/âŠ¢ â– ))
                                                                    (sym (apâ‚–-,â‚–-here id (sub (x/t ap/â‹¯[ Câ‚ ] Ï•)))) âŸ©
  sub'' (Î¹-âˆ‹/âŠ¢ (apâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ (id ,â‚– sub (x/t ap/â‹¯[ Câ‚ ] Ï•)) _ (here refl))) â‰¡âŸ¨ cong (Î» â–  â†’ sub'' (Î¹-âˆ‹/âŠ¢ â– )) (sym (â¦…â¦†-,â‚– (sub (x/t ap/â‹¯[ Câ‚ ] Ï•)) _ (here refl))) âŸ©
  sub'' (Î¹-âˆ‹/âŠ¢ (apâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦† _ (here refl))) â‰¡âŸ¨ sym (ap/â‹¯-ap â¦ƒ Câ‚‚ â¦„ (here refl)
                                                                                            â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) âŸ©
  sub' (id/` _ (here refl) ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†)   â‰¡âŸ¨ cong (Î» â–  â†’ sub' (â–  ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†))
                                                                      (sym (apâ‚–-â†‘-here Ï•)) âŸ© 
  sub' (apâ‚– (Ï• â†‘ m) _ x ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†)      â‰¡âŸ¨ sym (ap/â‹¯-Â·â‚– (Ï• â†‘ m) â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦† x) âŸ©
  apâ‚– ((Ï• â†‘ m) Â·[ Câ‚‚ ] â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) _ x        âˆ
dist-â†‘-â¦…â¦†-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} x/t Ï• mx x@(there y) =
  let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ m) in
  let sub' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ mx) in
  let sub'' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚‚ â¦„ â¦„ mx) in
  let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ mx) in
  apâ‚– (â¦… x/t â¦† Â·[ Câ‚ ] Ï•) _ x                               â‰¡âŸ¨ ap/â‹¯-Â·â‚– â¦… x/t â¦† Ï• x âŸ©
  sub' (apâ‚– â¦… x/t â¦† _ x ap/â‹¯ Ï•)                             â‰¡âŸ¨ cong (Î» â–  â†’ sub' (â–  ap/â‹¯[ Câ‚ ] Ï•)) (â¦…â¦†-,â‚– x/t _ x) âŸ©
  sub' (apâ‚– (id ,â‚– x/t) _ x ap/â‹¯ Ï•)                         â‰¡âŸ¨ cong (Î» â–  â†’ sub' (â–  ap/â‹¯[ Câ‚ ] Ï•)) (apâ‚–-,â‚–-there id x/t y) âŸ©
  sub' (apâ‚– id _ y ap/â‹¯ Ï•)                                  â‰¡âŸ¨ cong (Î» â–  â†’ sub' (â–  ap/â‹¯[ Câ‚ ] Ï•)) (apâ‚–-id y) âŸ©
  sub' (id/` _ y ap/â‹¯ Ï•)                                    â‰¡âŸ¨ ap/â‹¯-ap y Ï• âŸ©
  subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ (apâ‚– Ï• _ y))              â‰¡âŸ¨ {!!} âŸ©
  apâ‚– (Ï• Â·[ Câ‚‚ ] id) _ y                                    â‰¡âŸ¨ {!!} âŸ©
  apâ‚– (wkâ‚– _ Ï• Â·[ Câ‚‚ ] â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) _ y      â‰¡âŸ¨ ap/â‹¯-Â·â‚– â¦ƒ Câ‚‚ â¦„ (wkâ‚– _ Ï•) â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦† y âŸ©
  sub'' (apâ‚– (wkâ‚– _ Ï•) _ y ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) â‰¡âŸ¨ cong (Î» â–  â†’ sub'' (â–  ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†))
                                                                    (apâ‚–-wkâ‚–-wk Ï• y) âŸ©
  sub'' (wk _ (apâ‚– Ï• _ y) ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†)  â‰¡âŸ¨ cong (Î» â–  â†’ sub'' (â–  ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†))
                                                                    (sym (apâ‚–-â†‘-there Ï• y)) âŸ© 
  sub'' (apâ‚– (Ï• â†‘ m) _ x ap/â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†)   â‰¡âŸ¨ sym (ap/â‹¯-Â·â‚– â¦ƒ Câ‚‚ â¦„ (Ï• â†‘ m) â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦† x) âŸ©
  apâ‚– ((Ï• â†‘ m) Â·[ Câ‚‚ ] â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) _ x      âˆ

-- ComposeTraversal ------------------------------------------------------------

-- If the client provides a `ComposeTraversal` which works for all `ComposeKit`s,
-- they get `â‹¯-assoc` for `_áµ£âˆ˜áµ£_`, `_â‚›âˆ˜áµ£_`, `_áµ£âˆ˜â‚›_`, and `_â‚›âˆ˜â‚›_`.

record ComposeTraversal : Setâ‚ where
  field
    â‹¯-assoc : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ : Kit â¦„ â¦ƒ ğ”¸ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
                (t : Âµâ‚ âŠ¢ M) (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ) â†’
      (t â‹¯ Ï•â‚) â‹¯ Ï•â‚‚ â‰¡ t â‹¯ (Ï•â‚ Â·â‚– Ï•â‚‚)

  -- Example:
  --
  --   instance kit-assoc : ComposeTraversal {{traversal}}
  --   ComposeTraversal.â‹¯-assoc kit-assoc (` x) f g =
  --     tm' (f _ x) â‹¯ g    â‰¡âŸ¨ tm'-â‹¯-âˆ˜ f g x âŸ©
  --     tm' ((g âˆ˜â‚– f) _ x) âˆ
  --   ComposeTraversal.â‹¯-assoc kit-assoc (Î»â†’ e) f g = cong Î»â†’_
  --     (e â‹¯ f â†‘ _ â‹¯ g â†‘ _        â‰¡âŸ¨ â‹¯-assoc e (f â†‘ _) (g â†‘ _) âŸ©
  --      e â‹¯ ((g â†‘ _) âˆ˜â‚– (f â†‘ _)) â‰¡âŸ¨ cong (e â‹¯_) (sym (dist-â†‘-âˆ˜ _ g f)) âŸ©
  --      e â‹¯ (g âˆ˜â‚– f) â†‘ _         âˆ)
  --   ComposeTraversal.â‹¯-assoc kit-assoc (eâ‚ Â· eâ‚‚) f g = congâ‚‚ _Â·_ (â‹¯-assoc eâ‚ f g) (â‹¯-assoc eâ‚‚ f g)

  -- ComposeKit for Substitutions ------------------------------------------------

  infixl  9  _â‚›Â·_  _â‚›Â·áµ£_  _â‚›Â·â‚›_
  infixr  9  _âˆ˜â‚›_  _áµ£âˆ˜â‚›_  _â‚›âˆ˜â‚›_

  _â‚›Â·_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
        â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚
        â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
        â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  Ïƒ â‚›Â· Ï• = post â¦ƒ ğ•‚ = kitâ‚› â¦„ Ïƒ (Î» _ t â†’ t â‹¯ Ï•)

  _âˆ˜â‚›_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜â‚› Ï•â‚ = Ï•â‚ â‚›Â· Ï•â‚‚

  _â‚›Â·áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _â‚›Â·â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _áµ£âˆ˜â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _â‚›âˆ˜â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _â‚›Â·áµ£_ = _â‚›Â·_
  _â‚›Â·â‚›_ = _â‚›Â·_
  _áµ£âˆ˜â‚›_ = _âˆ˜â‚›_
  _â‚›âˆ˜â‚›_ = _âˆ˜â‚›_

  â‹¯-â‚›Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
           (Ïƒ : Âµâ‚ â€“[ kitâ‚›  ]â†’ Âµâ‚‚)
           (Ï• : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
           (x : Âµâ‚ âˆ‹ m)
         â†’ apâ‚– (Ïƒ â‚›Â· Ï•) _ x â‰¡ apâ‚– Ïƒ _ x â‹¯ Ï•
  â‹¯-â‚›Â· â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m} Ïƒ Ï• x =
    apâ‚– (Ïƒ â‚›Â· Ï•) _ x â‰¡âŸ¨âŸ©
    apâ‚– (post Ïƒ (Î» _ t â†’ t â‹¯ Ï•)) _ x â‰¡âŸ¨ apâ‚–-post Ïƒ (Î» _ t â†’ t â‹¯ Ï•) x âŸ©
    apâ‚– Ïƒ _ x â‹¯ Ï•    âˆ

  ~-cong-â‚›Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„
                {Ï•â‚ Ï•â‚' : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚}
                {Ï•â‚‚ Ï•â‚‚' : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ}
              â†’ Ï•â‚ ~ Ï•â‚'
              â†’ Ï•â‚‚ ~ Ï•â‚‚'
              â†’ (Ï•â‚ â‚›Â· Ï•â‚‚) ~ (Ï•â‚' â‚›Â· Ï•â‚‚')
  ~-cong-â‚›Â· â¦ƒ ğ•‚â‚‚ â¦„ {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' m x =
    apâ‚– (Ï•â‚  â‚›Â· Ï•â‚‚ ) m x                 â‰¡âŸ¨âŸ©
    apâ‚– (post Ï•â‚ (Î» _ t â†’ t â‹¯ Ï•â‚‚)) m x   â‰¡âŸ¨ apâ‚–-post Ï•â‚ (Î» _ t â†’ t â‹¯ Ï•â‚‚) x âŸ©
    apâ‚– Ï•â‚  m x â‹¯ Ï•â‚‚                     â‰¡âŸ¨ ~-cong-â‹¯ (apâ‚– Ï•â‚  m x) Ï•â‚‚~Ï•â‚‚' âŸ©
    apâ‚– Ï•â‚  m x â‹¯ Ï•â‚‚'                    â‰¡âŸ¨ cong (_â‹¯ Ï•â‚‚') (Ï•â‚~Ï•â‚' m x) âŸ©
    apâ‚– Ï•â‚' m x â‹¯ Ï•â‚‚'                    â‰¡âŸ¨ sym (apâ‚–-post Ï•â‚' (Î» _ t â†’ t â‹¯ Ï•â‚‚') x) âŸ©
    apâ‚– (post Ï•â‚' (Î» _ t â†’ t â‹¯ Ï•â‚‚')) m x â‰¡âŸ¨âŸ©
    apâ‚– (Ï•â‚' â‚›Â· Ï•â‚‚') m x                 âˆ

  tm-â‹¯-â‚›Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
              (Ï•â‚ : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚)
              (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              (x : Âµâ‚ âˆ‹ m)
            â†’ `/id â¦ƒ kitâ‚› â¦„ _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚ â‰¡ `/id â¦ƒ kitâ‚› â¦„ _ (apâ‚– (Ï•â‚ â‚›Â· Ï•â‚‚) _ x)
  tm-â‹¯-â‚›Â· â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} Ï•â‚ Ï•â‚‚ x =
    `/id â¦ƒ kitâ‚› â¦„ _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚    â‰¡âŸ¨âŸ©
    (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚                          â‰¡âŸ¨ sym (apâ‚–-post Ï•â‚ (Î» _ t â†’ t â‹¯ Ï•â‚‚) x) âŸ©
    apâ‚– (Ï•â‚ â‚›Â· Ï•â‚‚) _ x                         â‰¡âŸ¨âŸ©
    `/id â¦ƒ kitâ‚› â¦„ _ (apâ‚– (Ï•â‚ â‚›Â· Ï•â‚‚) _ x) âˆ

  -- ap/â‹¯-wkâ‚› : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx}
  --             (Ï• : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚)
  --             (x : Âµâ‚ âˆ‹ mx)
  --           â†’ ((apâ‚– Ï• _ x) â‹¯ (wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m id)) â‰¡ Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitâ‚› â¦„ â¦„ (wk _ (apâ‚– Ï• _ x))
  -- ap/â‹¯-wkâ‚› â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx} Ï• x =
  --   apâ‚– Ï• _ x â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ _ id                  â‰¡âŸ¨ {!refl!} âŸ©
  --   apâ‚– Ï• _ x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id               â‰¡âŸ¨âŸ©
  --   wk _ (apâ‚– Ï• _ x)                                â‰¡âŸ¨ sym (Î¹-wk â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitâ‚› â¦„ â¦„ {m = m} (apâ‚– Ï• _ x)) âŸ©
  --   Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitâ‚› â¦„ â¦„ (wk _ (apâ‚– Ï• _ x)) âˆ

  -- OLD TODO: generalize kitáµ£ to arbitrary kits and include â¦…â¦† lemmas.
  record WkDistKit {ğ•‚â‚ ğ•‚â‚‚ ğ•‚ : Kit} (Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚) (Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚) : Setâ‚ where
    private instance _ = ğ•‚â‚; _ = ğ•‚â‚‚; _ = ğ•‚; _ = Câ‚; _ = Câ‚‚
    field
      â†‘-wk :
        âˆ€ {Âµâ‚} {Âµâ‚‚} m
          (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
        â†’ (Ï• Â·[ Câ‚ ] wkâ‚– _ id) ~ (wkâ‚– _ id Â·[ Câ‚‚ ] (Ï• â†‘ m))

    dist-â†‘-f : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id â‹¯ (Ï• â†‘ m) â‰¡ t â‹¯ Ï• â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id
    dist-â†‘-f t Ï• =
      (t â‹¯ wkâ‚– _ id) â‹¯ (Ï• â†‘ _)       â‰¡âŸ¨ â‹¯-assoc t (wkâ‚– _ id) (Ï• â†‘ _)  âŸ©
      t â‹¯ (wkâ‚– _ id Â·[ Câ‚‚ ] (Ï• â†‘ _)) â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (â†‘-wk _ Ï•)) âŸ©
      t â‹¯ (Ï• Â·[ Câ‚ ] wkâ‚– _ id)       â‰¡âŸ¨ sym (â‹¯-assoc t Ï• (wkâ‚– _ id)) âŸ©
      (t â‹¯ Ï•) â‹¯ wkâ‚– _ id             âˆ

  open WkDistKit â¦ƒ â€¦ â¦„

  apâ‚–-wk-â†‘ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {mx}
          (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) m
          (x : Âµâ‚ âˆ‹ mx)
        â†’ apâ‚– (wkâ‚– _ id áµ£Â· (Ï• â†‘ m)) _ x â‰¡ wk _ (apâ‚– Ï• _ x)
  apâ‚–-wk-â†‘ {Âµâ‚} {Âµâ‚‚} Ï• m x =
    apâ‚– (wkâ‚– _ id áµ£Â· (Ï• â†‘ m)) _ x      â‰¡âŸ¨ apâ‚–-pre (Ï• â†‘ m) (apâ‚– (wkâ‚– _ id)) x âŸ©
    apâ‚– (Ï• â†‘ m) _ (apâ‚– (wkâ‚– _ id) _ x) â‰¡âŸ¨ cong (apâ‚– (Ï• â†‘ m) _) (apâ‚–-wkâ‚–-wk id x) âŸ©
    apâ‚– (Ï• â†‘ m) _ (there (apâ‚– id _ x)) â‰¡âŸ¨ cong (Î» â–  â†’ apâ‚– (Ï• â†‘ m) _ (there â– )) (apâ‚–-id x) âŸ©
    apâ‚– (Ï• â†‘ m) _ (there x)            â‰¡âŸ¨ apâ‚–-â†‘-there Ï• x âŸ©
    wk _ (apâ‚– Ï• _ x)                   âˆ

  apâ‚–-wk-â†‘' : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {mx}
          (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) m
          (x : Âµâ‚ âˆ‹ mx)
        â†’ apâ‚– (wkâ‚– _ id â‚›Â· (Ï• â†‘ m)) _ x â‰¡ `/id _ (wk _ (apâ‚– Ï• _ x))
  apâ‚–-wk-â†‘' {Âµâ‚} {Âµâ‚‚} Ï• m x =
    apâ‚– (wkâ‚– _ id â‚›Â· (Ï• â†‘ m)) _ x                â‰¡âŸ¨ apâ‚–-post (wkâ‚– _ id) (Î» _ t â†’ t â‹¯ (Ï• â†‘ m)) x âŸ©
    (apâ‚– (wkâ‚– _ id) _ x) â‹¯ (Ï• â†‘ m)               â‰¡âŸ¨ cong (_â‹¯ (Ï• â†‘ m)) (apâ‚–-wkâ‚–-wk id x) âŸ©
    wk _ (apâ‚– id _ x) â‹¯ (Ï• â†‘ m)                  â‰¡âŸ¨ cong (Î» â–  â†’ wk â¦ƒ kitâ‚› â¦„ _ â–  â‹¯ (Ï• â†‘ m)) (apâ‚–-id x) âŸ©
    wk _ (` x) â‹¯ (Ï• â†‘ m)                         â‰¡âŸ¨ cong (_â‹¯ Ï• â†‘ m) (sym (Î¹-wk â¦ƒ âŠ‘-áµ£â‚› â¦„ {m = m} x)) âŸ©
    ` there x â‹¯ (Ï• â†‘ m)                          â‰¡âŸ¨ â‹¯-var (there x) (Ï• â†‘ m) âŸ©
    `/id _ (apâ‚– (Ï• â†‘ m) _ (there x))             â‰¡âŸ¨ cong (`/id _) (apâ‚–-â†‘-there Ï• x) âŸ©
    `/id _ (wk _ (apâ‚– Ï• _ x))                    âˆ

  â†‘-wkáµ£ : âˆ€ {Âµâ‚} {Âµâ‚‚} m
            (Ï• : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
          â†’ (Ï• áµ£Â· wkâ‚– _ id) ~ (wkâ‚– _ id áµ£Â· (Ï• â†‘ m))
  â†‘-wkáµ£ {Âµâ‚} {Âµâ‚‚} m Ï• mx x =
    apâ‚– (Ï• áµ£Â· wkâ‚– _ id) _ x            â‰¡âŸ¨ apâ‚–-pre (wkâ‚– _ id) (apâ‚– Ï•) x âŸ©
    apâ‚– (wkâ‚– _ id) _ (apâ‚– Ï• _ x)       â‰¡âŸ¨ apâ‚–-wkâ‚–-wk id (apâ‚– Ï• _ x) âŸ©
    wk _ (apâ‚– id _ (apâ‚– Ï• _ x))        â‰¡âŸ¨ cong (wk _) (apâ‚–-id (apâ‚– Ï• _ x)) âŸ©
    wk _ (apâ‚– Ï• _ x)                   â‰¡âŸ¨ sym (apâ‚–-wk-â†‘ Ï• m x) âŸ©
    apâ‚– (wkâ‚– _ id áµ£Â· (Ï• â†‘ m)) _ x      âˆ

  wkkitáµ£áµ£ : WkDistKit ckitáµ£ ckitáµ£
  wkkitáµ£áµ£ = record { â†‘-wk = â†‘-wkáµ£ }

  private instance _ = wkkitáµ£áµ£

  â†‘-wkâ‚› : âˆ€ {Âµâ‚} {Âµâ‚‚} m
            (Ï• : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚)
          â†’ (Ï• â‚›Â·áµ£ wkâ‚– _ id) ~ (wkâ‚– _ id áµ£Â· (Ï• â†‘ m))
  â†‘-wkâ‚› {Âµâ‚} {Âµâ‚‚} m Ï• mx x =
    apâ‚– (Ï• â‚›Â· wkâ‚– _ id) _ x            â‰¡âŸ¨ apâ‚–-post Ï• (Î» _ t â†’ t â‹¯ wkâ‚– _ id) x âŸ©
    apâ‚– Ï• _ x â‹¯áµ£ wkâ‚– _ id              â‰¡âŸ¨âŸ©
    wk _ (apâ‚– Ï• _ x)                   â‰¡âŸ¨ sym (apâ‚–-wk-â†‘ Ï• m x) âŸ©
    apâ‚– (wkâ‚– _ id áµ£Â· (Ï• â†‘ m)) _ x      âˆ

  dist-â†‘-Â·' : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ â¦ƒ C : ComposeKit ğ•‚â‚‚ kitáµ£ ğ•‚â‚‚ â¦„ â¦ƒ W : WkDistKit C ckitáµ£ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m
                (Ï•â‚ : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              â†’ ((Ï•â‚ â‚›Â· Ï•â‚‚) â†‘ m) ~ ((Ï•â‚ â†‘ m) â‚›Â· (Ï•â‚‚ â†‘ m))
  dist-â†‘-Â·' â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ â¦ƒ W â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(here refl) =
    apâ‚– ((Ï•â‚ â‚›Â· Ï•â‚‚) â†‘ m) _ x                             â‰¡âŸ¨ apâ‚–-â†‘-here (Ï•â‚ â‚›Â· Ï•â‚‚) âŸ©
    ` here refl                                          â‰¡âŸ¨ sym (id/`/id _) âŸ©
    `/id â¦ƒ ğ•‚â‚‚ â¦„ _ (id/` _ (here refl))                   â‰¡âŸ¨ cong (`/id _) (sym (apâ‚–-â†‘-here Ï•â‚‚)) âŸ©
    `/id _ (apâ‚– (Ï•â‚‚ â†‘ m) _ (here refl))  â‰¡âŸ¨ sym (â‹¯-var (here refl) (Ï•â‚‚ â†‘ m)) âŸ©
    (` here refl) â‹¯ (Ï•â‚‚ â†‘ m)                             â‰¡âŸ¨ cong (_â‹¯ Ï•â‚‚ â†‘ m) (sym (apâ‚–-â†‘-here Ï•â‚)) âŸ©
    _â‹¯_ â¦ƒ ğ•‚â‚‚ â¦„ (apâ‚– (Ï•â‚ â†‘ m) _ x) (Ï•â‚‚ â†‘ m) â‰¡âŸ¨ sym (apâ‚–-post (Ï•â‚ â†‘ m) (Î» _ t â†’ t â‹¯ (Ï•â‚‚ â†‘ m)) x) âŸ©
    apâ‚– ((Ï•â‚ â†‘ m) â‚›Â· (Ï•â‚‚ â†‘ m)) _ x                       âˆ
  dist-â†‘-Â·' â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ â¦ƒ W â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(there y) =
    apâ‚– ((Ï•â‚ â‚›Â· Ï•â‚‚) â†‘ m) _ x                             â‰¡âŸ¨ apâ‚–-â†‘-there (Ï•â‚ â‚›Â· Ï•â‚‚) y âŸ©
    wk _ (apâ‚– (Ï•â‚ â‚›Â· Ï•â‚‚) _ y)                            â‰¡âŸ¨ cong (wk _) (apâ‚–-post Ï•â‚ (Î» _ t â†’ t â‹¯ Ï•â‚‚) y) âŸ©
    wk _ (apâ‚– Ï•â‚ _ y â‹¯ Ï•â‚‚)                               â‰¡âŸ¨âŸ©
    apâ‚– Ï•â‚ _ y â‹¯ Ï•â‚‚ â‹¯áµ£ wkâ‚– _ id                          â‰¡âŸ¨ â‹¯-assoc â¦ƒ ğ”¸ = C â¦„ (apâ‚– Ï•â‚ _ y) Ï•â‚‚ (wkâ‚– _ id) âŸ©
    apâ‚– Ï•â‚ _ y â‹¯ (ComposeKit._Â·â‚–_ C Ï•â‚‚ (wkâ‚– _ id))       â‰¡âŸ¨ ~-cong-â‹¯ (apâ‚– Ï•â‚ _ y) (WkDistKit.â†‘-wk W m Ï•â‚‚) âŸ©
    apâ‚– Ï•â‚ _ y â‹¯ (_áµ£Â·_ â¦ƒ ğ•‚â‚‚ â¦„ (wkâ‚– _ id) (Ï•â‚‚ â†‘ m))       â‰¡âŸ¨ sym (â‹¯-assoc (apâ‚– Ï•â‚ _ y) (wkâ‚– _ id) (Ï•â‚‚ â†‘ m)) âŸ©
    apâ‚– Ï•â‚ _ y â‹¯áµ£ wkâ‚– _ id â‹¯ (Ï•â‚‚ â†‘ m)                    â‰¡âŸ¨âŸ©
    wk _ (apâ‚– Ï•â‚ _ y) â‹¯ (Ï•â‚‚ â†‘ m)                         â‰¡âŸ¨ cong (_â‹¯ Ï•â‚‚ â†‘ m) (sym (apâ‚–-â†‘-there Ï•â‚ y)) âŸ©
    _â‹¯_ â¦ƒ ğ•‚â‚‚ â¦„ (apâ‚– (Ï•â‚ â†‘ m) _ x) (Ï•â‚‚ â†‘ m) â‰¡âŸ¨ sym (apâ‚–-post (Ï•â‚ â†‘ m) (Î» _ t â†’ t â‹¯ (Ï•â‚‚ â†‘ m)) x) âŸ©
    apâ‚– ((Ï•â‚ â†‘ m) â‚›Â· (Ï•â‚‚ â†‘ m)) _ x                       âˆ

  ap/â‹¯-apâ‚› : âˆ€ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
             â†’ let subâ‚ = subst (Âµâ‚‚ âŠ¢_) (Î¹-id/mâ†’M â¦ƒ âŠ‘â‚–-refl â¦ƒ kitâ‚› â¦„ â¦„ m) in
               let subâ‚‚ = subst (Âµâ‚‚ âŠ¢_) (Î¹-id/mâ†’M â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ â¦„ m) in
               subâ‚ (` x â‹¯ Ï•) â‰¡ subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ â¦„ (apâ‚– Ï• _ x))
  ap/â‹¯-apâ‚› â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} x Ï• =
    let sub = subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) in
    ` x â‹¯ Ï•                                     â‰¡âŸ¨ â‹¯-var x Ï• âŸ©
    `/id _ (apâ‚– Ï• _ x)                          â‰¡âŸ¨ `/idâ‰¡`/id' (apâ‚– Ï• _ x) âŸ©
    sub (`/id' _ (apâ‚– Ï• _ x))                   â‰¡âŸ¨âŸ©
    sub (Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ â¦„ (apâ‚– Ï• _ x)) âˆ

  ckitâ‚›áµ£ : ComposeKit kitâ‚› kitáµ£ kitâ‚›
  ckitâ‚›áµ£ = record
    { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-refl â¦ƒ kitâ‚› â¦„ 
    ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitáµ£ â¦„
    ; _ap/â‹¯_      = Î» t Ï• â†’ t â‹¯ Ï•
    ; ap/â‹¯-â‹¯      = Î» x/t Ï• â†’ refl
    ; ap/â‹¯-ap     = ap/â‹¯-apâ‚›
    ; _Â·â‚–_        = _â‚›Â·_
    ; ap/â‹¯-Â·â‚–     = â‹¯-â‚›Â·
    -- ; ap/â‹¯-wk     = ap/â‹¯-wkâ‚›
    ; tm-â‹¯-Â·      = tm-â‹¯-â‚›Â·
    ; dist-â†‘-Â·    = dist-â†‘-Â·' â¦ƒ W = wkkitáµ£áµ£ â¦„
    ; ~-cong-Â·    = ~-cong-â‚›Â·
    ; ~-cong-ap/â‹¯ = Î» { refl Ï•â‚~Ï•â‚‚ â†’ ~-cong-â‹¯ _ Ï•â‚~Ï•â‚‚ }
    }

  private instance _ = ckitâ‚›áµ£

  wkkitâ‚›áµ£ : WkDistKit ckitâ‚›áµ£ ckitáµ£
  wkkitâ‚›áµ£ = record { â†‘-wk = â†‘-wkâ‚› }

  private instance _ = wkkitâ‚›áµ£

  ckitâ‚›â‚› : ComposeKit kitâ‚› kitâ‚› kitâ‚›
  ckitâ‚›â‚› = record
    { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-refl â¦ƒ kitâ‚› â¦„ 
    ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitâ‚› â¦„
    ; _ap/â‹¯_      = Î» t Ï• â†’ t â‹¯ Ï•
    ; ap/â‹¯-â‹¯      = Î» x/t Ï• â†’ refl
    ; ap/â‹¯-ap     = ap/â‹¯-apâ‚›
    ; _Â·â‚–_        = _â‚›Â·_
    ; ap/â‹¯-Â·â‚–     = â‹¯-â‚›Â·
    ; tm-â‹¯-Â·      = tm-â‹¯-â‚›Â·
    ; dist-â†‘-Â·    = dist-â†‘-Â·' â¦ƒ W = wkkitâ‚›áµ£ â¦„
    ; ~-cong-Â·    = ~-cong-â‚›Â·
    ; ~-cong-ap/â‹¯ = Î» { refl Ï•â‚~Ï•â‚‚ â†’ ~-cong-â‹¯ _ Ï•â‚~Ï•â‚‚ }
    }

  private instance _ = ckitâ‚›â‚›

  --------------------------------------------------------------------------------

  â†‘-wkáµ£â‚› : âˆ€ {Âµâ‚} {Âµâ‚‚} m
            (Ï• : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
          â†’ (Ï• áµ£Â·â‚› wkâ‚– _ id) ~ (wkâ‚– _ id â‚›Â·áµ£ (Ï• â†‘ m))
  â†‘-wkáµ£â‚› {Âµâ‚} {Âµâ‚‚} m Ï• mx x =
    apâ‚– (Ï• áµ£Â· wkâ‚– _ id) _ x            â‰¡âŸ¨ apâ‚–-pre (wkâ‚– _ id) (apâ‚– Ï•) x âŸ©
    apâ‚– (wkâ‚– _ id) _ (apâ‚– Ï• _ x)       â‰¡âŸ¨ apâ‚–-wkâ‚–-wk id (apâ‚– Ï• _ x) âŸ©
    wk _ (apâ‚– id _ (apâ‚– Ï• _ x))        â‰¡âŸ¨ cong (wk _) (apâ‚–-id (apâ‚– Ï• _ x)) âŸ©
    wk _ (` apâ‚– Ï• _ x)                 â‰¡âŸ¨ sym (Î¹-wk â¦ƒ âŠ‘-áµ£â‚› â¦„ {m = m} (apâ‚– Ï• _ x)) âŸ©
    ` there (apâ‚– Ï• _ x)                â‰¡âŸ¨âŸ©
    `/id _ (wk _ (apâ‚– Ï• _ x))          â‰¡âŸ¨ sym (apâ‚–-wk-â†‘' Ï• _ x)  âŸ©
    apâ‚– (wkâ‚– _ id â‚›Â·áµ£ (Ï• â†‘ m)) _ x      âˆ

  wkkitáµ£â‚› : WkDistKit ckitáµ£ ckitâ‚›áµ£ 
  wkkitáµ£â‚› = record { â†‘-wk = â†‘-wkáµ£â‚› }

  private instance _ = wkkitáµ£â‚›

  --------------------------------------------------------------------------------

  â†‘-wkâ‚›â‚› : âˆ€ {Âµâ‚} {Âµâ‚‚} m
            (Ï• : Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚‚)
          â†’ (Ï• â‚›Â·â‚› wkâ‚– _ id) ~ (wkâ‚– _ id â‚›Â·â‚› (Ï• â†‘ m))
  â†‘-wkâ‚›â‚› {Âµâ‚} {Âµâ‚‚} m Ï• mx x =
    apâ‚– (Ï• â‚›Â· wkâ‚– _ id) _ x            â‰¡âŸ¨ apâ‚–-post Ï• (Î» _ t â†’ t â‹¯ wkâ‚– _ id) x âŸ©
    apâ‚– Ï• _ x â‹¯â‚› wkâ‚– _ id              â‰¡âŸ¨ â‹¯-x/t-wk' â¦ƒ kitâ‚› â¦„ (apâ‚– Ï• _ x) âŸ©
    apâ‚– Ï• _ x â‹¯áµ£ wkâ‚– _ id              â‰¡âŸ¨âŸ©
    wk _ (apâ‚– Ï• _ x)                   â‰¡âŸ¨âŸ©
    `/id _ (wk _ (apâ‚– Ï• _ x))          â‰¡âŸ¨ sym (apâ‚–-wk-â†‘' â¦ƒ kitâ‚› â¦„ Ï• _ x)  âŸ©
    apâ‚– (wkâ‚– _ id â‚›Â·â‚› (Ï• â†‘ m)) _ x     âˆ

  wkkitâ‚›â‚› : WkDistKit ckitâ‚›â‚› ckitâ‚›â‚› 
  wkkitâ‚›â‚› = record { â†‘-wk = â†‘-wkâ‚›â‚› }

  private instance _ = wkkitâ‚›â‚›

  --------------------------------------------------------------------------------

  âˆ˜~âˆ˜â†’â‹¯â‰¡â‹¯ : âˆ€ {{ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚' ğ•‚â‚‚' ğ•‚ : Kit}}
              {{ğ”¸  : ComposeKit ğ•‚â‚  ğ•‚â‚‚  ğ•‚}}
              {{ğ”¸' : ComposeKit ğ•‚â‚' ğ•‚â‚‚' ğ•‚}}
              {Ï•â‚  : Âµâ‚ â€“[ ğ•‚â‚  ]â†’ Âµâ‚‚ } {Ï•â‚‚  : Âµâ‚‚  â€“[ ğ•‚â‚‚  ]â†’ Âµâ‚ƒ}
              {Ï•â‚' : Âµâ‚ â€“[ ğ•‚â‚' ]â†’ Âµâ‚‚'} {Ï•â‚‚' : Âµâ‚‚' â€“[ ğ•‚â‚‚' ]â†’ Âµâ‚ƒ} â†’
    (Ï•â‚ Â·[ ğ”¸ ] Ï•â‚‚) ~ (Ï•â‚' Â·[ ğ”¸' ] Ï•â‚‚') â†’
    âˆ€ {M} (t : Âµâ‚ âŠ¢ M) â†’
    t â‹¯ Ï•â‚ â‹¯ Ï•â‚‚ â‰¡ t â‹¯ Ï•â‚' â‹¯ Ï•â‚‚'
  âˆ˜~âˆ˜â†’â‹¯â‰¡â‹¯ â¦ƒ ğ”¸ = ğ”¸ â¦„ â¦ƒ ğ”¸' â¦„ {Ï•â‚ = Ï•â‚} {Ï•â‚‚ = Ï•â‚‚} {Ï•â‚' = Ï•â‚'} {Ï•â‚‚' = Ï•â‚‚'} eq t =
    t â‹¯ Ï•â‚ â‹¯ Ï•â‚‚         â‰¡âŸ¨ â‹¯-assoc t Ï•â‚ Ï•â‚‚ âŸ©
    t â‹¯ Ï•â‚  Â·[ ğ”¸  ] Ï•â‚‚  â‰¡âŸ¨ ~-cong-â‹¯ t eq âŸ©
    t â‹¯ Ï•â‚' Â·[ ğ”¸' ] Ï•â‚‚' â‰¡âŸ¨ sym (â‹¯-assoc t Ï•â‚' Ï•â‚‚') âŸ©
    t â‹¯ Ï•â‚' â‹¯ Ï•â‚‚'  âˆ

  --------------------------------------------------------------------------------

  open WkDistKit wkkitáµ£áµ£ public renaming (dist-â†‘-f to dist-â†‘-ren-wkáµ£) using ()
  open WkDistKit wkkitáµ£â‚› public renaming (dist-â†‘-f to dist-â†‘-ren-wkâ‚›) using ()
  open WkDistKit wkkitâ‚›áµ£ public renaming (dist-â†‘-f to dist-â†‘-sub-wkáµ£) using ()
  open WkDistKit wkkitâ‚›â‚› public renaming (dist-â†‘-f to dist-â†‘-sub-wkâ‚›) using ()

  --------------------------------------------------------------------------------

  wk-cancels-,â‚– : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
                    (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (Ï• ,â‚– x/t) â‰¡ t â‹¯ Î¹-â†’ Ï•
  wk-cancels-,â‚– â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C = C â¦„ t Ï• x/t =
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (Ï• ,â‚– x/t)        â‰¡âŸ¨ â‹¯-assoc â¦ƒ ğ”¸ = C â¦„ t (wkâ‚– _ id) (Ï• ,â‚– x/t) âŸ©
    t â‹¯ (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id Â·[ C ] (Ï• ,â‚– x/t)) â‰¡âŸ¨ ~-cong-â‹¯ _ (wk-cancels-,â‚–-Â· â¦ƒ C â¦„ Ï• x/t) âŸ©
    t â‹¯ Î¹-â†’ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ Ï•                        âˆ

  wkáµ£-cancels-,â‚– : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„
                     (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– x/t) â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,â‚– = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  wkáµ£-cancels-,áµ£ : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â†’áµ£ Âµâ‚‚) (x : Âµâ‚‚ âˆ‹ m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– x) â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,áµ£ = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  wkáµ£-cancels-,â‚› : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â†’â‚› Âµâ‚‚) (t' : Âµâ‚‚ âŠ¢ mâ†’M m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– t') â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,â‚› = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  -- TODO: those Î¹-â†’ are (Ï• Â· idâ‚›) and annoying. We could get rid of them with heterogeneous homotopies.

  wkâ‚›-cancels-,áµ£ : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â†’áµ£ Âµâ‚‚) (x : Âµâ‚‚ âˆ‹ m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ (Ï• ,â‚– x) â‰¡ t â‹¯ Î¹-â†’ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitáµ£ â¦„ â¦„ Ï•
  wkâ‚›-cancels-,áµ£ t Ï• x = wk-cancels-,â‚– â¦ƒ C = ckitâ‚›áµ£ â¦„ t Ï• x

  wkâ‚›-cancels-,â‚› : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï• : Âµâ‚ â†’â‚› Âµâ‚‚) (t' : Âµâ‚‚ âŠ¢ mâ†’M m) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ (Ï• ,â‚– t') â‰¡ t â‹¯ Î¹-â†’ â¦ƒ âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ kitâ‚› â¦„ â¦„ Ï•
  wkâ‚›-cancels-,â‚› t Ï• t' = wk-cancels-,â‚– â¦ƒ C = ckitâ‚›â‚› â¦„ t Ï• t'

  --------------------------------------------------------------------------------

  dist-áµ£Â·áµ£-â¦…â¦† : âˆ€ {Âµâ‚ Âµâ‚‚ m} (x : Âµâ‚ âˆ‹ m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
    (â¦… x â¦† áµ£Â·áµ£ Ï) ~ ((Ï â†‘ m) áµ£Â·áµ£ â¦… apâ‚– Ï _ x â¦†)
  dist-áµ£Â·áµ£-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-â‚›Â·áµ£-â¦…â¦† : âˆ€ {Âµâ‚ Âµâ‚‚ m} (t : Âµâ‚ âŠ¢ mâ†’M m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
    (â¦… t â¦† â‚›Â·áµ£ Ï) ~ ((Ï â†‘ m) áµ£Â·â‚› â¦… t â‹¯ Ï â¦†)
  dist-â‚›Â·áµ£-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-áµ£Â·â‚›-â¦…â¦† : âˆ€ {Âµâ‚ Âµâ‚‚ m} (x : Âµâ‚ âˆ‹ m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
    (â¦… x â¦† áµ£Â·â‚› Ïƒ) ~ ((Ïƒ â†‘ m) â‚›Â·â‚› â¦… apâ‚– Ïƒ _ x â¦†)
  dist-áµ£Â·â‚›-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-â‚›Â·â‚›-â¦…â¦† : âˆ€ {Âµâ‚ Âµâ‚‚ m} (t : Âµâ‚ âŠ¢ mâ†’M m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
    (â¦… t â¦† â‚›Â·â‚› Ïƒ) ~ ((Ïƒ â†‘ m) â‚›Â·â‚› â¦… t â‹¯ Ïƒ â¦†)
  dist-â‚›Â·â‚›-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  --------------------------------------------------------------------------------

  dist-â¦…â¦†-â‹¯ :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚ ğ•‚ â¦„
      {Âµâ‚ Âµâ‚‚ m M}
      (t : (m âˆ· Âµâ‚) âŠ¢ M) (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) â†’
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
    t â‹¯ â¦… x/t â¦† â‹¯ Ï• â‰¡ t â‹¯ (Ï• â†‘ m) â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†
  dist-â¦…â¦†-â‹¯ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {M} t x/t Ï• =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
    t â‹¯ â¦… x/t â¦† â‹¯ Ï•                                  â‰¡âŸ¨ â‹¯-assoc t â¦… x/t â¦† Ï• âŸ©
    t â‹¯ (â¦… x/t â¦† Â·[ Câ‚ ] Ï•)                          â‰¡âŸ¨ ~-cong-â‹¯ t (dist-â†‘-â¦…â¦†-Â· x/t Ï•) âŸ©
    t â‹¯ ((Ï• â†‘ m) Â·[ Câ‚‚ ] â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) â‰¡âŸ¨ sym (â‹¯-assoc t (Ï• â†‘ m) â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†) âŸ©
    t â‹¯ (Ï• â†‘ m) â‹¯ â¦… sub (x/t ap/â‹¯[ Câ‚ ] Ï•) â¦†         âˆ

  dist-â¦…â¦†áµ£-â‹¯áµ£ : âˆ€ {Âµâ‚ Âµâ‚‚ m M} (t : (m âˆ· Âµâ‚) âŠ¢ M) (x : Âµâ‚ âˆ‹ m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
    t â‹¯ â¦… x â¦† â‹¯ Ï â‰¡ t â‹¯ (Ï â†‘ m) â‹¯ â¦… apâ‚– Ï _ x â¦†
  dist-â¦…â¦†áµ£-â‹¯áµ£ = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†â‚›-â‹¯áµ£ : âˆ€ {Âµâ‚ Âµâ‚‚ m M} (t : (m âˆ· Âµâ‚) âŠ¢ M) (t' : Âµâ‚ âŠ¢ mâ†’M m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
    t â‹¯ â¦… t' â¦† â‹¯ Ï â‰¡ t â‹¯ (Ï â†‘ m) â‹¯ â¦… t' â‹¯ Ï â¦†
  dist-â¦…â¦†â‚›-â‹¯áµ£ = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†áµ£-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m M} (t : (m âˆ· Âµâ‚) âŠ¢ M) (x : Âµâ‚ âˆ‹ m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
    t â‹¯ â¦… x â¦† â‹¯ Ïƒ â‰¡ t â‹¯ (Ïƒ â†‘ m) â‹¯ â¦… apâ‚– Ïƒ _ x â¦†
  dist-â¦…â¦†áµ£-â‹¯â‚› = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†â‚›-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m M} (t : (m âˆ· Âµâ‚) âŠ¢ M) (t' : Âµâ‚ âŠ¢ mâ†’M m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
    t â‹¯ â¦… t' â¦† â‹¯ Ïƒ â‰¡ t â‹¯ (Ïƒ â†‘ m) â‹¯ â¦… t' â‹¯ Ïƒ â¦†
  dist-â¦…â¦†â‚›-â‹¯â‚› = dist-â¦…â¦†-â‹¯

  --------------------------------------------------------------------------------

  record ComposeTraversalLemmas : Setâ‚ where
    field
      â‹¯-id : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµ} {M} (t : Âµ âŠ¢ M) â†’ t â‹¯ id â¦ƒ ğ•‚ = ğ•‚ â¦„ â‰¡ t

    â‹¯-idâ‚› : âˆ€ {Âµ M} (t : Âµ âŠ¢ M) â†’ t â‹¯ id â¦ƒ ğ•‚ = kitâ‚› â¦„ â‰¡ t
    â‹¯-idáµ£ : âˆ€ {Âµ M} (t : Âµ âŠ¢ M) â†’ t â‹¯ id â¦ƒ ğ•‚ = kitáµ£ â¦„ â‰¡ t
    â‹¯-idâ‚› = â‹¯-id
    â‹¯-idáµ£ = â‹¯-id

    -- TODO: We can transfer this from â‹¯-id if we extend ComposeKit with a lemma,
    -- that operations on terms determine operations on ap/â‹¯
    -- We could go even further and say operations on ap/â‹¯ and â‹¯ are determined by
    -- operations on ap. Note that this is precisely what KitAltSimple does!!!!
    ap/â‹¯-id : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ : Kit â¦„
                â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
                {Âµ} {m/M} (x/t : Âµ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M) â†’ x/t ap/â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ â‰¡ Î¹-âˆ‹/âŠ¢ x/t
    ap/â‹¯-id â¦ƒ ğ•‚ â¦„ {Âµ} {M} x/t = {!!}

    -- does not require â‹¯-id if we have heterogenous homotopies.
    renâ†’sub : âˆ€ (t : Âµâ‚ âŠ¢ M) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
              t â‹¯áµ£ Ï â‰¡ t â‹¯â‚› Î¹-â†’ â¦ƒ âŠ‘-áµ£â‚› â¦„ Ï
    renâ†’sub t Ï =
      t â‹¯áµ£ Ï              â‰¡âŸ¨ sym (â‹¯-idâ‚› (t â‹¯áµ£ Ï)) âŸ©
      t â‹¯áµ£ Ï â‹¯â‚› id        â‰¡âŸ¨ â‹¯-assoc t Ï id âŸ©
      t â‹¯â‚› (Ï áµ£Â·â‚› id)     â‰¡âŸ¨âŸ©
      t â‹¯â‚› Î¹-â†’ â¦ƒ âŠ‘-áµ£â‚› â¦„ Ï âˆ

    -- renâ†’sub' : âˆ€ â¦ƒ ğ•‚â‚‚ ğ•‚ : Kit â¦„
    --              â¦ƒ Cáµ£ : ComposeKit â¦ƒ kitáµ£ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦„
    --              â¦ƒ Câ‚› : ComposeKit â¦ƒ kitâ‚› â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦„
    --              (e : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
    --            e ap/â‹¯[ Cáµ£ ] Ï â‰¡ e ap/â‹¯[ Câ‚› ] (idâ‚› â‚›âˆ˜áµ£ Ï)
    -- renâ†’sub' e Ï = {!!}
    --   -- e â‹¯áµ£ Ï           â‰¡âŸ¨ sym (â‹¯-idâ‚› (e â‹¯áµ£ Ï)) âŸ©
    --   -- e â‹¯áµ£ Ï â‹¯â‚› idâ‚›    â‰¡âŸ¨ â‹¯-assoc e Ï id/` âŸ©
    --   -- e â‹¯â‚› (idâ‚› â‚›âˆ˜áµ£ Ï) âˆ

    wk-cancels-â¦…â¦† :
      âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ : Kit â¦„
        â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
        â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚ â¦„
        â¦ƒ _ : WkDistKit Câ‚ Câ‚‚ â¦„ {Âµ M m}
        (t : Âµ âŠ¢ M) (x/t : Âµ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ â¦… x/t â¦† â‰¡ t
    wk-cancels-â¦…â¦† â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ t x/t =
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ â¦… x/t â¦†     â‰¡âŸ¨ ~-cong-â‹¯ (t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id) (â¦…â¦†-,â‚– x/t) âŸ©
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (id ,â‚– x/t) â‰¡âŸ¨ wk-cancels-,â‚– t id x/t âŸ©
      t â‹¯ Î¹-â†’ id                            â‰¡âŸ¨ {!!} âŸ© -- Would be easy with heterogenouos homotopies
      t â‹¯ id                                â‰¡âŸ¨ â‹¯-id t âŸ©
      t                                     âˆ

    wkáµ£-cancels-â¦…â¦†áµ£ : âˆ€ {Âµ M m} (t : Âµ âŠ¢ M) (x : Âµ âˆ‹ m) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ â¦… x â¦†áµ£ â‰¡ t
    wkáµ£-cancels-â¦…â¦†áµ£ = wk-cancels-â¦…â¦†

    wkáµ£-cancels-â¦…â¦†â‚› : âˆ€ {Âµ M m} (t : Âµ âŠ¢ M) (t' : Âµ âŠ¢ mâ†’M m) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ â¦… t' â¦†â‚› â‰¡ t
    wkáµ£-cancels-â¦…â¦†â‚› = wk-cancels-â¦…â¦†

    wkâ‚›-cancels-â¦…â¦†áµ£ : âˆ€ {Âµ M m} (t : Âµ âŠ¢ M) (x : Âµ âˆ‹ m) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ â¦… x â¦†áµ£ â‰¡ t
    wkâ‚›-cancels-â¦…â¦†áµ£ = wk-cancels-â¦…â¦†

    wkâ‚›-cancels-â¦…â¦†â‚› : âˆ€ {Âµ M m} (t : Âµ âŠ¢ M) (t' : Âµ âŠ¢ mâ†’M m) â†’
      t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ â¦… t' â¦†â‚› â‰¡ t
    wkâ‚›-cancels-â¦…â¦†â‚› = wk-cancels-â¦…â¦†

    -- special case of 
    --   dist-,â‚–-Â·Ê³ : âˆ€ {m}
    --                  (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --                  (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    --                  (x/t : Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    --                â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚–' x/t) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ ,â‚– x/t))
    â†‘âˆ˜â¦…â¦†-is-,â‚– :
      âˆ€ â¦ƒ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ m}
        (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
        (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ ((Ï• â†‘ m) Â·â‚– â¦… x/t â¦†) ~ (Ï• ,â‚– x/t)
    â†‘âˆ˜â¦…â¦†-is-,â‚– â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {m} x/t Ï• =
       ((Ï• â†‘ m) Â·â‚– â¦… x/t â¦†)     ~âŸ¨ {!!} âŸ©
       ((Ï• â†‘ m) Â·â‚– (id ,â‚– x/t)) ~âŸ¨ {!!} âŸ©
       (Ï• ,â‚– x/t)               ~âˆ

    -- â†‘âˆ˜â¦…â¦†-is-,â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m} (t : Âµâ‚‚ âŠ¢ mâ†’M m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
    --   â¦… t â¦†â‚› â‚›âˆ˜â‚› (Ïƒ â†‘ m) ~ Ïƒ ,â‚› t
    -- â†‘âˆ˜â¦…â¦†-is-,â‚› t Ïƒ _ (here refl) = â‹¯-var (here refl) â¦… t â¦†
    -- â†‘âˆ˜â¦…â¦†-is-,â‚› t Ïƒ _ (there x)   = wk-cancels-â¦…â¦†â‚› (Ïƒ _ x) t

    â†‘âˆ˜â¦…â¦†-is-,â‚› :
      âˆ€ {Âµâ‚ Âµâ‚‚ m}
        (t : Âµâ‚‚ âŠ¢ mâ†’M m)
        (Ï• : Âµâ‚ â†’â‚› Âµâ‚‚)
      â†’ ((Ï• â†‘ m) Â·â‚– â¦… t â¦†) ~ (Ï• ,â‚– t)
    â†‘âˆ˜â¦…â¦†-is-,â‚› = â†‘âˆ˜â¦…â¦†-is-,â‚–

    â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚– :
      âˆ€ â¦ƒ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ m}
        (t : (Âµâ‚ â–· m) âŠ¢ M)
        (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] id/mâ†’M m)
        (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ t â‹¯ (Ï• â†‘ m) â‹¯ â¦… x/t â¦† â‰¡ t â‹¯ (Ï• ,â‚– x/t)
    â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚– {m = m} t x/t Ï• =
      t â‹¯ (Ï• â†‘ m) â‹¯ â¦… x/t â¦†    â‰¡âŸ¨ â‹¯-assoc t (Ï• â†‘ m) â¦… x/t â¦† âŸ©
      t â‹¯ ((Ï• â†‘ m) Â·â‚– â¦… x/t â¦†) â‰¡âŸ¨ ~-cong-â‹¯ t (â†‘âˆ˜â¦…â¦†-is-,â‚– x/t Ï•) âŸ©
      t â‹¯ (Ï• ,â‚– x/t)           âˆ

    â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚› :
      âˆ€ {Âµâ‚ Âµâ‚‚ m}
        (t : (Âµâ‚ â–· m) âŠ¢ M)
        (t' : Âµâ‚‚ âŠ¢ mâ†’M m)
        (Ï• : Âµâ‚ â†’â‚› Âµâ‚‚)
      â†’ t â‹¯ (Ï• â†‘ m) â‹¯ â¦… t' â¦† â‰¡ t â‹¯ (Ï• ,â‚– t')
    â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚› = â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚–
