open import Kitty.Term.Terms
open import Kitty.Term.Traversal using (Traversal)
open import Kitty.Term.KitHomotopy using (KitHomotopy)
import Kitty.Term.Sub
import Kitty.Term.SubCompose

module Kitty.Term.ComposeTraversal
    {ğ•‹ : Terms}
    {â„“} {ğ•Š : Kitty.Term.Sub.SubWithLaws ğ•‹ â„“}
    {T : Traversal ğ•‹ ğ•Š}
    {H : KitHomotopy T}
    (ğ•ŠC : Kitty.Term.SubCompose.SubCompose H)
  where

open import Data.List using (List; []; _âˆ·_)
open import Data.List.Membership.Propositional using (_âˆˆ_)
open import Data.List.Relation.Unary.Any using (here; there)
open import Level using (Level; _âŠ”_) renaming (suc to lsuc; zero to lzero)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; trans; cong; congâ‚‚; subst; module â‰¡-Reasoning)
open import Relation.Nullary using (Â¬_)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitT T
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open import Kitty.Term.ComposeKit H
open import Kitty.Term.SubCompose H
open import Kitty.Util.SubstProperties

open Terms ğ•‹
open Traversal T
open KitHomotopy H
open Kit â¦ƒ â€¦ â¦„
open SubWithLaws ğ•Š
open Sub SubWithLaws-Sub
open SubCompose ğ•ŠC
open ~-Reasoning
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„
open ComposeKit â¦ƒ â€¦ â¦„

private instance
  _ = kitáµ£
  _ = kitâ‚›
  _ = ckitáµ£
  _ = kittáµ£
  _ = kittâ‚›

private variable
  st                        : SortTy
  s sâ‚ sâ‚‚ sâ‚ƒ s' sâ‚' sâ‚‚' sâ‚ƒ' : Sort st
  S Sâ‚ Sâ‚‚ Sâ‚ƒ S' Sâ‚' Sâ‚‚' Sâ‚ƒ' : SortCtx

-- ComposeTraversal ------------------------------------------------------------

-- If the client provides a `ComposeTraversal` which works for all `ComposeKit`s,
-- they get `â‹¯-assoc` for `_áµ£âˆ˜áµ£_`, `_â‚›âˆ˜áµ£_`, `_áµ£âˆ˜â‚›_`, and `_â‚›âˆ˜â‚›_`.

record ComposeTraversal : Set (lsuc â„“) where
  field
    â‹¯-assoc :
      âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
        {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
        {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
        â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
        â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
        â¦ƒ Wâ‚â‚‚ : KitT ğ•‚ â¦„
        â¦ƒ ğ”¸ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
        (t : Sâ‚ âŠ¢ s) (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) (Ï•â‚‚ : Sâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚ƒ)
      â†’ (t â‹¯ Ï•â‚) â‹¯ Ï•â‚‚ â‰¡ t â‹¯ (Ï•â‚ Â·â‚– Ï•â‚‚)

  -- Example:
  --
  --   instance kit-assoc : ComposeTraversal {{traversal}}
  --   ComposeTraversal.â‹¯-assoc kit-assoc (` x) f g =
  --     tm' (f _ x) â‹¯ g    â‰¡âŸ¨ tm'-â‹¯-âˆ˜ f g x âŸ©
  --     tm' ((g âˆ˜â‚– f) _ x) âˆ
  --   ComposeTraversal.â‹¯-assoc kit-assoc (Î»â†’ e) f g = cong Î»â†’_
  --     (e â‹¯ f â†‘ _ â‹¯ g â†‘ _        â‰¡âŸ¨ â‹¯-assoc e (f â†‘ _) (g â†‘ _) âŸ©
  --      e â‹¯ ((g â†‘ _) âˆ˜â‚– (f â†‘ _)) â‰¡âŸ¨ cong (e â‹¯_) (sym (dist-â†‘-âˆ˜ _ g f)) âŸ©
  --      e â‹¯ (g âˆ˜â‚– f) â†‘ _         âˆ)
  --   ComposeTraversal.â‹¯-assoc kit-assoc (eâ‚ Â· eâ‚‚) f g = congâ‚‚ _Â·_ (â‹¯-assoc eâ‚ f g) (â‹¯-assoc eâ‚‚ f g)

  wk*-wkâ‚–* : 
      âˆ€ (t : S âŠ¢ s) S' â†’
      wk* S' t â‰¡ t â‹¯áµ£ wkâ‚–* S' id
  wk*-wkâ‚–* {S} {s} t [] =
    wk* [] t        â‰¡âŸ¨âŸ©
    t               â‰¡âŸ¨ sym (â‹¯-id t) âŸ©
    t â‹¯áµ£ id         â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (wkâ‚–*-[] id)) âŸ©
    t â‹¯áµ£ wkâ‚–* [] id âˆ
  wk*-wkâ‚–* {S} {s} t (S' â–· s') =
    wk* (S' â–· s') t                â‰¡âŸ¨âŸ©
    wk s' (wk* S' t)               â‰¡âŸ¨ cong (wk s') (wk*-wkâ‚–* t S') âŸ©
    wk s' (t â‹¯áµ£ wkâ‚–* S' id)        â‰¡âŸ¨âŸ©
    t â‹¯áµ£ wkâ‚–* S' id â‹¯áµ£ wkâ‚– s' id   â‰¡âŸ¨ â‹¯-assoc t (wkâ‚–* S' id) (wkâ‚– s' id) âŸ©
    t â‹¯áµ£ (wkâ‚–* S' id Â·â‚– wkâ‚– s' id) â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (wk-Ï•-id (wkâ‚–* S' id))) âŸ©
    t â‹¯áµ£ wkâ‚– s' (wkâ‚–* S' id)       â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (wkâ‚–*-â–· S' s' id)) âŸ©
    t â‹¯áµ£ wkâ‚–* (S' â–· s') id         âˆ

  dist-â†‘-f :
      âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
        {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
        {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚â‚‚ : KitT ğ•‚ â¦„
      (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚)
    â†’ t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id â‹¯ (Ï• â†‘ s) â‰¡ t â‹¯ Ï• â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id
  dist-â†‘-f â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ t Ï• =
    (t â‹¯ wkâ‚– _ id) â‹¯ (Ï• â†‘ _)       â‰¡âŸ¨ â‹¯-assoc t (wkâ‚– _ id) (Ï• â†‘ _)  âŸ©
    t â‹¯ (wkâ‚– _ id Â·[ Câ‚‚ ] (Ï• â†‘ _)) â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (â†‘-wk Ï• _)) âŸ©
    t â‹¯ (Ï• Â·[ Câ‚ ] wkâ‚– _ id)       â‰¡âŸ¨ sym (â‹¯-assoc t Ï• (wkâ‚– _ id)) âŸ©
    (t â‹¯ Ï•) â‹¯ wkâ‚– _ id             âˆ

  -- &/â‹¯-assoc' :
  --   âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚â‚‚,â‚ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„
  --     â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚â‚‚ â¦„
  --     â¦ƒ Câ‚â‚‚,â‚ƒ : ComposeKit ğ•‚â‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚,â‚ƒ â¦„
  --     â¦ƒ Câ‚‚â‚ƒ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚‚â‚ƒ â¦„
  --     â¦ƒ Câ‚,â‚‚â‚ƒ : ComposeKit ğ•‚â‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„
  --     {Sâ‚ Sâ‚‚ Sâ‚ƒ} {s} 
  --     (x/t : Sâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] s) (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) (Ï•â‚‚ : Sâ‚‚ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚ƒ) â†’
  --   `/id ((x/t &/â‹¯[ Câ‚â‚‚ ] Ï•â‚) &/â‹¯[ Câ‚â‚‚,â‚ƒ ] Ï•â‚‚) â‰¡ `/id (x/t &/â‹¯[ Câ‚,â‚‚â‚ƒ ] (Ï•â‚ Â·[ Câ‚‚â‚ƒ ] Ï•â‚‚))
  -- &/â‹¯-assoc' = ?

  -- &/â‹¯-assoc :
  --   âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚â‚‚â‚ƒ â¦„
  --     â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚â‚‚ â¦„
  --     â¦ƒ Câ‚â‚‚,â‚ƒ : ComposeKit ğ•‚â‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚â‚ƒ â¦„
  --     â¦ƒ Câ‚‚â‚ƒ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚‚â‚ƒ â¦„
  --     â¦ƒ Câ‚,â‚‚â‚ƒ : ComposeKit ğ•‚â‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚â‚‚â‚ƒ â¦„
  --     {Sâ‚ Sâ‚‚ Sâ‚ƒ} {s} 
  --     (x/t : Sâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] s) (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) (Ï•â‚‚ : Sâ‚‚ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚ƒ) â†’
  --   (x/t &/â‹¯[ Câ‚â‚‚ ] Ï•â‚) &/â‹¯[ Câ‚â‚‚,â‚ƒ ] Ï•â‚‚ â‰¡ x/t &/â‹¯[ Câ‚,â‚‚â‚ƒ ] (Ï•â‚ Â·[ Câ‚‚â‚ƒ ] Ï•â‚‚)
  -- &/â‹¯-assoc = ?

  Â·-assoc :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢â‚ƒ_ : VarScoped} â¦ƒ ğ•‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚ƒ_ â¦„
      {_âˆ‹/âŠ¢â‚â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚â‚‚ : Kit _âˆ‹/âŠ¢â‚â‚‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚â‚ƒ_ : VarScoped} â¦ƒ ğ•‚â‚‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚‚â‚ƒ_ â¦„
      {_âˆ‹/âŠ¢â‚â‚‚,â‚ƒ_ : VarScoped} â¦ƒ ğ•‚â‚â‚‚,â‚ƒ : Kit _âˆ‹/âŠ¢â‚â‚‚,â‚ƒ_ â¦„
      {_âˆ‹/âŠ¢â‚,â‚‚â‚ƒ_ : VarScoped} â¦ƒ ğ•‚â‚,â‚‚â‚ƒ : Kit _âˆ‹/âŠ¢â‚,â‚‚â‚ƒ_ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚ƒ : KitT ğ•‚â‚ƒ â¦„
      â¦ƒ Wâ‚â‚‚ : KitT ğ•‚â‚â‚‚ â¦„
      â¦ƒ Wâ‚‚â‚ƒ : KitT ğ•‚â‚‚â‚ƒ â¦„
      â¦ƒ Wâ‚â‚‚,â‚ƒ : KitT ğ•‚â‚â‚‚,â‚ƒ â¦„
      â¦ƒ Wâ‚,â‚‚â‚ƒ : KitT ğ•‚â‚,â‚‚â‚ƒ â¦„
      â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚â‚‚ â¦„
      â¦ƒ Câ‚â‚‚,â‚ƒ : ComposeKit ğ•‚â‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚,â‚ƒ â¦„
      â¦ƒ Câ‚‚â‚ƒ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚‚â‚ƒ â¦„
      â¦ƒ Câ‚,â‚‚â‚ƒ : ComposeKit ğ•‚â‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„
      {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} {Sâ‚„}
      (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚)
      (Ï•â‚‚ : Sâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚ƒ)
      (Ï•â‚ƒ : Sâ‚ƒ â€“[ ğ•‚â‚ƒ ]â†’ Sâ‚„)
    â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ) ~ (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ))
  Â·-assoc â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚ƒ â¦„ â¦ƒ ğ•‚â‚â‚‚ â¦„ â¦ƒ ğ•‚â‚‚â‚ƒ â¦„ â¦ƒ ğ•‚â‚â‚‚,â‚ƒ â¦„ â¦ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„ â¦ƒ Câ‚â‚‚ â¦„ â¦ƒ Câ‚â‚‚,â‚ƒ â¦„ â¦ƒ Câ‚‚â‚ƒ â¦„ â¦ƒ Câ‚,â‚‚â‚ƒ â¦„
          {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} {Sâ‚„} Ï•â‚ Ï•â‚‚ Ï•â‚ƒ = mk-~ Î» s x â†’
    `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ))                     â‰¡âŸ¨ sym (â‹¯-var x ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ)) âŸ©
    ` x â‹¯ ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ)                          â‰¡âŸ¨ sym (â‹¯-assoc (` x) (Ï•â‚ Â·â‚– Ï•â‚‚) Ï•â‚ƒ) âŸ©
    ` x â‹¯ (Ï•â‚ Â·â‚– Ï•â‚‚) â‹¯ Ï•â‚ƒ                             â‰¡âŸ¨ sym (cong (_â‹¯ Ï•â‚ƒ) (â‹¯-assoc (` x) Ï•â‚ Ï•â‚‚)) âŸ©
    ` x â‹¯ Ï•â‚ â‹¯ Ï•â‚‚ â‹¯ Ï•â‚ƒ                                â‰¡âŸ¨ â‹¯-assoc (` x â‹¯ Ï•â‚) Ï•â‚‚ Ï•â‚ƒ âŸ©
    ` x â‹¯ Ï•â‚ â‹¯ (Ï•â‚‚ Â·â‚– Ï•â‚ƒ)                             â‰¡âŸ¨ â‹¯-assoc (` x) Ï•â‚ (Ï•â‚‚ Â·â‚– Ï•â‚ƒ) âŸ©
    ` x â‹¯ (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ))                          â‰¡âŸ¨ â‹¯-var x (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ)) âŸ©
    `/id (x & (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ)))                     âˆ

  â†‘*-wk* :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚ â¦„
      â¦ƒ Câ‚â‚ : ComposeKit ğ•‚â‚ ğ•‚â‚ ğ•‚â‚ â¦„
      â¦ƒ Câ‚‚â‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚‚ ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚ƒâ‚ƒ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ Cxâ‚ : ComposeKit ğ•‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Cxâ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      â¦ƒ W  : KitT ğ•‚ â¦„
      {Sâ‚} {Sâ‚‚} (Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚) S
    â†’ (Ï• Â·[ Câ‚ ] wkâ‚–* S id) ~ (wkâ‚–* S id Â·[ Câ‚‚ ] (Ï• â†‘* S))
  â†‘*-wk* â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Sâ‚ = Sâ‚} {Sâ‚‚} Ï• [] =
    (Ï• Â·[ Câ‚ ] wkâ‚–* [] id)         ~âŸ¨ ~-cong-Â· ~-refl (wkâ‚–*-[] id) âŸ©
    (Ï• Â·[ Câ‚ ] id)                 ~âŸ¨ Â·-idÊ³ Ï• âŸ©
    Ï•                              ~âŸ¨ ~-sym (Â·-idË¡ Ï•) âŸ©
    (id Â·[ Câ‚‚ ] Ï•)                 ~âŸ¨ ~-sym (~-cong-Â· (wkâ‚–*-[] id) (â†‘*-[] Ï•)) âŸ©
    (wkâ‚–* [] id Â·[ Câ‚‚ ] (Ï• â†‘* [])) ~âˆ
  â†‘*-wk* â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ â¦ƒ Câ‚â‚ â¦„ â¦ƒ Câ‚‚â‚‚ â¦„ â¦ƒ Câ‚ƒâ‚ƒ â¦„ â¦ƒ Cxâ‚ â¦„ â¦ƒ Cxâ‚‚ â¦„ {Sâ‚ = Sâ‚} {Sâ‚‚} Ï• (S â–· s) =
    (Ï• Â·[ Câ‚ ] wkâ‚–* (S â–· s) id)                          ~âŸ¨ ~-cong-Â· ~-refl (wkâ‚–*-â–· S s id) âŸ©
    (Ï• Â·[ Câ‚ ] wkâ‚– s (wkâ‚–* S id))                        ~âŸ¨ ~-cong-Â· ~-refl (wk-Ï•-id (wkâ‚–* S id)) âŸ©
    (Ï• Â·[ Câ‚ ] (wkâ‚–* S id Â·[ Câ‚‚â‚‚ ] wkâ‚– s id))            ~âŸ¨ ~-sym (Â·-assoc Ï• (wkâ‚–* S id) (wkâ‚– s id)) âŸ©
    ((Ï• Â·[ Câ‚ ] wkâ‚–* S id) Â·[ Cxâ‚ ] wkâ‚– s id)            ~âŸ¨ ~-cong-Â· (â†‘*-wk* Ï• S) ~-refl âŸ©
    ((wkâ‚–* S id Â·[ Câ‚‚ ] (Ï• â†‘* S)) Â·[ Cxâ‚ ] wkâ‚– s id)     ~âŸ¨ Â·-assoc (wkâ‚–* S id) (Ï• â†‘* S) (wkâ‚– s id)  âŸ©
    (wkâ‚–* S id Â·[ Cxâ‚‚ ] ((Ï• â†‘* S) Â·[ Câ‚ ] wkâ‚– s id))     ~âŸ¨ ~-cong-Â· ~-refl (â†‘-wk (Ï• â†‘* S) s) âŸ©
    (wkâ‚–* S id Â·[ Cxâ‚‚ ] (wkâ‚– s id Â·[ Câ‚‚ ] (Ï• â†‘* S) â†‘ s)) ~âŸ¨ ~-sym (Â·-assoc (wkâ‚–* S id) (wkâ‚– s id) ((Ï• â†‘* S) â†‘ s)) âŸ©
    ((wkâ‚–* S id Â·[ Câ‚‚â‚‚ ] wkâ‚– s id) Â·[ Câ‚‚ ] (Ï• â†‘* S) â†‘ s) ~âŸ¨ ~-cong-Â· (~-sym (wk-Ï•-id (wkâ‚–* S id))) ~-refl âŸ©
    (wkâ‚– s (wkâ‚–* S id) Â·[ Câ‚‚ ] ((Ï• â†‘* S) â†‘ s))           ~âŸ¨ ~-sym (~-cong-Â· (wkâ‚–*-â–· S s id) (â†‘*-â–· S s Ï•)) âŸ©
    (wkâ‚–* (S â–· s) id Â·[ Câ‚‚ ] (Ï• â†‘* (S â–· s)))             ~âˆ

  dist-â†‘*-f :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚â‚ : ComposeKit ğ•‚â‚ ğ•‚â‚ ğ•‚â‚ â¦„
      â¦ƒ Câ‚‚â‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚‚ ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚ƒâ‚ƒ : ComposeKit ğ•‚â‚âŠ”ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Cxâ‚ : ComposeKit ğ•‚â‚âŠ”ğ•‚â‚‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Cxâ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚â‚‚ : KitT ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      (t : Sâ‚ âŠ¢ s) (Ï• : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚)
    â†’ t â‹¯ wkâ‚–* â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ S id â‹¯ (Ï• â†‘* S) â‰¡ t â‹¯ Ï• â‹¯ wkâ‚–* â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ S id
  dist-â†‘*-f {S = S} â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ t Ï• =
    (t â‹¯ wkâ‚–* S id) â‹¯ (Ï• â†‘* S)       â‰¡âŸ¨ â‹¯-assoc t (wkâ‚–* S id) (Ï• â†‘* S)  âŸ©
    t â‹¯ (wkâ‚–* S id Â·[ Câ‚‚ ] (Ï• â†‘* S)) â‰¡âŸ¨ ~-cong-â‹¯ t (~-sym (â†‘*-wk* Ï• S)) âŸ©
    t â‹¯ (Ï• Â·[ Câ‚ ] wkâ‚–* S id)        â‰¡âŸ¨ sym (â‹¯-assoc t Ï• (wkâ‚–* S id)) âŸ©
    (t â‹¯ Ï•) â‹¯ wkâ‚–* S id              âˆ

  dist-â†‘-â¦…â¦†-Â· :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      â¦ƒ W : KitT ğ•‚ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit ğ•‚â‚‚ ğ•‚â‚‚ ğ•‚â‚‚ â¦„
      {Sâ‚ Sâ‚‚ s} (x/t : Sâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] s) (Ï• : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) â†’
    (â¦… x/t â¦† Â·[ Câ‚ ] Ï•) ~ ((Ï• â†‘ s) Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)
  dist-â†‘-â¦…â¦†-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Wâ‚ â¦„ â¦ƒ Wâ‚‚ â¦„ â¦ƒ W â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ â¦ƒ Câ‚ƒ â¦„ {Sâ‚} {Sâ‚‚} {s} x/t Ï• = mk-~ Î» where
    sx x@(here refl) â†’
      `/id (x & (â¦… x/t â¦† Â·[ Câ‚ ] Ï•))                        â‰¡âŸ¨ cong `/id (&-Â·â‚–-&/â‹¯ â¦… x/t â¦† Ï• x) âŸ©
      `/id (x & â¦… x/t â¦† &/â‹¯ Ï•)                              â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯ Ï•)) (use-~-hom (â¦…â¦†-,â‚– x/t) _ x) âŸ©
      `/id (x & (id ,â‚– x/t) &/â‹¯ Ï•)                          â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯ Ï•)) (&-,â‚–-here id x/t) âŸ©
      `/id (x/t &/â‹¯ Ï•)                                      â‰¡âŸ¨ Î¹-`/id (x/t &/â‹¯ Ï•) âŸ©
      `/id (Î¹-âˆ‹/âŠ¢ (x/t &/â‹¯ Ï•))                              â‰¡âŸ¨ cong (Î» â–  â†’ `/id (Î¹-âˆ‹/âŠ¢ â– )) (sym (&-,â‚–-here id (x/t &/â‹¯[ Câ‚ ] Ï•))) âŸ©
      `/id (Î¹-âˆ‹/âŠ¢ (here refl & (id â¦ƒ ğ•‚ = ğ•‚ â¦„ ,â‚– (x/t &/â‹¯[ Câ‚ ] Ï•))))
                                                            â‰¡âŸ¨ cong (Î» â–  â†’ `/id (Î¹-âˆ‹/âŠ¢ â– ))
                                                                    (sym (use-~-hom (â¦…â¦†-,â‚– (x/t &/â‹¯[ Câ‚ ] Ï•)) _ (here refl))) âŸ©
      `/id (Î¹-âˆ‹/âŠ¢ (here refl & â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))        â‰¡âŸ¨ cong `/id (sym (&/â‹¯-& â¦ƒ Câ‚‚ â¦„ (here refl) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)) âŸ©
      `/id â¦ƒ ğ•‚ â¦„ (id/` (here refl) &/â‹¯[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)) (sym (&-â†‘-here Ï•)) âŸ© 
      `/id (x & (Ï• â†‘ s) &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)            â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (Ï• â†‘ s) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦† x)) âŸ©
      `/id (x & ((Ï• â†‘ s) Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))      âˆ
    sx x@(there y) â†’
      `/id (x & (â¦… x/t â¦† Â·[ Câ‚ ] Ï•))                                â‰¡âŸ¨ cong `/id (&-Â·â‚–-&/â‹¯ â¦… x/t â¦† Ï• x) âŸ©
      `/id (x & â¦… x/t â¦† &/â‹¯ Ï•)                                      â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯[ Câ‚ ] Ï•)) (use-~-hom (â¦…â¦†-,â‚– x/t) _ x) âŸ©
      `/id (x & (id ,â‚– x/t) &/â‹¯ Ï•)                                  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯[ Câ‚ ] Ï•)) (&-,â‚–-there id x/t y) âŸ©
      `/id (y & id &/â‹¯[ Câ‚ ] Ï•)                                     â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯[ Câ‚ ] Ï•)) (&-id y) âŸ©
      `/id â¦ƒ ğ•‚ â¦„ (id/` y &/â‹¯ Ï•)                                     â‰¡âŸ¨ cong (`/id â¦ƒ ğ•‚ â¦„) (&/â‹¯-& y Ï•) âŸ©
      `/id (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ (y & Ï•))                      â‰¡âŸ¨ cong (`/id â¦ƒ ğ•‚ â¦„) (sym (&-Î¹-â†’ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ = ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ Ï• y)) âŸ©
      `/id (y & (Î¹-â†’ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ = ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ Ï•))                â‰¡âŸ¨ use-~ (~-Î¹-â†’ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚‚ = ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ Câ‚ â¦„ â¦„ Ï•) _ y âŸ©

      `/id (y & Ï•)                                                  â‰¡âŸ¨ sym (use-~ (Â·-idÊ³ Ï•) _ y) âŸ©
      `/id (y & (Ï• Â·[ Câ‚‚ ] id))                                     â‰¡âŸ¨ use-~ (~-cong-Â· ~-refl
                                                                        (~-sym (wk-cancels-,â‚–-Â· id (x/t &/â‹¯[ Câ‚ ] Ï•)))) _ y âŸ©
      `/id (y & (Ï• Â·[ Câ‚‚ ] (wkâ‚– _ id Â·[ Câ‚‚ ] (id ,â‚– (x/t &/â‹¯[ Câ‚ ] Ï•))))) â‰¡âŸ¨ use-~ (~-cong-Â· â¦ƒ ğ•‚â‚ = ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚‚ = ğ•‚ â¦„ â¦ƒ ğ•‚ = ğ•‚ â¦„ ~-refl
                                                                            (~-cong-Â· â¦ƒ ğ•‚â‚ = ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚‚ = ğ•‚ â¦„ â¦ƒ ğ•‚ = ğ•‚ â¦„ ~-refl (~-sym (â¦…â¦†-,â‚– (x/t &/â‹¯[ Câ‚ ] Ï•))))) _ y âŸ©
      `/id (y & (Ï• Â·[ Câ‚‚ ] (wkâ‚– _ id Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))) â‰¡âŸ¨ sym (use-~ (Â·-assoc Ï• (wkâ‚– _ id) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†) _ y) âŸ©
      `/id (y & ((Ï• Â·[ Câ‚ƒ ] wkâ‚– _ id) Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)) â‰¡âŸ¨ use-~ (~-cong-Â· (~-sym (wk-Ï•-id Ï•)) ~-refl) _ y âŸ©
      `/id (y & (wkâ‚– _ Ï• Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))              â‰¡âŸ¨ cong `/id
                                                                            (&-Â·â‚–-&/â‹¯ â¦ƒ C = Câ‚‚ â¦„ (wkâ‚– _ Ï•) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦† y) âŸ©
      `/id (y & (wkâ‚– _ Ï•) &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)                  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))
                                                                                        (&-wkâ‚–-wk Ï• y) âŸ©
      `/id (wk _ (y & Ï•) &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)                   â‰¡âŸ¨ cong (Î» â–  â†’ `/id (â–  &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))
                                                                                        (sym (&-â†‘-there Ï• y)) âŸ© 
      `/id (x & (Ï• â†‘ s) &/â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†)                    â‰¡âŸ¨ cong `/id
                                                                        (sym (&-Â·â‚–-&/â‹¯ â¦ƒ C = Câ‚‚ â¦„ (Ï• â†‘ s) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦† x)) âŸ©
      `/id (x & ((Ï• â†‘ s) Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†))              âˆ

  -- ComposeKit for Substitutions ------------------------------------------------

  -- TODO: generalize with â‰¡â‚œ
  ~-cong-&/â‹¯â‚› :
    âˆ€ {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ W : KitT ğ•‚ â¦„ {st} {s : Sort st} {tâ‚ tâ‚‚ : Sâ‚ âŠ¢ s}
      {Ï•â‚ Ï•â‚‚ : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚}
    â†’ tâ‚ â‰¡ tâ‚‚
    â†’ Ï•â‚ ~ Ï•â‚‚
    â†’ tâ‚ â‹¯ Ï•â‚ â‰¡ tâ‚‚ â‹¯ Ï•â‚‚
  ~-cong-&/â‹¯â‚› refl Ï•â‚~Ï•â‚‚ = ~-cong-â‹¯ _ Ï•â‚~Ï•â‚‚

  &/â‹¯-wk-â†‘â‚› :
    âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ W : KitT K â¦„ â¦ƒ C : ComposeKit K kitáµ£ K â¦„
      {Sâ‚} {Sâ‚‚} {st} {s} {sx : Sort st}
      (t : Sâ‚ âŠ¢ sx)
      (Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚)
    â†’ t â‹¯ Ï• â‹¯ wknáµ£ â‰¡ t â‹¯ wknáµ£ â‹¯ (Ï• â†‘ s)
  &/â‹¯-wk-â†‘â‚› {_} {Sâ‚} {Sâ‚‚} {st} {s} {sx} t Ï• =
    t â‹¯ Ï• â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id          â‰¡âŸ¨ â‹¯-assoc t Ï• (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id) âŸ©
    t â‹¯ (Ï• Â·â‚– wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id)       â‰¡âŸ¨ ~-cong-â‹¯ t (â†‘-wk Ï• _) âŸ©
    t â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id Â·â‚– (Ï• â†‘ s)) â‰¡âŸ¨ sym (â‹¯-assoc t (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id) (Ï• â†‘ s)) âŸ©
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• â†‘ s)    âˆ

  ckitâ‚› : âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ W : KitT K â¦„ â¦ƒ C : ComposeKit K kitáµ£ K â¦„ â†’ ComposeKit kitâ‚› K kitâ‚›
  ckitâ‚› â¦ƒ K â¦„ â¦ƒ C â¦„ = record
    { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚  = âŠ‘â‚–-refl â¦ƒ kitâ‚› â¦„
    ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚  = âŠ‘â‚–-âŠ¤ â¦ƒ K â¦„
    ; _&/â‹¯_      = _â‹¯_
    ; &/â‹¯-â‹¯      = Î» x/t Ï• â†’ refl
    ; &/â‹¯-wk-â†‘   = &/â‹¯-wk-â†‘â‚› â¦ƒ K â¦„ â¦ƒ C â¦„
    ; ~-cong-&/â‹¯ = ~-cong-&/â‹¯â‚›
    }

  private instance _ = ckitâ‚›

  ckitâ‚›áµ£ : ComposeKit kitâ‚› kitáµ£ kitâ‚›
  ckitâ‚›áµ£ = ckitâ‚›

  ckitâ‚›â‚› : ComposeKit kitâ‚› kitâ‚› kitâ‚›
  ckitâ‚›â‚› = ckitâ‚›

  -- infixl  9  _â‚›Â·_  _â‚›Â·áµ£_  _â‚›Â·â‚›_
  -- infixr  9  _âˆ˜â‚›_  _áµ£âˆ˜â‚›_  _â‚›âˆ˜â‚›_
  infixl  9  _â‚›Â·áµ£_  _â‚›Â·â‚›_
  infixr  9  _áµ£âˆ˜â‚›_  _â‚›âˆ˜â‚›_

  _â‚›Â·_ : âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ W : KitT K â¦„ â¦ƒ C : ComposeKit K kitáµ£ K â¦„
           {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚‚ â€“[ K ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  Ïƒ â‚›Â· Ï• = Ïƒ Â·â‚– Ï•

  _âˆ˜â‚›_ : âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ W : KitT K â¦„ â¦ƒ C : ComposeKit K kitáµ£ K â¦„
           {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚‚ â€“[ K ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  Ï•â‚‚ âˆ˜â‚› Ï•â‚ = Ï•â‚ â‚›Â· Ï•â‚‚

  _â‚›Â·áµ£_ : âˆ€ {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚‚ â€“[ kitáµ£ ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  _â‚›Â·â‚›_ : âˆ€ {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  _áµ£âˆ˜â‚›_ : âˆ€ {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚‚ â€“[ kitáµ£ ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  _â‚›âˆ˜â‚›_ : âˆ€ {Sâ‚} {Sâ‚‚} {Sâ‚ƒ} â†’ Sâ‚‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚‚ â†’ Sâ‚ â€“[ kitâ‚› ]â†’ Sâ‚ƒ
  _â‚›Â·áµ£_ = _Â·â‚–_
  _â‚›Â·â‚›_ = _Â·â‚–_
  _áµ£âˆ˜â‚›_ = _âˆ˜â‚–_
  _â‚›âˆ˜â‚›_ = _âˆ˜â‚–_

--   âˆ˜~âˆ˜â†’â‹¯â‰¡â‹¯ : âˆ€ {{ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚' ğ•‚â‚‚' ğ•‚ : Kit}}
--               {{ğ”¸  : ComposeKit ğ•‚â‚  ğ•‚â‚‚  ğ•‚}}
--               {{ğ”¸' : ComposeKit ğ•‚â‚' ğ•‚â‚‚' ğ•‚}}
--               {Ï•â‚  : Sâ‚ â€“[ ğ•‚â‚  ]â†’ Sâ‚‚ } {Ï•â‚‚  : Sâ‚‚  â€“[ ğ•‚â‚‚  ]â†’ Sâ‚ƒ}
--               {Ï•â‚' : Sâ‚ â€“[ ğ•‚â‚' ]â†’ Sâ‚‚'} {Ï•â‚‚' : Sâ‚‚' â€“[ ğ•‚â‚‚' ]â†’ Sâ‚ƒ} â†’
--     (Ï•â‚ Â·[ ğ”¸ ] Ï•â‚‚) ~ (Ï•â‚' Â·[ ğ”¸' ] Ï•â‚‚') â†’
--     âˆ€ {s} (t : Sâ‚ âŠ¢ s) â†’
--     t â‹¯ Ï•â‚ â‹¯ Ï•â‚‚ â‰¡ t â‹¯ Ï•â‚' â‹¯ Ï•â‚‚'
--   âˆ˜~âˆ˜â†’â‹¯â‰¡â‹¯ â¦ƒ ğ”¸ = ğ”¸ â¦„ â¦ƒ ğ”¸' â¦„ {Ï•â‚ = Ï•â‚} {Ï•â‚‚ = Ï•â‚‚} {Ï•â‚' = Ï•â‚'} {Ï•â‚‚' = Ï•â‚‚'} eq t =
--     t â‹¯ Ï•â‚ â‹¯ Ï•â‚‚         â‰¡âŸ¨ â‹¯-assoc t Ï•â‚ Ï•â‚‚ âŸ©
--     t â‹¯ Ï•â‚  Â·[ ğ”¸  ] Ï•â‚‚  â‰¡âŸ¨ ~-cong-â‹¯ t eq âŸ©
--     t â‹¯ Ï•â‚' Â·[ ğ”¸' ] Ï•â‚‚' â‰¡âŸ¨ sym (â‹¯-assoc t Ï•â‚' Ï•â‚‚') âŸ©
--     t â‹¯ Ï•â‚' â‹¯ Ï•â‚‚'  âˆ

  wk-cancels-,â‚– :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„ â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„ â¦ƒ W : KitT ğ•‚ â¦„
      â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s)
    â†’ t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (Ï• ,â‚– x/t) â‰¡ t â‹¯ Ï•
  wk-cancels-,â‚– â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C = C â¦„ t Ï• x/t =
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (Ï• ,â‚– x/t)        â‰¡âŸ¨ â‹¯-assoc â¦ƒ ğ”¸ = C â¦„ t (wkâ‚– _ id) (Ï• ,â‚– x/t) âŸ©
    t â‹¯ (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id Â·[ C ] (Ï• ,â‚– x/t)) â‰¡âŸ¨ ~-cong-â‹¯ _ (wk-cancels-,â‚–-Â· â¦ƒ C = C â¦„ Ï• x/t) âŸ©
    t â‹¯ Ï•                                       âˆ

  wkáµ£-cancels-,â‚– :
    âˆ€ {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– x/t) â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,â‚– = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  wkáµ£-cancels-,áµ£ :
    âˆ€ (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â†’áµ£ Sâ‚‚) (x : Sâ‚‚ âˆ‹ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– x) â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,áµ£ = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  wkáµ£-cancels-,â‚› :
    âˆ€ (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â†’â‚› Sâ‚‚) (t' : Sâ‚‚ âŠ¢ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• ,â‚– t') â‰¡ t â‹¯ Ï•
  wkáµ£-cancels-,â‚› = wk-cancels-,â‚– â¦ƒ C = ckitáµ£ â¦„

  wkâ‚›-cancels-,áµ£ :
    âˆ€ (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â†’áµ£ Sâ‚‚) (x : Sâ‚‚ âˆ‹ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ (Ï• ,â‚– x) â‰¡ t â‹¯ Ï•
  wkâ‚›-cancels-,áµ£ t Ï• x = wk-cancels-,â‚– â¦ƒ C = ckitâ‚›áµ£ â¦„ t Ï• x

  wkâ‚›-cancels-,â‚› :
    âˆ€ (t : Sâ‚ âŠ¢ s') (Ï• : Sâ‚ â†’â‚› Sâ‚‚) (t' : Sâ‚‚ âŠ¢ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ (Ï• ,â‚– t') â‰¡ t â‹¯ Ï•
  wkâ‚›-cancels-,â‚› t Ï• t' = wk-cancels-,â‚– â¦ƒ C = ckitâ‚›â‚› â¦„ t Ï• t'

  --------------------------------------------------------------------------------

  dist-áµ£Â·áµ£-â¦…â¦† :
    âˆ€ {Sâ‚ Sâ‚‚ s} (x : Sâ‚ âˆ‹ s) (Ï : Sâ‚ â†’áµ£ Sâ‚‚) â†’
    (â¦… x â¦† áµ£Â·áµ£ Ï) ~ ((Ï â†‘ s) áµ£Â·áµ£ â¦… x & Ï â¦†)
  dist-áµ£Â·áµ£-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-â‚›Â·áµ£-â¦…â¦† :
    âˆ€ {Sâ‚ Sâ‚‚ s} (t : Sâ‚ âŠ¢ s) (Ï : Sâ‚ â†’áµ£ Sâ‚‚) â†’
    (â¦… t â¦† â‚›Â·áµ£ Ï) ~ ((Ï â†‘ s) áµ£Â·â‚› â¦… t â‹¯ Ï â¦†)
  dist-â‚›Â·áµ£-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-áµ£Â·â‚›-â¦…â¦† :
    âˆ€ {Sâ‚ Sâ‚‚ s} (x : Sâ‚ âˆ‹ s) (Ïƒ : Sâ‚ â†’â‚› Sâ‚‚) â†’
    (â¦… x â¦† áµ£Â·â‚› Ïƒ) ~ ((Ïƒ â†‘ s) â‚›Â·â‚› â¦… x & Ïƒ â¦†)
  dist-áµ£Â·â‚›-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  dist-â‚›Â·â‚›-â¦…â¦† :
    âˆ€ {Sâ‚ Sâ‚‚ s} (t : Sâ‚ âŠ¢ s) (Ïƒ : Sâ‚ â†’â‚› Sâ‚‚) â†’
    (â¦… t â¦† â‚›Â·â‚› Ïƒ) ~ ((Ïƒ â†‘ s) â‚›Â·â‚› â¦… t â‹¯ Ïƒ â¦†)
  dist-â‚›Â·â‚›-â¦…â¦† = dist-â†‘-â¦…â¦†-Â·

  --------------------------------------------------------------------------------

  dist-â¦…â¦†-â‹¯ :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„ â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„ â¦ƒ W : KitT ğ•‚ â¦„ 
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚‚ ğ•‚â‚‚ â¦„
      {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st}
      (t : (s âˆ· Sâ‚) âŠ¢ s') (x/t : Sâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] s) (Ï• : Sâ‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚‚) â†’
    t â‹¯ â¦… x/t â¦† â‹¯ Ï• â‰¡ t â‹¯ (Ï• â†‘ s) â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†
  dist-â¦…â¦†-â‹¯ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Wâ‚ â¦„ â¦ƒ Wâ‚‚ â¦„ â¦ƒ W â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Sâ‚} {Sâ‚‚} {s} {st} {s'} t x/t Ï• =
    t â‹¯ â¦… x/t â¦† â‹¯ Ï•                           â‰¡âŸ¨ â‹¯-assoc t â¦… x/t â¦† Ï• âŸ©
    t â‹¯ (â¦… x/t â¦† Â·[ Câ‚ ] Ï•)                   â‰¡âŸ¨ ~-cong-â‹¯ t (dist-â†‘-â¦…â¦†-Â· x/t Ï•) âŸ©
    t â‹¯ ((Ï• â†‘ s) Â·[ Câ‚‚ ] â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†) â‰¡âŸ¨ sym (â‹¯-assoc t (Ï• â†‘ s) â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†) âŸ©
    t â‹¯ (Ï• â†‘ s) â‹¯ â¦… x/t &/â‹¯[ Câ‚ ] Ï• â¦†         âˆ

  dist-â¦…â¦†áµ£-â‹¯áµ£ : âˆ€ {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st} (t : (s âˆ· Sâ‚) âŠ¢ s') (x : Sâ‚ âˆ‹ s) (Ï : Sâ‚ â†’áµ£ Sâ‚‚) â†’
    t â‹¯ â¦… x â¦† â‹¯ Ï â‰¡ t â‹¯ (Ï â†‘ s) â‹¯ â¦… x & Ï â¦†
  dist-â¦…â¦†áµ£-â‹¯áµ£ = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†â‚›-â‹¯áµ£ : âˆ€ {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st} (t : (s âˆ· Sâ‚) âŠ¢ s') (t' : Sâ‚ âŠ¢ s) (Ï : Sâ‚ â†’áµ£ Sâ‚‚) â†’
    t â‹¯ â¦… t' â¦† â‹¯ Ï â‰¡ t â‹¯ (Ï â†‘ s) â‹¯ â¦… t' â‹¯ Ï â¦†
  dist-â¦…â¦†â‚›-â‹¯áµ£ = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†áµ£-â‹¯â‚› : âˆ€ {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st} (t : (s âˆ· Sâ‚) âŠ¢ s') (x : Sâ‚ âˆ‹ s) (Ïƒ : Sâ‚ â†’â‚› Sâ‚‚) â†’
    t â‹¯ â¦… x â¦† â‹¯ Ïƒ â‰¡ t â‹¯ (Ïƒ â†‘ s) â‹¯ â¦… x & Ïƒ â¦†
  dist-â¦…â¦†áµ£-â‹¯â‚› = dist-â¦…â¦†-â‹¯

  dist-â¦…â¦†â‚›-â‹¯â‚› : âˆ€ {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st} (t : (s âˆ· Sâ‚) âŠ¢ s') (t' : Sâ‚ âŠ¢ s) (Ïƒ : Sâ‚ â†’â‚› Sâ‚‚) â†’
    t â‹¯ â¦… t' â¦† â‹¯ Ïƒ â‰¡ t â‹¯ (Ïƒ â†‘ s) â‹¯ â¦… t' â‹¯ Ïƒ â¦†
  dist-â¦…â¦†â‚›-â‹¯â‚› = dist-â¦…â¦†-â‹¯

  -- For ITraversal implementations
  dist-â¦…â¦†â‚›-â‹¯ :
    âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ W : KitT ğ•‚ â¦„
      â¦ƒ Câ‚ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      â¦ƒ Câ‚ƒ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      {Sâ‚ Sâ‚‚ s} {st} {s' : Sort st} 
      (t : (Sâ‚ â–· s) âŠ¢ s') (t' : Sâ‚ âŠ¢ s) (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚) â†’
    t â‹¯ â¦… t' â¦†â‚› â‹¯ Ï• â‰¡ t â‹¯ (Ï• â†‘ s) â‹¯ â¦… t' â‹¯ Ï• â¦†â‚›
  dist-â¦…â¦†â‚›-â‹¯ â¦ƒ ğ•‚ â¦„ â¦ƒ W â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ â¦ƒ Câ‚ƒ â¦„ {Sâ‚} {Sâ‚‚} {s} {st} {s'} t t' Ï• =
    t â‹¯ â¦… t' â¦†â‚› â‹¯ Ï•                   â‰¡âŸ¨ dist-â¦…â¦†-â‹¯ â¦ƒ Câ‚ = Câ‚ â¦„ t t' Ï• âŸ©
    t â‹¯ (Ï• â†‘ s) â‹¯ â¦… t' &/â‹¯[ Câ‚ ] Ï• â¦†â‚› â‰¡âŸ¨ cong (Î» â–  â†’ t â‹¯ Ï• â†‘ s â‹¯ â¦… â–  â¦†â‚›) (&/â‹¯-â‹¯ â¦ƒ Câ‚ â¦„ t' Ï•) âŸ©
    t â‹¯ (Ï• â†‘ s) â‹¯ â¦… t' â‹¯ Ï• â¦†â‚›         âˆ

--   record ComposeTraversalLemmas : Setâ‚ where

  â‹¯-idâ‚› : âˆ€ {S st} {s : Sort st} (t : S âŠ¢ s) â†’ t â‹¯ id â¦ƒ ğ•‚ = kitâ‚› â¦„ â‰¡ t
  â‹¯-idáµ£ : âˆ€ {S st} {s : Sort st} (t : S âŠ¢ s) â†’ t â‹¯ id â¦ƒ ğ•‚ = kitáµ£ â¦„ â‰¡ t
  â‹¯-idâ‚› = â‹¯-id
  â‹¯-idáµ£ = â‹¯-id

  -- -- TODO OLD: We can transfer this from â‹¯-id if we extend ComposeKit with a lemma,
  -- -- that operations on terms determine operations on &/â‹¯
  -- -- We could go even further and say operations on &/â‹¯ and â‹¯ are determined by
  -- -- operations on ap. Note that this is precisely what KitAltSimple does!!!!
  -- &/â‹¯-id :
  --   âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ : Kit â¦„
  --     â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
  --     {S} {s/s} (x/t : S âˆ‹/âŠ¢[ ğ•‚â‚ ] s/s)
  --   â†’ x/t &/â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ â‰¡ Î¹-âˆ‹/âŠ¢ x/t
  -- &/â‹¯-id â¦ƒ ğ•‚ â¦„ {S} {s} x/t = {!!}

  wk-cancels-â¦…â¦† :
    âˆ€ {_âˆ‹/âŠ¢â‚_ : VarScoped} â¦ƒ ğ•‚â‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„
      {_âˆ‹/âŠ¢â‚‚_ : VarScoped} â¦ƒ ğ•‚â‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„
      {_âˆ‹/âŠ¢_ : VarScoped}  â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      â¦ƒ KTâ‚ : KitT ğ•‚â‚ â¦„ â¦ƒ KTâ‚‚ : KitT ğ•‚â‚‚ â¦„ â¦ƒ KT : KitT ğ•‚ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚ â¦„
      {S st} {s' : Sort st}
      (t : S âŠ¢ s') (x/t : S âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ â¦… x/t â¦† â‰¡ t
  wk-cancels-â¦…â¦† â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ t x/t =
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ â¦… x/t â¦†     â‰¡âŸ¨ ~-cong-â‹¯ (t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id) (â¦…â¦†-,â‚– x/t) âŸ©
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ _ id â‹¯ (id ,â‚– x/t) â‰¡âŸ¨ wk-cancels-,â‚– t id x/t âŸ©
    t â‹¯ id                                â‰¡âŸ¨ â‹¯-id t âŸ©
    t                                     âˆ

  wkáµ£-cancels-â¦…â¦†áµ£ : âˆ€ {S s} {st} {s' : Sort st} (t : S âŠ¢ s') (x : S âˆ‹ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ â¦… x â¦†áµ£ â‰¡ t
  wkáµ£-cancels-â¦…â¦†áµ£ = wk-cancels-â¦…â¦†

  wkáµ£-cancels-â¦…â¦†â‚› : âˆ€ {S s} {st} {s' : Sort st} (t : S âŠ¢ s') (t' : S âŠ¢ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ â¦… t' â¦†â‚› â‰¡ t
  wkáµ£-cancels-â¦…â¦†â‚› = wk-cancels-â¦…â¦†

  wkâ‚›-cancels-â¦…â¦†áµ£ : âˆ€ {S s} {st} {s' : Sort st} (t : S âŠ¢ s') (x : S âˆ‹ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ â¦… x â¦†áµ£ â‰¡ t
  wkâ‚›-cancels-â¦…â¦†áµ£ = wk-cancels-â¦…â¦†

  wkâ‚›-cancels-â¦…â¦†â‚› : âˆ€ {S s} {st} {s' : Sort st} (t : S âŠ¢ s') (t' : S âŠ¢ s) â†’
    t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitâ‚› â¦„ _ id â‹¯ â¦… t' â¦†â‚› â‰¡ t
  wkâ‚›-cancels-â¦…â¦†â‚› = wk-cancels-â¦…â¦†

  -- -- special case of 
  -- --   dist-,â‚–-Â·Ê³ : âˆ€ {s}
  -- --                  (Ï•â‚ : Sâ‚ â€“[ ğ•‚â‚ ]â†’ Sâ‚‚)
  -- --                  (Ï•â‚‚ : Sâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Sâ‚ƒ)
  -- --                  (x/t : Sâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] s)
  -- --                â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚–' x/t) ~ ((Ï•â‚ â†‘ s) Â·â‚– (Ï•â‚‚ ,â‚– x/t))
  -- â†‘âˆ˜â¦…â¦†-is-,â‚– :
  --   âˆ€ â¦ƒ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„ {Sâ‚ Sâ‚‚ s}
  --     (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s)
  --     (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
  --   â†’ ((Ï• â†‘ s) Â·â‚– â¦… x/t â¦†) ~ (Ï• ,â‚– x/t)
  -- â†‘âˆ˜â¦…â¦†-is-,â‚– â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Sâ‚} {Sâ‚‚} {s} x/t Ï• =
  --     ((Ï• â†‘ s) Â·â‚– â¦… x/t â¦†)     ~âŸ¨ {!!} âŸ©
  --     ((Ï• â†‘ s) Â·â‚– (id ,â‚– x/t)) ~âŸ¨ {!!} âŸ©
  --     (Ï• ,â‚– x/t)               ~âˆ

  -- -- â†‘âˆ˜â¦…â¦†-is-,â‚› : âˆ€ {Sâ‚ Sâ‚‚ s} (t : Sâ‚‚ âŠ¢ s) (Ïƒ : Sâ‚ â†’â‚› Sâ‚‚) â†’
  -- --   â¦… t â¦†â‚› â‚›âˆ˜â‚› (Ïƒ â†‘ s) ~ Ïƒ ,â‚› t
  -- -- â†‘âˆ˜â¦…â¦†-is-,â‚› t Ïƒ _ (here refl) = â‹¯-var (here refl) â¦… t â¦†
  -- -- â†‘âˆ˜â¦…â¦†-is-,â‚› t Ïƒ _ (there x)   = wk-cancels-â¦…â¦†â‚› (Ïƒ _ x) t

  -- â†‘âˆ˜â¦…â¦†-is-,â‚› :
  --   âˆ€ {Sâ‚ Sâ‚‚ s}
  --     (t : Sâ‚‚ âŠ¢ s)
  --     (Ï• : Sâ‚ â†’â‚› Sâ‚‚)
  --   â†’ ((Ï• â†‘ s) Â·â‚– â¦… t â¦†) ~ (Ï• ,â‚– t)
  -- â†‘âˆ˜â¦…â¦†-is-,â‚› = â†‘âˆ˜â¦…â¦†-is-,â‚–

  -- â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚– :
  --   âˆ€ â¦ƒ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„ {Sâ‚ Sâ‚‚ s}
  --     (t : (Sâ‚ â–· s) âŠ¢ s)
  --     (x/t : Sâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ] s)
  --     (Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚)
  --   â†’ t â‹¯ (Ï• â†‘ s) â‹¯ â¦… x/t â¦† â‰¡ t â‹¯ (Ï• ,â‚– x/t)
  -- â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚– {s = s} t x/t Ï• =
  --   t â‹¯ (Ï• â†‘ s) â‹¯ â¦… x/t â¦†    â‰¡âŸ¨ â‹¯-assoc t (Ï• â†‘ s) â¦… x/t â¦† âŸ©
  --   t â‹¯ ((Ï• â†‘ s) Â·â‚– â¦… x/t â¦†) â‰¡âŸ¨ ~-cong-â‹¯ t (â†‘âˆ˜â¦…â¦†-is-,â‚– x/t Ï•) âŸ©
  --   t â‹¯ (Ï• ,â‚– x/t)           âˆ

  -- â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚› :
  --   âˆ€ {Sâ‚ Sâ‚‚ s}
  --     (t : (Sâ‚ â–· s) âŠ¢ s)
  --     (t' : Sâ‚‚ âŠ¢ s)
  --     (Ï• : Sâ‚ â†’â‚› Sâ‚‚)
  --   â†’ t â‹¯ (Ï• â†‘ s) â‹¯ â¦… t' â¦† â‰¡ t â‹¯ (Ï• ,â‚– t')
  -- â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚› = â‹¯â†‘â‹¯â¦…â¦†-is-â‹¯,â‚–
