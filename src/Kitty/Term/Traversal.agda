open import Kitty.Term.Modes
import Kitty.Term.Sub as S

module Kitty.Term.Traversal
    {ğ•„ : Modes}
    (ğ•‹ : Terms ğ•„)
    {â„“} (ğ•Š : S.SubWithLaws ğ•‹ â„“)
  where

open import Data.List.Relation.Unary.Any using (here; there)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Level using () renaming (suc to lsuc)

open import Kitty.Term.Prelude
open import Kitty.Util.SubstProperties
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open Modes ğ•„
open Terms ğ•‹
open Kit â¦ƒ â€¦ â¦„
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws ğ•Š
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„

private variable
  m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
  M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
  Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

private instance _ = kitáµ£

record Traversal : Set (lsuc â„“) where
  infixl   5  _â‹¯_

  field
    _â‹¯_   :
      âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
        {Âµâ‚ Âµâ‚‚ M} 
      â†’ Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M

    â‹¯-var :
      âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
        (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
      â†’ (` x) â‹¯ Ï• â‰¡ `/id (x & Ï•)

    â‹¯-id :
      âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
        {Âµ} {M} (t : Âµ âŠ¢ M)
      â†’ t â‹¯ id â¦ƒ ğ•‚ = ğ•‚ â¦„ â‰¡ t

  kitâ‚› : Kit _âŠ¢_
  Kit.id/mâ†’M           kitâ‚› = mâ†’M
  Kit.mâ†’M/id           kitâ‚› = Î» M â†’ M
  Kit.id/mâ†’M/id        kitâ‚› = Î» m â†’ refl
  Kit.id/`             kitâ‚› = `_
  Kit.`/id             kitâ‚› = Î» t â†’ t
  Kit.id/`/id          kitâ‚› = Î» x â†’ refl
  Kit.wk               kitâ‚› = Î» M t â†’ t â‹¯ wkâ‚– _ id
  Kit.wk-id/`          kitâ‚› = Î» m x â†’
    (` x) â‹¯ wkâ‚– m id     â‰¡âŸ¨ â‹¯-var x (wkâ‚– m id) âŸ©
    `/id (x & wkâ‚– m id)  â‰¡âŸ¨ cong (`/id) (&-wkâ‚–-wk id x) âŸ©
    `/id (wk _ (x & id)) â‰¡âŸ¨ cong (`/id) (cong (wk _) (&-id x)) âŸ©
    `/id (wk _ x)        â‰¡âŸ¨âŸ©
    (` there x)          âˆ
  Kit.kit-tag          kitâ‚› = K-Sub
  Kit.id/`-injective   kitâ‚› = Î» eq â†’ `-injective eq
  Kit.`/id-injective   kitâ‚› = Î» eq â†’ eq

  private instance _ = kitâ‚›

  âŠ‘-áµ£â‚› : kitáµ£ âŠ‘â‚– kitâ‚›
  âŠ‘-áµ£â‚› = record
    { Î¹-Mode   = mâ†’M
    ; Î¹-id/mâ†’M = Î» m â†’ refl
    ; Î¹-mâ†’M/id = Î» m/M â†’ refl
    ; Î¹-âˆ‹/âŠ¢    = `_
    ; Î¹-id/`   = Î» x â†’ refl
    ; Î¹-`/id   = Î» x/t â†’ refl
    ; Î¹-wk     = Î» {m'} {m} {Âµ} x â†’
        ` Kit.wk kitáµ£ _ x   â‰¡âŸ¨âŸ©
        ` there x           â‰¡âŸ¨ cong (Î» â–  â†’ ` there â– ) (sym (&-id x)) âŸ©
        ` there (x & id)    â‰¡âŸ¨ cong `_ (sym (&-wkâ‚–-wk id x)) âŸ©
        ` (x & wkâ‚– _ id)    â‰¡âŸ¨ sym (â‹¯-var â¦ƒ kitáµ£ â¦„ x (wkâ‚– _ id)) âŸ©
        (` x) â‹¯ wkâ‚– _ id    â‰¡âŸ¨âŸ©
        Kit.wk kitâ‚› _ (` x) âˆ
    }

  âŠ‘â‚–-âŠ¥ :
    âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
    â†’ kitáµ£ âŠ‘â‚– ğ•‚
  âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ â¦„ = record
    { Î¹-Mode   = Kit.id/mâ†’M ğ•‚
    ; Î¹-id/mâ†’M = Î» m â†’ refl
    ; Î¹-mâ†’M/id = Î» m â†’ sym (Kit.id/mâ†’M/id ğ•‚ m)
    ; Î¹-âˆ‹/âŠ¢    = Kit.id/` ğ•‚
    ; Î¹-id/`   = Î» x â†’ refl
    ; Î¹-`/id   = Î» x â†’ sym (Kit.id/`/id ğ•‚ x)
    ; Î¹-wk     = Î» x â†’ sym (wk-id/` _ x)
    }

  infixl   5   _â‹¯áµ£_  _â‹¯â‚›_ _â‹¯[_]_
  infixl   9  _âˆ¥áµ£_  _âˆ¥â‚›_

  open Kit kitáµ£ using () renaming (wk to wkáµ£; wk* to wk*áµ£) public
  open Kit kitâ‚› using () renaming (wk to wkâ‚›; wk* to wk*â‚›) public

  -- Substitution / Renaming

  _â†’áµ£_ : List VarMode â†’ List VarMode â†’ Set â„“
  _â†’â‚›_ : List VarMode â†’ List VarMode â†’ Set â„“
  _â†’áµ£_ = _â€“[ kitáµ£ ]â†’_
  _â†’â‚›_ = _â€“[ kitâ‚› ]â†’_

  -- Empty

  []áµ£ : [] â†’áµ£ []
  []â‚› : [] â†’â‚› []
  []áµ£ = []â‚–
  []â‚› = []â‚–

  []*áµ£ : âˆ€ {Âµâ‚‚} â†’ [] â†’áµ£ Âµâ‚‚
  []*â‚› : âˆ€ {Âµâ‚‚} â†’ [] â†’â‚› Âµâ‚‚
  []*áµ£ = []*
  []*â‚› = []*

  -- Extension

  _,áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚‚ âˆ‹ m     â†’ (Âµâ‚ â–· m) â†’áµ£ Âµâ‚‚
  _,â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ mâ†’M m â†’ (Âµâ‚ â–· m) â†’â‚› Âµâ‚‚
  _,áµ£_ = _,â‚–_
  _,â‚›_ = _,â‚–_

  -- Weakening

  wkâ†’áµ£  : âˆ€ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’áµ£ (Âµâ‚‚ â–· m)
  wkâ†’â‚›  : âˆ€ {Âµâ‚} {Âµâ‚‚} m â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› (Âµâ‚‚ â–· m)
  wkâ†’áµ£* : âˆ€ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’áµ£ (Âµâ‚‚ â–·â–· Âµ)
  wkâ†’â‚›* : âˆ€ {Âµâ‚} {Âµâ‚‚} Âµ â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› (Âµâ‚‚ â–·â–· Âµ)
  wkâ†’áµ£  = wkâ‚–
  wkâ†’â‚›  = wkâ‚–
  wkâ†’áµ£* = wkâ‚–*
  wkâ†’â‚›* = wkâ‚–*

  wkn :
    âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
      {Âµ} {m}
    â†’ Âµ â€“[ ğ•‚ ]â†’ (Âµ â–· m)
  wkn = wkâ‚– _ id

  wknáµ£ : âˆ€ {Âµ} {m} â†’ Âµ â†’áµ£ (Âµ â–· m)
  wknâ‚› : âˆ€ {Âµ} {m} â†’ Âµ â†’â‚› (Âµ â–· m)
  wknáµ£ = wkn
  wknâ‚› = wkn

  -- Lifting

  _â†‘áµ£_  : âˆ€ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ âˆ€ m  â†’ (Âµâ‚ â–·  m)  â†’áµ£ (Âµâ‚‚ â–· m)
  _â†‘â‚›_  : âˆ€ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ âˆ€ m  â†’ (Âµâ‚ â–·  m)  â†’â‚› (Âµâ‚‚ â–· m)
  _â†‘áµ£*_ : âˆ€ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â†’áµ£ (Âµâ‚‚ â–·â–· Âµ')
  _â†‘â‚›*_ : âˆ€ {Âµâ‚} {Âµâ‚‚} â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµâ‚ â–·â–· Âµ') â†’â‚› (Âµâ‚‚ â–·â–· Âµ')
  _â†‘áµ£_  = _â†‘_
  _â†‘â‚›_  = _â†‘_
  _â†‘áµ£*_ = _â†‘*_
  _â†‘â‚›*_ = _â†‘*_

  -- Identity

  idáµ£ : âˆ€ {Âµ} â†’ Âµ â†’áµ£ Âµ
  idâ‚› : âˆ€ {Âµ} â†’ Âµ â†’â‚› Âµ
  idáµ£ = id
  idâ‚› = id

  -- Lowering

  _â†“áµ£ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} â†’ (Âµâ‚ â–· m) â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’áµ£ Âµâ‚‚
  _â†“â‚› : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} â†’ (Âµâ‚ â–· m) â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚‚
  _â†“áµ£ = _â†“
  _â†“â‚› = _â†“

  -- Parallel composition

  _âˆ¥áµ£_ : âˆ€ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â†’áµ£ Âµ) â†’ (Âµâ‚‚ â†’áµ£ Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â†’áµ£ Âµ)
  _âˆ¥â‚›_ : âˆ€ {Âµâ‚ Âµâ‚‚ Âµ} â†’ (Âµâ‚ â†’â‚› Âµ) â†’ (Âµâ‚‚ â†’â‚› Âµ) â†’ ((Âµâ‚ â–·â–· Âµâ‚‚) â†’â‚› Âµ)
  _âˆ¥áµ£_ = _âˆ¥_
  _âˆ¥â‚›_ = _âˆ¥_

  -- Single substitution

  â¦…_â¦†áµ£  : âˆ€ {Âµ m} â†’ Âµ âˆ‹ m     â†’ (Âµ â–· m)  â†’áµ£ Âµ
  â¦…_â¦†â‚›  : âˆ€ {Âµ m} â†’ Âµ âŠ¢ mâ†’M m â†’ (Âµ â–· m)  â†’â‚› Âµ
  â¦…_â¦†áµ£  = â¦…_â¦†
  â¦…_â¦†â‚›  = â¦…_â¦†

  -- Singleton renaming/substitution for terms with 1 free variable.
  -- Allows the term to be substituted to have arbitrary free variables.
  -- This is useful for things like pattern matching in combination with `_âˆ¥_`,
  -- where a matching substitution needs to be built up piece by piece.
  â¦…_â¦†áµ£â‚€ : âˆ€ {Âµ m} â†’ Âµ âˆ‹ m     â†’ ([] â–· m) â†’áµ£ Âµ
  â¦…_â¦†â‚›â‚€ : âˆ€ {Âµ m} â†’ Âµ âŠ¢ mâ†’M m â†’ ([] â–· m) â†’â‚› Âµ
  â¦…_â¦†áµ£â‚€ = â¦…_â¦†â‚€
  â¦…_â¦†â‚›â‚€ = â¦…_â¦†â‚€

  -- Specialized application
  _â‹¯â‚›_ : Âµâ‚ âŠ¢ M â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M
  _â‹¯áµ£_ : Âµâ‚ âŠ¢ M â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M
  _â‹¯â‚›_ = _â‹¯_
  _â‹¯áµ£_ = _â‹¯_

  _â‹¯[_]_ :
    âˆ€ {KitMode : Set} {_âˆ‹/âŠ¢_ : Scoped KitMode}
    â†’ Âµâ‚ âŠ¢ M â†’ (ğ•‚ : Kit _âˆ‹/âŠ¢_) â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M
  t â‹¯[ ğ•‚ ] Ï• = t â‹¯ Ï• where instance _ = ğ•‚

  -- -- Alternative without duplication and `R.id` instead of `idáµ£`:
  -- module R = Kit kitáµ£
  -- module S = Kit kitâ‚›

  -- -- Composition

  -- infixr  10  _áµ£âˆ˜áµ£_  _â‚›âˆ˜â‚›_
  -- infixl  10  _áµ£Â·áµ£_  _â‚›Â·â‚›_
  -- infixr  10  _âˆ˜áµ£_  _âˆ˜â‚›_  _â‚›âˆ˜áµ£_  _áµ£âˆ˜â‚›_
  -- infixl  10  _áµ£Â·_  _â‚›Â·_  _áµ£Â·â‚›_  _â‚›Â·áµ£_

  -- -- Composition

  -- _áµ£âˆ˜áµ£_ : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’áµ£ Âµâ‚ƒ
  -- _â‚›âˆ˜â‚›_ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- _áµ£âˆ˜áµ£_ = _âˆ˜â‚–_
  -- _â‚›âˆ˜â‚›_ = _âˆ˜â‚–_

  -- _áµ£Â·áµ£_ : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚‚ â†’áµ£ Âµâ‚ƒ â†’ Âµâ‚ â†’áµ£ Âµâ‚ƒ
  -- _â‚›Â·â‚›_ : Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚‚ â†’â‚› Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- _áµ£Â·áµ£_ = _Â·â‚–_
  -- _â‚›Â·â‚›_ = _Â·â‚–_

  -- _âˆ˜áµ£_ : {{K : Kit}} â†’ Âµâ‚‚ â€“[ K ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â€“[ K ]â†’ Âµâ‚ƒ
  -- _âˆ˜â‚›_ : {{K : Kit}} â†’ Âµâ‚‚ â€“[ K ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- (Ï• âˆ˜áµ£ Ï) _ x = Ï• _ (Ï _ x)
  -- (Ï• âˆ˜â‚› Ïƒ) _ x = Ïƒ _ x â‹¯ Ï•

  -- _â‚›âˆ˜áµ£_ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- _áµ£âˆ˜â‚›_ : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- _â‚›âˆ˜áµ£_ = _âˆ˜áµ£_
  -- _áµ£âˆ˜â‚›_ = _âˆ˜â‚›_

  -- -- Reverse composition

  -- _áµ£Â·_ : {{K : Kit}} â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ K ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ K ]â†’ Âµâ‚ƒ
  -- _â‚›Â·_ : {{K : Kit}} â†’ Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚‚ â€“[ K ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- Ï•â‚ áµ£Â·  Ï•â‚‚ = Ï•â‚‚ âˆ˜áµ£ Ï•â‚
  -- Ï•â‚ â‚›Â·  Ï•â‚‚ = Ï•â‚‚ âˆ˜â‚› Ï•â‚

  -- _áµ£Â·â‚›_ : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚‚ â†’â‚› Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- _â‚›Â·áµ£_ : Âµâ‚ â†’â‚› Âµâ‚‚ â†’ Âµâ‚‚ â†’áµ£ Âµâ‚ƒ â†’ Âµâ‚ â†’â‚› Âµâ‚ƒ
  -- Ï•â‚ áµ£Â·â‚› Ï•â‚‚ = Ï•â‚‚ âˆ˜áµ£ Ï•â‚
  -- Ï•â‚ â‚›Â·áµ£ Ï•â‚‚ = Ï•â‚‚ âˆ˜â‚› Ï•â‚

  -- -- Embedding renamings as substitutions

  -- toâ‚› : {{K : Kit}} â†’ Âµâ‚ â€“[ K ]â†’ Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚‚
  -- toâ‚› Ï• = Î» m x â†’ `/id m (Ï• m x)
  -- -- toâ‚› Ï• = idâ‚› âˆ˜â‚– Ï•

  -- áµ£toâ‚› : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚‚
  -- áµ£toâ‚› Ï• = toâ‚› Ï•

  -- fromáµ£ : {{K : Kit}} â†’ Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â€“[ K ]â†’ Âµâ‚‚
  -- fromáµ£ Ï• = Î» m x â†’ id/` m (Ï• m x)

  -- â‚›fromáµ£ : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚‚
  -- â‚›fromáµ£ Ï• = fromáµ£ Ï•

  -- â‚›fromáµ£' : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Âµâ‚ â†’â‚› Âµâ‚‚
  -- â‚›fromáµ£' Ï• = Î» m x â†’ ` (Ï• m x)

  -- toâ‚›âˆ˜fromáµ£ : {{K : Kit}} â†’ (Ï• : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’ toâ‚› â¦ƒ K â¦„ (fromáµ£ â¦ƒ K â¦„ Ï•) ~ â‚›fromáµ£ Ï•
  -- toâ‚›âˆ˜fromáµ£ Ï• m x = id/`/id (Ï• m x)

  -- â‚›fromáµ£â‰¡áµ£toâ‚› : (Î» {Âµâ‚} {Âµâ‚‚} â†’ â‚›fromáµ£ {Âµâ‚} {Âµâ‚‚}) â‰¡ (Î» {Âµâ‚} {Âµâ‚‚} â†’ áµ£toâ‚› {Âµâ‚} {Âµâ‚‚})
  -- â‚›fromáµ£â‰¡áµ£toâ‚› = refl

  -- â‚›fromáµ£'â‰¡áµ£toâ‚› : (Î» {Âµâ‚} {Âµâ‚‚} â†’ â‚›fromáµ£' {Âµâ‚} {Âµâ‚‚}) â‰¡ (Î» {Âµâ‚} {Âµâ‚‚} â†’ áµ£toâ‚› {Âµâ‚} {Âµâ‚‚})
  -- â‚›fromáµ£'â‰¡áµ£toâ‚› = refl
