open import Kitty.Term.Modes
open import Kitty.Term.Traversal using (Traversal)
open import Kitty.Term.KitHomotopy using (KitHomotopy)
open import Kitty.Term.Sub using (SubWithLaws)

module Kitty.Term.SubCompose {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) (ğ•Š : SubWithLaws ğ•‹) (T : Traversal ğ•‹ ğ•Š) (H : KitHomotopy ğ•‹ ğ•Š T) where

open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning

open import Kitty.Term.ComposeKit ğ•‹ ğ•Š T H
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.KitT ğ•‹ ğ•Š T
open import Kitty.Term.Prelude
open import Kitty.Term.Sub ğ•‹
open import Kitty.Util.SubstProperties
open ComposeKit â¦ƒ â€¦ â¦„
open Kit â¦ƒ â€¦ â¦„
open Kitty.Term.Sub.SubWithLaws ğ•Š
open Modes ğ•„
open Sub â¦ƒ â€¦ â¦„
open Terms ğ•‹
open Traversal T
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„
open ~-Reasoning

record SubCompose : Setâ‚ where
  infixl  9  _Â·â‚–_
  infixr  9  _âˆ˜â‚–_

  field
    _Â·â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
          â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
          â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
          â†’ Âµâ‚ â€“[ ğ•‚  ]â†’ Âµâ‚ƒ

    &-Â·â‚–-&/â‹¯ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
                (x : Âµâ‚ âˆ‹ m)
              â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
                x & (Ï•â‚ Â·â‚– Ï•â‚‚) â‰¡ sub ((x & Ï•â‚) &/â‹¯ Ï•â‚‚)

  ~-cong-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
                {Ï•â‚ Ï•â‚' : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚}
                {Ï•â‚‚ Ï•â‚‚' : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ}
              â†’ Ï•â‚ ~ Ï•â‚'
              â†’ Ï•â‚‚ ~ Ï•â‚‚'
              â†’ (Ï•â‚ Â·â‚– Ï•â‚‚) ~ (Ï•â‚' Â·â‚– Ï•â‚‚')
  ~-cong-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' m x =
    let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    `/id (x & (Ï•â‚  Â·â‚– Ï•â‚‚ ))      â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ x) âŸ©
    `/id (sub (x & Ï•â‚  &/â‹¯ Ï•â‚‚ )) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (sub â– )) (~-cong-&/â‹¯ (~â†’~' Ï•â‚~Ï•â‚' _ x) Ï•â‚‚~Ï•â‚‚') âŸ©
    `/id (sub (x & Ï•â‚' &/â‹¯ Ï•â‚‚')) â‰¡âŸ¨ cong (`/id) (sym (&-Â·â‚–-&/â‹¯ Ï•â‚' Ï•â‚‚' x)) âŸ©
    `/id (x & (Ï•â‚' Â·â‚– Ï•â‚‚'))      âˆ

  tm-â‹¯-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
              (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
              (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              (x : Âµâ‚ âˆ‹ m)
            â†’ `/id (x & Ï•â‚) â‹¯ Ï•â‚‚ â‰¡ `/id (x & (Ï•â‚ Â·â‚– Ï•â‚‚))
  tm-â‹¯-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m} Ï•â‚ Ï•â‚‚ x =
    let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    let sub' = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„  m) in
    `/id (x & Ï•â‚) â‹¯ Ï•â‚‚         â‰¡âŸ¨ sym (&/â‹¯-â‹¯' (x & Ï•â‚) Ï•â‚‚) âŸ©
    `/id (sub (x & Ï•â‚ &/â‹¯ Ï•â‚‚)) â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ x)) âŸ©
    `/id (x & (Ï•â‚ Â·â‚– Ï•â‚‚))      âˆ

  dist-â†‘-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m
                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m))
  dist-â†‘-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(here refl) =
    let subâ‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    let subâ‚‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m))                             â‰¡âŸ¨ cong `/id (&-â†‘-here (Ï•â‚ Â·â‚– Ï•â‚‚)) âŸ©
    `/id (id/` (here refl))                                 â‰¡âŸ¨ id/`/id (here refl) âŸ©
    ` here refl                                             â‰¡âŸ¨ sym (id/`/id (here refl)) âŸ©
    `/id (id/` (here refl))                                 â‰¡âŸ¨ sym (Î¹-âˆ‹/âŠ¢-~â‚œ (id/` (here refl))) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (id/` (here refl))))     â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â– )))
                                                                    (sym (&-â†‘-here Ï•â‚‚)) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (here refl & (Ï•â‚‚ â†‘ m)))) â‰¡âŸ¨ cong `/id (sym (&/â‹¯-& (here refl) (Ï•â‚‚ â†‘ m))) âŸ©
    `/id (subâ‚ (id/` (here refl) &/â‹¯ (Ï•â‚‚ â†‘ m)))             â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯ Ï•â‚‚ â†‘ m))) (sym (&-â†‘-here Ï•â‚)) âŸ©
    `/id (subâ‚ (x & (Ï•â‚ â†‘ m) &/â‹¯ (Ï•â‚‚ â†‘ m)))                 â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (Ï•â‚ â†‘ m) (Ï•â‚‚ â†‘ m) x)) âŸ©
    `/id (x & ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m)))                       âˆ
  dist-â†‘-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(there y) =
    let subâ‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚' = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m))                     â‰¡âŸ¨ cong `/id (&-â†‘-there (Ï•â‚ Â·â‚– Ï•â‚‚) y) âŸ©
    `/id (wk _ (y & (Ï•â‚ Â·â‚– Ï•â‚‚)))                    â‰¡âŸ¨ cong (Î» â–  â†’ `/id (wk _ â– )) (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ y) âŸ©
    `/id (wk _ (subâ‚' (y & Ï•â‚ &/â‹¯ Ï•â‚‚)))             â‰¡âŸ¨ cong `/id (dist-subst (wk _) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) (y & Ï•â‚ &/â‹¯ Ï•â‚‚)) âŸ©
    `/id (subâ‚ (wk _ (y & Ï•â‚ &/â‹¯ Ï•â‚‚)))              â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ â– )) (&/â‹¯-wk-â†‘ (y & Ï•â‚) Ï•â‚‚) âŸ©
    `/id (subâ‚ (wk _ (y & Ï•â‚) &/â‹¯ (Ï•â‚‚ â†‘ m)))        â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯ (Ï•â‚‚ â†‘ m)))) (sym (&-â†‘-there Ï•â‚ y)) âŸ©
    `/id (subâ‚ (x & (Ï•â‚ â†‘ m) &/â‹¯ (Ï•â‚‚ â†‘ m)))         â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (Ï•â‚ â†‘ m) (Ï•â‚‚ â†‘ m) x)) âŸ©
    `/id (x & ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m))) âˆ

  dist-â†‘*-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
                Âµ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ) â†’
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) ~ ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ))
  dist-â†‘*-Â· []      Ï•â‚ Ï•â‚‚ =
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* [])         ~âŸ¨ â†‘*-[] (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    Ï•â‚ Â·â‚– Ï•â‚‚                   ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-[] Ï•â‚) (â†‘*-[] Ï•â‚‚)) âŸ©
    ((Ï•â‚ â†‘* []) Â·â‚– (Ï•â‚‚ â†‘* [])) ~âˆ
  dist-â†‘*-Â· (Âµ â–· m) Ï•â‚ Ï•â‚‚ =
    (Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* (Âµ â–· m)               ~âŸ¨ â†‘*-â–· Âµ m (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) â†‘ m               ~âŸ¨ ~-cong-â†‘' (dist-â†‘*-Â· Âµ Ï•â‚ Ï•â‚‚) âŸ©
    ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ)) â†‘ m        ~âŸ¨ dist-â†‘-Â· m (Ï•â‚ â†‘* Âµ) (Ï•â‚‚ â†‘* Âµ) âŸ©
    ((Ï•â‚ â†‘* Âµ) â†‘ m) Â·â‚– ((Ï•â‚‚ â†‘* Âµ) â†‘ m)  ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-â–· Âµ m Ï•â‚) (â†‘*-â–· Âµ m Ï•â‚‚)) âŸ©
    (Ï•â‚ â†‘* (Âµ â–· m)) Â·â‚– (Ï•â‚‚ â†‘* (Âµ â–· m))  ~âˆ

  -- dist-,â‚–-Â· : âˆ€ {m}
  --               (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
  --               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
  --               (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m)
  --             â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚âŠ” ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
  --               ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚– sub (x/t &/â‹¯ Ï•â‚‚)) ~ (Ï•â‚ ,â‚– x/t Â·â‚– Ï•â‚‚)

  _âˆ˜â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
        â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
        â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
        â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜â‚– Ï•â‚ = Ï•â‚ Â·â‚– Ï•â‚‚

  infixl  9  _Â·[_]_
  infixr  9  _âˆ˜[_]_

  _Â·[_]_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
          â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
          â†’ ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚
          â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
          â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï•â‚ Â·[ C ] Ï•â‚‚ = _Â·â‚–_ â¦ƒ C = C â¦„ Ï•â‚ Ï•â‚‚


  _âˆ˜[_]_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
          â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
          â†’ ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚
          â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
          â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜[ C ] Ï•â‚ = _âˆ˜â‚–_ â¦ƒ C = C â¦„ Ï•â‚‚ Ï•â‚

  Â·-idÊ³ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
          â†’ (Ï• Â·â‚– id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„) ~ Ï•
  Â·-idÊ³ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} Ï• mx x =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (Ï• Â·â‚– id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„))      â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ Ï• id x) âŸ©
    `/id (sub (x & Ï• &/â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„)) â‰¡âŸ¨ &/â‹¯-â‹¯' (x & Ï•) id âŸ©
    `/id (x & Ï•) â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„         â‰¡âŸ¨ â‹¯-id (`/id (x & Ï•)) âŸ©
    `/id (x & Ï•)                         âˆ

  Â·-idË¡ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚)
          â†’ (id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ Â·â‚– Ï•) ~ Ï•
  Â·-idË¡ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} Ï• mx x =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ Â·â‚– Ï•))          â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ id Ï• x) âŸ©
    `/id (sub (x & id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ &/â‹¯ Ï•))     â‰¡âŸ¨ cong (Î» â–  â†’ `/id (sub (â–  &/â‹¯ Ï•))) (&-id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ x) âŸ©
    `/id (sub (id/` x &/â‹¯ Ï•))                â‰¡âŸ¨ cong (`/id) (&/â‹¯-& x Ï•) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x & Ï•))) â‰¡âŸ¨ Î¹-âˆ‹/âŠ¢-~â‚œ (x & Ï•) âŸ©
    `/id (x & Ï•)                             âˆ

  -- Alternative route:
    -- (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ (wkâ‚– _ (Ï• ,â‚– x/t)) ~ Ï•
  -- From which then follows:
    -- wkâ‚– _ Ï• Â· â¦… x/t â¦† ~
    -- wkâ‚– _ id Â· Ï• Â· â¦… x/t â¦† ~
    -- Ï• Â· wkâ‚– _ id Â· â¦… x/t â¦† ~
    -- Ï• Â· id ~
    -- Ï•
  wk-cancels-,â‚–-Â· :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m}
      (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    â†’ (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ Ï•
  wk-cancels-,â‚–-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• x/t mx x =
    let subâ‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)))         â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ (wkâ‚– _ id) (Ï• ,â‚– x/t) x) âŸ©
    `/id (subâ‚ (x & wkâ‚– _ id &/â‹¯ (Ï• ,â‚– x/t)))   â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯[ C ] (Ï• ,â‚– x/t)))) (&-wkâ‚–-wk id x) âŸ©
    `/id (subâ‚ (wk _ (x & id) &/â‹¯ (Ï• ,â‚– x/t)))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (wk â¦ƒ ğ•‚â‚ â¦„ _ â–  &/â‹¯ (Ï• ,â‚– x/t)))) (&-id x) âŸ©
    `/id (subâ‚ (wk _ (id/` x) &/â‹¯ (Ï• ,â‚– x/t)))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯[ C ] (Ï• ,â‚– x/t)))) (wk-id/` _ x) âŸ©
    `/id (subâ‚ (id/` (there x) &/â‹¯ (Ï• ,â‚– x/t))) â‰¡âŸ¨ cong (`/id) (&/â‹¯-& (there x) (Ï• ,â‚– x/t)) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (there x & (Ï• ,â‚– x/t))))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â– ))) (&-,â‚–-there Ï• x/t x) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (x & Ï•)))                 â‰¡âŸ¨ cong (`/id) (sym (Î¹-ap-â†’ Ï• x)) âŸ©
    `/id (x & (Î¹-â†’ Ï•))                          â‰¡âŸ¨ Î¹-~-â†’ Ï• _ x âŸ©
    `/id (x & Ï•)                                âˆ

  wk-Ï•-id :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      {Âµâ‚} {Âµâ‚‚} {m}
      (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    â†’ wkâ‚– m Ï• ~ (Ï• Â·â‚– wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m id)
  wk-Ï•-id â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ â¦ƒ W â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• mx x =
    let sub = subst ((Âµâ‚‚ â–· m) âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M mx) in
    `/id (x & wkâ‚– m Ï•)                         â‰¡âŸ¨ cong `/id (&-wkâ‚–-wk Ï• x) âŸ©
    `/id (wk m (x & Ï•))                        â‰¡âŸ¨ sym (Î¹-âˆ‹/âŠ¢-~â‚œ (wk m (x & Ï•))) âŸ©
    `/id (sub (Î¹-âˆ‹/âŠ¢ (wk m (x & Ï•))))          â‰¡âŸ¨ cong (Î» â–  â†’ `/id (sub â– )) (sym (&/â‹¯-wk (x & Ï•))) âŸ©
    `/id (sub (x & Ï• &/â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m id)) â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ Ï• (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m id) x)) âŸ©
    `/id (x & (Ï• Â·â‚– wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m id))      âˆ

  â†‘-wk :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚ : KitT ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : KitT ğ•‚â‚‚ â¦„
      {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) m
    â†’ (Ï• Â·[ Câ‚ ] wkâ‚– m id) ~ (wkâ‚– m id Â·[ Câ‚‚ ] (Ï• â†‘ m))
  â†‘-wk â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚ â¦„ â¦ƒ Câ‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} Ï• m =
      (Ï• Â·[ Câ‚ ] wkâ‚– m id)                             ~âŸ¨ ~-sym (wk-Ï•-id Ï•) âŸ©
      wkâ‚– m Ï•                                          ~âŸ¨ ~-sym (wk-cancels-,â‚–-Â· (wkâ‚– m Ï•) (id/` (here refl))) âŸ©
      (wkâ‚– m id Â·[ Câ‚‚ ] (wkâ‚– m Ï• ,â‚– id/` (here refl))) ~âŸ¨ ~-cong-Â· ~-refl (~-sym (â†‘-,â‚– Ï• m)) âŸ©
      (wkâ‚– m id Â·[ Câ‚‚ ] (Ï• â†‘ m))                       ~âˆ

  -- Specializations for Renamings ------------------------------------------------

  infixl  9  _áµ£Â·_  _áµ£Â·áµ£_  _áµ£Â·â‚›_
  infixr  9  _âˆ˜áµ£_  _áµ£âˆ˜áµ£_  _â‚›âˆ˜áµ£_

  private instance _ = kitáµ£; _ = kitâ‚›; _ = ckitáµ£

  _áµ£Â·_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï áµ£Â· Ï• = Ï Â·â‚– Ï•

  _âˆ˜áµ£_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜áµ£ Ï•â‚ = Ï•â‚ áµ£Â· Ï•â‚‚

  _áµ£Â·áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
  _áµ£Â·â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _áµ£âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
  _â‚›âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _áµ£Â·áµ£_ = _áµ£Â·_
  _áµ£Â·â‚›_ = _áµ£Â·_
  _áµ£âˆ˜áµ£_ = _âˆ˜áµ£_
  _â‚›âˆ˜áµ£_ = _âˆ˜áµ£_

