open import Kitty.Term.Modes
open import Kitty.Term.Traversal using (Traversal; KitHomotopy)

module Kitty.Term.SubCompose {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) (T : Traversal ğ•‹) (H : KitHomotopy ğ•‹ T) where

open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
import Kitty.Term.ComposeKit ğ•‹ T H as CC
open CC â¦ƒ â€¦ â¦„
open ComposeKit â¦ƒ â€¦ â¦„
-- open import Kitty.Term.KitOrder ğ•‹ â¦ƒ â€¦ â¦„
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open Modes ğ•„
open Terms ğ•‹
open Kit â¦ƒ â€¦ â¦„
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws â¦ƒ â€¦ â¦„
open ~-Reasoning
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„
open Traversal T

record SubCompose (ğ•Š : SubWithLaws) : Setâ‚ where
  infixl  9  _Â·â‚–_
  infixr  9  _âˆ˜â‚–_
  private instance _ = ğ•Š

  field
    -- _Â·â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚ : ğ•‚â‚ âŠ‘â‚– ğ•‚ â¦„ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚ : ğ•‚â‚‚ âŠ‘â‚– ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
    --       â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
    --       â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
    --       â†’ Âµâ‚ â€“[ ğ•‚  ]â†’ Âµâ‚ƒ
    _Â·â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
          â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
          â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
          â†’ Âµâ‚ â€“[ ğ•‚  ]â†’ Âµâ‚ƒ

    ap/â‹¯-Â·â‚– : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
                (x : Âµâ‚ âˆ‹ m)
              â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
                apâ‚– (Ï•â‚ Â·â‚– Ï•â‚‚) _ x â‰¡ sub (apâ‚– Ï•â‚ _ x ap/â‹¯ Ï•â‚‚)

    tm-â‹¯-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
               (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
               (x : Âµâ‚ âˆ‹ m)
             â†’ `/id _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚ â‰¡ `/id _ (apâ‚– (Ï•â‚ Â·â‚– Ï•â‚‚) _ x)

    dist-â†‘-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m
                 (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                 (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
               â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m))

    ~-cong-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
                 {Ï•â‚ Ï•â‚' : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚}
                 {Ï•â‚‚ Ï•â‚‚' : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ}
               â†’ Ï•â‚ ~ Ï•â‚'
               â†’ Ï•â‚‚ ~ Ï•â‚‚'
               â†’ (Ï•â‚ Â·â‚– Ï•â‚‚) ~ (Ï•â‚' Â·â‚– Ï•â‚‚')

  -- Alternative route:
    -- (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ (wkâ‚– _ (Ï• ,â‚– x/t)) ~ Ï•
  -- From which then follows:
    -- wkâ‚– _ Ï• Â· â¦… x/t â¦† ~
    -- wkâ‚– _ id Â· Ï• Â· â¦… x/t â¦† ~
    -- Ï• Â· wkâ‚– _ id Â· â¦… x/t â¦† ~
    -- Ï• Â· id ~
    -- Ï•
  wk-cancels-,â‚–-Â· :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m}
      (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    â†’ (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ Ï•
  wk-cancels-,â‚–-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• x/t mx x =
    let subâ‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id _ (apâ‚– (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) mx x)         â‰¡âŸ¨ cong (`/id _) (ap/â‹¯-Â·â‚– (wkâ‚– _ id) (Ï• ,â‚– x/t) x) âŸ©
    `/id _ (subâ‚ (apâ‚– (wkâ‚– _ id) _ x ap/â‹¯ (Ï• ,â‚– x/t))) â‰¡âŸ¨ cong (Î» â–  â†’ `/id _ (subâ‚ (â–  ap/â‹¯[ C ] (Ï• ,â‚– x/t)))) (apâ‚–-wkâ‚–-wk id x) âŸ©
    `/id _ (subâ‚ (wk _ (apâ‚– id _ x) ap/â‹¯ (Ï• ,â‚– x/t)))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id _ (subâ‚ (wk â¦ƒ ğ•‚â‚ â¦„ _ â–  ap/â‹¯ (Ï• ,â‚– x/t)))) (apâ‚–-id x) âŸ©
    `/id _ (subâ‚ (wk _ (id/` _ x) ap/â‹¯ (Ï• ,â‚– x/t)))    â‰¡âŸ¨ cong (Î» â–  â†’ `/id _ (subâ‚ (â–  ap/â‹¯[ C ] (Ï• ,â‚– x/t)))) (wk-id/` _ x) âŸ©
    `/id _ (subâ‚ (id/` _ (there x) ap/â‹¯ (Ï• ,â‚– x/t)))   â‰¡âŸ¨ cong (`/id _) (ap/â‹¯-ap (there x) (Ï• ,â‚– x/t)) âŸ©
    -- `/id _ (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (apâ‚– (Ï• ,â‚– x/t) _ (there x)))) â‰¡âŸ¨ {!cong (Î» â–  â†’ subâ‚‚ (Î¹-âˆ‹/âŠ¢ â– )) (apâ‚–-,â‚–-there Ï• x/t x)!} âŸ©
    -- `/id _ (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (apâ‚– Ï• _ x)))                  â‰¡âŸ¨ {!sym (Î¹-ap-â†’ Ï• x)!} âŸ©
    -- `/id _ (apâ‚– Ï• mx x)                          âˆ
    `/id _ (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (apâ‚– (Ï• ,â‚– x/t) _ (there x)))) â‰¡âŸ¨ cong (Î» â–  â†’ `/id _ (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â– ))) (apâ‚–-,â‚–-there Ï• x/t x) âŸ©
    `/id _ (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (apâ‚– Ï• _ x)))                  â‰¡âŸ¨ cong (`/id _) (sym (Î¹-ap-â†’ Ï• x)) âŸ©
    `/id _ (apâ‚– (Î¹-â†’ Ï•) mx x)                          â‰¡âŸ¨ Î¹-~-â†’ Ï• _ x âŸ©
    `/id _ (apâ‚– Ï• mx x)                                âˆ

  -- tm-â‹¯-Â· : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
  --               (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
  --               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
  --               (x : Âµâ‚ âˆ‹ m)
  --             â†’ `/id _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚ â‰¡ `/id _ (apâ‚– (Ï•â‚ Â·â‚– Ï•â‚‚) _ x)
  -- tm-â‹¯-Â· {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m} Ï•â‚ Ï•â‚‚ x =
  --   let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
  --   `/id _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚          â‰¡âŸ¨ {!!} âŸ©
  --   `/id _ (sub (apâ‚– Ï•â‚ _ x ap/â‹¯ Ï•â‚‚)) â‰¡âŸ¨ cong (`/id _) (sym (ap/â‹¯-Â·â‚– Ï•â‚ Ï•â‚‚ x)) âŸ©
  --   `/id _ (apâ‚– (Ï•â‚ Â·â‚– Ï•â‚‚) _ x)       âˆ

  dist-â†‘*-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
                Âµ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ) â†’
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) ~ ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ))
  dist-â†‘*-Â· []      Ï•â‚ Ï•â‚‚ =
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* [])         ~âŸ¨ â†‘*-[] (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    Ï•â‚ Â·â‚– Ï•â‚‚                   ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-[] Ï•â‚) (â†‘*-[] Ï•â‚‚)) âŸ©
    ((Ï•â‚ â†‘* []) Â·â‚– (Ï•â‚‚ â†‘* [])) ~âˆ
  dist-â†‘*-Â· (Âµ â–· m) Ï•â‚ Ï•â‚‚ =
    (Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* (Âµ â–· m)               ~âŸ¨ â†‘*-â–· Âµ m (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) â†‘ m               ~âŸ¨ ~-cong-â†‘ (dist-â†‘*-Â· Âµ Ï•â‚ Ï•â‚‚) âŸ©
    ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ)) â†‘ m        ~âŸ¨ dist-â†‘-Â· m (Ï•â‚ â†‘* Âµ) (Ï•â‚‚ â†‘* Âµ) âŸ©
    ((Ï•â‚ â†‘* Âµ) â†‘ m) Â·â‚– ((Ï•â‚‚ â†‘* Âµ) â†‘ m)  ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-â–· Âµ m Ï•â‚) (â†‘*-â–· Âµ m Ï•â‚‚)) âŸ©
    (Ï•â‚ â†‘* (Âµ â–· m)) Â·â‚– (Ï•â‚‚ â†‘* (Âµ â–· m))  ~âˆ

-- instance
--   comp : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â†’ SubCompose
--   comp = record { _Â·â‚–_ = Î» Ï•â‚ Ï•â‚‚ â†’ post (Î¹-â†’ Ï•â‚) Î» _ x/t â†’ {!x/t ap/â‹¯ Ï•â‚‚!}  }

infixl  9  _Â·[_]_
infixr  9  _âˆ˜[_]_

_Â·[_]_ : âˆ€ â¦ƒ ğ•Š ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
         â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
         â†’ SubCompose ğ•Š
         â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
         â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
Ï•â‚ Â·[ C ] Ï•â‚‚ = Ï•â‚ Â·â‚– Ï•â‚‚ where open SubCompose C


_âˆ˜[_]_ : âˆ€ â¦ƒ ğ•Š ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
         â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
         â†’ SubCompose ğ•Š
         â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
         â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
Ï•â‚‚ âˆ˜[ C ] Ï•â‚ = Ï•â‚‚ âˆ˜â‚– Ï•â‚ where open SubCompose C

-- -- ComposeKit for Renamings ----------------------------------------------------

-- infixl  9  _áµ£Â·_  _áµ£Â·áµ£_  _áµ£Â·â‚›_
-- infixr  9  _âˆ˜áµ£_  _áµ£âˆ˜áµ£_  _â‚›âˆ˜áµ£_

-- _áµ£Â·_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
-- Ï áµ£Â· Ï• = pre Ï• (apâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ Ï)

-- _âˆ˜áµ£_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
-- Ï•â‚‚ âˆ˜áµ£ Ï•â‚ = Ï•â‚ áµ£Â· Ï•â‚‚

-- _áµ£Â·áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
-- _áµ£Â·â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
-- _áµ£âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
-- _â‚›âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
-- _áµ£Â·áµ£_ = _áµ£Â·_
-- _áµ£Â·â‚›_ = _áµ£Â·_
-- _áµ£âˆ˜áµ£_ = _âˆ˜áµ£_
-- _â‚›âˆ˜áµ£_ = _âˆ˜áµ£_

-- ap-áµ£Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
--           (Ï : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
--           (Ï• : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
--           (x : Âµâ‚ âˆ‹ m)
--         â†’ apâ‚– (Ï áµ£Â· Ï•) _ x â‰¡ apâ‚– Ï• _ (apâ‚– Ï _ x)
-- ap-áµ£Â· â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m} Ï Ï• x =
--   apâ‚– (Ï áµ£Â· Ï•) _ x        â‰¡âŸ¨âŸ©
--   apâ‚– (pre Ï• (apâ‚– Ï)) _ x â‰¡âŸ¨ apâ‚–-pre Ï• (apâ‚– Ï) x âŸ©
--   apâ‚– Ï• _ (apâ‚– Ï _ x)     âˆ

-- ~-cong-áµ£Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„
--                {Ï•â‚ Ï•â‚' : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚}
--                {Ï•â‚‚ Ï•â‚‚' : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ}
--              â†’ Ï•â‚ ~ Ï•â‚'
--              â†’ Ï•â‚‚ ~ Ï•â‚‚'
--              â†’ (Ï•â‚ áµ£Â· Ï•â‚‚) ~ (Ï•â‚' áµ£Â· Ï•â‚‚')
-- ~-cong-áµ£Â· â¦ƒ ğ•‚â‚‚ â¦„ {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' = ~'â†’~ (Î» m x â†’
--   apâ‚– (Ï•â‚  áµ£Â· Ï•â‚‚ ) m x        â‰¡âŸ¨âŸ©
--   apâ‚– (pre Ï•â‚‚  (apâ‚– Ï•â‚ )) m x â‰¡âŸ¨ apâ‚–-pre Ï•â‚‚ (apâ‚– Ï•â‚) x âŸ©
--   apâ‚– Ï•â‚‚  _ (apâ‚– Ï•â‚  m x)     â‰¡âŸ¨ cong (apâ‚– Ï•â‚‚ _) (~â†’~' Ï•â‚~Ï•â‚' m x) âŸ©
--   apâ‚– Ï•â‚‚  _ (apâ‚– Ï•â‚' m x)     â‰¡âŸ¨ ~â†’~' Ï•â‚‚~Ï•â‚‚' _ (apâ‚– Ï•â‚' m x) âŸ©
--   apâ‚– Ï•â‚‚' _ (apâ‚– Ï•â‚' m x)     â‰¡âŸ¨ sym (apâ‚–-pre Ï•â‚‚' (apâ‚– Ï•â‚') x) âŸ©
--   apâ‚– (pre Ï•â‚‚' (apâ‚– Ï•â‚')) m x â‰¡âŸ¨âŸ©
--   apâ‚– (Ï•â‚' áµ£Â· Ï•â‚‚') m x        âˆ)

-- dist-â†‘-áµ£Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m
--                (Ï•â‚ : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
--                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
--              â†’ ((Ï•â‚ áµ£Â· Ï•â‚‚) â†‘ m) ~ ((Ï•â‚ â†‘ m) áµ£Â· (Ï•â‚‚ â†‘ m))
-- dist-â†‘-áµ£Â· â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ = ~'â†’~ Î» where
--   mx x@(here refl) â†’
--     apâ‚– ((Ï•â‚ áµ£Â· Ï•â‚‚) â†‘ m) _ x            â‰¡âŸ¨ apâ‚–-â†‘-here (Ï•â‚ áµ£Â· Ï•â‚‚) âŸ©
--     id/` _ (here refl)                  â‰¡âŸ¨ sym (apâ‚–-â†‘-here Ï•â‚‚) âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (here refl)          â‰¡âŸ¨âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (id/` _ (here refl)) â‰¡âŸ¨ cong (apâ‚– (Ï•â‚‚ â†‘ m) _) (sym (apâ‚–-â†‘-here Ï•â‚)) âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (apâ‚– (Ï•â‚ â†‘ m) _ x)   â‰¡âŸ¨ sym (apâ‚–-pre (Ï•â‚‚ â†‘ m) (apâ‚– (Ï•â‚ â†‘ m)) x) âŸ©
--     apâ‚– ((Ï•â‚ â†‘ m) áµ£Â· (Ï•â‚‚ â†‘ m)) _ x      âˆ
--   mx x@(there y) â†’
--     apâ‚– ((Ï•â‚ áµ£Â· Ï•â‚‚) â†‘ m) _ x            â‰¡âŸ¨ apâ‚–-â†‘-there (Ï•â‚ áµ£Â· Ï•â‚‚) y âŸ©
--     wk _ (apâ‚– (Ï•â‚ áµ£Â· Ï•â‚‚) _ y)           â‰¡âŸ¨ cong (wk _) (apâ‚–-pre Ï•â‚‚ (apâ‚– Ï•â‚) y) âŸ©
--     wk _ (apâ‚– Ï•â‚‚ _ (apâ‚– Ï•â‚ _ y))        â‰¡âŸ¨ sym (apâ‚–-â†‘-there Ï•â‚‚ (apâ‚– Ï•â‚ _ y)) âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (there (apâ‚– Ï•â‚ _ y)) â‰¡âŸ¨âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (wk _ (apâ‚– Ï•â‚ _ y))  â‰¡âŸ¨ cong (apâ‚– (Ï•â‚‚ â†‘ m) _) (sym (apâ‚–-â†‘-there Ï•â‚ y)) âŸ©
--     apâ‚– (Ï•â‚‚ â†‘ m) _ (apâ‚– (Ï•â‚ â†‘ m) _ x)   â‰¡âŸ¨ sym (apâ‚–-pre (Ï•â‚‚ â†‘ m) (apâ‚– (Ï•â‚ â†‘ m)) x) âŸ©
--     apâ‚– ((Ï•â‚ â†‘ m) áµ£Â· (Ï•â‚‚ â†‘ m)) _ x      âˆ

-- tm-â‹¯-áµ£Â· : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
--              (Ï•â‚ : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
--              (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
--              (x : Âµâ‚ âˆ‹ m)
--            â†’ `/id _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚ â‰¡ `/id _ (apâ‚– (Ï•â‚ áµ£Â· Ï•â‚‚) _ x)
-- tm-â‹¯-áµ£Â· â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} Ï•â‚ Ï•â‚‚ x =
--   `/id _ (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚       â‰¡âŸ¨âŸ©
--   ` (apâ‚– Ï•â‚ _ x) â‹¯ Ï•â‚‚            â‰¡âŸ¨ â‹¯-var (apâ‚– Ï•â‚ _ x) Ï•â‚‚ âŸ©
--   `/id _ (apâ‚– Ï•â‚‚ _ (apâ‚– Ï•â‚ _ x)) â‰¡âŸ¨ cong (`/id _) (sym (apâ‚–-pre Ï•â‚‚ (apâ‚– Ï•â‚) x)) âŸ©
--   `/id _ (apâ‚– (Ï•â‚ áµ£Â· Ï•â‚‚) _ x)    âˆ

-- ap/â‹¯-wkáµ£ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx}
--              (Ï• : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
--              (x : Âµâ‚ âˆ‹ mx)
--            â†’ (apâ‚– (wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m id) _ (apâ‚– Ï• _ x)) â‰¡ Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ (wk _ (apâ‚– Ï• _ x))
-- ap/â‹¯-wkáµ£ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx} Ï• x =
--   apâ‚– (wkâ‚– _ id) _ (apâ‚– Ï• _ x)            â‰¡âŸ¨ apâ‚–-wkâ‚–-wk id (apâ‚– Ï• _ x) âŸ©
--   wk _ (apâ‚– id _ (apâ‚– Ï• _ x))             â‰¡âŸ¨ cong (wk _) (apâ‚–-id (apâ‚– Ï• _ x)) âŸ©
--   wk _ (id/` _ (apâ‚– Ï• _ x))               â‰¡âŸ¨ sym (Î¹-wk â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ {m = m} (apâ‚– Ï• _ x)) âŸ©
--   Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ (wk _ (apâ‚– Ï• _ x)) âˆ

-- ap/â‹¯-â‹¯áµ£ : âˆ€ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
--         â†’ let sub = subst (Âµâ‚‚ âŠ¢_) (sym (id/mâ†’M/id m)) in
--           `/id' â¦ƒ ğ•‚â‚‚ â¦„ _ (apâ‚– Ï• _ x) â‰¡ sub (` x â‹¯ Ï•)
-- ap/â‹¯-â‹¯áµ£ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} x Ï• =
--   let sub = subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) in
--   let subâ»Â¹ = subst (Âµâ‚‚ âŠ¢_) (sym (id/mâ†’M/id m)) in
--   `/id' â¦ƒ ğ•‚â‚‚ â¦„ _ (apâ‚– Ï• _ x)         â‰¡âŸ¨ sym (cancel-subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) (`/id' _ (apâ‚– Ï• _ x))) âŸ©
--   subâ»Â¹ (sub (`/id' _ (apâ‚– Ï• _ x)))  â‰¡âŸ¨ cong subâ»Â¹ (sym (`/idâ‰¡`/id' (apâ‚– Ï• _ x))) âŸ©
--   subâ»Â¹ (`/id â¦ƒ ğ•‚â‚‚ â¦„ _ (apâ‚– Ï• _ x))  â‰¡âŸ¨ cong subâ»Â¹ (sym (â‹¯-var x Ï•)) âŸ©
--   subâ»Â¹ (` x â‹¯ Ï•)                    âˆ

-- ckitáµ£ : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ ComposeKit kitáµ£ ğ•‚ ğ•‚
-- ckitáµ£ â¦ƒ ğ•‚ â¦„ = record
--   { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„
--   ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-refl â¦ƒ ğ•‚ â¦„
--   ; _ap/â‹¯_      = Î» x Ï• â†’ apâ‚– Ï• _ x
--   ; ap/â‹¯-â‹¯      = ap/â‹¯-â‹¯áµ£
--   ; ap/â‹¯-ap     = Î» x Ï• â†’ refl
--   ; _Â·â‚–_        = _áµ£Â·_
--   ; ap/â‹¯-Â·â‚–     = ap-áµ£Â·
--   -- ; ap/â‹¯-wk     = ap/â‹¯-wkáµ£
--   ; tm-â‹¯-Â·      = tm-â‹¯-áµ£Â·
--   ; dist-â†‘-Â·    = dist-â†‘-áµ£Â·
--   ; ~-cong-Â·    = ~-cong-áµ£Â·
--   ; ~-cong-ap/â‹¯ = Î» { refl Ï•â‚~Ï•â‚‚ â†’ ~â†’~' Ï•â‚~Ï•â‚‚ _ _ }
--   }
