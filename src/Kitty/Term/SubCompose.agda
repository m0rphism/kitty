open import Kitty.Term.Modes
open import Kitty.Term.Traversal using (Traversal; KitHomotopy)

module Kitty.Term.SubCompose {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) (T : Traversal ğ•‹) (H : KitHomotopy ğ•‹ T) where

open import Data.List.Properties using (++-assoc; ++-identityÊ³)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_; _Ã—_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; sym; subst; substâ‚‚; cong; module â‰¡-Reasoning)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
import Kitty.Term.ComposeKit ğ•‹ T H as CC
open CC â¦ƒ â€¦ â¦„
open ComposeKit â¦ƒ â€¦ â¦„
open WkKit â¦ƒ â€¦ â¦„
-- open import Kitty.Term.KitOrder ğ•‹ â¦ƒ â€¦ â¦„
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open import Kitty.Util.SubstProperties
open Modes ğ•„
open Terms ğ•‹
open Kit â¦ƒ â€¦ â¦„
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws â¦ƒ â€¦ â¦„
open ~-Reasoning
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„
open Traversal T

record SubCompose (ğ•Š : SubWithLaws) : Setâ‚ where
  infixl  9  _Â·â‚–_
  infixr  9  _âˆ˜â‚–_
  private instance _ = ğ•Š

  field
    _Â·â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
          â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
          â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
          â†’ Âµâ‚ â€“[ ğ•‚  ]â†’ Âµâ‚ƒ

    &-Â·â‚–-&/â‹¯ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
                (x : Âµâ‚ âˆ‹ m)
              â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M m) in
                x & (Ï•â‚ Â·â‚– Ï•â‚‚) â‰¡ sub ((x & Ï•â‚) &/â‹¯ Ï•â‚‚)

  ~-cong-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
                {Ï•â‚ Ï•â‚' : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚}
                {Ï•â‚‚ Ï•â‚‚' : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ}
              â†’ Ï•â‚ ~ Ï•â‚'
              â†’ Ï•â‚‚ ~ Ï•â‚‚'
              â†’ (Ï•â‚ Â·â‚– Ï•â‚‚) ~ (Ï•â‚' Â·â‚– Ï•â‚‚')
  ~-cong-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {Ï•â‚} {Ï•â‚'} {Ï•â‚‚} {Ï•â‚‚'} Ï•â‚~Ï•â‚' Ï•â‚‚~Ï•â‚‚' m x =
    let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    `/id (x & (Ï•â‚  Â·â‚– Ï•â‚‚ ))      â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ x) âŸ©
    `/id (sub (x & Ï•â‚  &/â‹¯ Ï•â‚‚ )) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (sub â– )) (~-cong-&/â‹¯ (~â†’~' Ï•â‚~Ï•â‚' _ x) Ï•â‚‚~Ï•â‚‚') âŸ©
    `/id (sub (x & Ï•â‚' &/â‹¯ Ï•â‚‚')) â‰¡âŸ¨ cong (`/id) (sym (&-Â·â‚–-&/â‹¯ Ï•â‚' Ï•â‚‚' x)) âŸ©
    `/id (x & (Ï•â‚' Â·â‚– Ï•â‚‚'))      âˆ

  tm-â‹¯-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m}
              (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
              (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              (x : Âµâ‚ âˆ‹ m)
            â†’ `/id (x & Ï•â‚) â‹¯ Ï•â‚‚ â‰¡ `/id (x & (Ï•â‚ Â·â‚– Ï•â‚‚))
  tm-â‹¯-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {m} Ï•â‚ Ï•â‚‚ x =
    let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    let sub' = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„  m) in
    `/id (x & Ï•â‚) â‹¯ Ï•â‚‚         â‰¡âŸ¨ sym (&/â‹¯-â‹¯' (x & Ï•â‚) Ï•â‚‚) âŸ©
    `/id (sub (x & Ï•â‚ &/â‹¯ Ï•â‚‚)) â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ x)) âŸ©
    `/id (x & (Ï•â‚ Â·â‚– Ï•â‚‚))      âˆ

  dist-â†‘-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m
                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
              â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m))
  dist-â†‘-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(here refl) =
    let subâ‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    let subâ‚‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
    `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m))                             â‰¡âŸ¨ cong `/id (&-â†‘-here (Ï•â‚ Â·â‚– Ï•â‚‚)) âŸ©
    `/id (id/` (here refl))                                 â‰¡âŸ¨ id/`/id (here refl) âŸ©
    ` here refl                                             â‰¡âŸ¨ sym (id/`/id (here refl)) âŸ©
    `/id (id/` (here refl))                                 â‰¡âŸ¨ sym (Î¹-âˆ‹/âŠ¢-~â‚œ (id/` (here refl))) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (id/` (here refl))))     â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â– )))
                                                                    (sym (&-â†‘-here Ï•â‚‚)) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (here refl & (Ï•â‚‚ â†‘ m)))) â‰¡âŸ¨ cong `/id (sym (&/â‹¯-& (here refl) (Ï•â‚‚ â†‘ m))) âŸ©
    `/id (subâ‚ (id/` (here refl) &/â‹¯ (Ï•â‚‚ â†‘ m)))             â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯ Ï•â‚‚ â†‘ m))) (sym (&-â†‘-here Ï•â‚)) âŸ©
    `/id (subâ‚ (x & (Ï•â‚ â†‘ m) &/â‹¯ (Ï•â‚‚ â†‘ m)))                 â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (Ï•â‚ â†‘ m) (Ï•â‚‚ â†‘ m) x)) âŸ©
    `/id (x & ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m)))                       âˆ
  dist-â†‘-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} m Ï•â‚ Ï•â‚‚ mx x@(there y) =
    let subâ‚ = subst ((Âµâ‚ƒ â–· m) âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚' = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘ m))                     â‰¡âŸ¨ cong `/id (&-â†‘-there (Ï•â‚ Â·â‚– Ï•â‚‚) y) âŸ©
    `/id (wk _ (y & (Ï•â‚ Â·â‚– Ï•â‚‚)))                    â‰¡âŸ¨ cong (Î» â–  â†’ `/id (wk _ â– )) (&-Â·â‚–-&/â‹¯ Ï•â‚ Ï•â‚‚ y) âŸ©
    `/id (wk _ (subâ‚' (y & Ï•â‚ &/â‹¯ Ï•â‚‚)))             â‰¡âŸ¨ cong `/id (dist-subst (wk _) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) (y & Ï•â‚ &/â‹¯ Ï•â‚‚)) âŸ©
    `/id (subâ‚ (wk _ (y & Ï•â‚ &/â‹¯ Ï•â‚‚)))              â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ â– )) (&/â‹¯-wk-â†‘ (y & Ï•â‚) Ï•â‚‚) âŸ©
    `/id (subâ‚ (wk _ (y & Ï•â‚) &/â‹¯ (Ï•â‚‚ â†‘ m)))        â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯ (Ï•â‚‚ â†‘ m)))) (sym (&-â†‘-there Ï•â‚ y)) âŸ©
    `/id (subâ‚ (x & (Ï•â‚ â†‘ m) &/â‹¯ (Ï•â‚‚ â†‘ m)))         â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (Ï•â‚ â†‘ m) (Ï•â‚‚ â†‘ m) x)) âŸ©
    `/id (x & ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ â†‘ m))) âˆ

  dist-â†‘*-Â· : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
                Âµ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ) â†’
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) ~ ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ))
  dist-â†‘*-Â· []      Ï•â‚ Ï•â‚‚ =
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* [])         ~âŸ¨ â†‘*-[] (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    Ï•â‚ Â·â‚– Ï•â‚‚                   ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-[] Ï•â‚) (â†‘*-[] Ï•â‚‚)) âŸ©
    ((Ï•â‚ â†‘* []) Â·â‚– (Ï•â‚‚ â†‘* [])) ~âˆ
  dist-â†‘*-Â· (Âµ â–· m) Ï•â‚ Ï•â‚‚ =
    (Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* (Âµ â–· m)               ~âŸ¨ â†‘*-â–· Âµ m (Ï•â‚ Â·â‚– Ï•â‚‚) âŸ©
    ((Ï•â‚ Â·â‚– Ï•â‚‚) â†‘* Âµ) â†‘ m               ~âŸ¨ ~-cong-â†‘' (dist-â†‘*-Â· Âµ Ï•â‚ Ï•â‚‚) âŸ©
    ((Ï•â‚ â†‘* Âµ) Â·â‚– (Ï•â‚‚ â†‘* Âµ)) â†‘ m        ~âŸ¨ dist-â†‘-Â· m (Ï•â‚ â†‘* Âµ) (Ï•â‚‚ â†‘* Âµ) âŸ©
    ((Ï•â‚ â†‘* Âµ) â†‘ m) Â·â‚– ((Ï•â‚‚ â†‘* Âµ) â†‘ m)  ~âŸ¨ ~-sym (~-cong-Â· (â†‘*-â–· Âµ m Ï•â‚) (â†‘*-â–· Âµ m Ï•â‚‚)) âŸ©
    (Ï•â‚ â†‘* (Âµ â–· m)) Â·â‚– (Ï•â‚‚ â†‘* (Âµ â–· m))  ~âˆ

  -- dist-,â‚–-Â· : âˆ€ {m}
  --               (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
  --               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
  --               (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m)
  --             â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚âŠ” ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
  --               ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚– sub (x/t &/â‹¯ Ï•â‚‚)) ~ (Ï•â‚ ,â‚– x/t Â·â‚– Ï•â‚‚)

  _âˆ˜â‚–_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
        â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
        â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
        â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜â‚– Ï•â‚ = Ï•â‚ Â·â‚– Ï•â‚‚

  Â·-idÊ³ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
          â†’ (Ï• Â·â‚– id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„) ~ Ï•
  Â·-idÊ³ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} Ï• mx x =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (Ï• Â·â‚– id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„))      â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ Ï• id x) âŸ©
    `/id (sub (x & Ï• &/â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„)) â‰¡âŸ¨ &/â‹¯-â‹¯' (x & Ï•) id âŸ©
    `/id (x & Ï•) â‹¯ id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„         â‰¡âŸ¨ â‹¯-id (`/id (x & Ï•)) âŸ©
    `/id (x & Ï•)                         âˆ

  Â·-idË¡ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚)
          â†’ (id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ Â·â‚– Ï•) ~ Ï•
  Â·-idË¡ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} Ï• mx x =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ Â·â‚– Ï•))          â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ id Ï• x) âŸ©
    `/id (sub (x & id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ &/â‹¯ Ï•))     â‰¡âŸ¨ cong (Î» â–  â†’ `/id (sub (â–  &/â‹¯ Ï•))) (&-id â¦ƒ ğ•‚ = ğ•‚â‚ â¦„ x) âŸ©
    `/id (sub (id/` x &/â‹¯ Ï•))                â‰¡âŸ¨ cong (`/id) (&/â‹¯-& x Ï•) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x & Ï•))) â‰¡âŸ¨ Î¹-âˆ‹/âŠ¢-~â‚œ (x & Ï•) âŸ©
    `/id (x & Ï•)                             âˆ

  -- Â·-assoc : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚â‚‚,â‚ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„
  --             â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚â‚‚ â¦„
  --             â¦ƒ Câ‚â‚‚,â‚ƒ : ComposeKit ğ•‚â‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚â‚‚,â‚ƒ â¦„
  --             â¦ƒ Câ‚‚â‚ƒ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ƒ ğ•‚â‚‚â‚ƒ â¦„
  --             â¦ƒ Câ‚,â‚‚â‚ƒ : ComposeKit ğ•‚â‚ ğ•‚â‚‚â‚ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„
  --             {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {Âµâ‚„}
  --             (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
  --             (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
  --             (Ï•â‚ƒ : Âµâ‚ƒ â€“[ ğ•‚â‚ƒ ]â†’ Âµâ‚„)
  --         â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ) ~ (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ))
  -- Â·-assoc â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚ƒ â¦„ â¦ƒ ğ•‚â‚â‚‚ â¦„ â¦ƒ ğ•‚â‚‚â‚ƒ â¦„ â¦ƒ ğ•‚â‚â‚‚,â‚ƒ â¦„ â¦ƒ ğ•‚â‚,â‚‚â‚ƒ â¦„ â¦ƒ Câ‚â‚‚ â¦„ â¦ƒ Câ‚â‚‚,â‚ƒ â¦„ â¦ƒ Câ‚‚â‚ƒ â¦„ â¦ƒ Câ‚,â‚‚â‚ƒ â¦„
  --         {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} {Âµâ‚„} Ï•â‚ Ï•â‚‚ Ï•â‚ƒ m x =
  --   let subâ‚â‚‚,â‚ƒ = subst (Âµâ‚„ âˆ‹/âŠ¢[ ğ•‚â‚â‚‚,â‚ƒ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
  --   let subâ‚â‚‚ = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
  --   let subâ‚,â‚‚â‚ƒ = subst (Âµâ‚„ âˆ‹/âŠ¢[ ğ•‚â‚,â‚‚â‚ƒ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
  --   let subâ‚‚â‚ƒ = subst (Âµâ‚„ âˆ‹/âŠ¢[ ğ•‚â‚‚â‚ƒ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
  --   `/id (x & ((Ï•â‚ Â·â‚– Ï•â‚‚) Â·â‚– Ï•â‚ƒ))                          â‰¡âŸ¨ cong (`/id) (&-&/â‹¯-Â·â‚– (Ï•â‚ Â·â‚– Ï•â‚‚) Ï•â‚ƒ x) âŸ©
  --   `/id (subâ‚â‚‚,â‚ƒ (x & (Ï•â‚ Â·â‚– Ï•â‚‚) &/â‹¯[ Câ‚â‚‚,â‚ƒ ] Ï•â‚ƒ))        â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚â‚‚,â‚ƒ (â–  &/â‹¯[ Câ‚â‚‚,â‚ƒ ] Ï•â‚ƒ)))
  --                                                                  (&-&/â‹¯-Â·â‚– Ï•â‚ Ï•â‚‚ x) âŸ©
  --   `/id (subâ‚â‚‚,â‚ƒ (subâ‚â‚‚ (x & Ï•â‚ &/â‹¯ Ï•â‚‚) &/â‹¯[ Câ‚â‚‚,â‚ƒ ] Ï•â‚ƒ)) â‰¡âŸ¨ {!&/â‹¯-assoc!} âŸ©
  --   `/id (subâ‚,â‚‚â‚ƒ (x & Ï•â‚ &/â‹¯[ Câ‚,â‚‚â‚ƒ ] (Ï•â‚‚ Â·â‚– Ï•â‚ƒ)))        â‰¡âŸ¨ cong (`/id) (sym (&-&/â‹¯-Â·â‚– Ï•â‚ (Ï•â‚‚ Â·â‚– Ï•â‚ƒ) x)) âŸ©
  --   `/id (x & (Ï•â‚ Â·â‚– (Ï•â‚‚ Â·â‚– Ï•â‚ƒ)))                          âˆ

  -- Alternative route:
    -- (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ (wkâ‚– _ (Ï• ,â‚– x/t)) ~ Ï•
  -- From which then follows:
    -- wkâ‚– _ Ï• Â· â¦… x/t â¦† ~
    -- wkâ‚– _ id Â· Ï• Â· â¦… x/t â¦† ~
    -- Ï• Â· wkâ‚– _ id Â· â¦… x/t â¦† ~
    -- Ï• Â· id ~
    -- Ï•
  wk-cancels-,â‚–-Â· :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m}
      (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    â†’ (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)) ~ Ï•
  wk-cancels-,â‚–-Â· â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• x/t mx x =
    let subâ‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) in
    `/id (x & (wkâ‚– _ id Â·â‚– (Ï• ,â‚– x/t)))         â‰¡âŸ¨ cong (`/id) (&-Â·â‚–-&/â‹¯ (wkâ‚– _ id) (Ï• ,â‚– x/t) x) âŸ©
    `/id (subâ‚ (x & wkâ‚– _ id &/â‹¯ (Ï• ,â‚– x/t)))   â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯[ C ] (Ï• ,â‚– x/t)))) (&-wkâ‚–-wk id x) âŸ©
    `/id (subâ‚ (wk _ (x & id) &/â‹¯ (Ï• ,â‚– x/t)))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (wk â¦ƒ ğ•‚â‚ â¦„ _ â–  &/â‹¯ (Ï• ,â‚– x/t)))) (&-id x) âŸ©
    `/id (subâ‚ (wk _ (id/` x) &/â‹¯ (Ï• ,â‚– x/t)))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚ (â–  &/â‹¯[ C ] (Ï• ,â‚– x/t)))) (wk-id/` _ x) âŸ©
    `/id (subâ‚ (id/` (there x) &/â‹¯ (Ï• ,â‚– x/t))) â‰¡âŸ¨ cong (`/id) (&/â‹¯-& (there x) (Ï• ,â‚– x/t)) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (there x & (Ï• ,â‚– x/t))))  â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ â– ))) (&-,â‚–-there Ï• x/t x) âŸ©
    `/id (subâ‚‚ (Î¹-âˆ‹/âŠ¢ (x & Ï•)))                 â‰¡âŸ¨ cong (`/id) (sym (Î¹-ap-â†’ Ï• x)) âŸ©
    `/id (x & (Î¹-â†’ Ï•))                          â‰¡âŸ¨ Î¹-~-â†’ Ï• _ x âŸ©
    `/id (x & Ï•)                                âˆ

  dist-wk-â†‘ :
    âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Câ‚‚â‚ : ComposeKit ğ•‚â‚‚ ğ•‚â‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      â¦ƒ Wâ‚ : WkKit ğ•‚â‚ â¦„
      â¦ƒ Wâ‚‚ : WkKit ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„
      {Âµâ‚} {Âµâ‚‚} {m}
      (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚) 
    â†’ (Ï• Â·â‚– wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) ~ (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id Â·â‚– (Ï• â†‘ m))
  dist-wk-â†‘ â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ Câ‚â‚‚ â¦„ â¦ƒ Câ‚‚â‚ â¦„ â¦ƒ Wâ‚ â¦„ â¦ƒ Wâ‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} Ï• mx x =
      let subâ‚ = subst ((Âµâ‚‚ â–· m) âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M mx) in
      let subâ‚‚ = subst ((Âµâ‚‚ â–· m) âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M mx) in
      let subâ‚‚' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M mx) in
      let subâ‚‚'' = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M mx) in
      `/id (x & (Ï• Â·â‚– wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id))              â‰¡âŸ¨ cong `/id (&-Â·â‚–-&/â‹¯ Ï• (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) x) âŸ©
      `/id (subâ‚ (x & Ï• &/â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id))        â‰¡âŸ¨ &/â‹¯-â‹¯' (x & Ï•) (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) âŸ©
      `/id (x & Ï•) â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id                 â‰¡âŸ¨ â‹¯-x/t-wk (x & Ï•) âŸ©
      `/id (wk _ (x & Ï•))                                â‰¡âŸ¨ `/id-wk-cong _ (x & Ï•) (subâ‚‚'' (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x & Ï•)))
                                                              (sym (Î¹-âˆ‹/âŠ¢-~â‚œ (x & Ï•))) âŸ©
      `/id (wk _ (subâ‚‚'' (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x & Ï•)))) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (wk _ â– )) (sym (&/â‹¯-& x Ï•)) âŸ©
      `/id (wk _ (subâ‚‚' (id/` x &/â‹¯ Ï•)))                 â‰¡âŸ¨ cong `/id (dist-subst' (Î» x â†’ x) (wk m) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ mx) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦ƒ ğ•Š â¦„ â¦ƒ Câ‚‚â‚ â¦„ â¦„ mx) (id/` x &/â‹¯ Ï•)) âŸ©
      `/id (subâ‚‚ (wk _ (id/` x &/â‹¯ Ï•)))                  â‰¡âŸ¨ cong (Î» â–  â†’ `/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (subâ‚‚ â– )) (&/â‹¯-wk-â†‘ (id/` x) Ï•) âŸ©
      `/id (subâ‚‚ (wk _ (id/` â¦ƒ ğ•‚â‚‚ â¦„ x) &/â‹¯ (Ï• â†‘ m)))     â‰¡âŸ¨ cong (Î» â–  â†’ `/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (subâ‚‚ (wk _ â–  &/â‹¯[ Câ‚‚â‚ ] (Ï• â†‘ m))))
                                                                 (sym (&-id x)) âŸ©
      `/id (subâ‚‚ (wk _ (x & id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„) &/â‹¯ (Ï• â†‘ m))) â‰¡âŸ¨ cong (Î» â–  â†’ `/id (subâ‚‚ (â–  &/â‹¯ (Ï• â†‘ m)))) (sym (&-wkâ‚–-wk (id â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„) x)) âŸ©
      `/id (subâ‚‚ (x & wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id &/â‹¯ (Ï• â†‘ m)))  â‰¡âŸ¨ cong `/id (sym (&-Â·â‚–-&/â‹¯ (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) (Ï• â†‘ m) x)) âŸ©
      `/id (x & (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id Â·â‚– (Ï• â†‘ m)))        âˆ

  -- Specializations for Renamings ------------------------------------------------

  infixl  9  _áµ£Â·_  _áµ£Â·áµ£_  _áµ£Â·â‚›_
  infixr  9  _âˆ˜áµ£_  _áµ£âˆ˜áµ£_  _â‚›âˆ˜áµ£_

  private instance _ = kitáµ£; _ = kitâ‚›; _ = ckitáµ£

  _áµ£Â·_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï áµ£Â· Ï• = Ï Â·â‚– Ï•

  _âˆ˜áµ£_ : âˆ€ â¦ƒ ğ•‚â‚‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
  Ï•â‚‚ âˆ˜áµ£ Ï•â‚ = Ï•â‚ áµ£Â· Ï•â‚‚

  _áµ£Â·áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
  _áµ£Â·â‚›_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _áµ£âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚ƒ
  _â‚›âˆ˜áµ£_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ} â†’ Âµâ‚‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ â†’ Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚ â†’ Âµâ‚ â€“[ kitâ‚› ]â†’ Âµâ‚ƒ
  _áµ£Â·áµ£_ = _áµ£Â·_
  _áµ£Â·â‚›_ = _áµ£Â·_
  _áµ£âˆ˜áµ£_ = _âˆ˜áµ£_
  _â‚›âˆ˜áµ£_ = _âˆ˜áµ£_

infixl  9  _Â·[_]_
infixr  9  _âˆ˜[_]_

_Â·[_]_ : âˆ€ â¦ƒ ğ•Š ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
         â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
         â†’ SubCompose ğ•Š
         â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
         â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
Ï•â‚ Â·[ C ] Ï•â‚‚ = Ï•â‚ Â·â‚– Ï•â‚‚ where open SubCompose C


_âˆ˜[_]_ : âˆ€ â¦ƒ ğ•Š ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ â¦ƒ C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}
         â†’ Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
         â†’ SubCompose ğ•Š
         â†’ Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚
         â†’ Âµâ‚ â€“[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]â†’ Âµâ‚ƒ
Ï•â‚‚ âˆ˜[ C ] Ï•â‚ = Ï•â‚‚ âˆ˜â‚– Ï•â‚ where open SubCompose C
