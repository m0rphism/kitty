open import Kitty.Term.Modes
open import Kitty.Term.Traversal using (Traversal; KitHomotopy)
import Kitty.Term.Sub

module Kitty.Term.ComposeKit {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) (T : Traversal ğ•‹) (H : KitHomotopy ğ•‹ T) (ğ•Š : Kitty.Term.Sub.SubWithLaws ğ•‹) where

open import Data.List using (List; []; _âˆ·_; length)
open import Data.List.Properties using (++-identityÊ³)
open import Data.List.Membership.Propositional using (_âˆˆ_)
open import Data.List.Relation.Unary.Any using (here; there)
open import Level using (Level; _âŠ”_) renaming (suc to lsuc; zero to lzero)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; trans; cong; congâ‚‚; subst; substâ‚‚; module â‰¡-Reasoning)
open import Relation.Nullary using (Â¬_)
open â‰¡-Reasoning

open import Kitty.Term.Prelude
open import Kitty.Term.Kit ğ•‹
open import Kitty.Term.KitOrder ğ•‹
open import Kitty.Term.Sub ğ•‹
open import Kitty.Util.SubstProperties

open Modes ğ•„
open Terms ğ•‹
open Traversal T
open KitHomotopy H
open Kit â¦ƒ â€¦ â¦„
open Sub â¦ƒ â€¦ â¦„
open SubWithLaws â¦ƒ â€¦ â¦„
open ~-Reasoning
open _âŠ‘â‚–_ â¦ƒ â€¦ â¦„

private instance _ = ğ•Š

private
  variable
    m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
    M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
    Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

private instance
  _ = kitáµ£
  _ = kitâ‚›

record ComposeKit (ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ : Kit) : Setâ‚ where
  infixl  8  _&/â‹¯_

  private instance _ = ğ•‚â‚; _ = ğ•‚â‚‚; _ = ğ•‚â‚âŠ”ğ•‚â‚‚

  field
    â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ : ğ•‚â‚ âŠ‘â‚– ğ•‚â‚âŠ”ğ•‚â‚‚
    â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ : ğ•‚â‚‚ âŠ‘â‚– ğ•‚â‚âŠ”ğ•‚â‚‚

    _&/â‹¯_ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m/M}
             â†’ Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M
             â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚
             â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ] (Î¹-Mode m/M)

    &/â‹¯-â‹¯ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m/M} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
            â†’ let sub = subst (Âµâ‚‚ âŠ¢_) (Î¹-mâ†’M/id m/M) in
              `/id' â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x/t &/â‹¯ Ï•) â‰¡ sub (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•)

    &/â‹¯-& : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
             â†’ let subâ‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
               let subâ‚‚ = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ m) in
               subâ‚ (id/` x &/â‹¯ Ï•) â‰¡ subâ‚‚ (Î¹-âˆ‹/âŠ¢ â¦ƒ ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x & Ï•))

    &/â‹¯-wk-â†‘ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} {mx}
                 (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] mx)
                 (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚)
               â†’ wk _ (x/t &/â‹¯ Ï•) â‰¡ wk _ x/t &/â‹¯ (Ï• â†‘ m)

    &/â‹¯-wk : âˆ€ {m'} {m/M : VarMode/TermMode â¦ƒ ğ•‚â‚ â¦„} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M)
                 â†’ x/t &/â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m' id â‰¡ Î¹-âˆ‹/âŠ¢ (wk m' x/t)

    -- â‹¯-x/t-wk : âˆ€ {m'} {m/M : VarMode/TermMode â¦ƒ ğ•‚â‚ â¦„} (x/t : Âµâ‚ âˆ‹/âŠ¢ m/M)
    --             â†’ (`/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) â‰¡ `/id' (wk m' x/t)

    -- &/â‹¯-wk : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} {mx}
    --             (Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --             (x : Âµâ‚ âˆ‹ mx)
    --           â†’ (x & Ï• &/â‹¯ wkâ‚– m id) â‰¡ Î¹-âˆ‹/âŠ¢ (wk _ (x & Ï•))

    ~-cong-&/â‹¯ :
      âˆ€ {x/tâ‚ x/tâ‚‚ : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] (id/mâ†’M m)}
        {Ï•â‚ Ï•â‚‚ : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚}
      â†’ x/tâ‚ â‰¡ x/tâ‚‚
      â†’ Ï•â‚ ~ Ï•â‚‚
      â†’ x/tâ‚ &/â‹¯ Ï•â‚ â‰¡ x/tâ‚‚ &/â‹¯ Ï•â‚‚

  â‹¯-x/t-wk' : âˆ€ {m'} {m/M : VarMode/TermMode â¦ƒ ğ•‚â‚ â¦„} (x/t : Âµâ‚ âˆ‹/âŠ¢ m/M)
              â†’ (`/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m' id) â‰¡ `/id' (wk m' x/t)
  â‹¯-x/t-wk' {Âµâ‚} {m'} {m/M} x/t =
    let sub = subst ((Âµâ‚ â–· m') âŠ¢_) (sym (Î¹-mâ†’M/id m/M)) in
    `/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m' id           â‰¡âŸ¨ sym (subst-sym' (Î¹-mâ†’M/id m/M)
                                                                  (`/id' (x/t &/â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id))
                                                                  (`/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m' id)
                                                                  (&/â‹¯-â‹¯ x/t (wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ m' id))) âŸ©
    sub (`/id' (x/t &/â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id)) â‰¡âŸ¨ cong (Î» â–  â†’ sub (`/id' â– )) (&/â‹¯-wk x/t) âŸ©
    sub (`/id' (Î¹-âˆ‹/âŠ¢ (wk m' x/t)))           â‰¡âŸ¨ sym (Î¹-`/id' (wk m' x/t)) âŸ©
    `/id' (wk m' x/t)                         âˆ

  â‹¯-x/t-wk : âˆ€ {m'} {m} (x/t : Âµ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m)
              â†’ (`/id x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) â‰¡ `/id (wk m' x/t)
  â‹¯-x/t-wk {Âµ} {m'} {m} x/t =
    let sub = subst (Âµ âŠ¢_) (id/mâ†’M/id m) in
    let sub' = subst ((Âµ â–· m') âŠ¢_) (id/mâ†’M/id m) in
    `/id x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id         â‰¡âŸ¨ cong (_â‹¯ _) (`/idâ‰¡`/id' x/t) âŸ©
    sub (`/id' x/t) â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id  â‰¡âŸ¨ dist-subst (_â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) (id/mâ†’M/id m) (`/id' x/t) âŸ©
    sub' (`/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚â‚‚ â¦„ _ id) â‰¡âŸ¨ cong sub' (â‹¯-x/t-wk' x/t) âŸ©
    sub' (`/id' (wk m' x/t))               â‰¡âŸ¨ sym (`/idâ‰¡`/id' (wk m' x/t)) âŸ©
    `/id (wk m' x/t)                       âˆ

  &/â‹¯-â‹¯' : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
          â†’ let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
            `/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (sub (x/t &/â‹¯ Ï•)) â‰¡ `/id â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•
  &/â‹¯-â‹¯' {Âµâ‚} {Âµâ‚‚} {m} x/t Ï• =
    let sub = subst (Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
    let subx = subst (Âµâ‚‚ âŠ¢_) (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m)) in
    let suby = subst (Âµâ‚‚ âŠ¢_) (Î¹-mâ†’M/id (id/mâ†’M m)) in
    let subxy = subst (Âµâ‚‚ âŠ¢_) (trans (Î¹-mâ†’M/id (id/mâ†’M m)) (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m))) in
    let subxyz = subst (Âµâ‚‚ âŠ¢_) (trans (trans (Î¹-mâ†’M/id (id/mâ†’M m)) (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m))) (id/mâ†’M/id m)) in
    let sub' = subst (Âµâ‚ âŠ¢_) (id/mâ†’M/id m) in
    let sub'' = subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) in
    let sub''' = subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) in
    `/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (sub (x/t &/â‹¯ Ï•))           â‰¡âŸ¨ `/idâ‰¡`/id' (sub (x/t &/â‹¯ Ï•)) âŸ©
    sub'' (`/id' â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (sub (x/t &/â‹¯ Ï•)))  â‰¡âŸ¨ cong sub'' (dist-subst' {F = Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ]_} mâ†’M/id (`/id') (Î¹-id/mâ†’M m) (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m)) (x/t &/â‹¯ Ï•)) âŸ©
    sub'' (subx (`/id' â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ (x/t &/â‹¯ Ï•))) â‰¡âŸ¨ cong (Î» â–  â†’ sub'' (subx â– )) (&/â‹¯-â‹¯ x/t Ï•) âŸ©
    sub'' (subx (suby (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•))) â‰¡âŸ¨ cong sub'' (subst-merge (Âµâ‚‚ âŠ¢_) _ (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m)) (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•)) âŸ©
    sub'' (subxy (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•))       â‰¡âŸ¨ subst-merge (Âµâ‚‚ âŠ¢_) _ (id/mâ†’M/id m) (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•) âŸ©
    subxyz (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•)
      â‰¡âŸ¨ subst-irrelevant {F = Âµâ‚‚ âŠ¢_}
          (trans (trans (Î¹-mâ†’M/id (id/mâ†’M m)) (cong (mâ†’M/id â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„) (Î¹-id/mâ†’M m))) (id/mâ†’M/id m))
          (id/mâ†’M/id m)
          (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•) âŸ©
    sub''' (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•)               â‰¡âŸ¨ sym (dist-subst (_â‹¯ Ï•) (id/mâ†’M/id m) (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t)) âŸ©
    sub' (`/id' â¦ƒ ğ•‚â‚ â¦„ x/t) â‹¯ Ï•                â‰¡âŸ¨ cong (_â‹¯ Ï•) (sym (`/idâ‰¡`/id' x/t)) âŸ©
    `/id â¦ƒ ğ•‚â‚ â¦„ x/t â‹¯ Ï•                        âˆ

    -- &/â‹¯-â‹¯ : âˆ€ {Âµâ‚} {Âµâ‚‚} {m/M} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
    --         â†’ let sub = subst (Âµâ‚‚ âŠ¢_) (Î¹-mâ†’M/id m/M) in
    --           `/id' â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ _ (x/t &/â‹¯ Ï•) â‰¡ sub (`/id' â¦ƒ ğ•‚â‚ â¦„ _ x/t â‹¯ Ï•)

    -- &/â‹¯-ap' : âˆ€ {Âµâ‚} {Âµâ‚‚} {m} (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
    --            â†’ id/` â¦ƒ ğ•‚â‚ â¦„ _ x &/â‹¯ Ï• ~â‚œ[ sym {!Î¹-mâ†’M/id m!} ] & Ï• _ x

-- -- --       let sub  = subst (Âµâ‚‚ âŠ¢_) (_âŠ‘â‚–_.Î¹-mâ†’M/id ğ•‚â‚‚âŠ‘ğ•‚ m/M) in
-- -- --       sub (Kit.`/id' ğ•‚â‚‚ _ x/t â‹¯ Ï•) â‰¡ Kit.`/id' ğ•‚ _ (x/t â‹¯á¶œ Ï•)

    -- tm-&/â‹¯-Â· : âˆ€ (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    --               (x/t : Âµâ‚ âˆ‹/âŠ¢ m)
    --             â†’ `/id' (& Ï•â‚ _ x) â‹¯ Ï•â‚‚ â‰¡ `/id (& (Ï•â‚ Â·â‚– Ï•â‚‚) _ x)

    -- &/â‹¯-ap : âˆ€ {m/M} (x/t : Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
    --           â†’ let sub = subst (Âµâ‚‚ âŠ¢_) (Î¹-mâ†’M/id m/M) in
    --             `/id' â¦ƒ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ _ (x/t &/â‹¯ Ï•) â‰¡ sub (`/id' â¦ƒ ğ•‚â‚ â¦„ _ x/t â‹¯ Ï•)

    -- dist-wk-Â· : âˆ€ m
    --               (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --               (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    --             â†’ wkâ‚– m (Ï•â‚ Â·â‚– Ï•â‚‚) ~ (Ï•â‚ Â·â‚– wkâ‚– m Ï•â‚‚)

    -- dist-,â‚–-Â·Ë¡ : âˆ€ {m}
    --                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    --                (x/t : Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] id/mâ†’M m)
    --              â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚âŠ” ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
    --                ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚– sub (x/t &/â‹¯ Ï•â‚‚)) ~ ((Ï•â‚ ,â‚– x/t) Â·â‚– Ï•â‚‚)

    -- dist-,â‚–-Â·Ê³ : âˆ€ {m}
    --                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    --                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    --                (x/t : Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    --              â†’ ((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚–' x/t) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ ,â‚– x/t))

    -- -- dist-,â‚–-Â·Ê³ : âˆ€ {m}
    -- --                (Ï•â‚ : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚)
    -- --                (Ï•â‚‚ : Âµâ‚‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚ƒ)
    -- --                (x/t : Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚‚ ] id/mâ†’M m)
    -- --              â†’ let sub = subst (Âµâ‚ƒ âˆ‹/âŠ¢[ ğ•‚â‚âŠ” ğ•‚â‚‚ ]_) (Î¹-id/mâ†’M m) in
    -- --                (((Ï•â‚ Â·â‚– Ï•â‚‚) ,â‚– sub (Î¹-âˆ‹/âŠ¢ x/t))) ~ ((Ï•â‚ â†‘ m) Â·â‚– (Ï•â‚‚ ,â‚– x/t))

infixl  8  _&/â‹¯[_]_

_&/â‹¯[_]_ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚ â¦„ {m/M}
            â†’ Âµâ‚ âˆ‹/âŠ¢[ ğ•‚â‚ ] m/M
            â†’ (C : ComposeKit ğ•‚â‚ ğ•‚â‚‚ ğ•‚â‚âŠ”ğ•‚â‚‚)
            â†’ Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚
            â†’ Âµâ‚‚ âˆ‹/âŠ¢[ ğ•‚â‚âŠ”ğ•‚â‚‚ ] (Î¹-Mode â¦ƒ ComposeKit.ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚ C â¦„ m/M)
x/t &/â‹¯[ C ] Ï• = x/t &/â‹¯ Ï• where open ComposeKit C

open ComposeKit â¦ƒ â€¦ â¦„

~-cong-wk : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ â¦„
              â¦ƒ Cx : ComposeKit ğ•‚â‚ kitáµ£ ğ•‚â‚ â¦„
              â¦ƒ Cy : ComposeKit ğ•‚â‚‚ kitáµ£ ğ•‚â‚‚ â¦„
              {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
  Ï• ~ Ï•' â†’
  wkâ‚– m Ï• ~ wkâ‚– m Ï•'
~-cong-wk â¦ƒ ğ•‚â‚ â¦„ â¦ƒ ğ•‚â‚‚ â¦„ â¦ƒ Câ‚â‚‚ â¦„ â¦ƒ Câ‚‚â‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' mx x =
  `/id â¦ƒ ğ•‚â‚ â¦„ (x & wkâ‚– _ Ï•)                     â‰¡âŸ¨ cong `/id (&-wkâ‚–-wk Ï• x) âŸ©
  `/id â¦ƒ ğ•‚â‚ â¦„ (wk _ (x & Ï•))                    â‰¡âŸ¨ sym (â‹¯-x/t-wk (x & Ï•)) âŸ©
  `/id â¦ƒ ğ•‚â‚ â¦„ (x & Ï•) â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id   â‰¡âŸ¨ cong (_â‹¯ _) (Ï•~Ï•' mx x) âŸ©
  `/id â¦ƒ ğ•‚â‚‚ â¦„ (x & Ï•') â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id  â‰¡âŸ¨ â‹¯-x/t-wk (x & Ï•') âŸ©
  `/id â¦ƒ ğ•‚â‚‚ â¦„ (wk _ (x & Ï•'))                   â‰¡âŸ¨ cong `/id (sym (&-wkâ‚–-wk Ï•' x)) âŸ©
  `/id â¦ƒ ğ•‚â‚‚ â¦„ (x & wkâ‚– _ Ï•')                    âˆ

~-cong-wk* : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ â¦„
              â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ kitáµ£ ğ•‚â‚ â¦„
              â¦ƒ Câ‚‚â‚ : ComposeKit ğ•‚â‚‚ kitáµ£ ğ•‚â‚‚ â¦„
              {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
  Ï• ~ Ï•' â†’
  wkâ‚–* Âµ Ï• ~ wkâ‚–* Âµ Ï•'
~-cong-wk* {Âµ = []} {Ï•} {Ï•'} Ï•~Ï•' =
  wkâ‚–* [] Ï•  ~âŸ¨ wkâ‚–*-[] Ï• âŸ©
  Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
  Ï•'         ~âŸ¨ ~-sym (wkâ‚–*-[] Ï•') âŸ©
  wkâ‚–* [] Ï•' ~âˆ
~-cong-wk* {Âµ = Âµ â–· m} {Ï•} {Ï•'} Ï•~Ï•' =
  wkâ‚–* (Âµ â–· m) Ï•    ~âŸ¨ wkâ‚–*-â–· Âµ m Ï• âŸ©
  wkâ‚– m (wkâ‚–* Âµ Ï•)  ~âŸ¨ ~-cong-wk (~-cong-wk* Ï•~Ï•') âŸ©
  wkâ‚– m (wkâ‚–* Âµ Ï•') ~âŸ¨ ~-sym (wkâ‚–*-â–· Âµ m Ï•') âŸ©
  wkâ‚–* (Âµ â–· m) Ï•' ~âˆ

~-cong-â†‘ : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ â¦„
              â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ kitáµ£ ğ•‚â‚ â¦„
              â¦ƒ Câ‚‚â‚ : ComposeKit ğ•‚â‚‚ kitáµ£ ğ•‚â‚‚ â¦„
              {Âµâ‚} {Âµâ‚‚} {m} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
  Ï• ~ Ï•' â†’
  (Ï• â†‘ m) ~ (Ï•' â†‘ m)
~-cong-â†‘ {Âµâ‚} {Âµâ‚‚} {m} {Ï•} {Ï•'} Ï•~Ï•' =
  (Ï• â†‘ m)                           ~âŸ¨ â†‘-,â‚– Ï• m âŸ©
  (wkâ‚– _ Ï•  ,â‚– id/` (here refl))  ~âŸ¨ ~-cong-,â‚– (~-cong-wk Ï•~Ï•') ~â‚“-refl âŸ©
  (wkâ‚– _ Ï•' ,â‚– id/` (here refl))  ~âŸ¨ ~-sym (â†‘-,â‚– Ï•' m) âŸ©
  (Ï•' â†‘ m)                          ~âˆ

~-cong-â†‘* : âˆ€ â¦ƒ ğ•‚â‚ ğ•‚â‚‚ â¦„
              â¦ƒ Câ‚â‚‚ : ComposeKit ğ•‚â‚ kitáµ£ ğ•‚â‚ â¦„
              â¦ƒ Câ‚‚â‚ : ComposeKit ğ•‚â‚‚ kitáµ£ ğ•‚â‚‚ â¦„
              {Âµâ‚} {Âµâ‚‚} {Âµ} {Ï• : Âµâ‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚‚} {Ï•' : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚} â†’
  Ï• ~ Ï•' â†’
  (Ï• â†‘* Âµ) ~ (Ï•' â†‘* Âµ)
~-cong-â†‘* {Âµ = []}    {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
  (Ï• â†‘* [])  ~âŸ¨ â†‘*-[] Ï• âŸ©
  Ï•          ~âŸ¨ Ï•~Ï•' âŸ©
  Ï•'         ~âŸ¨ ~-sym (â†‘*-[] Ï•') âŸ©
  (Ï•' â†‘* []) ~âˆ
~-cong-â†‘* {Âµ = Âµ â–· m} {Ï• = Ï•} {Ï•' = Ï•'} Ï•~Ï•' =
  (Ï• â†‘* (Âµ â–· m))  ~âŸ¨ â†‘*-â–· Âµ m Ï• âŸ©
  (Ï• â†‘* Âµ) â†‘ m    ~âŸ¨ ~-cong-â†‘ (~-cong-â†‘* Ï•~Ï•') âŸ©
  (Ï•' â†‘* Âµ) â†‘ m   ~âŸ¨ ~-sym (â†‘*-â–· Âµ m Ï•') âŸ©
  (Ï•' â†‘* (Âµ â–· m)) ~âˆ

âŠ‘â‚–-âŠ¤ : âˆ€ â¦ƒ ğ•Š : SubWithLaws â¦„ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ C : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â†’ ğ•‚ âŠ‘â‚– kitâ‚›
âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚ â¦„ = record
  { Î¹-Mode   = mâ†’M/id
  ; Î¹-id/mâ†’M = id/mâ†’M/id
  ; Î¹-mâ†’M/id = Î» m/M â†’ refl
  ; Î¹-âˆ‹/âŠ¢    = `/id'
  ; Î¹-id/`   = id/`/id'
  ; Î¹-`/id   = Î» {Âµ} {m} x/t â†’
      let sub = subst (Âµ âŠ¢_) (Kit.id/mâ†’M/id ğ•‚ m) in
      `/id x/t        â‰¡âŸ¨ `/idâ‰¡`/id' x/t âŸ©
      sub (`/id' x/t) âˆ
  ; Î¹-`/id'  = Î» x/t â†’ refl
  ; Î¹-wk     = Î» {m'} {m} {Âµ} {m/M} x/t â†’
      `/id' (wk _ x/t)                  â‰¡âŸ¨ sym (â‹¯-x/t-wk' x/t) âŸ©
      `/id' x/t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‰¡âŸ¨âŸ©
      Kit.wk kitâ‚› _ (Kit.`/id' ğ•‚ x/t)   âˆ
  ; Î¹-âˆ‹/âŠ¢-id = Î» { refl x/t â†’ refl }
  ; Î¹-âˆ‹/âŠ¢-~â‚œ = Î» {Âµ} {m} x/t â†’
      let sub = subst (Âµ âŠ¢_) (id/mâ†’M/id m) in
      sub (`/id' â¦ƒ ğ•‚ â¦„ x/t) â‰¡âŸ¨ sym (`/idâ‰¡`/id' x/t) âŸ©
      `/id x/t              âˆ
  ; Î¹-âˆ‹/âŠ¢-~â‚œ[] = Î» x/t â†’ refl
  }

-- ComposeKit for Renamings ----------------------------------------------------

-- &/â‹¯-wkáµ£ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx}
--              (Ï• : Âµâ‚ â€“[ kitáµ£ ]â†’ Âµâ‚‚)
--              (x : Âµâ‚ âˆ‹ mx)
--            â†’ (x & Ï• & (wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m id)) â‰¡ Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ (wk _ (x & Ï•))
-- &/â‹¯-wkáµ£ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx} Ï• x =
--   x & Ï• & (wkâ‚– _ id)                      â‰¡âŸ¨ &-wkâ‚–-wk id (x & Ï•) âŸ©
--   wk _ (x & Ï• & id)                       â‰¡âŸ¨ cong (wk _) (&-id (x & Ï•)) âŸ©
--   wk _ (id/` (x & Ï•))                     â‰¡âŸ¨ sym (Î¹-wk â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ {m = m} (x & Ï•)) âŸ©
--   Î¹-âˆ‹/âŠ¢ â¦ƒ âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„ â¦„ (wk _ (x & Ï•)) âˆ

&/â‹¯-wkáµ£ : âˆ€ â¦ƒ ğ•‚ â¦„ {m'} {m} (x : Âµâ‚ âˆ‹ m)
          â†’ x & wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m' id â‰¡ id/` (wk m' x)
&/â‹¯-wkáµ£ {Âµâ‚} â¦ƒ ğ•‚ â¦„ {m'} {m} x =
  x & wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m' id â‰¡âŸ¨ &-wkâ‚–-wk id x âŸ©
  wk m' (x & id)          â‰¡âŸ¨ cong (wk m') (&-id x) âŸ©
  wk m' (id/` x )         â‰¡âŸ¨ wk-id/` m' x âŸ©
  id/` (wk m' x)          âˆ

&/â‹¯-wkâ‚› : âˆ€ â¦ƒ ğ•‚ â¦„
            â¦ƒ C : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„
            {m'} {M} (t : Âµâ‚ âŠ¢ M)
          â†’ t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m' id â‰¡ wk m' t
&/â‹¯-wkâ‚› {Âµâ‚} â¦ƒ ğ•‚ â¦„ {m'} {M} t =
  t â‹¯ wkâ‚– â¦ƒ ğ•‚ = ğ•‚ â¦„ m' id    â‰¡âŸ¨ ~-cong-â‹¯ t {!~-cong-wk!} âŸ©
  t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m' id â‰¡âŸ¨ {!!} âŸ©
  wk m' t                    âˆ

&/â‹¯-â‹¯áµ£ : âˆ€ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} (x : Âµâ‚ âˆ‹ m) (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) 
        â†’ let sub = subst (Âµâ‚‚ âŠ¢_) (sym (id/mâ†’M/id m)) in
          `/id' â¦ƒ ğ•‚â‚‚ â¦„ (x & Ï•) â‰¡ sub (` x â‹¯ Ï•)
&/â‹¯-â‹¯áµ£ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} x Ï• =
  let sub = subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) in
  let subâ»Â¹ = subst (Âµâ‚‚ âŠ¢_) (sym (id/mâ†’M/id m)) in
  `/id' â¦ƒ ğ•‚â‚‚ â¦„ (x & Ï•)        â‰¡âŸ¨ sym (cancel-subst (Âµâ‚‚ âŠ¢_) (id/mâ†’M/id m) (`/id' (x & Ï•))) âŸ©
  subâ»Â¹ (sub (`/id' (x & Ï•))) â‰¡âŸ¨ cong subâ»Â¹ (sym (`/idâ‰¡`/id' (x & Ï•))) âŸ©
  subâ»Â¹ (`/id â¦ƒ ğ•‚â‚‚ â¦„ (x & Ï•)) â‰¡âŸ¨ cong subâ»Â¹ (sym (â‹¯-var x Ï•)) âŸ©
  subâ»Â¹ (` x â‹¯ Ï•)             âˆ

&/â‹¯-wk-â†‘áµ£ : âˆ€ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx}
              (x : Âµâ‚ âˆ‹ mx)
              (Ï• : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚)
            â†’ wk _ (x & Ï•) â‰¡ there x & (Ï• â†‘ m)
&/â‹¯-wk-â†‘áµ£ â¦ƒ ğ•‚â‚‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx} x Ï• =
  wk _ (x & Ï•)     â‰¡âŸ¨ sym (&-â†‘-there Ï• x) âŸ©
  wk _ x & (Ï• â†‘ m) âˆ

ckitáµ£ : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ ComposeKit kitáµ£ ğ•‚ ğ•‚
ckitáµ£ â¦ƒ ğ•‚ â¦„ = record
  { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-âŠ¥ â¦ƒ ğ•‚ = ğ•‚ â¦„
  ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-refl â¦ƒ ğ•‚ â¦„
  ; _&/â‹¯_      = _&_
  ; &/â‹¯-â‹¯      = &/â‹¯-â‹¯áµ£
  ; &/â‹¯-&      = Î» x Ï• â†’ refl
  ; &/â‹¯-wk-â†‘   = &/â‹¯-wk-â†‘áµ£
  ; &/â‹¯-wk     = &/â‹¯-wkáµ£
  ; ~-cong-&/â‹¯ = Î» { refl Ï•â‚~Ï•â‚‚ â†’ ~â†’~' Ï•â‚~Ï•â‚‚ _ _ }
  }

-- &/â‹¯-wk-â†‘â‚› : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx}
--               (t : Âµâ‚ âŠ¢ mx)
--               (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
--             â†’ wk _ (t â‹¯ Ï•) â‰¡ wk _ t â‹¯ (Ï• â†‘ m)
-- &/â‹¯-wk-â†‘â‚› â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {m} {mx} t Ï• =
--   wk _ (t â‹¯ Ï•)                                        â‰¡âŸ¨ {!!} âŸ©
--   t â‹¯ Ï• â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id                       â‰¡âŸ¨ {!!} âŸ©
--   t â‹¯ (Ï• â†‘* []) â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* [])       â‰¡âŸ¨âŸ©
--   t â‹¯* (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id âˆ· Ï• âˆ· []) â†‘** []        â‰¡âŸ¨
--     â‹¯-â†‘ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id âˆ· Ï• âˆ· [])
--         ((Ï• â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id âˆ· [])
--         (Î» {Âµ'} x â†’
--           ` x â‹¯ (Ï• â†‘* Âµ') â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* Âµ')           â‰¡âŸ¨ cong (_â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* Âµ')) (â‹¯-var x (Ï• â†‘* Âµ')) âŸ©
--           `/id (x & (Ï• â†‘* Âµ')) â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* Âµ')       â‰¡âŸ¨ {!!} âŸ©
--           `/id (x & (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* Âµ')) â‹¯ ((Ï• â†‘ m) â†‘* Âµ') â‰¡âŸ¨ cong (_â‹¯ Ï• â†‘ m â†‘* Âµ') (sym (â‹¯-var x (wkâ‚– _ id â†‘* Âµ'))) âŸ©
--           ` x â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* Âµ') â‹¯ ((Ï• â†‘ m) â†‘* Âµ')      âˆ
--         )
--         t âŸ©
--   t â‹¯* ((Ï• â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id âˆ· []) â†‘** []  â‰¡âŸ¨âŸ©
--   t â‹¯ (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â†‘* []) â‹¯ ((Ï• â†‘ m) â†‘* []) â‰¡âŸ¨ {!!} âŸ©
--   t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ (Ï• â†‘ m)                 â‰¡âŸ¨ {!!} âŸ©
--   wk _ t â‹¯ (Ï• â†‘ m)                                    âˆ

-- ckitâ‚› : âˆ€ â¦ƒ ğ•‚ â¦„ â†’ ComposeKit kitâ‚› ğ•‚ kitâ‚›
-- ckitâ‚› â¦ƒ ğ•‚ â¦„ = record
--   { ğ•‚â‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-refl â¦ƒ kitâ‚› â¦„
--   ; ğ•‚â‚‚âŠ‘ğ•‚â‚âŠ”ğ•‚â‚‚   = âŠ‘â‚–-âŠ¤ â¦ƒ ğ•Š â¦„ â¦ƒ ğ•‚ â¦„
--   ; _&/â‹¯_      = _â‹¯_
--   ; &/â‹¯-â‹¯      = {!&/â‹¯-â‹¯áµ£!}
--   ; &/â‹¯-ap     = Î» x Ï• â†’ {!!}
--   ; &/â‹¯-wk-â†‘   = &/â‹¯-wk-â†‘â‚›
--   ; ~-cong-&/â‹¯ = {!Î» { refl Ï•â‚~Ï•â‚‚ â†’ ~â†’~' Ï•â‚~Ï•â‚‚ _ _ }!}
  -- }
