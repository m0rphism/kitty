open import Kitty.Term.Modes

-- Version of KitAlt with a simpler KitTraversal.â‹¯-â†‘ field.

module Kitty.Term.KitAltSimple {ğ•„ : Modes} (ğ•‹ : Terms ğ•„) where

open import Data.List using (List; []; _âˆ·_; _++_)
open import Data.List.Properties using (++-assoc)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; cong; congâ‚‚; subst; substâ‚‚; sym; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Data.List.Relation.Unary.Any using (here; there)
open import Axiom.Extensionality.Propositional using (Extensionality)
open import Kitty.Term.Prelude
open import Level using (_âŠ”_)

open import Kitty.Util.Star

open Modes ğ•„
open Terms ğ•‹

private
  variable
    m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : VarMode
    M Mâ‚ Mâ‚‚ Mâ‚ƒ M' Mâ‚' Mâ‚‚' Mâ‚ƒ' : TermMode
    Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List VarMode

-- Alternative KitTraversal ----------------------------------------------------

open import Kitty.Term.Kit ğ•‹
open import Kitty.Util.Homotopy

open Kit {{...}}

_â€“[_]â†’*_ : List VarMode â†’ (_ : List Kit) â†’ List VarMode â†’ Set _
Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ = Star (Î» ğ•‚ x y â†’ y â€“[ ğ•‚ ]â†’ x) ğ•‚s Âµâ‚‚ Âµâ‚

infixl  6  _â†‘**_
_â†‘**_ : {ğ•‚s : List Kit} â†’ Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ â†’ âˆ€ Âµ' â†’ (Âµ' ++ Âµâ‚) â€“[ ğ•‚s ]â†’* (Âµ' ++ Âµâ‚‚)
[] â†‘** Âµ' = []
(_âˆ·_ {b = ğ•‚} f fs) â†‘** Âµ' = (Kit._â†‘*_ ğ•‚ f Âµ') âˆ· (fs â†‘** Âµ')

â†‘**-neutral :
  âˆ€ {ğ•‚s : List Kit}
  â†’ (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚)
  â†’ fs â†‘** [] â‰¡ fs
â†‘**-neutral []       = refl
â†‘**-neutral (f âˆ· fs) = cong (f âˆ·_) (â†‘**-neutral fs)

subst-[] :
  âˆ€ {â„“â‚ â„“â‚‚} {A : Set â„“â‚} {B : Set â„“â‚‚} (R : B â†’ A â†’ A â†’ Set) {aâ‚ aâ‚'}
  â†’ (eqâ‚ : aâ‚ â‰¡ aâ‚')
  â†’ [] â‰¡ substâ‚‚ (Star R []) eqâ‚ eqâ‚ []
subst-[] R refl = refl

subst-[]-flip :
  âˆ€ {â„“â‚ â„“â‚‚} {A : Set â„“â‚} {B : Set â„“â‚‚} (R : B â†’ A â†’ A â†’ Set) {aâ‚ aâ‚'}
  â†’ (eqâ‚ : aâ‚ â‰¡ aâ‚')
  â†’ [] â‰¡ substâ‚‚ (Î» x y â†’ Star R [] y x) eqâ‚ eqâ‚ []
subst-[]-flip R refl = refl

subst-âˆ· :
  âˆ€ {â„“â‚ â„“â‚‚} {A : Set â„“â‚} {B : Set â„“â‚‚} (R : B â†’ A â†’ A â†’ Set) {aâ‚ aâ‚' aâ‚‚ aâ‚‚' aâ‚ƒ aâ‚ƒ' : A}
    {b} {bs} {r : R b aâ‚ aâ‚‚} {rs : Star R bs aâ‚‚ aâ‚ƒ}
  â†’ (eqâ‚ : aâ‚ â‰¡ aâ‚')
  â†’ (eqâ‚‚ : aâ‚‚ â‰¡ aâ‚‚')
  â†’ (eqâ‚ƒ : aâ‚ƒ â‰¡ aâ‚ƒ')
  â†’ let sub = substâ‚‚ (Star R (b âˆ· bs)) eqâ‚ eqâ‚ƒ in
    let subâ‚ = substâ‚‚ (R b) eqâ‚ eqâ‚‚ in
    let subâ‚‚ = substâ‚‚ (Star R bs) eqâ‚‚ eqâ‚ƒ in
    sub (r âˆ· rs) â‰¡ subâ‚ r âˆ· subâ‚‚ rs
subst-âˆ· R refl refl refl = refl

subst-âˆ·-flipped :
  âˆ€ {â„“â‚ â„“â‚‚} {A : Set â„“â‚} {B : Set â„“â‚‚} (R : B â†’ A â†’ A â†’ Set) {aâ‚ aâ‚' aâ‚‚ aâ‚‚' aâ‚ƒ aâ‚ƒ' : A}
    {b} {bs} {r : R b aâ‚ aâ‚‚} {rs : Star R bs aâ‚‚ aâ‚ƒ}
  â†’ (eqâ‚ : aâ‚ â‰¡ aâ‚')
  â†’ (eqâ‚‚ : aâ‚‚ â‰¡ aâ‚‚')
  â†’ (eqâ‚ƒ : aâ‚ƒ â‰¡ aâ‚ƒ')
  â†’ let sub = substâ‚‚ (Î» x y â†’ Star R (b âˆ· bs) y x) eqâ‚ƒ eqâ‚ in
    let subâ‚ = substâ‚‚ (Î» x y â†’ R b y x) eqâ‚‚ eqâ‚ in
    let subâ‚‚ = substâ‚‚ (Î» x y â†’ Star R bs y x) eqâ‚ƒ eqâ‚‚ in
    sub (r âˆ· rs) â‰¡ subâ‚ r âˆ· subâ‚‚ rs
subst-âˆ·-flipped R refl refl refl = refl

open import Kitty.Util.SubstProperties

dist-â†‘*-â–·â–· :
  âˆ€ {{ğ•‚ : Kit}} Âµ' Âµ''
  â†’ (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚)
  â†’ let sub = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
    f â†‘* Âµ' â†‘* Âµ'' â‰¡ sub (f â†‘* (Âµ' â–·â–· Âµ''))
dist-â†‘*-â–·â–· {Âµâ‚} {Âµâ‚‚} Âµ' []        f = refl
dist-â†‘*-â–·â–· {Âµâ‚} {Âµâ‚‚} {{ğ•‚}} Âµ' (Âµ'' â–· m) f =
  let sub = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
                               (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
  let sub'' = substâ‚‚ (Î» x y â†’ (x â–· m) â€“[ ğ•‚ ]â†’ (y â–· m)) (++-assoc Âµ'' Âµ' Âµâ‚)
                                                       (++-assoc Âµ'' Âµ' Âµâ‚‚) in
  let sub' = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (++-assoc Âµ'' Âµ' Âµâ‚)
                                (++-assoc Âµ'' Âµ' Âµâ‚‚) in
  f â†‘* Âµ' â†‘* (Âµ'' â–· m)         â‰¡âŸ¨âŸ©
  f â†‘* Âµ' â†‘* Âµ'' â†‘ m           â‰¡âŸ¨ cong (_â†‘ m) (dist-â†‘*-â–·â–· Âµ' Âµ'' f) âŸ©
  sub' (f â†‘* (Âµ' â–·â–· Âµ'')) â†‘ m  â‰¡âŸ¨ dist-substâ‚‚ (Î» â–  â†’ _â†‘_ â¦ƒ ğ•‚ â¦„ â–  m) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) (f â†‘* (Âµ' â–·â–· Âµ'')) âŸ©
  sub'' (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m) â‰¡âŸ¨ comm-substâ‚‚ (_â–· m) (_â–· m) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m) âŸ©
  sub (f â†‘* (Âµ' â–·â–· Âµ'') â†‘ m)   â‰¡âŸ¨âŸ©
  sub (f â†‘* (Âµ' â–·â–· (Âµ'' â–· m))) âˆ

dist-â†‘**-â–·â–· :
  âˆ€ {ğ•‚s : List Kit} Âµ' Âµ''
  â†’ (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚)
  â†’ let sub = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
    f â†‘** Âµ' â†‘** Âµ'' â‰¡ sub (f â†‘** (Âµ' â–·â–· Âµ''))
dist-â†‘**-â–·â–· {Âµâ‚} {Âµâ‚‚} {ğ•‚s = ğ•‚s} Âµ' []        f =
  f â†‘** Âµ' â†‘** []  â‰¡âŸ¨ â†‘**-neutral (f â†‘** Âµ') âŸ©
  f â†‘** Âµ'         â‰¡âŸ¨âŸ©
  f â†‘** (Âµ' â–·â–· []) âˆ
dist-â†‘**-â–·â–· {Âµâ‚} {.Âµâ‚} Âµ' (Âµ'' â–· m) []       = subst-[]-flip (Î» ğ•‚s Âµâ‚‚ Âµâ‚ â†’ Âµâ‚ â€“[ ğ•‚s ]â†’ Âµâ‚‚) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
dist-â†‘**-â–·â–· {Âµâ‚} {Âµâ‚‚} {ğ•‚ âˆ· ğ•‚s}  Âµ' (Âµ'' â–· m) (_âˆ·_ {x = .Âµâ‚‚} {y = y} f fs) =
  let sub = substâ‚‚ (_â€“[ ğ•‚ âˆ· ğ•‚s ]â†’*_) (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚)
                                     (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚‚) in
  let subâ‚ = substâ‚‚ (_â€“[ ğ•‚ ]â†’_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' y))
                                (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
  let subâ‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' Âµâ‚))
                                  (cong (_âˆ·_ m) (++-assoc Âµ'' Âµ' y)) in
  let instance _ = ğ•‚ in
  (f âˆ· fs) â†‘** Âµ' â†‘** (Âµ'' â–· m)                                       â‰¡âŸ¨âŸ©
  (f â†‘* Âµ' â†‘* Âµ'' â†‘ m) âˆ· (fs â†‘** Âµ' â†‘** (Âµ'' â–· m))                    â‰¡âŸ¨ congâ‚‚ _âˆ·_ (dist-â†‘*-â–·â–· Âµ' (Âµ'' â–· m) f)
                                                                                   (dist-â†‘**-â–·â–· Âµ' (Âµ'' â–· m) fs) âŸ©
  (subâ‚ (f â†‘* (Âµ' â–·â–· (Âµ'' â–· m)))) âˆ· (subâ‚‚ (fs â†‘** (Âµ' â–·â–· (Âµ'' â–· m)))) â‰¡âŸ¨ sym (subst-âˆ·-flipped
                                                                           (Î» ğ•‚s Âµâ‚‚ Âµâ‚ â†’ Âµâ‚ â€“[ ğ•‚s ]â†’ Âµâ‚‚)
                                                                           (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚‚)
                                                                           (++-assoc (Âµ'' â–· m) Âµ' y)
                                                                           (++-assoc (Âµ'' â–· m) Âµ' Âµâ‚)) âŸ©
  sub ((f â†‘* (Âµ' â–·â–· (Âµ'' â–· m))) âˆ· (fs â†‘** (Âµ' â–·â–· (Âµ'' â–· m))))         â‰¡âŸ¨âŸ©
  sub ((f âˆ· fs) â†‘** (Âµ' â–·â–· (Âµ'' â–· m)))                                âˆ

module TraversalOps (_â‹¯_ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {M} â†’ Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M) where
  infixl  5 _â‹¯*_
  _â‹¯*_ : âˆ€ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ M} â†’
        Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M
  t â‹¯* fs = fold-star' (Î» ğ•‚ _ _ t f â†’ _â‹¯_ {{ğ•‚}} t f) t fs

  _â‰ˆâ‚“_ : âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚} â†’ (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) â†’ (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚) â†’ Set
  _â‰ˆâ‚“_ {Âµâ‚ = Âµâ‚} f g = âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m) â†’ (` x) â‹¯* (f â†‘** Âµâ‚') â‰¡ (` x) â‹¯* (g â†‘** Âµâ‚')

  _â‰ˆâ‚œ_ : âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚} â†’ (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) â†’ (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚) â†’ Set
  _â‰ˆâ‚œ_ {Âµâ‚ = Âµâ‚} f g = âˆ€ {Âµâ‚'} {M} (t : (Âµâ‚ â–·â–· Âµâ‚') âŠ¢ M) â†’ t â‹¯* (f â†‘** Âµâ‚') â‰¡ t â‹¯* (g â†‘** Âµâ‚')

  subst-â‹¯ :
    âˆ€ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ Âµâ‚' Âµâ‚‚'}
      (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {M} (t : Âµâ‚' âŠ¢ M)
    â†’ (Âµâ‚â‰¡Âµâ‚' : Âµâ‚ â‰¡ Âµâ‚')
    â†’ (Âµâ‚‚â‰¡Âµâ‚‚' : Âµâ‚‚ â‰¡ Âµâ‚‚')
    â†’ let subâŠ¢â‚‚â»Â¹ = subst (_âŠ¢ _) (sym Âµâ‚‚â‰¡Âµâ‚‚') in
      let subâŠ¢â‚â»Â¹ = subst (_âŠ¢ M) (sym Âµâ‚â‰¡Âµâ‚') in
      let subâ†’â‚â‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) Âµâ‚â‰¡Âµâ‚' Âµâ‚‚â‰¡Âµâ‚‚' in
      subâŠ¢â‚‚â»Â¹ (t â‹¯* subâ†’â‚â‚‚ f) â‰¡
      subâŠ¢â‚â»Â¹ t â‹¯* f
  subst-â‹¯ f M refl refl = refl

  lemy :
    âˆ€ {ğ•‚s : List Kit} {Âµâ‚ Âµâ‚‚ Âµ' Âµ''}
      (f : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) m (x : (Âµâ‚ â–·â–· Âµ' â–·â–· Âµ'') âˆ‹ m)
    â†’ let subâ‚ = subst (_âˆ‹ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
      let subâ‚‚ = subst (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
    ((` x) â‹¯* ((f â†‘** Âµ') â†‘** Âµ'')) â‰¡ subâ‚‚ ((` subâ‚ x) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))
  lemy {ğ•‚s = ğ•‚s} {Âµâ‚} {Âµâ‚‚} {Âµ'} {Âµ''} f m x =
    let subâˆ‹â‚â»Â¹ = subst (_âˆ‹ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
    let subâŠ¢â‚‚ = subst (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
    let subâŠ¢â‚‚â»Â¹ = subst (_âŠ¢ _) (sym (++-assoc Âµ'' Âµ' Âµâ‚‚)) in
    let subâŠ¢â‚â»Â¹ = subst (_âŠ¢ mâ†’M m) (sym (++-assoc Âµ'' Âµ' Âµâ‚)) in
    let subâ†’â‚â‚‚ = substâ‚‚ (_â€“[ ğ•‚s ]â†’*_) (++-assoc Âµ'' Âµ' Âµâ‚) (++-assoc Âµ'' Âµ' Âµâ‚‚) in
    ((` x) â‹¯* (f â†‘** Âµ' â†‘** Âµ''))                         â‰¡âŸ¨ sym (cancel-substâ‚‚ (_âŠ¢ _) (++-assoc Âµ'' Âµ' Âµâ‚‚) _) âŸ©
    subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* (f â†‘** Âµ' â†‘** Âµ'')))         â‰¡âŸ¨ cong (Î» â–  â†’ subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* â– ))) (dist-â†‘**-â–·â–· Âµ' Âµ'' f) âŸ©
    subâŠ¢â‚‚ (subâŠ¢â‚‚â»Â¹ ((` x) â‹¯* subâ†’â‚â‚‚ (f â†‘** (Âµ' â–·â–· Âµ'')))) â‰¡âŸ¨ cong subâŠ¢â‚‚ (subst-â‹¯ (f â†‘** (Âµ' â–·â–· Âµ'')) (` x)
                                                                                 (++-assoc Âµ'' Âµ' Âµâ‚)
                                                                                 (++-assoc Âµ'' Âµ' Âµâ‚‚)) âŸ©
    subâŠ¢â‚‚ ((subâŠ¢â‚â»Â¹ (` x)) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))        â‰¡âŸ¨ cong subâŠ¢â‚‚ (cong (_â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))
                                                            (sym (dist-subst {F = (_âˆ‹ _)} {G = (_âŠ¢ _)} `_
                                                              (sym (++-assoc Âµ'' Âµ' Âµâ‚)) x))) âŸ©
    subâŠ¢â‚‚ ((` subâˆ‹â‚â»Â¹ x) â‹¯* (f â†‘** (Âµ' â–·â–· Âµ'')))          âˆ

  â‰ˆâ†‘** :
    âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚ Âµâ‚‚}
      (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚)
    â†’ (âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m)
        â†’ ((` x) â‹¯* (f â†‘** Âµâ‚')) â‰¡ ((` x) â‹¯* (g â†‘** Âµâ‚')))
    â†’ (âˆ€ {Âµâ‚'} {Âµâ‚''} {m} (x : (Âµâ‚ â–·â–· Âµâ‚' â–·â–· Âµâ‚'') âˆ‹ m)
        â†’ ((` x) â‹¯* ((f â†‘** Âµâ‚') â†‘** Âµâ‚'')) â‰¡ ((` x) â‹¯* ((g â†‘** Âµâ‚') â†‘** Âµâ‚'')))
  â‰ˆâ†‘** {ğ•‚sâ‚} {ğ•‚sâ‚‚} {Âµâ‚ = Âµâ‚} {Âµâ‚‚ = Âµâ‚‚} f g f~g {Âµâ‚' = Âµâ‚'} {Âµâ‚'' = Âµâ‚''} x =
    let subâ‚ = subst (_âˆ‹ _) (sym (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚)) in
    let subâ‚‚ = subst (_âŠ¢ _) (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚‚) in
    ((` x) â‹¯* ((f â†‘** Âµâ‚') â†‘** Âµâ‚'')) â‰¡âŸ¨ lemy f _ x âŸ©
    subâ‚‚ ((` subâ‚ x) â‹¯* (f â†‘** (Âµâ‚' â–·â–· Âµâ‚''))) â‰¡âŸ¨ cong subâ‚‚ (f~g {Âµâ‚' â–·â–· Âµâ‚''} (subst (_âˆ‹ _) (sym (++-assoc Âµâ‚'' Âµâ‚' Âµâ‚)) x) ) âŸ©
    subâ‚‚ ((` subâ‚ x) â‹¯* (g â†‘** (Âµâ‚' â–·â–· Âµâ‚''))) â‰¡âŸ¨ sym (lemy g _ x)  âŸ©
    ((` x) â‹¯* ((g â†‘** Âµâ‚') â†‘** Âµâ‚'')) âˆ

open import Data.Unit using (âŠ¤; tt)
module TraversalOps' (_â‹¯_ : âŠ¤ â†’ âˆ€ â¦ƒ ğ•‚ : Kit â¦„ {Âµâ‚} {Âµâ‚‚} {M} â†’ Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M) where
  open TraversalOps (_â‹¯_ tt) public

instance
  kit-[] : List Kit
  kit-[] = []

  kit-âˆ· : {{ğ•‚ : Kit}} â†’ {{ğ•‚s : List Kit}} â†’ List Kit
  kit-âˆ· {{ğ•‚}} {{ğ•‚s}} = ğ•‚ âˆ· ğ•‚s

record KitTraversalAlt : Setâ‚ where
  constructor mkKitTraversalAlt
  infixl  5  _â‹¯_

  field
    _â‹¯_   : âˆ€ {{ğ•‚ : Kit}} â†’
            Âµâ‚ âŠ¢ M â†’ Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ M

  open TraversalOps _â‹¯_ public

  field
    â‹¯-var : âˆ€ {{ğ•‚ : Kit}} (x : Âµâ‚ âˆ‹ m) (f : Âµâ‚ â€“â†’ Âµâ‚‚) â†’
            (` x) â‹¯ f â‰¡ `/id _ (f _ x)
    â‹¯-â†‘ : âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚} {Âµâ‚‚} (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚) â†’
          f â‰ˆâ‚“ g â†’ f â‰ˆâ‚œ g

-- Deriving KitTraversal, KitAssoc, and KitAssocLemmas -------------------------

module Derive (KT : KitTraversalAlt) where
  terms : Terms ğ•„
  terms = ğ•‹

  open KitTraversalAlt KT public

  kit-traversal : KitTraversal
  kit-traversal = record { _â‹¯_ = _â‹¯_ ; â‹¯-var = â‹¯-var }

  open KitTraversal kit-traversal hiding (_â‹¯_; â‹¯-var; kitáµ£; kitâ‚›) public

  ~-cong-â‹¯ :
    âˆ€ {{ğ•‚ : Kit}} {f g : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} (v : Âµâ‚ âŠ¢ M)
    â†’ f ~ g
    â†’ v â‹¯ f â‰¡ v â‹¯ g
  ~-cong-â‹¯ {f = f} {g} v f~g =
    â‹¯-â†‘ (f âˆ· [])
        (g âˆ· [])
        (Î» {Âµ} x â†’
          begin
            (` x) â‹¯ f â†‘* Âµ
          â‰¡âŸ¨ â‹¯-var x (f â†‘* Âµ) âŸ©
            `/id _ ((f â†‘* Âµ) _ x)
          â‰¡âŸ¨ cong (`/id _) (~-cong-â†‘* f~g _ x) âŸ©
            `/id _ ((g â†‘* Âµ) _ x)
          â‰¡âŸ¨ sym (â‹¯-var x (g â†‘* Âµ)) âŸ©
            (` x) â‹¯ g â†‘* Âµ 
          âˆ)
        v

  kit-homotopy : KitHomotopy kit-traversal
  kit-homotopy = record { ~-cong-â‹¯ = ~-cong-â‹¯ }

  open import Kitty.Term.Compose ğ•‹ kit-traversal kit-homotopy

  open ComposeKit {{...}} public

  private
    â‹¯-assoc : âˆ€ {{ğ•‚â‚ ğ•‚â‚‚ ğ•‚ : Kit}} {{ğ”¸ : ComposeKit {{ğ•‚â‚}} {{ğ•‚â‚‚}} {{ğ•‚}} }}
                (v : Âµâ‚ âŠ¢ M) (f : Âµâ‚ â€“[ ğ•‚â‚‚ ]â†’ Âµâ‚‚) (g : Âµâ‚‚ â€“[ ğ•‚â‚ ]â†’ Âµâ‚ƒ) â†’
      v â‹¯ f â‹¯ g â‰¡ v â‹¯ (g âˆ˜â‚– f)
    â‹¯-assoc {{ğ•‚â‚}} {{ğ•‚â‚‚}} {{ğ•‚}} v f g =
      v â‹¯ f â‹¯ g                            â‰¡âŸ¨ refl âŸ©
      v â‹¯* (g âˆ·[ ğ•‚â‚ ] f âˆ·[ ğ•‚â‚‚ ] [])
        â‰¡âŸ¨ â‹¯-â†‘ (g âˆ·[ ğ•‚â‚ ] f âˆ·[ ğ•‚â‚‚ ] [])
              ((g âˆ˜â‚– f) âˆ·[ ğ•‚ ] [])
              (Î» {Âµ} x â†’
                ` x â‹¯ f â†‘* Âµ â‹¯ g â†‘* Âµ                â‰¡âŸ¨ cong (_â‹¯ g â†‘* Âµ) (â‹¯-var x (f â†‘* Âµ)) âŸ©
                (`/id _ ((f â†‘* Âµ) _ x)) â‹¯ g â†‘* Âµ     â‰¡âŸ¨ tm-â‹¯-âˆ˜ (f â†‘* Âµ) (g â†‘* Âµ) x âŸ©
                `/id _ (((g â†‘* Âµ) âˆ˜â‚– (f â†‘* Âµ)) _ x)  â‰¡âŸ¨ cong (Î» h â†’ `/id {{ğ•‚}} _ h) (sym (dist-â†‘*-âˆ˜ Âµ g f _ x)) âŸ©
                `/id _ (((g âˆ˜â‚– f) â†‘* Âµ) _ x)         â‰¡âŸ¨ sym (â‹¯-var x ((g âˆ˜â‚– f) â†‘* Âµ)) âŸ©
                ` x â‹¯ (g âˆ˜â‚– f) â†‘* Âµ                  âˆ)
              v
        âŸ©
      v â‹¯* (_âˆ·_ {b = ğ•‚} (g âˆ˜â‚– f) [])       â‰¡âŸ¨ refl âŸ©
      v â‹¯ (g âˆ˜â‚– f)       âˆ

  kit-assoc : KitAssoc
  kit-assoc = record { â‹¯-assoc = â‹¯-assoc }

  open KitAssoc kit-assoc public hiding (kitáµ£áµ£; kitáµ£â‚›; kitâ‚›áµ£; kitâ‚›â‚›; wk-kitáµ£; wk-kitâ‚›)

  private
    â‹¯-id' : âˆ€ {{ğ•‚ : Kit}} {Âµ M} (v : Âµ âŠ¢ M) â†’ v â‹¯ idâ‚– {{ğ•‚}} â‰¡ v
    â‹¯-id' {{ğ•‚}} {Âµ} {M} v =
      â‹¯-â†‘ {Âµâ‚ = Âµ} (idâ‚– âˆ·[ ğ•‚ ] [])
          []
          (Î» {Âµ} x â†’
            ` x â‹¯ idâ‚– {{ğ•‚}} â†‘* Âµ           â‰¡âŸ¨ â‹¯-var x (idâ‚– â†‘* Âµ) âŸ©
            `/id _ ((idâ‚– {{ğ•‚}} â†‘* Âµ) _ x)  â‰¡âŸ¨ cong (Î» h â†’ `/id _ h) (idâ†‘*~id Âµ _ _ x) âŸ©
            `/id _ (id/` _ x)              â‰¡âŸ¨ id/`/id x âŸ©
            ` x                            âˆ)
          v

  kit-assoc-lemmas : KitAssocLemmas
  kit-assoc-lemmas = record { â‹¯-id = â‹¯-id' }

  open KitAssocLemmas kit-assoc-lemmas public

  instance
    kitáµ£  = KitTraversal.kitáµ£ kit-traversal
    kitâ‚›  = KitTraversal.kitâ‚› kit-traversal
    kitáµ£áµ£ = KitAssoc.kitáµ£áµ£ kit-assoc
    kitâ‚›áµ£ = KitAssoc.kitâ‚›áµ£ kit-assoc
    kitáµ£â‚› = KitAssoc.kitáµ£â‚› kit-assoc
    kitâ‚›â‚› = KitAssoc.kitâ‚›â‚› kit-assoc
    wk-kitáµ£ = KitAssoc.wk-kitáµ£ kit-assoc
    wk-kitâ‚› = KitAssoc.wk-kitâ‚› kit-assoc

  open Kit {{...}} public
  open import Kitty.Term.Kit ğ•‹ public



  -- module StarAttempt where
  --   open import Kitty.Util.Star
  --   open import Kitty.Term.MultiSub ğ•‹

  --   â†‘**-[] : âˆ€ {ğ•‚s : List Kit} {Âµâ‚} {Âµâ‚‚} (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) (t : Âµâ‚ âŠ¢ M)
  --         â†’ t â‹¯* fs â†‘** [] â‰¡ t â‹¯* fs
  --   â†‘**-[] [] t =
  --     t â‹¯* [] â†‘** [] â‰¡âŸ¨âŸ©
  --     t â‹¯* []        âˆ
  --   â†‘**-[] {ğ•‚s = ğ•‚ âˆ· ğ•‚s} (f âˆ· fs) t =
  --     let instance _ = ğ•‚ in
  --     t â‹¯* (f âˆ· fs) â†‘** []     â‰¡âŸ¨âŸ©
  --     t â‹¯* fs â†‘** [] â‹¯ f â†‘* [] â‰¡âŸ¨ cong (_â‹¯ f â†‘* []) (â†‘**-[] fs t) âŸ©
  --     t â‹¯* fs â‹¯ f â†‘* []        â‰¡âŸ¨ ~-cong-â‹¯ _ (â†‘*-[] f) âŸ©
  --     t â‹¯* fs â‹¯ f              â‰¡âŸ¨âŸ©
  --     t â‹¯* (f âˆ· fs)            âˆ

  --   â†‘**-â–· : âˆ€ {ğ•‚s : List Kit} {Âµâ‚} {Âµâ‚‚} {Âµ} {m} (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {mx} (x : Âµâ‚ â–·â–· (Âµ â–· m) âˆ‹ mx)
  --         â†’ (` x) â‹¯* fs â†‘** (Âµ â–· m) â‰¡ (` x) â‹¯* fs â†‘** Âµ â†‘** ([] â–· m)
  --   â†‘**-â–· {[]}     {Âµâ‚} {Âµâ‚‚} {Âµ} {m} []       x = refl
  --   â†‘**-â–· {ğ•‚ âˆ· ğ•‚s} {Âµâ‚} {Âµâ‚‚} {Âµ} {m} (f âˆ· fs) x =
  --     let instance _ = ğ•‚ in
  --     (` x) â‹¯* (f âˆ· fs) â†‘** (Âµ â–· m)                             â‰¡âŸ¨âŸ©
  --     (` x) â‹¯* ((f â†‘* (Âµ â–· m)) âˆ· (fs â†‘** (Âµ â–· m)))              â‰¡âŸ¨âŸ©
  --     ((` x) â‹¯* (fs â†‘** (Âµ â–· m)))        â‹¯ (f â†‘* (Âµ â–· m))       â‰¡âŸ¨ ~-cong-â‹¯ ((` x) â‹¯* (fs â†‘** (Âµ â–· m))) (â†‘*-â–· Âµ m f) âŸ©
  --     ((` x) â‹¯* (fs â†‘** (Âµ â–· m)))        â‹¯ (f â†‘* Âµ â†‘ m)         â‰¡âŸ¨ ~-cong-â‹¯ ((` x) â‹¯* fs â†‘** (Âµ â–· m)) (~-cong-â†‘ (~-sym (â†‘*-[] (f â†‘* Âµ)))) âŸ©
  --     ((` x) â‹¯* (fs â†‘** (Âµ â–· m)))        â‹¯ (f â†‘* Âµ â†‘* [] â†‘ m)   â‰¡âŸ¨ ~-cong-â‹¯ ((` x) â‹¯* fs â†‘** (Âµ â–· m)) (~-sym (â†‘*-â–· [] m (f â†‘* Âµ))) âŸ©
  --     ((` x) â‹¯* (fs â†‘** (Âµ â–· m)))        â‹¯ (f â†‘* Âµ â†‘* ([] â–· m)) â‰¡âŸ¨ cong (_â‹¯ f â†‘* Âµ â†‘* ([] â–· m)) (â†‘**-â–· fs x) âŸ©
  --     ((` x) â‹¯* (fs â†‘** Âµ â†‘** ([] â–· m))) â‹¯ (f â†‘* Âµ â†‘* ([] â–· m)) â‰¡âŸ¨âŸ©
  --     (` x) â‹¯* ((f â†‘* Âµ â†‘* ([] â–· m)) âˆ· (fs â†‘** Âµ â†‘** ([] â–· m))) â‰¡âŸ¨âŸ©
  --     (` x) â‹¯* (f âˆ· fs) â†‘** Âµ â†‘** ([] â–· m)                      âˆ

  --   â†‘**-here : âˆ€ {ğ•‚s : List Kit} {Âµâ‚} {Âµâ‚‚} (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {Âµâ‚'} {m} â†’
  --     (` here refl) â‹¯* fs â†‘** (Âµâ‚' â–· m) â‰¡ ` here refl
  --   â†‘**-here {[]} {Âµâ‚} {.Âµâ‚} [] {Âµâ‚'} {m} = refl
  --   â†‘**-here {ğ•‚s â–· ğ•‚} {Âµâ‚} {Âµâ‚‚} (f âˆ· fs) {Âµâ‚'} {m} =
  --     let instance _ = ğ•‚ in
  --     ` here refl â‹¯* (f âˆ· fs) â†‘** (Âµâ‚' â–· m)              â‰¡âŸ¨âŸ©
  --     ` here refl â‹¯* (fs â†‘** (Âµâ‚' â–· m)) â‹¯ f â†‘* (Âµâ‚' â–· m) â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµâ‚' â–· m)) (â†‘**-here fs) âŸ©
  --     ` here refl â‹¯ f â†‘* (Âµâ‚' â–· m)                       â‰¡âŸ¨ ~-cong-â‹¯ (` here refl) (â†‘*-â–· Âµâ‚' m f) âŸ©
  --     ` here refl â‹¯ f â†‘* Âµâ‚' â†‘ m                         â‰¡âŸ¨ â‹¯-var (here refl) (f â†‘* Âµâ‚' â†‘ m) âŸ©
  --     `/id (here refl & f â†‘* Âµâ‚' â†‘ m)                    â‰¡âŸ¨ cong `/id (&-â†‘-here (f â†‘* Âµâ‚')) âŸ©
  --     `/id (id/` â¦ƒ ğ•‚ â¦„ (here refl))                      â‰¡âŸ¨ id/`/id (here refl) âŸ©
  --     ` here refl                                        âˆ

  --   wk-â†‘-dist-â‹¯'' : âˆ€ {ğ•‚s} {Âµâ‚ Âµâ‚‚ Âµ m'} {m} (x : (Âµâ‚ â–·â–· Âµ) âˆ‹ m) (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) â†’
  --     wk _ (` x) â‹¯* fs â†‘** (Âµ â–· m')  â‰¡
  --     wk _ (` x â‹¯* fs â†‘** Âµ)
  --   wk-â†‘-dist-â‹¯'' {[]} {Âµâ‚} {.Âµâ‚} {Âµ} {m'} {m} x [] =
  --     wk _ (` x) â‹¯* [] â†‘** (Âµ â–· m')  â‰¡âŸ¨âŸ©
  --     wk _ (` x â‹¯* [] â†‘** Âµ)         âˆ
  --   wk-â†‘-dist-â‹¯'' {ğ•‚s â–· ğ•‚} {Âµâ‚} {Âµâ‚‚} {Âµ} {m'} {m} x (f âˆ· fs) =
  --     let instance _ = ğ•‚ in
  --     wk _ (` x) â‹¯* (f âˆ· fs) â†‘** (Âµ â–· m')           â‰¡âŸ¨âŸ©
  --     wk _ (` x) â‹¯* fs â†‘** (Âµ â–· m') â‹¯ f â†‘* (Âµ â–· m') â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµ â–· m')) (wk-â†‘-dist-â‹¯'' x fs) âŸ©
  --     wk _ (` x â‹¯* fs â†‘** Âµ) â‹¯ f â†‘* (Âµ â–· m')        â‰¡âŸ¨ {!!} âŸ©
  --     wk _ (` x â‹¯* fs â†‘** Âµ â‹¯ f â†‘* Âµ)               â‰¡âŸ¨âŸ©
  --     wk _ (` x â‹¯* (f âˆ· fs) â†‘** Âµ)                  âˆ

  --   -- wk-â†‘-dist-â‹¯''' : âˆ€ {ğ•‚s} {Âµâ‚ Âµâ‚‚ Âµ m'} {m} (t : (Âµâ‚ â–·â–· Âµ) âŠ¢ m) (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) â†’
  --   --   wk _ t â‹¯* fs â†‘** (Âµ â–· m')  â‰¡
  --   --   wk _ (t â‹¯* fs â†‘** Âµ)
  --   -- wk-â†‘-dist-â‹¯''' {[]} {Âµâ‚} {.Âµâ‚} {Âµ} {m'} {m} t [] = refl
  --   -- wk-â†‘-dist-â‹¯''' {ğ•‚s â–· ğ•‚} {Âµâ‚} {Âµâ‚‚} {Âµ} {m'} {m} t (f âˆ· fs) =
  --   --   let instance _ = ğ•‚ in
  --   --   wk _ t â‹¯* (f âˆ· fs) â†‘** (Âµ â–· m')           â‰¡âŸ¨âŸ©
  --   --   wk _ t â‹¯* fs â†‘** (Âµ â–· m') â‹¯ f â†‘* (Âµ â–· m') â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµ â–· m')) (wk-â†‘-dist-â‹¯''' t fs) âŸ©
  --   --   wk _ (t â‹¯* fs â†‘** Âµ) â‹¯ f â†‘* (Âµ â–· m')      â‰¡âŸ¨ wk-â†‘-dist-â‹¯''' (t â‹¯* fs â†‘** Âµ) (f âˆ· []) âŸ©
  --   --   wk _ (t â‹¯* fs â†‘** Âµ â‹¯ f â†‘* Âµ)             â‰¡âŸ¨âŸ©
  --   --   wk _ (t â‹¯* (f âˆ· fs) â†‘** Âµ)                âˆ

  --   open import Data.Nat using (â„•; zero; suc; _+_)
  --   open import Data.Nat using (_<â€²_; _â‰¤â€²_; â‰¤â€²-step; â‰¤â€²-refl)
  --   open import Data.Nat.Properties using (suc-injective)
  --   open import Data.Nat.Induction
  --   open import Induction.WellFounded

  --   0â‰¤â€²n : âˆ€ {n} â†’ 0 â‰¤â€² n
  --   0â‰¤â€²n {zero} = â‰¤â€²-refl
  --   0â‰¤â€²n {suc n} = â‰¤â€²-step 0â‰¤â€²n

  --   suc-â‰¤â€² : âˆ€ {m n} â†’ m â‰¤â€² n â†’ suc m â‰¤â€² suc n
  --   suc-â‰¤â€² {m} {.m} â‰¤â€²-refl = â‰¤â€²-refl
  --   suc-â‰¤â€² {m} {.(suc _)} (â‰¤â€²-step m<n) = â‰¤â€²-step (suc-â‰¤â€² m<n)

  --   wk-â†‘-dist-â‹¯''' : âˆ€ n {ğ•‚s} (eq : n â‰¡ length ğ•‚s) {Âµâ‚ Âµâ‚‚ Âµ m'} {m} (t : (Âµâ‚ â–·â–· Âµ) âŠ¢ m) (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) â†’
  --     wk _ t â‹¯* fs â†‘** (Âµ â–· m')  â‰¡
  --     wk _ (t â‹¯* fs â†‘** Âµ)
  --   wk-â†‘-dist-â‹¯''' = <â€²-rec
  --     (Î» n â†’ âˆ€ {ğ•‚s} (eq : n â‰¡ length ğ•‚s) {Âµâ‚ Âµâ‚‚ Âµ m'} {m} (t : (Âµâ‚ â–·â–· Âµ) âŠ¢ m) (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚)
  --         â†’ wk _ t â‹¯* fs â†‘** (Âµ â–· m')  â‰¡ wk _ (t â‹¯* fs â†‘** Âµ))
  --     Î» where
  --       zero IH {[]} eq {Âµâ‚} {.Âµâ‚} {Âµ} {m'} {m} t [] â†’ refl
  --       (suc zero) IH {[] â–· ğ•‚} eq {Âµâ‚} {Âµâ‚‚} {Âµ} {m'} {m} t (f âˆ· []) â†’
  --         let instance _ = ğ•‚ in
  --         wk _ t â‹¯ f â†‘* (Âµ â–· m')           â‰¡âŸ¨ {!!} âŸ©
  --         wk _ (t â‹¯ f â†‘* Âµ)                âˆ
  --       (suc (suc n)) IH {ğ•‚s â–· ğ•‚} eq {Âµâ‚} {Âµâ‚‚} {Âµ} {m'} {m} t (f âˆ· fs) â†’
  --         let instance _ = ğ•‚ in
  --         wk _ t â‹¯* (f âˆ· fs) â†‘** (Âµ â–· m')           â‰¡âŸ¨âŸ©
  --         wk _ t â‹¯* fs â†‘** (Âµ â–· m') â‹¯ f â†‘* (Âµ â–· m') â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµ â–· m')) (IH (suc n) â‰¤â€²-refl (suc-injective eq) t fs) âŸ©
  --         wk _ (t â‹¯* fs â†‘** Âµ) â‹¯ f â†‘* (Âµ â–· m')      â‰¡âŸ¨ IH 1 (suc-â‰¤â€² (suc-â‰¤â€² 0â‰¤â€²n) ) refl (t â‹¯* fs â†‘** Âµ) (f âˆ· []) âŸ©
  --         wk _ (t â‹¯* fs â†‘** Âµ â‹¯ f â†‘* Âµ)             â‰¡âŸ¨âŸ©
  --         wk _ (t â‹¯* (f âˆ· fs) â†‘** Âµ)                âˆ
  --   -- wk-â†‘-dist-â‹¯''' {.[]} {zero} {eq} {Âµâ‚} {.Âµâ‚} {Âµ} {m'} {m} t [] = refl
  --   -- wk-â†‘-dist-â‹¯''' {.(_ â–· _)} {suc n} {eq} {Âµâ‚} {Âµâ‚‚} {Âµ} {m'} {m} t (_âˆ·_ {b = ğ•‚} {bs = ğ•‚s} f fs) =
  --   --   let instance _ = ğ•‚ in
  --   --   wk _ t â‹¯* (f âˆ· fs) â†‘** (Âµ â–· m')           â‰¡âŸ¨âŸ©
  --   --   wk _ t â‹¯* fs â†‘** (Âµ â–· m') â‹¯ f â†‘* (Âµ â–· m') â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµ â–· m')) (wk-â†‘-dist-â‹¯''' t fs) âŸ©
  --   --   wk _ (t â‹¯* fs â†‘** Âµ) â‹¯ f â†‘* (Âµ â–· m')      â‰¡âŸ¨ wk-â†‘-dist-â‹¯''' {n = {!!}} {eq = {!!}} (t â‹¯* fs â†‘** Âµ) (f âˆ· []) âŸ©
  --   --   wk _ (t â‹¯* fs â†‘** Âµ â‹¯ f â†‘* Âµ)             â‰¡âŸ¨âŸ©
  --   --   wk _ (t â‹¯* (f âˆ· fs) â†‘** Âµ)                âˆ

  --   wk-â†‘-dist-â‹¯' : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚' Âµâ‚‚ m'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m') (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â‹¯ f â†‘ m â†‘* Âµâ‚' â‰¡
  --     ` x â‹¯ f â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚'     
  --   wk-â†‘-dist-â‹¯' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {[]} {Âµâ‚‚} {m'} {m} x f =
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* [] â‹¯ f â†‘ m â†‘* [] â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â‹¯ f â†‘ m             â‰¡âŸ¨ cong (_â‹¯ f â†‘ m) (â‹¯-var x (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id)) âŸ©
  --     `/id (x & wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id) â‹¯ f â†‘ m        â‰¡âŸ¨ cong (_â‹¯ f â†‘ m) {!!} âŸ©
  --     ` there x â‹¯ f â†‘ m                               â‰¡âŸ¨ â‹¯-var (there x) (f â†‘ m) âŸ©
  --     `/id (there x & f â†‘ m)                          â‰¡âŸ¨ cong `/id (&-â†‘-there f x) âŸ©
  --     `/id (wk m (x & f))                             â‰¡âŸ¨ sym (â‹¯-x/t-wk'' (x & f)) âŸ©
  --     `/id (x & f) â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id            â‰¡âŸ¨ cong (_â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id) (sym (â‹¯-var x f)) âŸ©
  --     ` x â‹¯ f â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id                 â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ f â†‘* [] â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* []     âˆ
  --   wk-â†‘-dist-â‹¯' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚' â–· mâ‚'} {Âµâ‚‚} {m'} {m} x@(here refl) f =
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* (Âµâ‚' â–· mâ‚') â‹¯ f â†‘ m â†‘* (Âµâ‚' â–· mâ‚') â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ f â†‘* (Âµâ‚' â–· mâ‚') â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* (Âµâ‚' â–· mâ‚')     âˆ
  --   wk-â†‘-dist-â‹¯' â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚' â–· mâ‚'} {Âµâ‚‚} {m'} {m} x@(there y) f =
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* (Âµâ‚' â–· mâ‚') â‹¯ f â†‘ m â†‘* (Âµâ‚' â–· mâ‚')                â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â†‘ mâ‚' â‹¯ f â†‘ m â†‘* Âµâ‚' â†‘ mâ‚'                    â‰¡âŸ¨ {!!} âŸ©
  --     `/id (x & wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â†‘ mâ‚') â‹¯ f â†‘ m â†‘* Âµâ‚' â†‘ mâ‚'               â‰¡âŸ¨ {!!} âŸ©
  --     `/id (wk mâ‚' (y & wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚')) â‹¯ f â†‘ m â†‘* Âµâ‚' â†‘ mâ‚'            â‰¡âŸ¨ {!!} âŸ©
  --     ` y â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ f â†‘ m â†‘* Âµâ‚' â†‘ mâ‚'  â‰¡âŸ¨ {!!} âŸ©
  --     ` y â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â‹¯ f â†‘ m â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id        â‰¡âŸ¨âŸ©
  --     wk _ (` y â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â‹¯ f â†‘ m â†‘* Âµâ‚')                         â‰¡âŸ¨ cong (wk _) (wk-â†‘-dist-â‹¯' y f) âŸ©
  --     wk _ (` y â‹¯ f â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚')                             â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ f â†‘* Âµâ‚' â†‘ mâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â†‘ mâ‚'                        â‰¡âŸ¨ {!!} âŸ©
  --     ` x â‹¯ f â†‘* (Âµâ‚' â–· mâ‚') â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* (Âµâ‚' â–· mâ‚')                    âˆ

  --   -- wk-â†‘-dist-â‹¯ : âˆ€ â¦ƒ ğ•‚ â¦„ {Âµâ‚ Âµâ‚‚ M} {m} (t : Âµâ‚ âŠ¢ M) (f : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
  --   --   t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â‹¯ f â†‘ m â‰¡
  --   --   t â‹¯ f â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id
  --   -- wk-â†‘-dist-â‹¯ â¦ƒ ğ•‚ â¦„ {Âµâ‚} {Âµâ‚‚} {M} {m} t f =
  --   --   let xx = â‹¯-â†‘ ((f â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· [])
  --   --                (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· f âˆ· [])
  --   --                (Î» {Âµâ‚'} x â†’
  --   --                  ` x â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚' â‹¯ f â†‘ m â†‘* Âµâ‚' â‰¡âŸ¨ wk-â†‘-dist-â‹¯' x f âŸ©
  --   --                  ` x â‹¯ f â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â†‘* Âµâ‚'     âˆ
  --   --                ) t in
  --   --   t â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id â‹¯ f â†‘ m                  â‰¡âŸ¨âŸ©
  --   --   t â‹¯* ((f â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· [])        â‰¡âŸ¨ sym (â†‘**-[] ((f â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· []) t) âŸ©
  --   --   t â‹¯* ((f â†‘ m) âˆ· wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· []) â†‘** [] â‰¡âŸ¨ xx âŸ©
  --   --   t â‹¯* (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· f âˆ· []) â†‘** []       â‰¡âŸ¨ â†‘**-[] (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· f âˆ· []) t âŸ©
  --   --   t â‹¯* (wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id âˆ· f âˆ· [])              â‰¡âŸ¨âŸ©
  --   --   t â‹¯ f â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ m id                      âˆ

  --   â†‘**-there : âˆ€ {ğ•‚s : List Kit} {Âµâ‚} {Âµâ‚‚} (fs : Âµâ‚ â€“[ ğ•‚s ]â†’* Âµâ‚‚) {Âµâ‚'} {m} {mx} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ mx) â†’
  --     ` there x â‹¯* fs â†‘** (Âµâ‚' â–· m) â‰¡ wkâ‚› m (` x â‹¯* fs â†‘** Âµâ‚')
  --   â†‘**-there {[]} {Âµâ‚} {.Âµâ‚} [] {Âµâ‚'} {m} {mx} x =
  --     (` there x) â‰¡âŸ¨ sym (â‹¯-x/t-wk'' x) âŸ©
  --     wkâ‚› m (` x) âˆ
  --   â†‘**-there {ğ•‚s â–· ğ•‚} {Âµâ‚} {Âµâ‚‚} (f âˆ· fs) {Âµâ‚'} {m} {mx} x =
  --     -- let instance _ = ğ•‚ in
  --     -- (` there x) â‹¯* (f âˆ· fs) â†‘** (Âµâ‚' â–· m)              â‰¡âŸ¨âŸ©
  --     -- (` there x) â‹¯* (fs â†‘** (Âµâ‚' â–· m)) â‹¯ f â†‘* (Âµâ‚' â–· m) â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµâ‚' â–· m)) (â†‘**-there fs x) âŸ©
  --     -- wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚') â‹¯ f â†‘* (Âµâ‚' â–· m)       â‰¡âŸ¨ ~-cong-â‹¯ _ (â†‘*-â–· Âµâ‚' m f) âŸ©
  --     -- wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚') â‹¯ f â†‘* Âµâ‚' â†‘ m         â‰¡âŸ¨âŸ©
  --     -- (` x) â‹¯* fs â†‘** Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‹¯ f â†‘* Âµâ‚' â†‘ m â‰¡âŸ¨ wk-â†‘-dist-â‹¯ ((` x) â‹¯* fs â†‘** Âµâ‚') (f â†‘* Âµâ‚') âŸ©
  --     -- (` x) â‹¯* fs â†‘** Âµâ‚' â‹¯ f â†‘* Âµâ‚' â‹¯ wkâ‚– â¦ƒ ğ•‚ = kitáµ£ â¦„ _ id â‰¡âŸ¨âŸ©
  --     -- wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚' â‹¯ f â†‘* Âµâ‚')             â‰¡âŸ¨âŸ©
  --     -- wkâ‚› m ((` x) â‹¯* (f âˆ· fs) â†‘** Âµâ‚')                  âˆ

  --     let instance _ = ğ•‚ in
  --     (` there x) â‹¯* (f âˆ· fs) â†‘** (Âµâ‚' â–· m)              â‰¡âŸ¨âŸ©
  --     (` there x) â‹¯* (fs â†‘** (Âµâ‚' â–· m)) â‹¯ f â†‘* (Âµâ‚' â–· m) â‰¡âŸ¨ cong (_â‹¯ f â†‘* (Âµâ‚' â–· m)) (â†‘**-there fs x) âŸ©
  --     wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚') â‹¯ f â†‘* (Âµâ‚' â–· m)       â‰¡âŸ¨ ~-cong-â‹¯ _ (â†‘*-â–· Âµâ‚' m f) âŸ©
  --     wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚') â‹¯ f â†‘* Âµâ‚' â†‘ m         â‰¡âŸ¨ {!!} âŸ©
  --     `/id (wk m ((` x) â‹¯* fs â†‘** Âµâ‚')) â‹¯ f â†‘* Âµâ‚' â†‘ m   â‰¡âŸ¨ {!!} âŸ©
  --     wkâ‚› m ((` x) â‹¯* fs â†‘** Âµâ‚' â‹¯ f â†‘* Âµâ‚')             â‰¡âŸ¨âŸ©
  --     wkâ‚› m ((` x) â‹¯* (f âˆ· fs) â†‘** Âµâ‚')                  âˆ

  --   â‹¯-â†‘' : âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚} {Âµâ‚‚} (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚)
  --         â†’ (âˆ€ {m} (x : Âµâ‚ âˆ‹ m) â†’ (` x) â‹¯* f â‰¡ (` x) â‹¯* g)
  --         â†’ (âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m) â†’ (` x) â‹¯* (f â†‘** Âµâ‚') â‰¡ (` x) â‹¯* (g â†‘** Âµâ‚'))
  --   â‹¯-â†‘' fs gs fs~gs {[]} x =
  --     (` x) â‹¯* fs â†‘** [] â‰¡âŸ¨ â†‘**-[] fs (` x) âŸ©
  --     (` x) â‹¯* fs        â‰¡âŸ¨ fs~gs x âŸ©
  --     (` x) â‹¯* gs        â‰¡âŸ¨ sym (â†‘**-[] gs (` x)) âŸ©
  --     (` x) â‹¯* gs â†‘** [] âˆ
  --   â‹¯-â†‘' fs gs fs~gs {Âµâ‚' â–· m'} x@(here refl) =
  --     (` x) â‹¯* fs â†‘** (Âµâ‚' â–· m') â‰¡âŸ¨ â†‘**-here fs âŸ©
  --     ` here refl                â‰¡âŸ¨ sym (â†‘**-here gs) âŸ©
  --     (` x) â‹¯* gs â†‘** (Âµâ‚' â–· m') âˆ
  --   â‹¯-â†‘' fs gs fs~gs {Âµâ‚' â–· m'} {m} x@(there y) =
  --     (` x) â‹¯* fs â†‘** (Âµâ‚' â–· m')  â‰¡âŸ¨ â†‘**-there fs y âŸ©
  --     wk m' ((` y) â‹¯* fs â†‘** Âµâ‚') â‰¡âŸ¨ cong (wk m') (â‹¯-â†‘' fs gs fs~gs y) âŸ©
  --     wk m' ((` y) â‹¯* gs â†‘** Âµâ‚') â‰¡âŸ¨ sym (â†‘**-there gs y) âŸ©
  --     (` x) â‹¯* gs â†‘** (Âµâ‚' â–· m')  âˆ

  --   -- â‹¯-â†‘'' : âˆ€ {ğ•‚sâ‚ ğ•‚sâ‚‚ : List Kit} {Âµâ‚} {Âµâ‚‚} (f : Âµâ‚ â€“[ ğ•‚sâ‚ ]â†’* Âµâ‚‚) (g : Âµâ‚ â€“[ ğ•‚sâ‚‚ ]â†’* Âµâ‚‚)
  --   --        â†’ (âˆ€ {m} (x : Âµâ‚ âˆ‹ m) â†’ (` x) â‹¯*' f â‰¡ (` x) â‹¯*' g)
  --   --        â†’ (âˆ€ {Âµâ‚'} {m} (x : (Âµâ‚ â–·â–· Âµâ‚') âˆ‹ m) â†’ (` x) â‹¯*' (f â†‘** Âµâ‚') â‰¡ (` x) â‹¯*' (g â†‘** Âµâ‚'))
  --   -- â‹¯-â†‘'' fs gs fs~gs {[]} x =
  --   --   (` x) â‹¯*' fs â†‘** [] â‰¡âŸ¨ {!â†‘**-[] fs x!} âŸ©
  --   --   (` x) â‹¯*' fs        â‰¡âŸ¨ fs~gs x âŸ©
  --   --   (` x) â‹¯*' gs        â‰¡âŸ¨ {!sym (â†‘**-[] gs x)!} âŸ©
  --   --   (` x) â‹¯*' gs â†‘** [] âˆ
  --   -- â‹¯-â†‘'' fs gs fs~gs {Âµâ‚' â–· m'} x@(here refl) =
  --   --   (` x) â‹¯*' fs â†‘** (Âµâ‚' â–· m')        â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' fs â†‘** Âµâ‚' â†‘** ([] â–· m') â‰¡âŸ¨ {!!} âŸ©
  --   --   ` here refl                       â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' gs â†‘** Âµâ‚' â†‘** ([] â–· m') â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' gs â†‘** (Âµâ‚' â–· m') âˆ
  --   -- â‹¯-â†‘'' fs gs fs~gs {Âµâ‚' â–· m'} {m} x@(there y) =
  --   --   (` x) â‹¯*' fs â†‘** (Âµâ‚' â–· m')        â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' fs â†‘** Âµâ‚' â†‘** ([] â–· m') â‰¡âŸ¨ {!!} âŸ©
  --   --   wk m' ((` y) â‹¯*' fs â†‘** Âµâ‚')       â‰¡âŸ¨ cong (wk m') (â‹¯-â†‘'' fs gs fs~gs y) âŸ©
  --   --   wk m' ((` y) â‹¯*' gs â†‘** Âµâ‚')       â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' gs â†‘** Âµâ‚' â†‘** ([] â–· m') â‰¡âŸ¨ {!!} âŸ©
  --   --   (` x) â‹¯*' gs â†‘** (Âµâ‚' â–· m') âˆ
