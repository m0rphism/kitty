module Kitty.Examples.SystemF-Paper.Definitions where

open import Kitty.Examples.SystemF-Paper.Kits
open import Data.List using (List; []; _âˆ·_)
open import Data.Product using (_,_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; cong; congâ‚‚; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning

-- Fixities --------------------------------------------------------------------

infix   3  _âŠ¢_  _â†ª_  _âŠ¢_âˆ¶_
infixr  5  Î»x_  Î›Î±_  âˆ€[Î±âˆ¶_]_
infixr  6  _â‡’_
infixl  6  _Â·_  _âˆ™_
infix   7  `_

-- -- Modes -----------------------------------------------------------------------

data Mode : ModeTy â†’ Set where
  ğ•– : Mode Var   -- Expressions
  ğ•¥ : Mode Var   -- Types
  ğ•œ : Mode Term  -- Kinds

variable
  mt                        : ModeTy
  m mâ‚ mâ‚‚ mâ‚ƒ m' mâ‚' mâ‚‚' mâ‚ƒ' : Mode mt
  Âµ Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµ' Âµâ‚' Âµâ‚‚' Âµâ‚ƒ' : List (Mode Var)
  x y z                     : Âµ âˆ‹ m

-- Syntax ----------------------------------------------------------------------

-- Expressions, Types, and Kinds
data _âŠ¢_ : List (Mode Var) â†’ Mode mt â†’ Set where
  `_        : âˆ€ {m}  â†’  Âµ âˆ‹ m  â†’  Âµ âŠ¢ m
  Î»x_       : (ğ•– âˆ· Âµ) âŠ¢ ğ•–  â†’  Âµ âŠ¢ ğ•–
  Î›Î±_       : (ğ•¥ âˆ· Âµ) âŠ¢ ğ•–  â†’  Âµ âŠ¢ ğ•–
  âˆ€[Î±âˆ¶_]_   : Âµ âŠ¢ ğ•œ  â†’  (ğ•¥ âˆ· Âµ) âŠ¢ ğ•¥  â†’  Âµ âŠ¢ ğ•¥
  _Â·_       : Âµ âŠ¢ ğ•–  â†’  Âµ âŠ¢ ğ•–  â†’  Âµ âŠ¢ ğ•–
  _âˆ™_       : Âµ âŠ¢ ğ•–  â†’  Âµ âŠ¢ ğ•¥  â†’  Âµ âŠ¢ ğ•–
  _â‡’_       : Âµ âŠ¢ ğ•¥  â†’  Âµ âŠ¢ ğ•¥  â†’  Âµ âŠ¢ ğ•¥
  â˜…         : Âµ âŠ¢ ğ•œ

variable
  e eâ‚ eâ‚‚ eâ‚ƒ e' eâ‚' eâ‚‚' : Âµ âŠ¢ ğ•–
  t tâ‚ tâ‚‚ tâ‚ƒ t' tâ‚' tâ‚‚' : Âµ âŠ¢ ğ•¥
  k kâ‚ kâ‚‚ kâ‚ƒ k' kâ‚' kâ‚‚' : Âµ âŠ¢ ğ•œ
  E Eâ‚ Eâ‚‚ Eâ‚ƒ E' Eâ‚' Eâ‚‚' : Âµ âŠ¢ m

-- Substitution & Lemmas -------------------------------------------------------

terms : Terms
terms = record
  { Mode        = Mode
  ; _âŠ¢_         = _âŠ¢_
  ; `_          = `_
  ; `-injective = Î» { refl â†’ refl }
  }

open Terms terms hiding (Mode; _âŠ¢_; `_)

_â‹¯_ :
  âˆ€ {_âˆ‹/âŠ¢_ : Scoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ {Âµâ‚ Âµâ‚‚} 
  â†’ Âµâ‚ âŠ¢ m â†’ Âµâ‚ â€“[ K ]â†’ Âµâ‚‚ â†’ Âµâ‚‚ âŠ¢ m
(` x)          â‹¯ Ï• = `/id (Ï• _ x)
(Î»x t)         â‹¯ Ï• = Î»x (t â‹¯ (Ï• â†‘ ğ•–))
(Î›Î± t)         â‹¯ Ï• = Î›Î± (t â‹¯ (Ï• â†‘ ğ•¥))
(âˆ€[Î±âˆ¶ tâ‚ ] tâ‚‚) â‹¯ Ï• = âˆ€[Î±âˆ¶ tâ‚ â‹¯ Ï• ] (tâ‚‚ â‹¯ (Ï• â†‘ ğ•¥))
(tâ‚ Â· tâ‚‚)      â‹¯ Ï• = (tâ‚ â‹¯ Ï•) Â· (tâ‚‚ â‹¯ Ï•)
(tâ‚ âˆ™ tâ‚‚)      â‹¯ Ï• = (tâ‚ â‹¯ Ï•) âˆ™ (tâ‚‚ â‹¯ Ï•)
(tâ‚ â‡’ tâ‚‚)      â‹¯ Ï• = (tâ‚ â‹¯ Ï•) â‡’ (tâ‚‚ â‹¯ Ï•)
â˜…              â‹¯ Ï• = â˜…

â‹¯-id :
  âˆ€ {_âˆ‹/âŠ¢_ : Scoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ {Âµ} (t : Âµ âŠ¢ m)
  â†’ t â‹¯ id â¦ƒ K â¦„ â‰¡ t
â‹¯-id â¦ƒ K â¦„ (` x)    = id/`/id â¦ƒ K â¦„ x
â‹¯-id (Î»x t)         = cong Î»x_ (t â‹¯ (id â†‘ ğ•–) â‰¡âŸ¨ cong (t â‹¯_) (~-ext idâ†‘~id) âŸ©
                                t â‹¯ id       â‰¡âŸ¨ â‹¯-id t âŸ©
                                t            âˆ)
â‹¯-id (Î›Î± t)         = cong Î›Î±_ (t â‹¯ (id â†‘ ğ•¥) â‰¡âŸ¨ cong (t â‹¯_) (~-ext idâ†‘~id) âŸ©
                                t â‹¯ id       â‰¡âŸ¨ â‹¯-id t âŸ©
                                t            âˆ)
â‹¯-id (âˆ€[Î±âˆ¶ tâ‚ ] tâ‚‚) = congâ‚‚ âˆ€[Î±âˆ¶_]_ (â‹¯-id tâ‚)
                                    (tâ‚‚ â‹¯ (id â†‘ ğ•¥) â‰¡âŸ¨ cong (tâ‚‚ â‹¯_) (~-ext idâ†‘~id) âŸ©
                                     tâ‚‚ â‹¯ id       â‰¡âŸ¨ â‹¯-id tâ‚‚ âŸ©
                                     tâ‚‚            âˆ)
â‹¯-id (tâ‚ Â· tâ‚‚)      = congâ‚‚ _Â·_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)
â‹¯-id (tâ‚ âˆ™ tâ‚‚)      = congâ‚‚ _âˆ™_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)
â‹¯-id (tâ‚ â‡’ tâ‚‚)      = congâ‚‚ _â‡’_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)
â‹¯-id â˜…              = refl

traversal : Traversal
traversal = record
  { _â‹¯_   = _â‹¯_
  ; â‹¯-var = Î» x Ï• â†’ refl
  ; â‹¯-id  = â‹¯-id
  }

open Traversal traversal hiding (_â‹¯_; â‹¯-id)

â‹¯-assoc :
  âˆ€ {_âˆ‹/âŠ¢_ _âˆ‹/âŠ¢â‚_ _âˆ‹/âŠ¢â‚‚_ : Scoped}
    â¦ƒ Kâ‚ : Kit _âˆ‹/âŠ¢â‚_ â¦„ â¦ƒ Kâ‚‚ : Kit _âˆ‹/âŠ¢â‚‚_ â¦„ â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„
    â¦ƒ Wâ‚ : WkKit Kâ‚ â¦„ â¦ƒ C : ComposeKit Kâ‚ Kâ‚‚ K â¦„
    {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ}
    (t : Âµâ‚ âŠ¢ m) (Ï•â‚ : Âµâ‚ â€“[ Kâ‚ ]â†’ Âµâ‚‚) (Ï•â‚‚ : Âµâ‚‚ â€“[ Kâ‚‚ ]â†’ Âµâ‚ƒ)
  â†’ (t â‹¯ Ï•â‚) â‹¯ Ï•â‚‚ â‰¡ t â‹¯ (Ï•â‚ Â·â‚˜ Ï•â‚‚)
â‹¯-assoc (` x)          Ï•â‚ Ï•â‚‚ = sym (&/â‹¯-â‹¯ (Ï•â‚ _ x) Ï•â‚‚)
â‹¯-assoc (Î»x t)         Ï•â‚ Ï•â‚‚ = cong Î»x_ ((t â‹¯ (Ï•â‚ â†‘ ğ•–)) â‹¯ (Ï•â‚‚ â†‘ ğ•–)  â‰¡âŸ¨ â‹¯-assoc t (Ï•â‚ â†‘ ğ•–) (Ï•â‚‚ â†‘ ğ•–) âŸ©
                                         t â‹¯ ((Ï•â‚ â†‘ ğ•–) Â·â‚˜ (Ï•â‚‚ â†‘ ğ•–)) â‰¡âŸ¨ cong (t â‹¯_) (sym (~-ext (dist-â†‘-Â· ğ•– Ï•â‚ Ï•â‚‚))) âŸ©
                                         t â‹¯ ((Ï•â‚ Â·â‚˜ Ï•â‚‚) â†‘ ğ•–)       âˆ)
â‹¯-assoc (Î›Î± t)         Ï•â‚ Ï•â‚‚ = cong Î›Î±_ ((t â‹¯ (Ï•â‚ â†‘ ğ•¥)) â‹¯ (Ï•â‚‚ â†‘ ğ•¥)  â‰¡âŸ¨ â‹¯-assoc t (Ï•â‚ â†‘ ğ•¥) (Ï•â‚‚ â†‘ ğ•¥) âŸ©
                                         t â‹¯ ((Ï•â‚ â†‘ ğ•¥) Â·â‚˜ (Ï•â‚‚ â†‘ ğ•¥)) â‰¡âŸ¨ cong (t â‹¯_) (sym (~-ext (dist-â†‘-Â· ğ•¥ Ï•â‚ Ï•â‚‚))) âŸ©
                                         t â‹¯ ((Ï•â‚ Â·â‚˜ Ï•â‚‚) â†‘ ğ•¥)       âˆ)
â‹¯-assoc (âˆ€[Î±âˆ¶ tâ‚ ] tâ‚‚) Ï•â‚ Ï•â‚‚ = congâ‚‚ âˆ€[Î±âˆ¶_]_ (â‹¯-assoc tâ‚ Ï•â‚ Ï•â‚‚)
                                        ((tâ‚‚ â‹¯ (Ï•â‚ â†‘ ğ•¥)) â‹¯ (Ï•â‚‚ â†‘ ğ•¥)  â‰¡âŸ¨ â‹¯-assoc tâ‚‚ (Ï•â‚ â†‘ ğ•¥) (Ï•â‚‚ â†‘ ğ•¥) âŸ©
                                         tâ‚‚ â‹¯ ((Ï•â‚ â†‘ ğ•¥) Â·â‚˜ (Ï•â‚‚ â†‘ ğ•¥)) â‰¡âŸ¨ cong (tâ‚‚ â‹¯_) (sym (~-ext (dist-â†‘-Â· ğ•¥ Ï•â‚ Ï•â‚‚))) âŸ©
                                         tâ‚‚ â‹¯ ((Ï•â‚ Â·â‚˜ Ï•â‚‚) â†‘ ğ•¥)       âˆ)
â‹¯-assoc (tâ‚ Â· tâ‚‚)      Ï•â‚ Ï•â‚‚ = congâ‚‚ _Â·_ (â‹¯-assoc tâ‚ Ï•â‚ Ï•â‚‚) (â‹¯-assoc tâ‚‚ Ï•â‚ Ï•â‚‚)
â‹¯-assoc (tâ‚ âˆ™ tâ‚‚)      Ï•â‚ Ï•â‚‚ = congâ‚‚ _âˆ™_ (â‹¯-assoc tâ‚ Ï•â‚ Ï•â‚‚) (â‹¯-assoc tâ‚‚ Ï•â‚ Ï•â‚‚)
â‹¯-assoc (tâ‚ â‡’ tâ‚‚)      Ï•â‚ Ï•â‚‚ = congâ‚‚ _â‡’_ (â‹¯-assoc tâ‚ Ï•â‚ Ï•â‚‚) (â‹¯-assoc tâ‚‚ Ï•â‚ Ï•â‚‚)
â‹¯-assoc â˜…              Ï•â‚ Ï•â‚‚ = refl

compose-traversal : ComposeTraversal
compose-traversal = record { â‹¯-assoc = â‹¯-assoc }

open ComposeTraversal compose-traversal hiding (â‹¯-assoc)

-- Type System -----------------------------------------------------------------

types : Types
types = record { â†‘áµ— = Î» { ğ•– â†’ _ , ğ•¥ ; ğ•¥ â†’ _ , ğ•œ ; ğ•œ â†’ _ , ğ•œ } }

open Types types

variable
  Î“ Î“â‚ Î“â‚‚ Î“' Î“â‚' Î“â‚‚' : Ctx Âµ
  T Tâ‚ Tâ‚‚ T' Tâ‚' Tâ‚‚' : Âµ âˆ¶âŠ¢ m

data _âŠ¢_âˆ¶_ : Ctx Âµ â†’ Âµ âŠ¢ m â†’ Âµ âˆ¶âŠ¢ m â†’ Set where
  âŠ¢` : âˆ€ {x : Âµ âˆ‹ m} {T : Âµ âˆ¶âŠ¢ m} â†’
    Î“ âˆ‹ x âˆ¶ T â†’
    Î“ âŠ¢ ` x âˆ¶ T
  âŠ¢Î» : âˆ€ {e : (ğ•– âˆ· Âµ) âŠ¢ ğ•–} â†’
    (tâ‚ âˆ·â‚œ Î“) âŠ¢ e âˆ¶ (wk _ tâ‚‚) â†’
    Î“ âŠ¢ Î»x e âˆ¶ tâ‚ â‡’ tâ‚‚
  âŠ¢Î› :
    (k âˆ·â‚œ Î“) âŠ¢ e âˆ¶ tâ‚‚ â†’
    Î“ âŠ¢ Î›Î± e âˆ¶ âˆ€[Î±âˆ¶ k ] tâ‚‚
  âŠ¢Â· :
    Î“ âŠ¢ eâ‚ âˆ¶ tâ‚ â‡’ tâ‚‚ â†’
    Î“ âŠ¢ eâ‚‚ âˆ¶ tâ‚ â†’
    Î“ âŠ¢ eâ‚ Â· eâ‚‚ âˆ¶ tâ‚‚
  âŠ¢âˆ™ : {Î“ : Ctx Âµ} â†’
    (kâ‚‚ âˆ·â‚œ Î“) âŠ¢ tâ‚ âˆ¶ kâ‚ â†’
    Î“ âŠ¢ tâ‚‚ âˆ¶ kâ‚‚ â†’
    Î“ âŠ¢ eâ‚ âˆ¶ âˆ€[Î±âˆ¶ kâ‚‚ ] tâ‚ â†’
    Î“ âŠ¢ eâ‚ âˆ™ tâ‚‚ âˆ¶ tâ‚ â‹¯ â¦… tâ‚‚ â¦†
  âŠ¢Ï„ :
    Î“ âŠ¢ t âˆ¶ â˜…

typing : Typing
typing = record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢` }

open Typing typing hiding (_âŠ¢_âˆ¶_; âŠ¢`) 

_âŠ¢â‹¯_ :
  âˆ€ {_âˆ‹/âŠ¢_ : Scoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ W : WkKit K â¦„
    â¦ƒ Câ‚ : ComposeKit K Káµ£ K â¦„ â¦ƒ Câ‚‚ : ComposeKit K K K â¦„
    â¦ƒ Câ‚ƒ : ComposeKit K Kâ‚› Kâ‚› â¦„
    â¦ƒ TK : TypingKit K W Câ‚ Câ‚‚ â¦„
    {Âµâ‚ Âµâ‚‚ mt} {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {m : Mode mt}
    {e : Âµâ‚ âŠ¢ m} {t : Âµâ‚ âˆ¶âŠ¢ m} {Ï• : Âµâ‚ â€“[ K ]â†’ Âµâ‚‚} â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âˆ‹*/âŠ¢*[ TK ] Ï• âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
âŠ¢` âŠ¢x âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âŠ¢x)
âŠ¢Î» {tâ‚‚ = tâ‚‚} âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î» (subst (_ âŠ¢ _ âˆ¶_) (sym (â‹¯-â†‘-wk tâ‚‚ _ _)) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _)))
âŠ¢Î› âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î› (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
âŠ¢âˆ™ {tâ‚ = tâ‚} {tâ‚‚ = tâ‚‚} âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï• = subst (_ âŠ¢ _ âˆ¶_) (sym (dist-â†‘-â¦…â¦†-â‹¯ tâ‚ tâ‚‚ _))
                                                 (âŠ¢âˆ™ (âŠ¢tâ‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _)) (âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢Ï„ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Ï„

typing-traversal : TypingTraversal
typing-traversal = record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ }

open TypingTraversal typing-traversal hiding (_âŠ¢â‹¯_)

-- Semantics -------------------------------------------------------------------

mutual
  data Neutral : Âµ âŠ¢ m â†’ Set where
    `_  : âˆ€ (x : Âµ âˆ‹ m) â†’ Neutral (` x)
    _Â·_ : Neutral eâ‚ â†’ Value eâ‚‚ â†’ Neutral (eâ‚ Â· eâ‚‚)
    _âˆ™t : Neutral eâ‚ â†’ Neutral (eâ‚ âˆ™ tâ‚‚)

  data Value : Âµ âŠ¢ m â†’ Set where
    Î»x_     : âˆ€ (e : (ğ•– âˆ· Âµ) âŠ¢ ğ•–) â†’ Value (Î»x e)
    Î›Î±_     : âˆ€ (e : (ğ•¥ âˆ· Âµ) âŠ¢ ğ•–) â†’ Value (Î›Î± e)
    neutral : Neutral e â†’ Value e

data _â†ª_ : Âµ âŠ¢ m â†’ Âµ âŠ¢ m â†’ Set where
  Î²-Î» : âˆ€ {eâ‚‚ : Âµ âŠ¢ ğ•–} â†’
    (Î»x eâ‚) Â· eâ‚‚ â†ª eâ‚ â‹¯ â¦… eâ‚‚ â¦†
  Î²-Î› : âˆ€ {tâ‚‚ : Âµ âŠ¢ ğ•¥} â†’
    (Î›Î± eâ‚) âˆ™ tâ‚‚ â†ª eâ‚ â‹¯ â¦… tâ‚‚ â¦†
  Î¾-Î» :
    e â†ª e' â†’
    Î»x e â†ª Î»x e'
  Î¾-Î› :
    e â†ª e' â†’
    Î›Î± e â†ª Î›Î± e'
  Î¾-Â·â‚ :
    eâ‚ â†ª eâ‚' â†’
    eâ‚ Â· eâ‚‚ â†ª eâ‚' Â· eâ‚‚
  Î¾-Â·â‚‚ :
    eâ‚‚ â†ª eâ‚‚' â†’
    eâ‚ Â· eâ‚‚ â†ª eâ‚ Â· eâ‚‚'
  Î¾-âˆ™â‚ :
    eâ‚ â†ª eâ‚' â†’
    eâ‚ âˆ™ tâ‚‚ â†ª eâ‚' âˆ™ tâ‚‚

-- Subject Reduction -----------------------------------------------------------

subject-reduction :
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} (âŠ¢Î» âŠ¢eâ‚) âŠ¢eâ‚‚)   Î²-Î»          = subst (_ âŠ¢ _ âˆ¶_) ({!wk-cancels-â¦…â¦†-â‹¯ tâ‚‚ _!}) (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢eâ‚‚ â¦†â‚›)
subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (âŠ¢Î› âŠ¢eâ‚))         Î²-Î›          = âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢tâ‚‚ â¦†â‚›
subject-reduction (âŠ¢Î» âŠ¢e)                      (Î¾-Î» eâ†ªe')    = âŠ¢Î» (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢Î› âŠ¢e)                      (Î¾-Î› eâ†ªe')    = âŠ¢Î› (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢eâ‚)             (Î¾-âˆ™â‚ eâ‚â†ªeâ‚') = âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚')
