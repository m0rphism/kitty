module Kitty.Examples.STLC-Pat-Derive.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; subst; module â‰¡-Reasoning)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _,_)
open â‰¡-Reasoning
open import Kitty.Examples.STLC-Pat-Derive.Definitions

open import Kitty.Typing.ITerms compose-traversal kit-type â„‚

â‰¡á¶œ-cong-âŠ¢ : âˆ€ {Âµ M} {Î“â‚ Î“â‚‚ : Ctx Âµ} {e : Âµ âŠ¢ M} {t : Âµ âˆ¶âŠ¢ M} â†’ 
  Î“â‚ â‰¡á¶œ Î“â‚‚ â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âŠ¢ e âˆ¶ t
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-` {x = x} âˆ‹x)               = âŠ¢-` (â‰¡á¶œ-cong-âˆ‹ x Î“â‚â‰¡Î“â‚‚ âˆ‹x)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-Î» âŠ¢e)                       = âŠ¢-Î» (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶ Î“â‚â‰¡Î“â‚‚ refl) âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                  = âŠ¢-Â· (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-tt                           = âŠ¢-tt
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-, âŠ¢eâ‚ âŠ¢eâ‚‚)                  = âŠ¢-, (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚ âŠ¢e)                    = âŠ¢-injâ‚ (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚‚ âŠ¢e)                    = âŠ¢-injâ‚‚ (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-match âŠ¢e âŠ¢cs ex)            = âŠ¢-match (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢cs) ex
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-clause-[]                    = âŠ¢-clause-[]
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-clause-âˆ· {P = P} âŠ¢p âŠ¢e âŠ¢cs) = âŠ¢-clause-âˆ· (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)
                                                            (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶â–¶ {Î“â‚' = PatTyâ†’Ctx' P} Î“â‚â‰¡Î“â‚‚ â‰¡á¶œ-refl) âŠ¢e)
                                                            (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢cs)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-ttáµ–                          = âŠ¢-ttáµ–
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-`áµ–                           = âŠ¢-`áµ–
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-,áµ– âŠ¢pâ‚ âŠ¢pâ‚‚)                 = âŠ¢-,áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢pâ‚) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢pâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚áµ– âŠ¢p)                   = âŠ¢-injâ‚áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚‚áµ– âŠ¢p)                   = âŠ¢-injâ‚‚áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)

open import Kitty.Typing.IKit compose-traversal kit-type â„‚ record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢-`; â‰¡á¶œ-cong-âŠ¢ = â‰¡á¶œ-cong-âŠ¢ }
open IKit â¦ƒ â€¦ â¦„

mutual
  _âŠ¢â‹¯_ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {e : Âµâ‚ âŠ¢ M} {t : Âµâ‚ âˆ¶âŠ¢ M} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Î“â‚ âŠ¢ e âˆ¶ t â†’
    Î“â‚‚ âˆ‹*/âŠ¢*[ IK ] Ï• âˆ¶ Î“â‚ â†’
    Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
  âŠ¢-` âˆ‹x               âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
  âŠ¢-Î» {tâ‚‚ = tâ‚‚} âŠ¢e     âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-Î» (subst (_ âŠ¢ _ âˆ¶_) (dist-â†‘-f tâ‚‚ _) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _)))
  âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-tt                 âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-tt
  âŠ¢-, âŠ¢eâ‚ âŠ¢eâ‚‚          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-, (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚ âŠ¢e            âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚‚ âŠ¢e            âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-match âŠ¢eâ‚ âŠ¢cs ex   âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-match (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢cs âŠ¢â‹¯ âŠ¢Ï•) (Exâ‹¯ ex)
  âŠ¢-clause-[]          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-clause-[]
  âŠ¢-clause-âˆ· âŠ¢p âŠ¢e âŠ¢cs âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-clause-âˆ· (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘*/âŠ¢â†‘* _)) (âŠ¢cs âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-ttáµ–                âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-ttáµ–
  âŠ¢-`áµ–                 âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-`áµ–
  _âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢-,áµ– {pâ‚ = pâ‚} {Pâ‚ = Pâ‚} {pâ‚‚ = pâ‚‚} {Pâ‚‚ = Pâ‚‚} âŠ¢pâ‚ âŠ¢pâ‚‚) âŠ¢Ï• =
    subst (Î“â‚‚ âŠ¢ ((pâ‚ â‹¯ Ï•) ,áµ– (pâ‚‚ â‹¯ Ï•)) âˆ¶_)
    (((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï•)) â‰¡âŸ¨ {!!} âŸ©
    (Pâ‚ â–¶â–¶áµ– Pâ‚‚) â‹¯ Ï•         âˆ)
    (âŠ¢-,áµ– (âŠ¢pâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢pâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘*/âŠ¢â†‘* PatTyâ†’Ctx' Pâ‚)))
  âŠ¢-injâ‚áµ– âŠ¢p           âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚áµ– (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚‚áµ– âŠ¢p           âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚‚áµ– (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•)

  Canâ‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {e : Âµâ‚ âŠ¢ ğ•–} {t : Âµâ‚ âŠ¢ ğ•¥} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Canonical e (t â‹¯ Ï•) â†’
    Canonical e t
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = e}         {`[_]_ {m = ğ•–} () x} {Ï•} can
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = .(Î»x _)}   {tâ‚ `â†’ tâ‚‚} {Ï•} C-Î»             = C-Î»
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = .tt}       {ğŸ™}        {Ï•} C-tt            = C-tt
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = .(_ , _)}  {tâ‚ `Ã— tâ‚‚} {Ï•} (C-, canâ‚ canâ‚‚) = C-, (Canâ‹¯ canâ‚) (Canâ‹¯ canâ‚‚)
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = .(injâ‚ _)} {tâ‚ `âŠ tâ‚‚} {Ï•} (C-injâ‚ can)    = C-injâ‚ (Canâ‹¯ can)
  Canâ‹¯ {Âµâ‚} {Âµâ‚‚} {e = .(injâ‚‚ _)} {tâ‚ `âŠ tâ‚‚} {Ï•} (C-injâ‚‚ can)    = C-injâ‚‚ (Canâ‹¯ can)

  -- Matchesâ‹¯ :
  --   âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
  --     â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
  --     â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
  --     â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
  --     {e : Âµâ‚ âŠ¢ ğ•–} {cs : Âµâ‚‚ âŠ¢ ğ•”ğ•¤} (p : Âµâ‚‚ âŠ¢ ğ•¡ Âµ') {e' : (Âµâ‚‚ â–·â–· Âµ') âŠ¢ ğ•–} {M : Matches e p} {Ï• : Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚ƒ} â†’
  --   Matchesâ‚ e cs p e' M â†’
  --   âˆƒ[ M' ] Matchesâ‚ e (cs â‹¯ Ï•) (p â‹¯ Ï•) (e' â‹¯ Ï•) M'
  -- Matchesâ‹¯ = ?

  Exâ‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {cs : Âµâ‚ âŠ¢ ğ•”ğ•¤} {t : Âµâ‚ âŠ¢ ğ•¥} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Exhaustive cs t â†’
    Exhaustive (cs â‹¯ Ï•) (t â‹¯ Ï•)
  -- Exâ‹¯ {cs = cs} {t} {Ï•} ex can = {!ex (Canâ‹¯ can)!}
  Exâ‹¯ {cs = cs} {`[_]_ {m = ğ•–} () xâ‚} {Ï•} ex can
  Exâ‹¯ {cs = cs} {tâ‚ `â†’ tâ‚‚} {Ï•} ex (C-Î» {e = e}) = {!ex (C-Î» {e = e})!}
  Exâ‹¯ {cs = cs} {ğŸ™}        {Ï•} ex can = {!!}
  Exâ‹¯ {cs = cs} {tâ‚ `Ã— tâ‚‚} {Ï•} ex can = {!!}
  Exâ‹¯ {cs = cs} {tâ‚ `âŠ tâ‚‚} {Ï•} ex can = {!!}

-- open ITraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

-- subject-reduction :
--   Î“ âŠ¢ e âˆ¶ t â†’
--   e â†ª e' â†’
--   Î“ âŠ¢ e' âˆ¶ t
-- subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} (âŠ¢Î» âŠ¢eâ‚) âŠ¢eâ‚‚)   Î²-Î»          = subst (_ âŠ¢ _ âˆ¶_) (wk-cancels-â¦…â¦† tâ‚‚ _) (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢eâ‚‚ â¦†)
-- subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (âŠ¢Î› âŠ¢eâ‚))         Î²-Î›          = âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢tâ‚‚ â¦†
-- subject-reduction (âŠ¢Î» âŠ¢e)                      (Î¾-Î» eâ†ªe')    = âŠ¢Î» (subject-reduction âŠ¢e eâ†ªe')
-- subject-reduction (âŠ¢Î› âŠ¢e)                      (Î¾-Î› eâ†ªe')    = âŠ¢Î› (subject-reduction âŠ¢e eâ†ªe')
-- subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
-- subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
-- subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢eâ‚)             (Î¾-âˆ™â‚ eâ‚â†ªeâ‚') = âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚')
