module Kitty.Examples.LambdaPi.SubjectReduction where

open import Data.Product using (âˆƒ-syntax; Î£-syntax; _Ã—_ ; _,_; projâ‚; projâ‚‚)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Function using () renaming (_âˆ‹_ to _by_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; cong; cong-app; subst; module â‰¡-Reasoning)
open import Data.List.Properties using (++-identityÊ³)
open import Data.Nat using (â„•; suc; zero)
open import Data.List using (List; []; _âˆ·_; drop)
open â‰¡-Reasoning

open import Kitty.Examples.LambdaPi.Definitions
open import Kitty.Examples.LambdaPi.Confluence
open import Kitty.Typing.TypingKit compose-traversal ctx-repr typing
open import Kitty.Util.List using (depth)
open TypingKit â¦ƒ â€¦ â¦„

-- Conversion is an equivalence relation

â‰ˆ-refl :
  e â‰ˆ e
â‰ˆ-refl {e = e} = mk-â‰ˆ e â†ª*-refl â†ª*-refl

â‰ˆ-sym :
  eâ‚ â‰ˆ eâ‚‚ â†’
  eâ‚‚ â‰ˆ eâ‚
â‰ˆ-sym (mk-â‰ˆ e eâ‚â†ª*e eâ‚‚â†ª*e) = mk-â‰ˆ e eâ‚‚â†ª*e eâ‚â†ª*e

â‰ˆ-trans :
  eâ‚ â‰ˆ eâ‚‚ â†’
  eâ‚‚ â‰ˆ eâ‚ƒ â†’
  eâ‚ â‰ˆ eâ‚ƒ
â‰ˆ-trans (mk-â‰ˆ e eâ‚â†ª*e eâ‚‚â†ª*e) (mk-â‰ˆ e' eâ‚‚â†ª*e' eâ‚ƒâ†ª*e')
 with confluence eâ‚‚â†ª*e eâ‚‚â†ª*e'
... | e'' , eâ†ª*e'' , e'â†ª*e''
 = mk-â‰ˆ e'' (â†ª*-trans eâ‚â†ª*e eâ†ª*e'') (â†ª*-trans eâ‚ƒâ†ª*e' e'â†ª*e'')

-- Reduction implies conversion

â†ªâ†’â‰ˆ :
  eâ‚ â†ª eâ‚‚ â†’
  eâ‚ â‰ˆ eâ‚‚
â†ªâ†’â‰ˆ eâ‚â†ªeâ‚‚ = mk-â‰ˆ _ (â†ª*-step eâ‚â†ªeâ‚‚ â†ª*-refl) â†ª*-refl

-- Lifting reduction and conversion pointwise to substitutions

_â†ªâ‚š*Ïƒ_ : âˆ€ (Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚) â†’ Set
Ïƒâ‚ â†ªâ‚š*Ïƒ Ïƒâ‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ Ïƒâ‚ _ x â†ªâ‚š* Ïƒâ‚‚ _ x

_â†ª*Ïƒ_ : âˆ€ (Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚) â†’ Set
Ïƒâ‚ â†ª*Ïƒ Ïƒâ‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ Ïƒâ‚ _ x â†ª* Ïƒâ‚‚ _ x

_â‰ˆÏƒ_ : âˆ€ (Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚) â†’ Set
Ïƒâ‚ â‰ˆÏƒ Ïƒâ‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ Ïƒâ‚ _ x â‰ˆ Ïƒâ‚‚ _ x

â†ªâ‚š*-â‹¯ :
  âˆ€ â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ KT : KitT K â¦„
    â¦ƒ Câ‚ : ComposeKit K K K â¦„ â¦ƒ Câ‚‚ : ComposeKit Kâ‚› K Kâ‚› â¦„ â¦ƒ Câ‚ƒ : ComposeKit K Kâ‚› Kâ‚› â¦„
    {Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚} {e e' : Sâ‚ âŠ¢ s} â†’
  e â†ªâ‚š* e' â†’
  (e â‹¯ Ï•) â†ªâ‚š* (e' â‹¯ Ï•)
â†ªâ‚š*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ â†ªâ‚š*-refl       = â†ªâ‚š*-refl
â†ªâ‚š*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ (â†ªâ‚š*-step p q) = â†ªâ‚š*-step (â†ªâ‚š-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ p) (â†ªâ‚š*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ q)

â†ª-â‹¯ :
  âˆ€ â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ KT : KitT K â¦„
    â¦ƒ Câ‚ : ComposeKit K K K â¦„ â¦ƒ Câ‚‚ : ComposeKit Kâ‚› K Kâ‚› â¦„ â¦ƒ Câ‚ƒ : ComposeKit K Kâ‚› Kâ‚› â¦„
    {Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚} {e e' : Sâ‚ âŠ¢ s} â†’
  e â†ª e' â†’
  e â‹¯ Ï• â†ª* e' â‹¯ Ï•
â†ª-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ eâ†ªe' = â†ªâ‚šâ†’â†ª* (â†ªâ‚š-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ (â†ªâ†’â†ªâ‚š eâ†ªe'))

â†ª*-â‹¯ :
  âˆ€ â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ KT : KitT K â¦„
    â¦ƒ Câ‚ : ComposeKit K K K â¦„ â¦ƒ Câ‚‚ : ComposeKit Kâ‚› K Kâ‚› â¦„ â¦ƒ Câ‚ƒ : ComposeKit K Kâ‚› Kâ‚› â¦„
    {Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚} {e e' : Sâ‚ âŠ¢ s} â†’
  e â†ª* e' â†’
  e â‹¯ Ï• â†ª* e' â‹¯ Ï•
â†ª*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ â†ª*-refl = â†ª*-refl
â†ª*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ (â†ª*-step p q) = â†ª*-trans (â†ª-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ p) (â†ª*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ q)

â‰ˆ-â‹¯â‚– :
  âˆ€ â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„ â¦ƒ KT : KitT K â¦„
    â¦ƒ Câ‚ : ComposeKit K K K â¦„ â¦ƒ Câ‚‚ : ComposeKit Kâ‚› K Kâ‚› â¦„ â¦ƒ Câ‚ƒ : ComposeKit K Kâ‚› Kâ‚› â¦„
    {Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚} {e e' : Sâ‚ âŠ¢ s} â†’
  e â‰ˆ e' â†’
  (e â‹¯ Ï•) â‰ˆ (e' â‹¯ Ï•)
â‰ˆ-â‹¯â‚– â¦ƒ Câ‚‚ = Câ‚‚ â¦„ {Ï• = Ï•} (mk-â‰ˆ E eâ‚â†ª*E eâ‚‚â†ª*E) = mk-â‰ˆ (E â‹¯ Ï•) (â†ª*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ eâ‚â†ª*E) (â†ª*-â‹¯ â¦ƒ Câ‚‚ = Câ‚‚ â¦„ eâ‚‚â†ª*E)

â†ªâ‚š*Ïƒ-â†‘ : âˆ€ {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚}
  â†’ Ïƒ â†ªâ‚š*Ïƒ Ïƒ'
  â†’ (Ïƒ â†‘â‚› s) â†ªâ‚š*Ïƒ (Ïƒ' â†‘â‚› s)
â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªâ‚šÏƒ' _ (here refl) = â†ªâ‚š*-refl
â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªâ‚šÏƒ' _ (there x) = â†ªâ‚š*-â‹¯ (Ïƒâ†ªâ‚šÏƒ' _ x)

â†ªâ‚š*Ïƒ-â‹¯ : âˆ€ {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} â†’
  e â†ªâ‚š e' â†’
  Ïƒ â†ªâ‚š*Ïƒ Ïƒ' â†’
  (e â‹¯ Ïƒ) â†ªâ‚š* (e' â‹¯ Ïƒ')
â†ªâ‚š*Ïƒ-â‹¯ Î¾-`                         Ïƒâ†ªÏƒ' = Ïƒâ†ªÏƒ' _ _
â†ªâ‚š*Ïƒ-â‹¯ {Ïƒ' = Ïƒ'} (Î²-Î» {eâ‚' = eâ‚'} {eâ‚‚' = eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')
                                   Ïƒâ†ªÏƒ' = subst (_ â†ªâ‚š*_) (sym (dist-â¦…â¦†â‚›-â‹¯â‚› eâ‚' eâ‚‚' Ïƒ'))
                                                (Î²*-Î» (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' (â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªÏƒ')) (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ'))
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-Î» eâ†ªâ‚še')                 Ïƒâ†ªÏƒ' = â†ªâ‚š*-map Î¾-Î» (â†ªâ‚š*Ïƒ-â‹¯ eâ†ªâ‚še' (â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªÏƒ'))
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-âˆ€ tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚')       Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚‚ Î¾-âˆ€ (â†ªâ‚š*Ïƒ-â‹¯ tâ‚â†ªâ‚štâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' (â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªÏƒ'))
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-Â· eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')       Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚‚ Î¾-Â· (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ Î¾-Set                       Ïƒâ†ªÏƒ' = â†ªâ‚š*-refl
â†ªâ‚š*Ïƒ-â‹¯ (Î²-projâ‚ eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')   Ïƒâ†ªÏƒ' = Î²*-projâ‚ (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î²-projâ‚‚ eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')   Ïƒâ†ªÏƒ' = Î²*-projâ‚‚ (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-âˆƒ tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚')       Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚‚ Î¾-âˆƒ (â†ªâ‚š*Ïƒ-â‹¯ tâ‚â†ªâ‚štâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' (â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªÏƒ'))
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-, eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')       Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚‚ Î¾-, (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-projâ‚ eâ†ªâ‚še')             Ïƒâ†ªÏƒ' = â†ªâ‚š*-map Î¾-projâ‚ (â†ªâ‚š*Ïƒ-â‹¯ eâ†ªâ‚še' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-projâ‚‚ eâ†ªâ‚še')             Ïƒâ†ªÏƒ' = â†ªâ‚š*-map Î¾-projâ‚‚ (â†ªâ‚š*Ïƒ-â‹¯ eâ†ªâ‚še' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î²-J eâ†ªâ‚še')                 Ïƒâ†ªÏƒ' = Î²*-J (â†ªâ‚š*Ïƒ-â‹¯ eâ†ªâ‚še' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-â‰¡ eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')       Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚‚ Î¾-â‰¡ (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')
â†ªâ‚š*Ïƒ-â‹¯ Î¾-refl                      Ïƒâ†ªÏƒ' = â†ªâ‚š*-refl
â†ªâ‚š*Ïƒ-â‹¯ (Î¾-J tâ†ªâ‚št' eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚') Ïƒâ†ªÏƒ' = â†ªâ‚š*-mapâ‚ƒ Î¾-J (â†ªâ‚š*Ïƒ-â‹¯ tâ†ªâ‚št' (â†ªâ‚š*Ïƒ-â†‘ Ïƒâ†ªÏƒ'))
                                                       (â†ªâ‚š*Ïƒ-â‹¯ eâ‚â†ªâ‚šeâ‚' Ïƒâ†ªÏƒ')
                                                       (â†ªâ‚š*Ïƒ-â‹¯ eâ‚‚â†ªâ‚šeâ‚‚' Ïƒâ†ªÏƒ')

â†ªâ‚š*Ïƒ-â‹¯' : âˆ€ {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} â†’
  e â†ªâ‚š* e' â†’
  Ïƒ â†ªâ‚š*Ïƒ Ïƒ' â†’
  (e â‹¯ Ïƒ) â†ªâ‚š* (e' â‹¯ Ïƒ')
â†ªâ‚š*Ïƒ-â‹¯' {e = e} â†ªâ‚š*-refl Ïƒâ†ªâ‚š*Ïƒ' = â†ªâ‚š*Ïƒ-â‹¯ {e = e} â†ªâ‚š-refl Ïƒâ†ªâ‚š*Ïƒ'
â†ªâ‚š*Ïƒ-â‹¯' (â†ªâ‚š*-step p q) Ïƒâ†ªâ‚š*Ïƒ' = â†ªâ‚š*-trans (â†ªâ‚š*Ïƒ-â‹¯ p Î» s x â†’ â†ªâ‚š*-refl) (â†ªâ‚š*Ïƒ-â‹¯' q Ïƒâ†ªâ‚š*Ïƒ' )

â†ª*Ïƒ-â‹¯ : âˆ€ {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} â†’
  e â†ª* e' â†’
  Ïƒ â†ª*Ïƒ Ïƒ' â†’
  (e â‹¯ Ïƒ) â†ª* (e' â‹¯ Ïƒ')
â†ª*Ïƒ-â‹¯ {e = e} eâ†ª*e' Ïƒâ†ª*Ïƒ' = â†ªâ‚š*â†’â†ª* (â†ªâ‚š*Ïƒ-â‹¯' (â†ª*â†’â†ªâ‚š* eâ†ª*e') Î» s x â†’ â†ª*â†’â†ªâ‚š* (Ïƒâ†ª*Ïƒ' s x))

â‰ˆ-â‹¯ : âˆ€ {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} â†’
  e â‰ˆ e' â†’
  Ïƒ â‰ˆÏƒ Ïƒ' â†’
  (e â‹¯ Ïƒ) â‰ˆ (e' â‹¯ Ïƒ')
â‰ˆ-â‹¯ (mk-â‰ˆ E eâ‚â†ª*E eâ‚‚â†ª*E) Ïƒâ‰ˆÏƒ' =
  mk-â‰ˆ _ (â†ª*Ïƒ-â‹¯ eâ‚â†ª*E Î» s x â†’ â‰ˆ-eâ‚â†ª*e (Ïƒâ‰ˆÏƒ' s x)) (â†ª*Ïƒ-â‹¯ eâ‚‚â†ª*E (Î» s x â†’ â‰ˆ-eâ‚‚â†ª*e (Ïƒâ‰ˆÏƒ' s x)))

â‰ˆâ†’â‰ˆÏƒ : âˆ€ {e e' : S âŠ¢ s} â†’
  e â‰ˆ e' â†’
  â¦… e â¦†' â‰ˆÏƒ â¦… e' â¦†'
â‰ˆâ†’â‰ˆÏƒ eâ‰ˆe' _ (here refl) = eâ‰ˆe'
â‰ˆâ†’â‰ˆÏƒ eâ‰ˆe' _ (there x) = mk-â‰ˆ (` x) â†ª*-refl â†ª*-refl

â‰ˆÏƒ-refl : âˆ€ {Ïƒ : Sâ‚ â†’â‚› Sâ‚‚} â†’
  Ïƒ â‰ˆÏƒ Ïƒ
â‰ˆÏƒ-refl _ x = â‰ˆ-refl

-- Context Conversion

_â‰ˆá¶œ_ : Ctx S â†’ Ctx S â†’ Set
Î“â‚ â‰ˆá¶œ Î“â‚‚ = âˆ€ s (x : _ âˆ‹ s) â†’ wk-telescope Î“â‚ x â‰ˆ wk-telescope Î“â‚‚ x

â‰ˆá¶œ-refl : âˆ€ {Î“ : Ctx S}
  â†’ Î“ â‰ˆá¶œ Î“
â‰ˆá¶œ-refl _ x = â‰ˆ-refl


â‰ˆ-subst : âˆ€ (eqâ‚ eqâ‚‚ : S â‰¡ S') â†’
  eâ‚ â‰ˆ eâ‚‚ â†’
  subst (_âŠ¢ s) eqâ‚ eâ‚ â‰ˆ subst (_âŠ¢ s) eqâ‚‚ eâ‚‚ 
â‰ˆ-subst refl refl p = p

â‰ˆ-substâ» : âˆ€ (eqâ‚ eqâ‚‚ : S â‰¡ S') â†’
  subst (_âŠ¢ s) eqâ‚ eâ‚ â‰ˆ subst (_âŠ¢ s) eqâ‚‚ eâ‚‚ â†’
  eâ‚ â‰ˆ eâ‚‚
â‰ˆ-substâ» refl refl p = p

â‰ˆá¶œ-ext : âˆ€ {Î“â‚ Î“â‚‚ : Ctx S}
  â†’ Î“â‚ â‰ˆá¶œ Î“â‚‚
  â†’ tâ‚ â‰ˆ tâ‚‚
  â†’ (Î“â‚ â–¶ tâ‚) â‰ˆá¶œ (Î“â‚‚ â–¶ tâ‚‚)
â‰ˆá¶œ-ext {S = S} Î“â‚â‰ˆÎ“â‚‚ tâ‚â‰ˆtâ‚‚ _ (here refl) = â‰ˆ-â‹¯â‚– (â‰ˆ-subst p p (â‰ˆ-subst (sym p) (sym p) tâ‚â‰ˆtâ‚‚))
                                           where p = ++-identityÊ³ S
â‰ˆá¶œ-ext {S = S} Î“â‚â‰ˆÎ“â‚‚ tâ‚â‰ˆtâ‚‚ _ (there x)   = â‰ˆ-â‹¯â‚– (Î“â‚â‰ˆÎ“â‚‚ _ x) 

â‰ˆ-Î“-âŠ¢ : âˆ€ {Î“â‚ Î“â‚‚ : Ctx S} {e : S âŠ¢ s} {t : S âˆ¶âŠ¢ s}
  â†’ Î“â‚ â‰ˆá¶œ Î“â‚‚
  â†’ Î“â‚ âŠ¢ e âˆ¶ t
  â†’ Î“â‚‚ âŠ¢ e âˆ¶ t
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢` {s = ğ•–} {x = x} refl) =  âŠ¢â‰ˆ (â‰ˆ-sym (Î“â‚â‰ˆÎ“â‚‚ _ x)) (âŠ¢` {x = x} refl)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢Î» âŠ¢tâ‚ âŠ¢e)             = âŠ¢Î» (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢tâ‚) (â‰ˆ-Î“-âŠ¢ (â‰ˆá¶œ-ext Î“â‚â‰ˆÎ“â‚‚ â‰ˆ-refl) âŠ¢e)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)            = âŠ¢Â· (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚‚)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚)            = âŠ¢âˆ€ (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢tâ‚) (â‰ˆ-Î“-âŠ¢ (â‰ˆá¶œ-ext Î“â‚â‰ˆÎ“â‚‚ â‰ˆ-refl) âŠ¢tâ‚‚)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢Set                    = âŠ¢Set
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢â‰ˆ tâ‰ˆt' âŠ¢e)            = âŠ¢â‰ˆ tâ‰ˆt' (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢e)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢âˆƒ âŠ¢tâ‚ âŠ¢tâ‚‚)            = âŠ¢âˆƒ (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢tâ‚) (â‰ˆ-Î“-âŠ¢ (â‰ˆá¶œ-ext Î“â‚â‰ˆÎ“â‚‚ â‰ˆ-refl) âŠ¢tâ‚‚)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚)            = âŠ¢, (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚‚)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢projâ‚ âŠ¢e)             = âŠ¢projâ‚ (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢e)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢projâ‚‚ âŠ¢e)             = âŠ¢projâ‚‚ (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢e)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢â‰¡ âŠ¢eâ‚ âŠ¢eâ‚‚)            = âŠ¢â‰¡ (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚‚)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢refl âŠ¢e)              = âŠ¢refl (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢e)
â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ (âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) = âŠ¢J (â‰ˆ-Î“-âŠ¢ (â‰ˆá¶œ-ext Î“â‚â‰ˆÎ“â‚‚ â‰ˆ-refl) âŠ¢t) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢uâ‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢uâ‚‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚) (â‰ˆ-Î“-âŠ¢ Î“â‚â‰ˆÎ“â‚‚ âŠ¢eâ‚‚)

â‰ˆ-Î“-âŠ¢â‚ : âˆ€ {Î“ : Ctx S} {tâ‚ tâ‚‚ : S âˆ¶âŠ¢ ğ•–} {e : (ğ•– âˆ· S) âŠ¢ ğ•–} {t : (ğ•– âˆ· S) âˆ¶âŠ¢ ğ•–}
  â†’ tâ‚ â‰ˆ tâ‚‚
  â†’ Î“ â–¶ tâ‚ âŠ¢ e âˆ¶ t
  â†’ Î“ â–¶ tâ‚‚ âŠ¢ e âˆ¶ t
â‰ˆ-Î“-âŠ¢â‚ {Î“ = Î“} tâ‚â‰ˆtâ‚‚ âŠ¢e = â‰ˆ-Î“-âŠ¢ (â‰ˆá¶œ-ext (â‰ˆá¶œ-refl {Î“ = Î“}) tâ‚â‰ˆtâ‚‚) âŠ¢e

--------------------------------------------------------------------------------
-- Inversion for lambda terms

â†ª-âˆ€-shape :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª-âˆ€-shape (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = _ ,  _ ,  refl ,  â†ª*-step tâ‚â†ªtâ‚' â†ª*-refl , â†ª*-refl    
â†ª-âˆ€-shape (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-step tâ‚‚â†ªtâ‚‚' â†ª*-refl    

â†ª*-âˆ€-shape :
  (âˆ€[xâˆ¶ tâ‚ ] tâ‚‚) â†ª* t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª*-âˆ€-shape â†ª*-refl =  _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-refl    
â†ª*-âˆ€-shape (â†ª*-step âˆ€â†ªt tâ†ª*t')
  with â†ª-âˆ€-shape âˆ€â†ªt
...  |  tâ‚' ,  tâ‚‚' ,  refl ,  tâ‚â†ª*tâ‚' , tâ‚‚â†ª*tâ‚‚'    
  with â†ª*-âˆ€-shape tâ†ª*t'
...  |  tâ‚'' ,  tâ‚‚'' ,  refl ,  tâ‚'â†ª*tâ‚'' , tâ‚‚'â†ª*tâ‚‚''    
  =  tâ‚'' ,  tâ‚‚'' ,  refl ,  â†ª*-trans tâ‚â†ª*tâ‚' tâ‚'â†ª*tâ‚'' , â†ª*-trans tâ‚‚â†ª*tâ‚‚' tâ‚‚'â†ª*tâ‚‚''    

invert-â‰ˆ-âˆ€ :
  (âˆ€[xâˆ¶ tâ‚ ] tâ‚‚) â‰ˆ (âˆ€[xâˆ¶ tâ‚' ] tâ‚‚') â†’
  tâ‚ â‰ˆ tâ‚' Ã— tâ‚‚ â‰ˆ tâ‚‚'
invert-â‰ˆ-âˆ€ (mk-â‰ˆ t âˆ€â‚â†ª*t âˆ€â‚‚â†ª*t)
  with â†ª*-âˆ€-shape âˆ€â‚â†ª*t                | â†ª*-âˆ€-shape âˆ€â‚‚â†ª*t
... |  Tâ‚ ,  Tâ‚‚ ,  refl ,  tâ‚â†ª*Tâ‚ , tâ‚‚â†ª*Tâ‚‚     |  .Tâ‚ ,  .Tâ‚‚ ,  refl ,  tâ‚'â†ª*Tâ‚ , tâ‚‚'â†ª*Tâ‚‚    
  =  (mk-â‰ˆ Tâ‚ tâ‚â†ª*Tâ‚ tâ‚'â†ª*Tâ‚) , (mk-â‰ˆ Tâ‚‚ tâ‚‚â†ª*Tâ‚‚ tâ‚‚'â†ª*Tâ‚‚) 

invert-âŠ¢Î»' :
  Î“ âŠ¢ Î»x e âˆ¶ t â†’
  âˆƒ[ tâ‚ ] âˆƒ[ tâ‚‚ ]
    t â‰ˆ (âˆ€[xâˆ¶ tâ‚ ] tâ‚‚) Ã—
    Î“ âŠ¢ tâ‚ âˆ¶ `Set Ã—
    Î“ â–¶ tâ‚ âŠ¢ e âˆ¶ tâ‚‚
invert-âŠ¢Î»' (âŠ¢Î» âŠ¢tâ‚ âŠ¢e) =  _ ,  _ ,  â‰ˆ-refl ,  âŠ¢tâ‚ , âŠ¢e    
invert-âŠ¢Î»' (âŠ¢â‰ˆ tâ‰ˆt' âŠ¢e) with invert-âŠ¢Î»' âŠ¢e
... |  tâ‚ ,  tâ‚‚ ,  t'â‰ˆâˆ€[tâ‚]tâ‚‚ ,  âŠ¢tâ‚ , âŠ¢e     =  tâ‚ ,  tâ‚‚ ,  â‰ˆ-trans (â‰ˆ-sym tâ‰ˆt') t'â‰ˆâˆ€[tâ‚]tâ‚‚ ,  âŠ¢tâ‚ , âŠ¢e    

invert-âŠ¢Î» :
  Î“ âŠ¢ Î»x e âˆ¶ âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†’
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ]
      tâ‚ â‰ˆ tâ‚' Ã—
      tâ‚‚ â‰ˆ tâ‚‚' Ã—
      Î“ âŠ¢ tâ‚' âˆ¶ `Set Ã—
      Î“ â–¶ tâ‚' âŠ¢ e âˆ¶ tâ‚‚'
invert-âŠ¢Î» âŠ¢e
 with invert-âŠ¢Î»' âŠ¢e
... |  tâ‚' ,  tâ‚‚' ,  âˆ€â‰ˆâˆ€' ,  âŠ¢tâ‚' , âŠ¢e    
 with invert-â‰ˆ-âˆ€ âˆ€â‰ˆâˆ€'
... |  tâ‚â‰ˆtâ‚' , tâ‚‚â‰ˆtâ‚‚' 
 =  tâ‚' ,  tâ‚‚' ,  tâ‚â‰ˆtâ‚' ,  tâ‚‚â‰ˆtâ‚‚' ,  âŠ¢tâ‚' , âŠ¢e     

-- Inversion for product terms

â†ª-âˆƒ-shape :
  âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚ â†ª t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª-âˆƒ-shape (Î¾-âˆƒâ‚ tâ‚â†ªtâ‚') =  _ ,  _ ,  refl ,  â†ª*-step tâ‚â†ªtâ‚' â†ª*-refl , â†ª*-refl    
â†ª-âˆƒ-shape (Î¾-âˆƒâ‚‚ tâ‚‚â†ªtâ‚‚') =  _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-step tâ‚‚â†ªtâ‚‚' â†ª*-refl    

â†ª*-âˆƒ-shape :
  (âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚) â†ª* t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª*-âˆƒ-shape â†ª*-refl =  _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-refl    
â†ª*-âˆƒ-shape (â†ª*-step âˆƒâ†ªt tâ†ª*t')
  with â†ª-âˆƒ-shape âˆƒâ†ªt
...  |  tâ‚' ,  tâ‚‚' ,  refl ,  tâ‚â†ª*tâ‚' , tâ‚‚â†ª*tâ‚‚'    
  with â†ª*-âˆƒ-shape tâ†ª*t'
...  |  tâ‚'' ,  tâ‚‚'' ,  refl ,  tâ‚'â†ª*tâ‚'' , tâ‚‚'â†ª*tâ‚‚''    
  =  tâ‚'' ,  tâ‚‚'' ,  refl ,  â†ª*-trans tâ‚â†ª*tâ‚' tâ‚'â†ª*tâ‚'' , â†ª*-trans tâ‚‚â†ª*tâ‚‚' tâ‚‚'â†ª*tâ‚‚''    

invert-â‰ˆ-âˆƒ :
  (âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚) â‰ˆ (âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚') â†’
  tâ‚ â‰ˆ tâ‚' Ã— tâ‚‚ â‰ˆ tâ‚‚'
invert-â‰ˆ-âˆƒ (mk-â‰ˆ t âˆƒâ‚â†ª*t âˆƒâ‚‚â†ª*t)
  with â†ª*-âˆƒ-shape âˆƒâ‚â†ª*t                                | â†ª*-âˆƒ-shape âˆƒâ‚‚â†ª*t
... |  Tâ‚ ,  Tâ‚‚ ,  refl ,  tâ‚â†ª*Tâ‚ , tâ‚‚â†ª*Tâ‚‚     |  .Tâ‚ ,  .Tâ‚‚ ,  refl ,  tâ‚'â†ª*Tâ‚ , tâ‚‚'â†ª*Tâ‚‚    
  =  (mk-â‰ˆ Tâ‚ tâ‚â†ª*Tâ‚ tâ‚'â†ª*Tâ‚) , (mk-â‰ˆ Tâ‚‚ tâ‚‚â†ª*Tâ‚‚ tâ‚‚'â†ª*Tâ‚‚) 

invert-âŠ¢,' : âˆ€ {eâ‚ : S âŠ¢ ğ•–} {tâ‚‚ : (ğ•– âˆ· S) âŠ¢ ğ•–} â†’
  Î“ âŠ¢ (eâ‚ `, eâ‚‚) âˆ¶ t â†’
  âˆƒ[ tâ‚ ] âˆƒ[ tâ‚‚ ]
    t â‰ˆ (âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚) Ã—
    Î“ âŠ¢ eâ‚ âˆ¶ tâ‚ Ã—
    Î“ âŠ¢ eâ‚‚ âˆ¶ tâ‚‚ â‹¯â‚› â¦… eâ‚ â¦†â‚›
invert-âŠ¢,' (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚) =  _ ,  _ ,  â‰ˆ-refl ,  âŠ¢eâ‚ , âŠ¢eâ‚‚    
invert-âŠ¢,' {tâ‚‚ = tâ‚‚} (âŠ¢â‰ˆ tâ‰ˆt' âŠ¢e) with invert-âŠ¢,' {tâ‚‚ = tâ‚‚} âŠ¢e
... |  tâ‚ ,  tâ‚‚ ,  t'â‰ˆâˆ€[tâ‚]tâ‚‚ ,  âŠ¢tâ‚ , âŠ¢e     =  tâ‚ ,  tâ‚‚ ,  â‰ˆ-trans (â‰ˆ-sym tâ‰ˆt') t'â‰ˆâˆ€[tâ‚]tâ‚‚ ,  âŠ¢tâ‚ , âŠ¢e    

invert-âŠ¢, : âˆ€ {eâ‚ : S âŠ¢ ğ•–} {tâ‚‚ : (ğ•– âˆ· S) âŠ¢ ğ•–} â†’
  Î“ âŠ¢ (eâ‚ `, eâ‚‚) âˆ¶ âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚ â†’
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ]
      tâ‚ â‰ˆ tâ‚' Ã—
      tâ‚‚ â‰ˆ tâ‚‚' Ã—
      Î“ âŠ¢ eâ‚ âˆ¶ tâ‚' Ã—
      Î“ âŠ¢ eâ‚‚ âˆ¶ tâ‚‚' â‹¯â‚› â¦… eâ‚ â¦†â‚›
invert-âŠ¢, {tâ‚‚ = tâ‚‚} âŠ¢e
 with invert-âŠ¢,' {tâ‚‚ = tâ‚‚} âŠ¢e
... |  tâ‚' ,  tâ‚‚' ,  eq ,  âŠ¢eâ‚ , âŠ¢eâ‚‚    
 with invert-â‰ˆ-âˆƒ eq
... |  tâ‚â‰ˆtâ‚' , tâ‚‚â‰ˆtâ‚‚' 
 =  tâ‚' ,  tâ‚‚' ,  tâ‚â‰ˆtâ‚' ,  tâ‚‚â‰ˆtâ‚‚' ,  âŠ¢eâ‚ , âŠ¢eâ‚‚     

--------------------------------------------------------------------------------

-- Inversion for equality terms

â†ª-â‰¡-shape :
  (eâ‚ `â‰¡ eâ‚‚) â†ª t â†’ 
  âˆƒ[ eâ‚' ] âˆƒ[ eâ‚‚' ] t â‰¡ (eâ‚' `â‰¡ eâ‚‚') Ã— (eâ‚ â†ª* eâ‚') Ã— (eâ‚‚ â†ª* eâ‚‚')
â†ª-â‰¡-shape (Î¾-â‰¡â‚ p) =  _ ,  _ ,  refl ,  â†ª*-step p â†ª*-refl , â†ª*-refl    
â†ª-â‰¡-shape (Î¾-â‰¡â‚‚ p) =  _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-step p â†ª*-refl    

â†ª*-â‰¡-shape :
  (eâ‚ `â‰¡ eâ‚‚) â†ª* t â†’ 
  âˆƒ[ eâ‚' ] âˆƒ[ eâ‚‚' ] t â‰¡ (eâ‚' `â‰¡ eâ‚‚') Ã— (eâ‚ â†ª* eâ‚') Ã— (eâ‚‚ â†ª* eâ‚‚')
â†ª*-â‰¡-shape â†ª*-refl =  _ ,  _ ,  refl ,  â†ª*-refl , â†ª*-refl    
â†ª*-â‰¡-shape (â†ª*-step x p)
 with â†ª-â‰¡-shape x
... |  eâ‚ ,  eâ‚‚ ,  refl ,  p' , q'    
 with â†ª*-â‰¡-shape p
... |  eâ‚' ,  eâ‚‚' ,  eq' ,  p'' , q''    
 =  _ ,  _ ,  eq' ,  â†ª*-trans p' p'' , â†ª*-trans q' q''    

invert-â‰ˆ-â‰¡ :
  (eâ‚ `â‰¡ eâ‚‚) â‰ˆ (eâ‚' `â‰¡ eâ‚‚') â†’
  (eâ‚ â‰ˆ eâ‚') Ã— (eâ‚‚ â‰ˆ eâ‚‚')
invert-â‰ˆ-â‰¡ (mk-â‰ˆ t tâ‚â†ª*t tâ‚‚â†ª*t)
 with â†ª*-â‰¡-shape tâ‚â†ª*t                           | â†ª*-â‰¡-shape tâ‚‚â†ª*t
... |  eâ‚' ,  eâ‚‚' ,  refl ,  p' , q'     |  eâ‚'' ,  eâ‚‚'' ,  refl ,  p'' , q''    
 =  mk-â‰ˆ eâ‚' p' p'' , mk-â‰ˆ eâ‚‚' q' q'' 

invert-âŠ¢refl' :
  Î“ âŠ¢ `refl âˆ¶ t â†’
  âˆƒ[ eâ‚ ] âˆƒ[ eâ‚‚ ] t â‰ˆ (eâ‚ `â‰¡ eâ‚‚) Ã— eâ‚ â‰ˆ eâ‚‚
invert-âŠ¢refl' (âŠ¢â‰ˆ t'â‰ˆt âŠ¢e) with invert-âŠ¢refl' âŠ¢e
... |  eâ‚ ,  eâ‚‚ ,  t'â‰ˆ[eâ‚â‰¡eâ‚‚] , p    =  eâ‚ ,  eâ‚‚ ,  â‰ˆ-trans (â‰ˆ-sym t'â‰ˆt) t'â‰ˆ[eâ‚â‰¡eâ‚‚] , p   
invert-âŠ¢refl' (âŠ¢refl âŠ¢e) =  _ ,  _ ,  â‰ˆ-refl , â‰ˆ-refl   

invert-âŠ¢refl :
  Î“ âŠ¢ `refl âˆ¶ (eâ‚ `â‰¡ eâ‚‚) â†’
  eâ‚ â‰ˆ eâ‚‚
invert-âŠ¢refl âŠ¢e
 with invert-âŠ¢refl' âŠ¢e
... |  eâ‚' ,  eâ‚‚' ,  eq , eâ‚'â‰ˆeâ‚‚'   
 with invert-â‰ˆ-â‰¡ eq
... |  eâ‚â‰ˆeâ‚' , eâ‚‚â‰ˆeâ‚‚'  = â‰ˆ-trans eâ‚â‰ˆeâ‚' (â‰ˆ-trans eâ‚'â‰ˆeâ‚‚' (â‰ˆ-sym eâ‚‚â‰ˆeâ‚‚'))

--------------------------------------------------------------------------------

_âŠ¢â‹¯_ :
  âˆ€ {_âˆ‹/âŠ¢_ : VarScoped} â¦ƒ K : Kit _âˆ‹/âŠ¢_ â¦„
    â¦ƒ W : KitT K â¦„ â¦ƒ Câ‚ : ComposeKit K Káµ£ K â¦„ â¦ƒ Câ‚‚ : ComposeKit K K K â¦„
    â¦ƒ TK : TypingKit K W Câ‚ Câ‚‚ â¦„
    â¦ƒ Câ‚„ : ComposeKit K Kâ‚› Kâ‚› â¦„
    {e : Sâ‚ âŠ¢ s} {t : Sâ‚ âˆ¶âŠ¢ s} {Ï• : Sâ‚ â€“[ K ]â†’ Sâ‚‚} â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âˆ‹*/âŠ¢*[ TK ] Ï• âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
âŠ¢` âˆ‹x âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âˆ€ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
âŠ¢Î» âŠ¢tâ‚ âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î» (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢Â· {eâ‚ = eâ‚} {tâ‚‚ = tâ‚‚} {eâ‚‚ = eâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  subst (Î“â‚‚ âŠ¢ (eâ‚ â‹¯ Ï•) Â· (eâ‚‚ â‹¯ Ï•) âˆ¶_)
        (sym (dist-â¦…â¦†-â‹¯ tâ‚‚ eâ‚‚ Ï•))
        (âŠ¢Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢âˆƒ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âˆƒ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢, {eâ‚ = eâ‚} {eâ‚‚ = eâ‚‚} {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  âŠ¢, (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•)
     (subst (Î“â‚‚ âŠ¢ (eâ‚‚ â‹¯ Ï•) âˆ¶_)
            (dist-â¦…â¦†-â‹¯ tâ‚‚ eâ‚ Ï•)
            (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢projâ‚ âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢projâ‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢projâ‚‚ {e = e} {tâ‚‚ = tâ‚‚} âŠ¢e) âŠ¢Ï• =
  subst (Î“â‚‚ âŠ¢ `projâ‚‚ (e â‹¯ Ï•) âˆ¶_)
        (sym (dist-â¦…â¦†-â‹¯ tâ‚‚ (`projâ‚ e) Ï•))
        (âŠ¢projâ‚‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢â‰¡ âŠ¢eâ‚ âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â‰¡ (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
âŠ¢refl âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢refl (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢J {t' = t'} {uâ‚ = uâ‚} {uâ‚‚ = uâ‚‚} {eâ‚ = eâ‚} {eâ‚‚ = eâ‚‚} {t = t} âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  subst (Î“â‚‚ âŠ¢ `J (t â‹¯ (Ï• â†‘ _)) (eâ‚ â‹¯ Ï•) (eâ‚‚ â‹¯ Ï•) âˆ¶_)
        (sym (dist-â¦…â¦†-â‹¯ t uâ‚‚ Ï•))
        (âŠ¢J (âŠ¢t âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
            (âŠ¢uâ‚ âŠ¢â‹¯ âŠ¢Ï•)
            (âŠ¢uâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
            (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•)
            (subst (Î“â‚‚ âŠ¢ (eâ‚‚ â‹¯ Ï•) âˆ¶_)
                   (dist-â¦…â¦†-â‹¯ t uâ‚ Ï•)
                   (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•) ))

âŠ¢Set âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Set
âŠ¢â‰ˆ tâ‰ˆt' âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â‰ˆ (â‰ˆ-â‹¯â‚– tâ‰ˆt') (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)

open TypingTraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

--------------------------------------------------------------------------------

subject-reduction : âˆ€ {Î“ : Ctx S} â†’
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (âŠ¢Î» âŠ¢t âŠ¢e)   (Î¾-Î» eâ†ªe')    = âŠ¢Î» âŠ¢t (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚) Î²-Î»           with invert-âŠ¢Î» âŠ¢eâ‚
...                                          |  tâ‚' ,  tâ‚‚' ,  tâ‚â‰ˆtâ‚' ,  tâ‚‚â‰ˆtâ‚‚' ,  âŠ¢tâ‚' , âŠ¢eâ‚'     
                                             = âŠ¢â‰ˆ (â‰ˆ-sym tâ‚‚â‰ˆtâ‚‚') âŠ¢eâ‚' âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢â‰ˆ tâ‚â‰ˆtâ‚' âŠ¢eâ‚‚ â¦†â‚›
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢â‰ˆ (â‰ˆ-â‹¯ {e = tâ‚‚} â‰ˆ-refl (â‰ˆâ†’â‰ˆÏƒ (â‰ˆ-sym (â†ªâ†’â‰ˆ eâ‚‚â†ªeâ‚‚'))))
                                                            (âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚'))
subject-reduction (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = âŠ¢âˆ€ (subject-reduction âŠ¢tâ‚ tâ‚â†ªtâ‚') (â‰ˆ-Î“-âŠ¢â‚ (â†ªâ†’â‰ˆ tâ‚â†ªtâ‚') âŠ¢tâ‚‚)
subject-reduction (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = âŠ¢âˆ€ âŠ¢tâ‚ (subject-reduction âŠ¢tâ‚‚ tâ‚‚â†ªtâ‚‚')
subject-reduction (âŠ¢â‰ˆ tâ‰ˆt' âŠ¢e) eâ†ªe'          = âŠ¢â‰ˆ tâ‰ˆt' (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢âˆƒ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-âˆƒâ‚ tâ‚â†ªtâ‚') = âŠ¢âˆƒ (subject-reduction âŠ¢tâ‚ tâ‚â†ªtâ‚') (â‰ˆ-Î“-âŠ¢â‚ (â†ªâ†’â‰ˆ tâ‚â†ªtâ‚') âŠ¢tâ‚‚)
subject-reduction (âŠ¢âˆƒ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-âˆƒâ‚‚ tâ‚‚â†ªtâ‚‚') = âŠ¢âˆƒ âŠ¢tâ‚ (subject-reduction âŠ¢tâ‚‚ tâ‚‚â†ªtâ‚‚')
subject-reduction (âŠ¢, {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-,â‚ eâ‚â†ªeâ‚') = âŠ¢, (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚')
                                                            (âŠ¢â‰ˆ (â‰ˆ-â‹¯ {e = tâ‚‚} â‰ˆ-refl (â‰ˆâ†’â‰ˆÏƒ (â†ªâ†’â‰ˆ eâ‚â†ªeâ‚'))) âŠ¢eâ‚‚)
subject-reduction (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-,â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢, âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
subject-reduction (âŠ¢projâ‚ âŠ¢e) Î²-projâ‚ with invert-âŠ¢, âŠ¢e
... |  tâ‚' ,  tâ‚‚' ,  tâ‚â‰ˆtâ‚' ,  tâ‚‚â‰ˆtâ‚‚' ,  âŠ¢eâ‚ , âŠ¢eâ‚‚      = âŠ¢â‰ˆ (â‰ˆ-sym tâ‚â‰ˆtâ‚') âŠ¢eâ‚
subject-reduction (âŠ¢projâ‚ âŠ¢e) (Î¾-projâ‚ eâ†ªe') = âŠ¢projâ‚ (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢projâ‚‚ âŠ¢e) Î²-projâ‚‚ with invert-âŠ¢, âŠ¢e
... |  tâ‚' ,  tâ‚‚' ,  tâ‚â‰ˆtâ‚' ,  tâ‚‚â‰ˆtâ‚‚' ,  âŠ¢eâ‚ , âŠ¢eâ‚‚      = âŠ¢â‰ˆ (â‰ˆ-â‹¯ (â‰ˆ-sym tâ‚‚â‰ˆtâ‚‚') (â‰ˆâ†’â‰ˆÏƒ (â‰ˆ-sym (â†ªâ†’â‰ˆ Î²-projâ‚))))
                                                             âŠ¢eâ‚‚
subject-reduction (âŠ¢projâ‚‚ {tâ‚‚ = tâ‚‚} âŠ¢e) (Î¾-projâ‚‚ eâ†ªe') = âŠ¢â‰ˆ (â‰ˆ-â‹¯ {e = tâ‚‚} â‰ˆ-refl (â‰ˆâ†’â‰ˆÏƒ (â‰ˆ-sym (â†ªâ†’â‰ˆ (Î¾-projâ‚ eâ†ªe')))))
                                                            (âŠ¢projâ‚‚ (subject-reduction âŠ¢e eâ†ªe'))
subject-reduction (âŠ¢â‰¡ âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-â‰¡â‚ eâ‚â†ªeâ‚') = âŠ¢â‰¡ (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢â‰¡ âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-â‰¡â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢â‰¡ âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
subject-reduction (âŠ¢J {t = t} âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) Î²-J with invert-âŠ¢refl âŠ¢eâ‚
... | eâ‚'â‰ˆeâ‚‚' =
  âŠ¢â‰ˆ (â‰ˆ-â‹¯ {e = t} â‰ˆ-refl (â‰ˆâ†’â‰ˆÏƒ eâ‚'â‰ˆeâ‚‚')) âŠ¢eâ‚‚
subject-reduction (âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Jâ‚ tâ†ªt') =
  âŠ¢â‰ˆ (â‰ˆ-â‹¯ (â‰ˆ-sym (â†ªâ†’â‰ˆ tâ†ªt')) â‰ˆÏƒ-refl) (âŠ¢J (subject-reduction âŠ¢t tâ†ªt') âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ (âŠ¢â‰ˆ (â‰ˆ-â‹¯ (â†ªâ†’â‰ˆ tâ†ªt') â‰ˆÏƒ-refl) âŠ¢eâ‚‚))
subject-reduction (âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Jâ‚‚ eâ‚â†ªeâ‚') = âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Jâ‚ƒ eâ‚‚â†ªeâ‚‚') = âŠ¢J âŠ¢t âŠ¢uâ‚ âŠ¢uâ‚‚ âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
