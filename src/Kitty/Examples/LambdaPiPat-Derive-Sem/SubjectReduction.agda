module Kitty.Examples.LambdaPiPat-Derive-Sem.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; cong-app; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Kitty.Examples.LambdaPiPat-Derive-Sem.Definitions
open import Kitty.Examples.LambdaPiPat-Derive-Sem.Confluence
open import Kitty.Util.Closures
open import Kitty.Semantics.ISemantics compose-traversal kit-type
open import Kitty.Typing.IKit compose-traversal kit-type ctx-repr iterms
open IKit â¦ƒ â€¦ â¦„
open import Function using () renaming (_âˆ‹_ to _by_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _Ã—_ ; _,_; projâ‚; projâ‚‚)

open ReflexiveTransitiveClosure using (refl; step)

--------------------------------------------------------------------------------

_âŠ¢â‹¯_ :
  âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {e : Âµâ‚ âŠ¢ M} {t : Âµâ‚ âˆ¶âŠ¢ M} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âˆ‹*/âŠ¢*[ IK ] Ï• âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
âŠ¢` âˆ‹x      âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
âŠ¢Î» âŠ¢tâ‚ âŠ¢e  âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î» (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âˆ€ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {e = eâ‚ Â· eâ‚‚} {Ï• = Ï•} (âŠ¢Â· {tâ‚ = tâ‚} {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  Î“â‚‚ âŠ¢ eâ‚ Â· eâ‚‚ â‹¯ Ï• âˆ¶ tâ‚‚ â‹¯â‚› â¦… eâ‚‚ â¦†â‚› â‹¯ Ï•
    by subst (Î“â‚‚ âŠ¢ (eâ‚ Â· eâ‚‚) â‹¯ Ï• âˆ¶_)
             ((tâ‚‚ â‹¯ (Ï• â†‘ ğ•–)) â‹¯â‚› â¦… eâ‚‚ â‹¯ Ï• â¦†â‚› â‰¡âŸ¨ sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚‚ eâ‚‚ Ï•) âŸ©
              tâ‚‚ â‹¯â‚› â¦… eâ‚‚ â¦†â‚› â‹¯ Ï•             âˆ)
             (âŠ¢Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢â˜…         âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â˜…
âŠ¢â‰£ tâ‰£t' âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â‰£ (â‰£-â‹¯â‚ tâ‰£t') (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
âŠ¢Î£ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î£ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢, {eâ‚ = eâ‚} {tâ‚} {tâ‚‚} {eâ‚‚} âŠ¢tâ‚ âŠ¢tâ‚‚) âŠ¢Ï• =
  âŠ¢, (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (subst (Î“â‚‚ âŠ¢ eâ‚‚ â‹¯ Ï• âˆ¶_)
                        (tâ‚‚ â‹¯â‚› â¦… eâ‚ â¦†â‚› â‹¯ Ï•         â‰¡âŸ¨ dist-â¦…â¦†â‚›-â‹¯ tâ‚‚ eâ‚ Ï• âŸ©
                         tâ‚‚ â‹¯ Ï• â†‘ ğ•– â‹¯â‚› â¦… eâ‚ â‹¯ Ï• â¦†â‚› âˆ)
                        (âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢projâ‚ âŠ¢t  âŠ¢â‹¯ âŠ¢Ï• = âŠ¢projâ‚ (âŠ¢t âŠ¢â‹¯ âŠ¢Ï•)
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢projâ‚‚ {e = e} {tâ‚} {tâ‚‚} âŠ¢t) âŠ¢Ï• =
  Î“â‚‚ âŠ¢ `projâ‚‚ e â‹¯ Ï• âˆ¶ tâ‚‚ â‹¯â‚› â¦… `projâ‚ e â¦†â‚› â‹¯ Ï•
    by subst (Î“â‚‚ âŠ¢ `projâ‚‚ e â‹¯ Ï• âˆ¶_)
             (tâ‚‚ â‹¯ Ï• â†‘ ğ•– â‹¯â‚› â¦… `projâ‚ e â‹¯ Ï• â¦†â‚› â‰¡âŸ¨ sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚‚ (`projâ‚ e) Ï•) âŸ©
              tâ‚‚ â‹¯ â¦… `projâ‚ e â¦†â‚› â‹¯ Ï•          âˆ)
             (âŠ¢projâ‚‚ (âŠ¢t âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢tt        âŠ¢â‹¯ âŠ¢Ï• = âŠ¢tt
âŠ¢âŠ¤         âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âŠ¤

open ITraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

-- --------------------------------------------------------------------------------

â‰£*-pres : âˆ€ {Âµ} {Î“â‚ Î“â‚‚ : Ctx Âµ} {M} {e : Âµ âŠ¢ M} {t : Âµ âŠ¢ M} â†’
  Î“â‚ â‰£* Î“â‚‚ â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âŠ¢ e âˆ¶ t
â‰£*-pres {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} {M = ğ•–} Î“â‰£ (âŠ¢` {x = x} refl) = âŠ¢â‰£ (â‰£-sym (â‰£*-wk-telescope {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} (Î“â‰£ x))) (âŠ¢` refl)
â‰£*-pres Î“â‰£ (âŠ¢Î» âŠ¢tâ‚ âŠ¢e)  = âŠ¢Î» (â‰£*-pres Î“â‰£ âŠ¢tâ‚) (â‰£*-pres (â‰£*-â†‘ Î“â‰£) âŠ¢e)
â‰£*-pres Î“â‰£ (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚) = âŠ¢âˆ€ (â‰£*-pres Î“â‰£ âŠ¢tâ‚) (â‰£*-pres (â‰£*-â†‘ Î“â‰£) âŠ¢tâ‚‚)
â‰£*-pres Î“â‰£ (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚) = âŠ¢Â· (â‰£*-pres Î“â‰£ âŠ¢eâ‚) (â‰£*-pres Î“â‰£ âŠ¢eâ‚‚)
â‰£*-pres Î“â‰£ âŠ¢â˜…           = âŠ¢â˜…
â‰£*-pres Î“â‰£ (âŠ¢â‰£ tâ‰£t' âŠ¢e) = âŠ¢â‰£ tâ‰£t' (â‰£*-pres Î“â‰£ âŠ¢e)
â‰£*-pres Î“â‰£ (âŠ¢Î£ âŠ¢tâ‚ âŠ¢tâ‚‚) = âŠ¢Î£ (â‰£*-pres Î“â‰£ âŠ¢tâ‚) (â‰£*-pres (â‰£*-â†‘ Î“â‰£) âŠ¢tâ‚‚)
â‰£*-pres Î“â‰£ (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚) = âŠ¢, (â‰£*-pres Î“â‰£ âŠ¢eâ‚) (â‰£*-pres Î“â‰£ âŠ¢eâ‚‚)
â‰£*-pres Î“â‰£ (âŠ¢projâ‚ âŠ¢e)  = âŠ¢projâ‚ (â‰£*-pres Î“â‰£ âŠ¢e)
â‰£*-pres Î“â‰£ (âŠ¢projâ‚‚ âŠ¢e)  = âŠ¢projâ‚‚ (â‰£*-pres Î“â‰£ âŠ¢e)
â‰£*-pres Î“â‰£ âŠ¢tt          = âŠ¢tt
â‰£*-pres Î“â‰£ âŠ¢âŠ¤           = âŠ¢âŠ¤

--------------------------------------------------------------------------------

open â†ª-WithConfluence confluence public

invert-âŠ¢Î» : âˆ€ {Âµ} {Î“ : Ctx Âµ} {e : (Âµ â–· ğ•–) âŠ¢ ğ•–} {t : Âµ âŠ¢ ğ•–} â†’
    Î“ âŠ¢ Î»x e âˆ¶ t â†’
    âˆƒ[ tâ‚ ] âˆƒ[ tâ‚‚ ]
      t â‰£ âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ Ã—
      Î“ âŠ¢ tâ‚ âˆ¶ â˜… Ã—
      Î“ â–¶ tâ‚ âŠ¢ e âˆ¶ tâ‚‚
invert-âŠ¢Î» (âŠ¢Î» âŠ¢tâ‚ âŠ¢e) = _ , _ , â‰£-refl , âŠ¢tâ‚ , âŠ¢e
invert-âŠ¢Î» (âŠ¢â‰£ tâ‰£t' âŠ¢e) with invert-âŠ¢Î» âŠ¢e
... | tâ‚ , tâ‚‚ , t'â‰£âˆ€[tâ‚]tâ‚‚ , âŠ¢tâ‚ , âŠ¢e = tâ‚ , tâ‚‚ , â‰£-trans (â‰£-sym tâ‰£t') t'â‰£âˆ€[tâ‚]tâ‚‚ , âŠ¢tâ‚ , âŠ¢e

invert-âŠ¢, : âˆ€ {Âµ} {Î“ : Ctx Âµ} {eâ‚ eâ‚‚ t : Âµ âŠ¢ ğ•–} â†’
    Î“ âŠ¢ eâ‚ , eâ‚‚ âˆ¶ t â†’
    âˆƒ[ tâ‚ ] âˆƒ[ tâ‚‚ ]
      t â‰£ Î£[xâˆ¶ tâ‚ ] tâ‚‚ Ã—
      Î“ âŠ¢ eâ‚ âˆ¶ tâ‚ Ã—
      Î“ âŠ¢ eâ‚‚ âˆ¶ tâ‚‚ â‹¯ â¦… eâ‚ â¦†â‚›
invert-âŠ¢, (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚) = _ , _ , â‰£-refl , âŠ¢eâ‚ , âŠ¢eâ‚‚
invert-âŠ¢, (âŠ¢â‰£ tâ‰£t' âŠ¢e) with invert-âŠ¢, âŠ¢e
... | tâ‚ , tâ‚‚ , t'â‰£Î£[tâ‚]tâ‚‚ , âŠ¢eâ‚ , âŠ¢eâ‚‚ = tâ‚ , tâ‚‚ , â‰£-trans (â‰£-sym tâ‰£t') t'â‰£Î£[tâ‚]tâ‚‚ , âŠ¢eâ‚ , âŠ¢eâ‚‚

â†ª-âˆ€-shape :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª-âˆ€-shape (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = _ , _ , refl , â†ª*-embed tâ‚â†ªtâ‚' , refl
â†ª-âˆ€-shape (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = _ , _ , refl , refl , â†ª*-embed tâ‚‚â†ªtâ‚‚'

â†ª*-âˆ€-shape :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª* t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª*-âˆ€-shape refl = _ , _ , refl , refl , refl
â†ª*-âˆ€-shape (step âˆ€â†ªt tâ†ª*t')
  with â†ª-âˆ€-shape âˆ€â†ªt
...  | tâ‚' , tâ‚‚' , refl , tâ‚â†ª*tâ‚' , tâ‚‚â†ª*tâ‚‚'
  with â†ª*-âˆ€-shape tâ†ª*t'
...  | tâ‚'' , tâ‚‚'' , refl , tâ‚'â†ª*tâ‚'' , tâ‚‚'â†ª*tâ‚‚''
  = tâ‚'' , tâ‚‚'' , refl , â†ª*-trans tâ‚â†ª*tâ‚' tâ‚'â†ª*tâ‚'' , â†ª*-trans tâ‚‚â†ª*tâ‚‚' tâ‚‚'â†ª*tâ‚‚''

â†ª-Î£-shape :
  Î£[xâˆ¶ tâ‚ ] tâ‚‚ â†ª t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ Î£[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª-Î£-shape (Î¾-Î£â‚ tâ‚â†ªtâ‚') = _ , _ , refl , â†ª*-embed tâ‚â†ªtâ‚' , refl
â†ª-Î£-shape (Î¾-Î£â‚‚ tâ‚‚â†ªtâ‚‚') = _ , _ , refl , refl , â†ª*-embed tâ‚‚â†ªtâ‚‚'

â†ª*-Î£-shape :
  Î£[xâˆ¶ tâ‚ ] tâ‚‚ â†ª* t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ Î£[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª*-Î£-shape refl = _ , _ , refl , refl , refl
â†ª*-Î£-shape (step Î£â†ªt tâ†ª*t')
  with â†ª-Î£-shape Î£â†ªt
...  | tâ‚' , tâ‚‚' , refl , tâ‚â†ª*tâ‚' , tâ‚‚â†ª*tâ‚‚'
  with â†ª*-Î£-shape tâ†ª*t'
...  | tâ‚'' , tâ‚‚'' , refl , tâ‚'â†ª*tâ‚'' , tâ‚‚'â†ª*tâ‚‚''
  = tâ‚'' , tâ‚‚'' , refl , â†ª*-trans tâ‚â†ª*tâ‚' tâ‚'â†ª*tâ‚'' , â†ª*-trans tâ‚‚â†ª*tâ‚‚' tâ‚‚'â†ª*tâ‚‚''

invert-â‰£-Î» :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â‰£ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' â†’
  tâ‚ â‰£ tâ‚' Ã— tâ‚‚ â‰£ tâ‚‚'
invert-â‰£-Î» (mk-â‰£ t âˆ€â‚â†ª*t âˆ€â‚‚â†ª*t)
  with â†ª*-âˆ€-shape âˆ€â‚â†ª*t                | â†ª*-âˆ€-shape âˆ€â‚‚â†ª*t
... | Tâ‚ , Tâ‚‚ , refl , tâ‚â†ª*Tâ‚ , tâ‚‚â†ª*Tâ‚‚ | .Tâ‚ , .Tâ‚‚ , refl , tâ‚'â†ª*Tâ‚ , tâ‚‚'â†ª*Tâ‚‚
  = mk-â‰£ Tâ‚ tâ‚â†ª*Tâ‚ tâ‚'â†ª*Tâ‚ , mk-â‰£ Tâ‚‚ tâ‚‚â†ª*Tâ‚‚ tâ‚‚'â†ª*Tâ‚‚

invert-â‰£-, :
  Î£[xâˆ¶ tâ‚ ] tâ‚‚ â‰£ Î£[xâˆ¶ tâ‚' ] tâ‚‚' â†’
  tâ‚ â‰£ tâ‚' Ã— tâ‚‚ â‰£ tâ‚‚'
invert-â‰£-, (mk-â‰£ t Î£â‚â†ª*t Î£â‚‚â†ª*t)
  with â†ª*-Î£-shape Î£â‚â†ª*t                | â†ª*-Î£-shape Î£â‚‚â†ª*t
... | Tâ‚ , Tâ‚‚ , refl , tâ‚â†ª*Tâ‚ , tâ‚‚â†ª*Tâ‚‚ | .Tâ‚ , .Tâ‚‚ , refl , tâ‚'â†ª*Tâ‚ , tâ‚‚'â†ª*Tâ‚‚
  = mk-â‰£ Tâ‚ tâ‚â†ª*Tâ‚ tâ‚'â†ª*Tâ‚ , mk-â‰£ Tâ‚‚ tâ‚‚â†ª*Tâ‚‚ tâ‚‚'â†ª*Tâ‚‚

--------------------------------------------------------------------------------

subject-reduction :
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (âŠ¢Î» âŠ¢t âŠ¢e)             (Î¾-Î» eâ†ªe')    = âŠ¢Î» âŠ¢t (subject-reduction âŠ¢e eâ†ªe')
subject-reduction {Î“ = Î“} (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚)   (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = âŠ¢âˆ€ (subject-reduction âŠ¢tâ‚ tâ‚â†ªtâ‚')
                                                            (â‰£*-pres (â‰£*-ext (â‰£*-refl {Î“ = Î“}) (â‰£-â†ª tâ‚â†ªtâ‚')) âŠ¢tâ‚‚)
subject-reduction (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚)           (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = âŠ¢âˆ€ âŠ¢tâ‚ (subject-reduction âŠ¢tâ‚‚ tâ‚‚â†ªtâ‚‚')
subject-reduction (âŠ¢Â· {eâ‚‚ = eâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) Î²-Î»           with invert-âŠ¢Î» âŠ¢eâ‚
...                                                       | tâ‚ , tâ‚‚ , âˆ€â‰£âˆ€ , âŠ¢tâ‚ , âŠ¢eâ‚
                                                       with invert-â‰£-Î» âˆ€â‰£âˆ€
...                                                       | tâ‚â‰£tâ‚' , tâ‚‚â‰£tâ‚‚'
                                                       =  âŠ¢â‰£ (â‰£-sym (â‰£-â‹¯â‚› tâ‚‚â‰£tâ‚‚' (â‰£Ïƒ-refl {Ïƒ = â¦… eâ‚‚ â¦†â‚›})))
                                                             (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢â‰£ tâ‚â‰£tâ‚' âŠ¢eâ‚‚ â¦†â‚›)
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)           (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢â‰£ (â‰£-â‹¯â‚› (â‰£-refl {t = tâ‚‚}) â‰£Ïƒ-â¦… â‰£-â†© eâ‚‚â†ªeâ‚‚' â¦†)
                                                            (âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚'))
subject-reduction (âŠ¢â‰£ tâ‰£t' âŠ¢e)           eâ†ªe'          = âŠ¢â‰£ tâ‰£t' (subject-reduction âŠ¢e eâ†ªe')
subject-reduction {Î“ = Î“} (âŠ¢Î£ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-Î£â‚ tâ‚â†ªtâ‚') = âŠ¢Î£ (subject-reduction âŠ¢tâ‚ tâ‚â†ªtâ‚')
                                                          (â‰£*-pres (â‰£*-ext (â‰£*-refl {Î“ = Î“}) (â‰£-â†ª tâ‚â†ªtâ‚')) âŠ¢tâ‚‚)
subject-reduction (âŠ¢Î£ âŠ¢tâ‚ âŠ¢tâ‚‚) (Î¾-Î£â‚‚ tâ‚‚â†ªtâ‚‚') = âŠ¢Î£ âŠ¢tâ‚ (subject-reduction âŠ¢tâ‚‚ tâ‚‚â†ªtâ‚‚')
subject-reduction {Î“ = Î“} (âŠ¢, {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-,â‚ eâ‚â†ªeâ‚') =
  âŠ¢, (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚')
     (âŠ¢â‰£ (â‰£-â‹¯â‚› (â‰£-refl {t = tâ‚‚}) â‰£Ïƒ-â¦… â‰£-â†ª eâ‚â†ªeâ‚' â¦†) âŠ¢eâ‚‚)
subject-reduction (âŠ¢, âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-,â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢, âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
subject-reduction (âŠ¢projâ‚ âŠ¢e) Î²-projâ‚
 with invert-âŠ¢, âŠ¢e
... | tâ‚ , tâ‚‚ , Î£â‰£Î£ , âŠ¢eâ‚ , âŠ¢eâ‚‚
 with invert-â‰£-, Î£â‰£Î£
... | tâ‚â‰£tâ‚' , tâ‚‚â‰£tâ‚‚'
  = âŠ¢â‰£ (â‰£-sym tâ‚â‰£tâ‚') âŠ¢eâ‚
subject-reduction (âŠ¢projâ‚‚ âŠ¢e) Î²-projâ‚‚
 with invert-âŠ¢, âŠ¢e
... | tâ‚ , tâ‚‚ , Î£â‰£Î£ , âŠ¢eâ‚ , âŠ¢eâ‚‚
 with invert-â‰£-, Î£â‰£Î£
... | tâ‚â‰£tâ‚' , tâ‚‚â‰£tâ‚‚'
  = âŠ¢â‰£ (â‰£-â‹¯â‚› (â‰£-sym tâ‚‚â‰£tâ‚‚') â‰£Ïƒ-â¦… â‰£-â†© Î²-projâ‚ â¦†) âŠ¢eâ‚‚
subject-reduction (âŠ¢projâ‚ âŠ¢e) (Î¾-projâ‚ eâ†ªe') = âŠ¢projâ‚ (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢projâ‚‚ {tâ‚‚ = tâ‚‚} âŠ¢e) (Î¾-projâ‚‚ eâ†ªe') = âŠ¢â‰£ (â‰£-â‹¯â‚› (â‰£-refl {t = tâ‚‚}) â‰£Ïƒ-â¦… â‰£-â†© (Î¾-projâ‚ eâ†ªe') â¦†) (âŠ¢projâ‚‚ (subject-reduction âŠ¢e eâ†ªe'))
