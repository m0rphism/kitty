module Kitty.Examples.LambdaPi-Derive-Sem.Confluence where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Kitty.Examples.LambdaPi-Derive-Sem.Definitions
open import Kitty.Util.Closures

-- TODO
postulate 
  â‰¡á¶œ-cong-âŠ¢ : âˆ€ {Âµ M} {Î“â‚ Î“â‚‚ : Ctx Âµ} {e : Âµ âŠ¢ M} {t : Âµ âˆ¶âŠ¢ M} â†’ 
    Î“â‚ â‰¡á¶œ Î“â‚‚ â†’
    Î“â‚ âŠ¢ e âˆ¶ t â†’
    Î“â‚‚ âŠ¢ e âˆ¶ t

open import Kitty.Typing.ITerms compose-traversal kit-type ctx-repr

iterms : ITerms
iterms = record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢` ; â‰¡á¶œ-cong-âŠ¢ = â‰¡á¶œ-cong-âŠ¢ }

open import Kitty.Typing.IKit compose-traversal kit-type ctx-repr iterms
open IKit â¦ƒ â€¦ â¦„
open import Function using () renaming (_âˆ‹_ to _by_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Product using (âˆƒ-syntax; _Ã—_ ; _,_)

Î¾-Î»* :
  e â†ª* e' â†’
  Î»x e â†ª* Î»x e'
Î¾-Î»* = map-â†ª* Î¾-Î»

Î¾-âˆ€â‚* :
  tâ‚ â†ª* tâ‚' â†’
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª* âˆ€[xâˆ¶ tâ‚' ] tâ‚‚
Î¾-âˆ€â‚* = map-â†ª* Î¾-âˆ€â‚

Î¾-âˆ€â‚‚* :
  tâ‚‚ â†ª* tâ‚‚' â†’
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª* âˆ€[xâˆ¶ tâ‚ ] tâ‚‚'
Î¾-âˆ€â‚‚* = map-â†ª* Î¾-âˆ€â‚‚

Î¾-Â·â‚* :
  eâ‚ â†ª* eâ‚' â†’
  eâ‚ Â· eâ‚‚ â†ª* eâ‚' Â· eâ‚‚
Î¾-Â·â‚* = map-â†ª* Î¾-Â·â‚

Î¾-Â·â‚‚* :
  eâ‚‚ â†ª* eâ‚‚' â†’
  eâ‚ Â· eâ‚‚ â†ª* eâ‚ Â· eâ‚‚'
Î¾-Â·â‚‚* = map-â†ª* Î¾-Â·â‚‚

infix   3  _â†ªâ‚š_
data _â†ªâ‚š_ : Âµ âŠ¢ M â†’ Âµ âŠ¢ M â†’ Set where
  Î¾-` : âˆ€ {x : Âµ âˆ‹ m} â†’
    ` x â†ªâ‚š ` x
  Î²-Î» : âˆ€ {tâ‚ tâ‚' : (Âµ â–· ğ•–) âŠ¢ ğ•–} {tâ‚‚ tâ‚‚' : Âµ âŠ¢ ğ•–} â†’
    tâ‚ â†ªâ‚š tâ‚' â†’
    tâ‚‚ â†ªâ‚š tâ‚‚' â†’
    (Î»x tâ‚) Â· tâ‚‚ â†ªâ‚š tâ‚' â‹¯ â¦… tâ‚‚' â¦†â‚›
  Î¾-Î» :
    t â†ªâ‚š t' â†’
    Î»x t â†ªâ‚š Î»x t'
  Î¾-âˆ€ :
    tâ‚ â†ªâ‚š tâ‚' â†’
    tâ‚‚ â†ªâ‚š tâ‚‚' â†’
    âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ªâ‚š âˆ€[xâˆ¶ tâ‚' ] tâ‚‚'
  Î¾-Â· :
    tâ‚ â†ªâ‚š tâ‚' â†’
    tâ‚‚ â†ªâ‚š tâ‚‚' â†’
    tâ‚ Â· tâ‚‚ â†ªâ‚š tâ‚' Â· tâ‚‚'
  Î¾-â˜… :
    â˜… â†ªâ‚š (â˜… {Âµ = Âµ})

â†ªâ‚š-refl : t â†ªâ‚š t
â†ªâ‚š-refl {t = ` x}          = Î¾-`
â†ªâ‚š-refl {t = Î»x t}         = Î¾-Î» â†ªâ‚š-refl
â†ªâ‚š-refl {t = âˆ€[xâˆ¶ tâ‚ ] tâ‚‚} = Î¾-âˆ€ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = tâ‚ Â· tâ‚‚}      = Î¾-Â· â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = â˜…}            = Î¾-â˜…

open import Kitty.Semantics.ISemantics compose-traversal kit-type ctx-repr

semanticsâ‚š : Semantics
semanticsâ‚š = record { _â†ª_ = _â†ªâ‚š_ }

open Semantics semanticsâ‚š public using () renaming
  ( _â†ª*_ to _â†ªâ‚š*_
  ; â†ª*-trans to â†ªâ‚š*-trans
  ; _â†ªÏƒ_ to _â†ªâ‚šÏƒ_
  ; _â†ªÏƒ*_ to _â†ªâ‚šÏƒ*_
  ; _â†ª*Ïƒ_ to _â†ªâ‚š*Ïƒ_
  )

rsemanticsâ‚š : ReflexiveSemantics semanticsâ‚š
rsemanticsâ‚š = record { â†ª-refl = â†ªâ‚š-refl }

open ReflexiveTransitiveClosure using (refl; step)

open SemKit â¦ƒ â€¦ â¦„

â†ª-â‹¯ :
  âˆ€ â¦ƒ ğ•‚ : Kit â¦„
    â¦ƒ K : KitT ğ•‚ â¦„
    â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„
    â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    â¦ƒ SK : SemKit semanticsâ‚š ğ•‚ K Câ‚ Câ‚‚ â¦„
    {Âµâ‚ Âµâ‚‚ M} {t t' : Âµâ‚ âŠ¢ M} {Ï• Ï•' : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚}
  â†’ t â†ªâ‚š t'
  â†’ Ï• â‰¡Ï•/â†ªÏ• Ï•'
  â†’ t â‹¯ Ï• â†ªâ‚š t' â‹¯ Ï•'
â†ª-â‹¯ {Ï• = Ï•} {Ï•'} (Î¾-` {x = x}) Ï•â†ªÏ•' = â†ª/id' {Ï•â‚ = Ï•} {Ï•â‚‚ = Ï•'} (Ï•â†ªÏ•' x)
â†ª-â‹¯ {Ï• = Ï•} {Ï•'} (Î²-Î» {tâ‚' = tâ‚'} {tâ‚‚' = tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ï•â†ªÏ•' = subst (_ â†ªâ‚š_) (sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚' tâ‚‚' Ï•'))
                                                                              (Î²-Î» (â†ª-â‹¯ tâ‚â†ªâ‚štâ‚' (â‰¡Ï•/â†ªÏ•-â†‘ Ï•â†ªÏ•'))
                                                                                   (â†ª-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' Ï•â†ªÏ•'))
â†ª-â‹¯ (Î¾-Î» tâ†ªt')       Ï•â†ªÏ•' = Î¾-Î» (â†ª-â‹¯ tâ†ªt' (â‰¡Ï•/â†ªÏ•-â†‘ Ï•â†ªÏ•'))
â†ª-â‹¯ (Î¾-âˆ€ tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ï•â†ªÏ•' = Î¾-âˆ€ (â†ª-â‹¯ tâ‚â†ªâ‚štâ‚' Ï•â†ªÏ•') (â†ª-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' (â‰¡Ï•/â†ªÏ•-â†‘ Ï•â†ªÏ•'))
â†ª-â‹¯ (Î¾-Â· tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ï•â†ªÏ•' = Î¾-Â· (â†ª-â‹¯ tâ‚â†ªâ‚štâ‚' Ï•â†ªÏ•') (â†ª-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' Ï•â†ªÏ•')
â†ª-â‹¯ Î¾-â˜…                   Ï•â†ªÏ•' = Î¾-â˜…

sem-traversal : SemTraversal rsemanticsâ‚š
sem-traversal = record { â†ª-â‹¯ = â†ª-â‹¯ }

open SemTraversal sem-traversal renaming (â†ª-â‹¯â‚› to â†ªâ‚šÏƒ-â‹¯) hiding (â†ª-â‹¯)

module Semâ‚š where
  open Semantics semanticsâ‚š public
  open ReflexiveSemantics rsemanticsâ‚š public
  open SemTraversal sem-traversal public

-- Conversions between â†ª and â†ªâ‚š ------------------------------------------------

â†ªâ†’â†ªâ‚š : t â†ª t' â†’ t â†ªâ‚š t'
â†ªâ†’â†ªâ‚š Î²-Î»           = Î²-Î» â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Î» tâ†ªt')    = Î¾-Î» (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = Î¾-âˆ€ (â†ªâ†’â†ªâ‚š tâ‚â†ªtâ‚') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = Î¾-âˆ€ â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ‚‚â†ªtâ‚‚')
â†ªâ†’â†ªâ‚š (Î¾-Â·â‚ tâ‚â†ªtâ‚') = Î¾-Â· (â†ªâ†’â†ªâ‚š tâ‚â†ªtâ‚') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Â·â‚‚ tâ‚‚â†ªtâ‚‚') = Î¾-Â· â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ‚‚â†ªtâ‚‚')

â†ªâ‚šâ†’â†ª* : t â†ªâ‚š t' â†’ t â†ª* t'
â†ªâ‚šâ†’â†ª* Î¾-`                    = refl
â†ªâ‚šâ†’â†ª* (Î²-Î» {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚'') =
  ((Î»x tâ‚) Â· tâ‚‚)   â†ª*âŸ¨ Î¾-Â·â‚* (Î¾-Î»* (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚')) âŸ©
  ((Î»x tâ‚') Â· tâ‚‚)  â†ª*âŸ¨ Î¾-Â·â‚‚* (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚'') âŸ©
  ((Î»x tâ‚') Â· tâ‚‚') â†ªâŸ¨ Î²-Î» âŸ©
  (tâ‚' â‹¯ â¦… tâ‚‚' â¦†â‚›) â†ªâˆ
â†ªâ‚šâ†’â†ª* (Î¾-Î» tâ†ªâ‚št')            = Î¾-Î»* (â†ªâ‚šâ†’â†ª* tâ†ªâ‚št')
â†ªâ‚šâ†’â†ª* (Î¾-âˆ€ {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
  âˆ€[xâˆ¶ tâ‚  ] tâ‚‚  â†ª*âŸ¨ Î¾-âˆ€â‚* (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚') âŸ©
  âˆ€[xâˆ¶ tâ‚' ] tâ‚‚  â†ª*âŸ¨ Î¾-âˆ€â‚‚* (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚') âŸ©
  âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' â†ªâˆ
â†ªâ‚šâ†’â†ª* (Î¾-Â· {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
  tâ‚  Â· tâ‚‚  â†ª*âŸ¨ Î¾-Â·â‚* (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚') âŸ©
  tâ‚' Â· tâ‚‚  â†ª*âŸ¨ Î¾-Â·â‚‚* (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚') âŸ©
  tâ‚' Â· tâ‚‚' â†ªâˆ
â†ªâ‚šâ†’â†ª* Î¾-â˜…                    = refl

sem-trans : SemTrans semantics semanticsâ‚š
sem-trans = record { toâ‚š = â†ªâ†’â†ªâ‚š ; fromâ‚š = â†ªâ‚šâ†’â†ª* }

open SemTrans sem-trans public renaming (toâ‚š* to â†ª*â†’â†ªâ‚š*; fromâ‚š* to â†ªâ‚š*â†’â†ª*)
open SemTrans-â†ª-â‹¯ sem-traversal public

--------------------------------------------------------------------------------

diamondâ‚š :
  t â†ªâ‚š tâ‚ â†’
  t â†ªâ‚š tâ‚‚ â†’
  âˆƒ[ t' ] tâ‚ â†ªâ‚š t' Ã— tâ‚‚ â†ªâ‚š t'
diamondâ‚š Î¾-`             Î¾-`               = _ , Î¾-` , Î¾-`
diamondâ‚š (Î²-Î» {tâ‚' = tâ‚'} tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î²-Î» tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
  with diamondâ‚š tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamondâ‚š tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
  = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , â†ªâ‚šÏƒ-â‹¯ tâ‚'â†ªTâ‚ Semâ‚š.â†ªÏƒ-â¦… tâ‚‚'â†ªTâ‚‚ â¦† , â†ªâ‚šÏƒ-â‹¯ tâ‚''â†ªTâ‚ Semâ‚š.â†ªÏƒ-â¦… tâ‚‚''â†ªTâ‚‚ â¦†
diamondâ‚š (Î²-Î» {tâ‚' = tâ‚'} tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-Â· (Î¾-Î» tâ‚â†ªtâ‚'') tâ‚‚â†ªtâ‚‚'')
  with diamondâ‚š tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamondâ‚š tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
  = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , â†ªâ‚šÏƒ-â‹¯ tâ‚'â†ªTâ‚ Semâ‚š.â†ªÏƒ-â¦… tâ‚‚'â†ªTâ‚‚ â¦† , (Î²-Î» tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚)
diamondâ‚š (Î¾-Î» tâ†ªt') (Î¾-Î» tâ†ªt'')
  with diamondâ‚š tâ†ªt' tâ†ªt''
...  | T , t'â†ªT , t''â†ªT
  = Î»x T , Î¾-Î» t'â†ªT , Î¾-Î» t''â†ªT
diamondâ‚š (Î¾-âˆ€ tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-âˆ€ tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
  with diamondâ‚š tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamondâ‚š tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
  = âˆ€[xâˆ¶ Tâ‚ ] Tâ‚‚ , Î¾-âˆ€ tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , Î¾-âˆ€ tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚
diamondâ‚š (Î¾-Â· (Î¾-Î» tâ‚â†ªtâ‚') tâ‚‚â†ªtâ‚‚') (Î²-Î» tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
  with diamondâ‚š tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamondâ‚š tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
  = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , Î²-Î» tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , â†ªâ‚šÏƒ-â‹¯ tâ‚''â†ªTâ‚ Semâ‚š.â†ªÏƒ-â¦… tâ‚‚''â†ªTâ‚‚ â¦†
diamondâ‚š (Î¾-Â· tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-Â· tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
  with diamondâ‚š tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamondâ‚š tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
  = Tâ‚ Â· Tâ‚‚ , Î¾-Â· tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , Î¾-Â· tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚
diamondâ‚š Î¾-â˜… Î¾-â˜… = â˜… , Î¾-â˜… , Î¾-â˜…

open SemTrans-confluence diamondâ‚š public
  using (stripâ‚š; confluenceâ‚š; confluence)
