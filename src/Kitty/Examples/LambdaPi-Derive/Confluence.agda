module Kitty.Examples.LambdaPi-Derive.Confluence where

open import Data.Product using (âˆƒ-syntax; _Ã—_ ; _,_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Function using () renaming (_âˆ‹_ to _by_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; subst; module â‰¡-Reasoning)

open import Kitty.Examples.LambdaPi-Derive.Definitions
open import Kitty.Util.Closures
open import Kitty.Typing.TypingKit compose-traversal ctx-repr
  record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢`; â‰¡á¶œ-cong-âŠ¢ = Î» { refl âŠ¢e â†’ âŠ¢e } }
open TypingKit â¦ƒ â€¦ â¦„

â†ª*-trans : eâ‚ â†ª* eâ‚‚ â†’ eâ‚‚ â†ª* eâ‚ƒ â†’ eâ‚ â†ª* eâ‚ƒ
â†ª*-trans â†ª*-refl         q = q
â†ª*-trans (â†ª*-step pâ‚ pâ‚‚) q = â†ª*-step pâ‚ (â†ª*-trans pâ‚‚ q)

â†ª*-map :
  {f : S âŠ¢ ğ•– â†’ S' âŠ¢ ğ•–} â†’
  (F : âˆ€ {eâ‚ eâ‚‚ : S âŠ¢ ğ•–} â†’ eâ‚ â†ª eâ‚‚ â†’ f eâ‚ â†ª f eâ‚‚) â†’
  eâ‚ â†ª* eâ‚‚ â†’
  f eâ‚ â†ª* f eâ‚‚
â†ª*-map F â†ª*-refl = â†ª*-refl
â†ª*-map F (â†ª*-step p q) = â†ª*-step (F p) (â†ª*-map F q)

module â†ª*-Reasoning where
  infix 1 begin_
  infixr 2 _â†ªâŸ¨_âŸ©_ _â†ª*âŸ¨_âŸ©_ _â‰¡âŸ¨_âŸ©_ _â‰¡âŸ¨âŸ©_
  infix 3 _âˆ

  begin_ : âˆ€ {eâ‚ eâ‚‚ : S âŠ¢ ğ•–} â†’ eâ‚ â†ª* eâ‚‚ â†’ eâ‚ â†ª* eâ‚‚
  begin p = p

  _â†ªâŸ¨_âŸ©_ : âˆ€ (eâ‚ {eâ‚‚} {eâ‚ƒ} : S âŠ¢ ğ•–) â†’ eâ‚ â†ª eâ‚‚ â†’ eâ‚‚ â†ª* eâ‚ƒ â†’ eâ‚ â†ª* eâ‚ƒ
  _ â†ªâŸ¨ p âŸ© q = â†ª*-step p q

  _â†ª*âŸ¨_âŸ©_ : âˆ€ (eâ‚ {eâ‚‚} {eâ‚ƒ} : S âŠ¢ ğ•–) â†’ eâ‚ â†ª* eâ‚‚ â†’ eâ‚‚ â†ª* eâ‚ƒ â†’ eâ‚ â†ª* eâ‚ƒ
  _ â†ª*âŸ¨ p âŸ© q = â†ª*-trans p q

  _â‰¡âŸ¨_âŸ©_ : âˆ€ (eâ‚ {eâ‚‚} {eâ‚ƒ} : S âŠ¢ ğ•–) â†’ eâ‚ â‰¡ eâ‚‚ â†’ eâ‚‚ â†ª* eâ‚ƒ â†’ eâ‚ â†ª* eâ‚ƒ
  _ â‰¡âŸ¨ refl âŸ© q = q

  _â‰¡âŸ¨âŸ©_ : âˆ€ (eâ‚ {eâ‚‚} {eâ‚ƒ} : S âŠ¢ ğ•–) â†’ eâ‚ â†ª* eâ‚‚ â†’ eâ‚ â†ª* eâ‚‚
  _ â‰¡âŸ¨âŸ© q = q

  _âˆ : âˆ€ (e : S âŠ¢ ğ•–) â†’ e â†ª* e
  _ âˆ = â†ª*-refl

infix   3  _â†ªâ‚š_
data _â†ªâ‚š_ : S âŠ¢ s â†’ S âŠ¢ s â†’ Set where

  -- Variables

  Î¾-` : âˆ€ {x : S âˆ‹ s} â†’
    ` x â†ªâ‚š ` x

  -- Pi Types

  Î²-Î» : âˆ€ {eâ‚ eâ‚' : (S â–· ğ•–) âŠ¢ ğ•–} {eâ‚‚ eâ‚‚' : S âŠ¢ ğ•–} â†’
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    (Î»x eâ‚) Â· eâ‚‚ â†ªâ‚š eâ‚' â‹¯ â¦… eâ‚‚' â¦†â‚›

  Î¾-âˆ€ :
    tâ‚ â†ªâ‚š tâ‚' â†’
    tâ‚‚ â†ªâ‚š tâ‚‚' â†’
    âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ªâ‚š âˆ€[xâˆ¶ tâ‚' ] tâ‚‚'

  Î¾-Î» :
    e â†ªâ‚š e' â†’
    Î»x e â†ªâ‚š Î»x e'

  Î¾-Â· :
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    eâ‚ Â· eâ‚‚ â†ªâ‚š eâ‚' Â· eâ‚‚'

  -- Sigma Types

  Î²-projâ‚ :
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    `projâ‚ (eâ‚ `, eâ‚‚) â†ªâ‚š eâ‚'
  Î²-projâ‚‚ :
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    `projâ‚‚ (eâ‚ `, eâ‚‚) â†ªâ‚š eâ‚‚'
  Î¾-âˆƒ :
    tâ‚ â†ªâ‚š tâ‚' â†’
    tâ‚‚ â†ªâ‚š tâ‚‚' â†’
    âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚ â†ªâ‚š âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚'
  Î¾-, :
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    eâ‚ `, eâ‚‚ â†ªâ‚š eâ‚' `, eâ‚‚'
  Î¾-projâ‚ :
    e â†ªâ‚š e' â†’
    `projâ‚ e â†ªâ‚š `projâ‚ e'
  Î¾-projâ‚‚ :
    e â†ªâ‚š e' â†’
    `projâ‚‚ e â†ªâ‚š `projâ‚‚ e'

  -- Equality Types

  Î²-J :
    e â†ªâ‚š e' â†’
    `J t `refl e â†ªâ‚š e'
  Î¾-â‰¡ :
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    (eâ‚ `â‰¡ eâ‚‚) â†ªâ‚š (eâ‚' `â‰¡ eâ‚‚')
  Î¾-refl :
    `refl {S = S} â†ªâ‚š `refl
  Î¾-J :
    t â†ªâ‚š t' â†’
    eâ‚ â†ªâ‚š eâ‚' â†’
    eâ‚‚ â†ªâ‚š eâ‚‚' â†’
    `J t eâ‚ eâ‚‚ â†ªâ‚š `J t' eâ‚' eâ‚‚'

  -- Universe Type

  Î¾-Set :
    `Set â†ªâ‚š (`Set {S = S})

â†ªâ‚š-refl : t â†ªâ‚š t
â†ªâ‚š-refl {t = ` x}          = Î¾-`
â†ªâ‚š-refl {t = âˆ€[xâˆ¶ tâ‚ ] tâ‚‚} = Î¾-âˆ€ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = Î»x t}         = Î¾-Î» â†ªâ‚š-refl
â†ªâ‚š-refl {t = tâ‚ Â· tâ‚‚}      = Î¾-Â· â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = âˆƒ[xâˆ¶ tâ‚ ] tâ‚‚} = Î¾-âˆƒ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = tâ‚ `, tâ‚‚}     = Î¾-, â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = `projâ‚ t}     = Î¾-projâ‚ â†ªâ‚š-refl
â†ªâ‚š-refl {t = `projâ‚‚ t}     = Î¾-projâ‚‚ â†ªâ‚š-refl
â†ªâ‚š-refl {t = eâ‚ `â‰¡ eâ‚‚}     = Î¾-â‰¡ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = `refl}        = Î¾-refl
â†ªâ‚š-refl {t = `J t eâ‚ eâ‚‚}   = Î¾-J â†ªâ‚š-refl â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ‚š-refl {t = `Set}         = Î¾-Set

data _â†ªâ‚š*_ : S âŠ¢ s â†’ S âŠ¢ s â†’ Set where
  â†ªâ‚š*-refl : e â†ªâ‚š* e
  â†ªâ‚š*-step : eâ‚ â†ªâ‚š eâ‚‚ â†’ eâ‚‚ â†ªâ‚š* eâ‚ƒ â†’ eâ‚ â†ªâ‚š* eâ‚ƒ

â†ªâ‚š*-trans : eâ‚ â†ªâ‚š* eâ‚‚ â†’ eâ‚‚ â†ªâ‚š* eâ‚ƒ â†’ eâ‚ â†ªâ‚š* eâ‚ƒ
â†ªâ‚š*-trans â†ªâ‚š*-refl         q = q
â†ªâ‚š*-trans (â†ªâ‚š*-step pâ‚ pâ‚‚) q = â†ªâ‚š*-step pâ‚ (â†ªâ‚š*-trans pâ‚‚ q)

â†ªâ‚š*-map :
  {f : S âŠ¢ ğ•– â†’ S' âŠ¢ ğ•–} â†’
  (F : âˆ€ {eâ‚ eâ‚‚ : S âŠ¢ ğ•–} â†’ eâ‚ â†ªâ‚š eâ‚‚ â†’ f eâ‚ â†ªâ‚š f eâ‚‚) â†’
  eâ‚ â†ªâ‚š* eâ‚‚ â†’
  f eâ‚ â†ªâ‚š* f eâ‚‚
â†ªâ‚š*-map F â†ªâ‚š*-refl = â†ªâ‚š*-refl
â†ªâ‚š*-map F (â†ªâ‚š*-step p q) = â†ªâ‚š*-step (F p) (â†ªâ‚š*-map F q)

â†ªâ†’â†ªâ‚š : t â†ª t' â†’ t â†ªâ‚š t'
â†ªâ†’â†ªâ‚š Î²-Î»            = Î²-Î» â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Î» tâ†ªt')     = Î¾-Î» (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-âˆ€â‚ tâ‚â†ªtâ‚')  = Î¾-âˆ€ (â†ªâ†’â†ªâ‚š tâ‚â†ªtâ‚') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚')  = Î¾-âˆ€ â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ‚‚â†ªtâ‚‚')
â†ªâ†’â†ªâ‚š (Î¾-Â·â‚ tâ‚â†ªtâ‚')  = Î¾-Â· (â†ªâ†’â†ªâ‚š tâ‚â†ªtâ‚') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Â·â‚‚ tâ‚‚â†ªtâ‚‚')  = Î¾-Â· â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ‚‚â†ªtâ‚‚')
â†ªâ†’â†ªâ‚š Î²-projâ‚        = Î²-projâ‚ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š Î²-projâ‚‚        = Î²-projâ‚‚ â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-âˆƒâ‚ tâ†ªt')    = Î¾-âˆƒ (â†ªâ†’â†ªâ‚š tâ†ªt') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-âˆƒâ‚‚ tâ†ªt')    = Î¾-âˆƒ â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-projâ‚ tâ†ªt') = Î¾-projâ‚ (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-projâ‚‚ tâ†ªt') = Î¾-projâ‚‚ (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-,â‚ tâ†ªt')    = Î¾-, (â†ªâ†’â†ªâ‚š tâ†ªt') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-,â‚‚ tâ†ªt')    = Î¾-, â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š Î²-J            = Î²-J â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-â‰¡â‚ tâ†ªt')    = Î¾-â‰¡ (â†ªâ†’â†ªâ‚š tâ†ªt') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-â‰¡â‚‚ tâ†ªt')    = Î¾-â‰¡ â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ†ªt')
â†ªâ†’â†ªâ‚š (Î¾-Jâ‚ tâ†ªt')    = Î¾-J (â†ªâ†’â†ªâ‚š tâ†ªt') â†ªâ‚š-refl â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Jâ‚‚ tâ†ªt')    = Î¾-J â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ†ªt') â†ªâ‚š-refl
â†ªâ†’â†ªâ‚š (Î¾-Jâ‚ƒ tâ†ªt')    = Î¾-J â†ªâ‚š-refl â†ªâ‚š-refl (â†ªâ†’â†ªâ‚š tâ†ªt')

â†ª*â†’â†ªâ‚š* : t â†ª* t' â†’ t â†ªâ‚š* t'
â†ª*â†’â†ªâ‚š* â†ª*-refl                = â†ªâ‚š*-refl
â†ª*â†’â†ªâ‚š* (â†ª*-step tâ†ªt' t'â†ª*t'') = â†ªâ‚š*-step (â†ªâ†’â†ªâ‚š tâ†ªt') (â†ª*â†’â†ªâ‚š* t'â†ª*t'')

â†ªâ‚šâ†’â†ª* :
  t â†ªâ‚š t' â†’
  t â†ª* t'
â†ªâ‚šâ†’â†ª* Î¾-`                    = â†ª*-refl
â†ªâ‚šâ†’â†ª* (Î²-Î» {eâ‚ = eâ‚} {eâ‚'} {eâ‚‚} {eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚'') =
  let open â†ª*-Reasoning in
  begin
    (Î»x eâ‚) Â· eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Â·â‚ (â†ª*-map Î¾-Î» (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚')) âŸ©
    (Î»x eâ‚') Â· eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Â·â‚‚ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚'') âŸ©
    (Î»x eâ‚') Â· eâ‚‚'
  â†ªâŸ¨ Î²-Î» âŸ©
    eâ‚' â‹¯â‚› â¦… eâ‚‚' â¦†â‚›
  âˆ
â†ªâ‚šâ†’â†ª* (Î¾-Î» tâ†ªâ‚št')            = â†ª*-map Î¾-Î» (â†ªâ‚šâ†’â†ª* tâ†ªâ‚št')
â†ªâ‚šâ†’â†ª* (Î¾-âˆ€ {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
  let open â†ª*-Reasoning in
  begin
    âˆ€[xâˆ¶ tâ‚  ] tâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-âˆ€â‚ (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚') âŸ©
    âˆ€[xâˆ¶ tâ‚' ] tâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-âˆ€â‚‚ (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚') âŸ©
    âˆ€[xâˆ¶ tâ‚' ] tâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* (Î¾-Â· {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
  let open â†ª*-Reasoning in
  begin
    eâ‚  Â· eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Â·â‚ (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚') âŸ©
    eâ‚' Â· eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Â·â‚‚ (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚') âŸ©
    eâ‚' Â· eâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* Î¾-Set                     = â†ª*-refl
â†ªâ‚šâ†’â†ª* (Î²-projâ‚ {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚') = 
  let open â†ª*-Reasoning in
  begin
    `projâ‚ (eâ‚ `, eâ‚‚)
  â†ª*âŸ¨ â†ª*-map Î¾-projâ‚ (â†ª*-map Î¾-,â‚ (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚')) âŸ©
    `projâ‚ (eâ‚' `, eâ‚‚)
  â†ª*âŸ¨ â†ª*-map Î¾-projâ‚ (â†ª*-map Î¾-,â‚‚ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚')) âŸ©
    `projâ‚ (eâ‚' `, eâ‚‚')
  â†ªâŸ¨ Î²-projâ‚ âŸ©
    eâ‚'
  âˆ
â†ªâ‚šâ†’â†ª* (Î²-projâ‚‚ {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚') =
  let open â†ª*-Reasoning in
  begin
    `projâ‚‚ (eâ‚ `, eâ‚‚)
  â†ª*âŸ¨ â†ª*-map Î¾-projâ‚‚ (â†ª*-map Î¾-,â‚ (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚')) âŸ©
    `projâ‚‚ (eâ‚' `, eâ‚‚)
  â†ª*âŸ¨ â†ª*-map Î¾-projâ‚‚ (â†ª*-map Î¾-,â‚‚ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚')) âŸ©
    `projâ‚‚ (eâ‚' `, eâ‚‚')
  â†ªâŸ¨ Î²-projâ‚‚ âŸ©
    eâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* (Î²-J {e = e} {e' = e'} {t = t} eâ†ªâ‚še') =
  let open â†ª*-Reasoning in
  begin
    `J t `refl e
  â†ª*âŸ¨ â†ª*-map Î¾-Jâ‚ƒ (â†ªâ‚šâ†’â†ª* eâ†ªâ‚še') âŸ©
    `J t `refl e'
  â†ªâŸ¨ Î²-J âŸ©
    e'
  âˆ
â†ªâ‚šâ†’â†ª* (Î¾-âˆƒ {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
  let open â†ª*-Reasoning in
  begin
    âˆƒ[xâˆ¶ tâ‚  ] tâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-âˆƒâ‚ (â†ªâ‚šâ†’â†ª* tâ‚â†ªâ‚štâ‚') âŸ©
    âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-âˆƒâ‚‚ (â†ªâ‚šâ†’â†ª* tâ‚‚â†ªâ‚štâ‚‚') âŸ©
    âˆƒ[xâˆ¶ tâ‚' ] tâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* (Î¾-, {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')     =
  let open â†ª*-Reasoning in
  begin
    eâ‚  `, eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-,â‚ (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚') âŸ©
    eâ‚' `, eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-,â‚‚ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚') âŸ©
    eâ‚' `, eâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* (Î¾-projâ‚ eâ†ªâ‚še')           = â†ª*-map Î¾-projâ‚ (â†ªâ‚šâ†’â†ª* eâ†ªâ‚še')
â†ªâ‚šâ†’â†ª* (Î¾-projâ‚‚ eâ†ªâ‚še')           = â†ª*-map Î¾-projâ‚‚ (â†ªâ‚šâ†’â†ª* eâ†ªâ‚še')
â†ªâ‚šâ†’â†ª* (Î¾-â‰¡ {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')     =
  let open â†ª*-Reasoning in
  begin
    eâ‚  `â‰¡ eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-â‰¡â‚ (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚') âŸ©
    eâ‚' `â‰¡ eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-â‰¡â‚‚ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚') âŸ©
    eâ‚' `â‰¡ eâ‚‚'
  âˆ
â†ªâ‚šâ†’â†ª* Î¾-refl                    = â†ª*-refl
â†ªâ‚šâ†’â†ª* (Î¾-J {t = t} {t' = t'} {eâ‚ = eâ‚} {eâ‚' = eâ‚'} {eâ‚‚ = eâ‚‚} {eâ‚‚' = eâ‚‚'} tâ†ªâ‚št' eâ‚â†ªâ‚šeâ‚' eâ‚‚â†ªâ‚šeâ‚‚')  =
  let open â†ª*-Reasoning in
  begin
    `J t eâ‚ eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Jâ‚ (â†ªâ‚šâ†’â†ª* tâ†ªâ‚št') âŸ©
    `J t' eâ‚ eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Jâ‚‚ (â†ªâ‚šâ†’â†ª* eâ‚â†ªâ‚šeâ‚') âŸ©
    `J t' eâ‚' eâ‚‚
  â†ª*âŸ¨ â†ª*-map Î¾-Jâ‚ƒ (â†ªâ‚šâ†’â†ª* eâ‚‚â†ªâ‚šeâ‚‚') âŸ©
    `J t' eâ‚' eâ‚‚'
  âˆ

â†ªâ‚š*â†’â†ª* : âˆ€ {t t' : S âŠ¢ ğ•–}
  â†’ t â†ªâ‚š* t'
  â†’ t â†ª* t'
â†ªâ‚š*â†’â†ª* â†ªâ‚š*-refl                  = â†ª*-refl
â†ªâ‚š*â†’â†ª* (â†ªâ‚š*-step tâ†ªâ‚št' t'â†ªâ‚š*t'') = â†ª*-trans (â†ªâ‚šâ†’â†ª* tâ†ªâ‚št') (â†ªâ‚š*â†’â†ª* t'â†ªâ‚š*t'')

-- _â†ªâ‚šÏƒ_ : âˆ€ {Sâ‚ Sâ‚‚} (Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚) â†’ Set
-- Ïƒâ‚ â†ªâ‚šÏƒ Ïƒâ‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Ïƒâ‚ _ x â†ªâ‚š Ïƒâ‚‚ _ x

-- -- Are Ctx's basically Substitutions which don't weaken automatically?
-- -- Can be represent them as such or even generalize our substitutions?
-- â†ªâ‚šÏƒ-refl : âˆ€ {Sâ‚ Sâ‚‚} {Ïƒ : Sâ‚ â†’â‚› Sâ‚‚} â†’
--   Ïƒ â†ªâ‚šÏƒ Ïƒ
-- â†ªâ‚šÏƒ-refl {m = ğ•–} x = â†ªâ‚š-refl

-- â†ªâ‚šÏƒ-ext : âˆ€ {Sâ‚ Sâ‚‚} {Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚} {m} {tâ‚ tâ‚‚ : Sâ‚‚ âŠ¢ mâ†’M m} â†’
--   Ïƒâ‚ â†ªâ‚šÏƒ Ïƒâ‚‚ â†’
--   tâ‚ â†ªâ‚š tâ‚‚ â†’
--   (Ïƒâ‚ ,â‚› tâ‚) â†ªâ‚šÏƒ (Ïƒâ‚‚ ,â‚› tâ‚‚)
-- â†ªâ‚šÏƒ-ext Ïƒâ‚â†ªÏƒâ‚‚ tâ‚â†ªtâ‚‚ (here refl) = tâ‚â†ªtâ‚‚
-- â†ªâ‚šÏƒ-ext Ïƒâ‚â†ªÏƒâ‚‚ tâ‚â†ªtâ‚‚ (there x)   = Ïƒâ‚â†ªÏƒâ‚‚ x

-- â†ªâ‚š-â‹¯ :
--   âˆ€ {M} {_âˆ‹/âŠ¢_ : Scoped M} â¦ƒ ğ•‚ : Kit _âˆ‹/âŠ¢_ â¦„
--     â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
--     â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
--     â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
--     {Sâ‚ Sâ‚‚ m} {Ï• : Sâ‚ â€“[ ğ•‚ ]â†’ Sâ‚‚} {t t' : Sâ‚ âŠ¢ m} â†’
--   t â†ªâ‚š t' â†’
--   t â‹¯ Ï• â†ªâ‚š t' â‹¯ Ï•
-- â†ªâ‚š-â‹¯ Î¾-`                = â†ªâ‚š-refl
-- â†ªâ‚š-â‹¯ (Î¾-Î» tâ†ªâ‚št')        = Î¾-Î» (â†ªâ‚š-â‹¯ tâ†ªâ‚št')
-- â†ªâ‚š-â‹¯ (Î¾-âˆ€ tâ†ªâ‚št' tâ†ªâ‚št'') = Î¾-âˆ€ (â†ªâ‚š-â‹¯ tâ†ªâ‚št') (â†ªâ‚š-â‹¯ tâ†ªâ‚št'')
-- â†ªâ‚š-â‹¯ (Î¾-Â· tâ†ªâ‚št' tâ†ªâ‚št'') = Î¾-Â· (â†ªâ‚š-â‹¯ tâ†ªâ‚št') (â†ªâ‚š-â‹¯ tâ†ªâ‚št'')
-- â†ªâ‚š-â‹¯ Î¾-`Set                = Î¾-`Set
-- â†ªâ‚š-â‹¯ {Ï• = Ï•} (Î²-Î» {tâ‚ = tâ‚} {tâ‚'} {tâ‚‚} {tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') =
--   subst (((Î»x tâ‚) Â· tâ‚‚) â‹¯ Ï• â†ªâ‚š_)
--         (sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚' tâ‚‚' Ï•))
--         (Î²-Î» (â†ªâ‚š-â‹¯ tâ‚â†ªâ‚štâ‚') (â†ªâ‚š-â‹¯ tâ‚‚â†ªâ‚štâ‚‚'))

-- â†ªâ‚š-â‹¯â‚› : âˆ€ {Sâ‚ Sâ‚‚ m} {Ï• : Sâ‚ â†’â‚› Sâ‚‚} {t t' : Sâ‚ âŠ¢ m} â†’
--   t â†ªâ‚š t' â†’
--   t â‹¯â‚› Ï• â†ªâ‚š t' â‹¯â‚› Ï•
-- â†ªâ‚š-â‹¯â‚› = â†ªâ‚š-â‹¯ where instance _ = kitâ‚›; _ = kittâ‚›; _ = ckitâ‚›â‚›; _ = ckitáµ£

-- â†ªâ‚š-â‹¯áµ£ : âˆ€ {Sâ‚ Sâ‚‚ m} {Ï• : Sâ‚ â†’áµ£ Sâ‚‚} {t t' : Sâ‚ âŠ¢ m} â†’
--   t â†ªâ‚š t' â†’
--   t â‹¯áµ£ Ï• â†ªâ‚š t' â‹¯áµ£ Ï•
-- â†ªâ‚š-â‹¯áµ£ = â†ªâ‚š-â‹¯ where instance _ = kitáµ£; _ = kittáµ£; _ = ckitâ‚›áµ£; _ = ckitáµ£

-- â†ªâ‚šÏƒ-wk : âˆ€ {Sâ‚ Sâ‚‚} {Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚} {m'} â†’
--   Ïƒâ‚ â†ªâ‚šÏƒ Ïƒâ‚‚ â†’
--   wkâ†’â‚› m' Ïƒâ‚ â†ªâ‚šÏƒ wkâ†’â‚› m' Ïƒâ‚‚
-- â†ªâ‚šÏƒ-wk {m' = ğ•–} Ïƒâ‚â†ªÏƒâ‚‚ x = â†ªâ‚š-â‹¯áµ£ (Ïƒâ‚â†ªÏƒâ‚‚ x)

-- â†ªâ‚šÏƒ-â†‘ : âˆ€ {Sâ‚ Sâ‚‚} {Ïƒâ‚ Ïƒâ‚‚ : Sâ‚ â†’â‚› Sâ‚‚} {m'} â†’
--   Ïƒâ‚ â†ªâ‚šÏƒ Ïƒâ‚‚ â†’
--   (Ïƒâ‚ â†‘â‚› m') â†ªâ‚šÏƒ (Ïƒâ‚‚ â†‘â‚› m')
-- â†ªâ‚šÏƒ-â†‘ {m' = ğ•–} Ïƒâ‚â†ªÏƒâ‚‚ = â†ªâ‚šÏƒ-ext (â†ªâ‚šÏƒ-wk Ïƒâ‚â†ªÏƒâ‚‚) â†ªâ‚š-refl

-- -- â†ªÏƒ-â‹¯ : âˆ€ {Sâ‚ Sâ‚‚ m} {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} (t : Sâ‚ âŠ¢ m) â†’
-- --   Ïƒ â†ªâ‚šÏƒ Ïƒ' â†’
-- --   t â‹¯ Ïƒ â†ªâ‚š t â‹¯ Ïƒ'
-- -- â†ªÏƒ-â‹¯ (` x)          Ïƒâ†ªÏƒ' = Ïƒâ†ªÏƒ' x
-- -- â†ªÏƒ-â‹¯ (Î»x t)         Ïƒâ†ªÏƒ' = Î¾-Î» (â†ªÏƒ-â‹¯ t (â†ªâ‚šÏƒ-â†‘ Ïƒâ†ªÏƒ'))
-- -- â†ªÏƒ-â‹¯ (âˆ€[xâˆ¶ tâ‚ ] tâ‚‚) Ïƒâ†ªÏƒ' = Î¾-âˆ€ (â†ªÏƒ-â‹¯ tâ‚ Ïƒâ†ªÏƒ') (â†ªÏƒ-â‹¯ tâ‚‚ (â†ªâ‚šÏƒ-â†‘ Ïƒâ†ªÏƒ'))
-- -- â†ªÏƒ-â‹¯ (tâ‚ Â· tâ‚‚)      Ïƒâ†ªÏƒ' = Î¾-Â· (â†ªÏƒ-â‹¯ tâ‚ Ïƒâ†ªÏƒ') (â†ªÏƒ-â‹¯ tâ‚‚ Ïƒâ†ªÏƒ')
-- -- â†ªÏƒ-â‹¯ `Set              Ïƒâ†ªÏƒ' = Î¾-`Set

-- â†ªâ‚šÏƒ-â‹¯ : âˆ€ {Sâ‚ Sâ‚‚ m} {t t' : Sâ‚ âŠ¢ m} {Ïƒ Ïƒ' : Sâ‚ â†’â‚› Sâ‚‚} â†’
--   t â†ªâ‚š t' â†’
--   Ïƒ â†ªâ‚šÏƒ Ïƒ' â†’
--   t â‹¯ Ïƒ â†ªâ‚š t' â‹¯ Ïƒ'
-- â†ªâ‚šÏƒ-â‹¯ Î¾-`                   Ïƒâ†ªÏƒ' = Ïƒâ†ªÏƒ' _
-- â†ªâ‚šÏƒ-â‹¯ {Ïƒ = Ïƒ} {Ïƒ'} (Î²-Î» {tâ‚' = tâ‚'} {tâ‚‚' = tâ‚‚'} tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ïƒâ†ªÏƒ' = subst (_ â†ªâ‚š_) (sym (dist-â¦…â¦†â‚›-â‹¯â‚› tâ‚' tâ‚‚' Ïƒ'))
--                                                                               (Î²-Î» (â†ªâ‚šÏƒ-â‹¯ tâ‚â†ªâ‚štâ‚' (â†ªâ‚šÏƒ-â†‘ Ïƒâ†ªÏƒ'))
--                                                                                    (â†ªâ‚šÏƒ-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' Ïƒâ†ªÏƒ'))
-- â†ªâ‚šÏƒ-â‹¯ (Î¾-Î» tâ†ªâ‚št')           Ïƒâ†ªÏƒ' = Î¾-Î» (â†ªâ‚šÏƒ-â‹¯ tâ†ªâ‚št' (â†ªâ‚šÏƒ-â†‘ Ïƒâ†ªÏƒ'))
-- â†ªâ‚šÏƒ-â‹¯ (Î¾-âˆ€ tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ïƒâ†ªÏƒ' = Î¾-âˆ€ (â†ªâ‚šÏƒ-â‹¯ tâ‚â†ªâ‚štâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚šÏƒ-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' (â†ªâ‚šÏƒ-â†‘ Ïƒâ†ªÏƒ'))
-- â†ªâ‚šÏƒ-â‹¯ (Î¾-Â· tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚') Ïƒâ†ªÏƒ' = Î¾-Â· (â†ªâ‚šÏƒ-â‹¯ tâ‚â†ªâ‚štâ‚' Ïƒâ†ªÏƒ') (â†ªâ‚šÏƒ-â‹¯ tâ‚‚â†ªâ‚štâ‚‚' Ïƒâ†ªÏƒ')
-- â†ªâ‚šÏƒ-â‹¯ Î¾-`Set                   Ïƒâ†ªÏƒ' = Î¾-`Set

-- â†ªâ‚šÏƒ-â¦…_â¦† : âˆ€ {S m} {tâ‚ tâ‚‚ : S âŠ¢ mâ†’M m} â†’
--   tâ‚ â†ªâ‚š tâ‚‚ â†’
--   â¦… tâ‚ â¦† â†ªâ‚šÏƒ â¦… tâ‚‚ â¦†
-- â†ªâ‚šÏƒ-â¦… tâ‚â†ªâ‚štâ‚‚ â¦† = â†ªâ‚šÏƒ-ext (â†ªâ‚šÏƒ-refl {Ïƒ = idâ‚›}) tâ‚â†ªâ‚štâ‚‚ 

-- â†ªâ‚šÏƒ-â‹¯-â¦…â¦† : âˆ€ {S M} {tâ‚ tâ‚' : (S â–· ğ•–) âŠ¢ M}  {tâ‚‚ tâ‚‚' : S âŠ¢ ğ•–} â†’
--   tâ‚ â†ªâ‚š tâ‚' â†’
--   tâ‚‚ â†ªâ‚š tâ‚‚' â†’
--   tâ‚ â‹¯ â¦… tâ‚‚ â¦†â‚› â†ªâ‚š tâ‚' â‹¯ â¦… tâ‚‚' â¦†â‚›
-- â†ªâ‚šÏƒ-â‹¯-â¦…â¦† tâ‚â†ªâ‚štâ‚' tâ‚‚â†ªâ‚štâ‚‚' = â†ªâ‚šÏƒ-â‹¯ tâ‚â†ªâ‚štâ‚' â†ªâ‚šÏƒ-â¦… tâ‚‚â†ªâ‚štâ‚‚' â¦†

-- diamond :
--   t â†ªâ‚š tâ‚ â†’
--   t â†ªâ‚š tâ‚‚ â†’
--   âˆƒ[ t' ] tâ‚ â†ªâ‚š t' Ã— tâ‚‚ â†ªâ‚š t'
-- diamond Î¾-`             Î¾-`               = _ , Î¾-` , Î¾-`
-- diamond (Î²-Î» {tâ‚' = tâ‚'} tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î²-Î» tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
--   with diamond tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamond tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
-- ...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
--   = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , â†ªâ‚šÏƒ-â‹¯ tâ‚'â†ªTâ‚ â†ªâ‚šÏƒ-â¦… tâ‚‚'â†ªTâ‚‚ â¦† , â†ªâ‚šÏƒ-â‹¯ tâ‚''â†ªTâ‚ â†ªâ‚šÏƒ-â¦… tâ‚‚''â†ªTâ‚‚ â¦†
-- diamond (Î²-Î» {tâ‚' = tâ‚'} tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-Â· (Î¾-Î» tâ‚â†ªtâ‚'') tâ‚‚â†ªtâ‚‚'')
--   with diamond tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamond tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
-- ...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
--   = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , â†ªâ‚šÏƒ-â‹¯ tâ‚'â†ªTâ‚ â†ªâ‚šÏƒ-â¦… tâ‚‚'â†ªTâ‚‚ â¦† , (Î²-Î» tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚)
-- diamond (Î¾-Î» tâ†ªt') (Î¾-Î» tâ†ªt'')
--   with diamond tâ†ªt' tâ†ªt''
-- ...  | T , t'â†ªT , t''â†ªT
--   = Î»x T , Î¾-Î» t'â†ªT , Î¾-Î» t''â†ªT
-- diamond (Î¾-âˆ€ tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-âˆ€ tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
--   with diamond tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamond tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
-- ...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
--   = âˆ€[xâˆ¶ Tâ‚ ] Tâ‚‚ , Î¾-âˆ€ tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , Î¾-âˆ€ tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚
-- diamond (Î¾-Â· (Î¾-Î» tâ‚â†ªtâ‚') tâ‚‚â†ªtâ‚‚') (Î²-Î» tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
--   with diamond tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamond tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
-- ...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
--   = Tâ‚ â‹¯â‚› â¦… Tâ‚‚ â¦†â‚› , Î²-Î» tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , â†ªâ‚šÏƒ-â‹¯ tâ‚''â†ªTâ‚ â†ªâ‚šÏƒ-â¦… tâ‚‚''â†ªTâ‚‚ â¦†
-- diamond (Î¾-Â· tâ‚â†ªtâ‚' tâ‚‚â†ªtâ‚‚') (Î¾-Â· tâ‚â†ªtâ‚'' tâ‚‚â†ªtâ‚‚'')
--   with diamond tâ‚â†ªtâ‚' tâ‚â†ªtâ‚'' | diamond tâ‚‚â†ªtâ‚‚' tâ‚‚â†ªtâ‚‚''
-- ...  | Tâ‚ , tâ‚'â†ªTâ‚ , tâ‚''â†ªTâ‚  | Tâ‚‚ , tâ‚‚'â†ªTâ‚‚ , tâ‚‚''â†ªTâ‚‚
--   = Tâ‚ Â· Tâ‚‚ , Î¾-Â· tâ‚'â†ªTâ‚ tâ‚‚'â†ªTâ‚‚ , Î¾-Â· tâ‚''â†ªTâ‚ tâ‚‚''â†ªTâ‚‚
-- diamond Î¾-`Set Î¾-`Set = `Set , Î¾-`Set , Î¾-`Set

-- strip :
--   t â†ªâ‚š tâ‚ â†’
--   t â†ªâ‚š* tâ‚‚ â†’
--   âˆƒ[ t' ] (tâ‚ â†ªâ‚š* t') Ã— (tâ‚‚ â†ªâ‚š t')
-- strip {t = t} {tâ‚} {tâ‚‚} tâ†ªâ‚štâ‚ refl = tâ‚ , refl , tâ†ªâ‚štâ‚
-- strip {t = t} {tâ‚} {tâ‚‚} tâ†ªâ‚štâ‚ (step tâ†ªâ‚štâ‚‚' tâ‚‚'â†ªâ‚š*tâ‚‚)
--   with diamond tâ†ªâ‚štâ‚ tâ†ªâ‚štâ‚‚'
-- ... | T , tâ‚â†ªâ‚šT , tâ‚‚'â†ªâ‚šT
--   with strip tâ‚‚'â†ªâ‚šT tâ‚‚'â†ªâ‚š*tâ‚‚
-- ... | U , Tâ†ªâ‚š*U , tâ‚‚â†ªU
--   = U , step tâ‚â†ªâ‚šT Tâ†ªâ‚š*U , tâ‚‚â†ªU

-- confluenceâ‚š : 
--   t â†ªâ‚š* tâ‚ â†’
--   t â†ªâ‚š* tâ‚‚ â†’
--   âˆƒ[ t' ] (tâ‚ â†ªâ‚š* t') Ã— (tâ‚‚ â†ªâ‚š* t')
-- confluenceâ‚š refl                   tâ†ªâ‚š*tâ‚‚ = _ , tâ†ªâ‚š*tâ‚‚ , refl
-- confluenceâ‚š (step tâ†ªâ‚štâ‚' tâ‚'â†ªâ‚š*tâ‚) tâ†ªâ‚š*tâ‚‚
--   with strip tâ†ªâ‚štâ‚' tâ†ªâ‚š*tâ‚‚
-- ... | T , tâ‚'â†ªâ‚š*T , tâ‚‚â†ªâ‚šT
--   with confluenceâ‚š tâ‚'â†ªâ‚š*tâ‚ tâ‚'â†ªâ‚š*T
-- ... | U , tâ‚â†ªâ‚š*U , Tâ†ªâ‚š*U
--   = U , tâ‚â†ªâ‚š*U , step tâ‚‚â†ªâ‚šT Tâ†ªâ‚š*U 

-- confluence : 
--   t â†ª* tâ‚ â†’
--   t â†ª* tâ‚‚ â†’
--   âˆƒ[ t' ] (tâ‚ â†ª* t') Ã— (tâ‚‚ â†ª* t')
-- confluence tâ†ª*tâ‚ tâ†ª*tâ‚‚
--   with confluenceâ‚š (â†ª*â†’â†ªâ‚š* tâ†ª*tâ‚) (â†ª*â†’â†ªâ‚š* tâ†ª*tâ‚‚)
-- ... | t' , tâ‚â†ªâ‚š*t' , tâ‚‚â†ªâ‚š*t'
--   = t' , â†ªâ‚š*â†’â†ª* tâ‚â†ªâ‚š*t' , â†ªâ‚š*â†’â†ª* tâ‚‚â†ªâ‚š*t'
