module Kitty.Examples.LambdaPi-Derive.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; cong-app; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Kitty.Examples.LambdaPi-Derive.Definitions
open import Kitty.Examples.LambdaPi-Derive.Confluence
open import Kitty.Examples.LambdaPi-Derive.Closures
open import Kitty.Typing.IKit compose-traversal kit-type record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢` }
open IKit â¦ƒ â€¦ â¦„
open import Function using () renaming (_âˆ‹_ to _by_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _Ã—_ ; _,_; projâ‚; projâ‚‚)

_â†ªÏƒ_ : âˆ€ {Âµâ‚ Âµâ‚‚} (Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’ Set
Ïƒâ‚ â†ªÏƒ Ïƒâ‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Ïƒâ‚ _ x â†ª Ïƒâ‚‚ _ x

_â†ª*Ïƒ_ : âˆ€ {Âµâ‚ Âµâ‚‚} (Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’ Set
Ïƒâ‚ â†ª*Ïƒ Ïƒâ‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Ïƒâ‚ _ x â†ª* Ïƒâ‚‚ _ x

_â†ªâ‚š*Ïƒ_ : âˆ€ {Âµâ‚ Âµâ‚‚} (Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’ Set
Ïƒâ‚ â†ªâ‚š*Ïƒ Ïƒâ‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Ïƒâ‚ _ x â†ªâ‚š* Ïƒâ‚‚ _ x

open ReflexiveTransitiveClosureâ‚‚ (_â†’â‚›_) _â†ªâ‚šÏƒ_ renaming
  ( ReflTrans to _â†ªâ‚šÏƒ*_
  ; map-ReflTrans to map-â†ªâ‚šÏƒ*
  ; _âŸ¨_âŸ©_ to _â†ªâ‚šÏƒâŸ¨_âŸ©_
  ; _*âŸ¨_âŸ©_ to _â†ªâ‚šÏƒ*âŸ¨_âŸ©_
  ; _âˆ to _â†ªâ‚šÏƒâˆ
  ; trans to â†ªâ‚šÏƒ*-trans
  ; embed to â†ªâ‚šÏƒ*-embed
  ) hiding (refl; step) public

to''' : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒâ‚ Ïƒâ‚‚ : (Âµâ‚ â–· m) â†’â‚› Âµâ‚‚} {tâ‚‚'} â†’
  Ïƒâ‚ â†“â‚› â‰¡ Ïƒâ‚‚ â†“â‚› â†’
  tâ‚‚' â‰¡ Ïƒâ‚‚ _ (here refl) â†’
  Ïƒâ‚ _ (here refl) â†ªâ‚š* tâ‚‚' â†’
  Ïƒâ‚ â†ªâ‚šÏƒ* Ïƒâ‚‚
to''' {Ïƒâ‚ = Ïƒâ‚} {Ïƒâ‚‚ = Ïƒâ‚‚} p q refl =
  step (Î» { (here refl) â†’ subst (_ â†ªâ‚š_) q â†ªâ‚š-refl
          ; (there x)   â†’ subst (_ â†ªâ‚š_) (cong-app (cong-app p _) x ) â†ªâ‚š-refl})
        refl
to''' {Ïƒâ‚ = Ïƒâ‚} xx refl (step {aâ‚‚ = t'} tâ‚â†ªt' t'â†ª*tâ‚‚) =
  step {aâ‚‚ = (Ïƒâ‚ â†“â‚›) ,â‚› t'}
       (Î» { (here refl) â†’ tâ‚â†ªt'
          ; (there x) â†’ â†ªâ‚š-refl})
       (to''' xx refl t'â†ª*tâ‚‚)

to'' : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒâ‚ Ïƒâ‚‚ : (Âµâ‚ â–· m) â†’â‚› Âµâ‚‚} {tâ‚‚'} {Ïƒâ‚‚'} â†’
  Ïƒâ‚‚' â‰¡ Ïƒâ‚‚ â†“â‚› â†’
  tâ‚‚' â‰¡ Ïƒâ‚‚ _ (here refl) â†’
  Ïƒâ‚ â†“â‚› â†ªâ‚šÏƒ* Ïƒâ‚‚' â†’
  Ïƒâ‚ _ (here refl) â†ªâ‚š* tâ‚‚' â†’
  Ïƒâ‚ â†ªâ‚šÏƒ* Ïƒâ‚‚
to'' p q refl tâ‚â†ª*tâ‚‚ = to''' p q tâ‚â†ª*tâ‚‚
to'' {Ïƒâ‚ = Ïƒâ‚} refl q (step {aâ‚‚ = Ïƒ'} Ïƒâ‚â†ª*Ïƒ' Ïƒ'â†ª*Ïƒâ‚‚) tâ‚â†ª*tâ‚‚ =
  step {aâ‚‚ = Ïƒ' ,â‚› Ïƒâ‚ _ (here refl)}
       (Î» { (here refl) â†’ â†ªâ‚š-refl
          ; (there x)   â†’ Ïƒâ‚â†ª*Ïƒ' x})
       (to'' refl q Ïƒ'â†ª*Ïƒâ‚‚ tâ‚â†ª*tâ‚‚)

to' : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒâ‚ Ïƒâ‚‚ : (Âµâ‚ â–· m) â†’â‚› Âµâ‚‚} â†’
  Ïƒâ‚ â†“â‚› â†ªâ‚šÏƒ* Ïƒâ‚‚ â†“â‚› â†’
  Ïƒâ‚ _ (here refl) â†ªâ‚š* Ïƒâ‚‚ _ (here refl) â†’
  Ïƒâ‚ â†ªâ‚šÏƒ* Ïƒâ‚‚
to' = to'' refl refl

to : âˆ€ {Âµâ‚ Âµâ‚‚} {Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Ïƒâ‚ â†ªâ‚š*Ïƒ Ïƒâ‚‚ â†’
  Ïƒâ‚ â†ªâ‚šÏƒ* Ïƒâ‚‚
to {[]}     Ïƒâ‚â†ª*Ïƒâ‚‚ = step (Î» ()) refl
to {Âµâ‚ â–· m} Ïƒâ‚â†ª*Ïƒâ‚‚ with to (Î» x â†’ Ïƒâ‚â†ª*Ïƒâ‚‚ (there x))
... | Ïƒâ‚â†ª*Ïƒâ‚‚' = to' Ïƒâ‚â†ª*Ïƒâ‚‚' (Ïƒâ‚â†ª*Ïƒâ‚‚ (here refl))

â†ªâ‚š*Ïƒ-â‹¯' : âˆ€ {Âµâ‚ Âµâ‚‚ m} {t t' : Âµâ‚ âŠ¢ m} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  t â†ªâ‚š* t' â†’
  Ïƒ â†ªâ‚šÏƒ Ïƒ' â†’
  t â‹¯ Ïƒ â†ªâ‚š* t' â‹¯ Ïƒ'
â†ªâ‚š*Ïƒ-â‹¯' {t = t} refl          Ïƒâ†ªâ‚šÏƒ' = step (â†ªâ‚šÏƒ-â‹¯ {t = t} â†ªâ‚š-refl Ïƒâ†ªâ‚šÏƒ') refl
â†ªâ‚š*Ïƒ-â‹¯' (step tâ†ªâ‚št' t'â†ªâ‚š*t'') Ïƒâ†ªâ‚šÏƒ' = step (â†ªâ‚šÏƒ-â‹¯ tâ†ªâ‚št' Î» x â†’ â†ªâ‚š-refl) (â†ªâ‚š*Ïƒ-â‹¯' t'â†ªâ‚š*t'' Ïƒâ†ªâ‚šÏƒ')

â†ªâ‚š*Ïƒ-â‹¯ : âˆ€ {Âµâ‚ Âµâ‚‚ m} {t t' : Âµâ‚ âŠ¢ m} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  t â†ªâ‚š* t' â†’
  Ïƒ â†ªâ‚šÏƒ* Ïƒ' â†’
  t â‹¯ Ïƒ â†ªâ‚š* t' â‹¯ Ïƒ'
â†ªâ‚š*Ïƒ-â‹¯ tâ†ªâ‚š*t' refl = â†ªâ‚š*Ïƒ-â‹¯' tâ†ªâ‚š*t' (Î» x â†’ â†ªâ‚š-refl)
â†ªâ‚š*Ïƒ-â‹¯ {t = t} tâ†ªâ‚š*t' (step {aâ‚‚ = Ïƒ'} Ïƒâ†ªâ‚šÏƒ' Ïƒ'â†ªâ‚š*Ïƒ'') = step {aâ‚‚ = t â‹¯ Ïƒ'} (â†ªâ‚šÏƒ-â‹¯ {t = t} â†ªâ‚š-refl Ïƒâ†ªâ‚šÏƒ') (â†ªâ‚š*Ïƒ-â‹¯ tâ†ªâ‚š*t' Ïƒ'â†ªâ‚š*Ïƒ'')

â†ªÏƒ-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª t' â†’
  Ïƒ â†ªÏƒ Ïƒ' â†’
  t â‹¯â‚› Ïƒ â†ª* t' â‹¯â‚› Ïƒ'
â†ªÏƒ-â‹¯â‚› tâ†ªt' Ïƒâ†ªÏƒ' = â†ªâ‚šâ†’â†ª* (â†ªâ‚šÏƒ-â‹¯ (â†ªâ†’â†ªâ‚š tâ†ªt') (Î» x â†’ â†ªâ†’â†ªâ‚š (Ïƒâ†ªÏƒ' x)))

â†ª*-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª* t' â†’
  Ïƒ â†ª*Ïƒ Ïƒ' â†’
  t â‹¯â‚› Ïƒ â†ª* t' â‹¯â‚› Ïƒ'
â†ª*-â‹¯â‚› tâ†ª*t' Ïƒâ†ª*Ïƒ' = â†ªâ‚š*â†’â†ª* (â†ªâ‚š*Ïƒ-â‹¯ (â†ª*â†’â†ªâ‚š* tâ†ª*t') (to (Î» x â†’ â†ª*â†’â†ªâ‚š* (Ïƒâ†ª*Ïƒ' x)))) 

--------------------------------------------------------------------------------

â‰£-refl : e â‰£ e
â‰£-refl = mk-â‰£ _ refl refl

â‰£-sym : eâ‚ â‰£ eâ‚‚ â†’ eâ‚‚ â‰£ eâ‚
â‰£-sym (mk-â‰£ e eâ‚â†ª*e eâ‚‚â†ª*e) = mk-â‰£ e eâ‚‚â†ª*e eâ‚â†ª*e

â‰£-trans : eâ‚ â‰£ eâ‚‚ â†’ eâ‚‚ â‰£ eâ‚ƒ â†’ eâ‚ â‰£ eâ‚ƒ
â‰£-trans (mk-â‰£ e eâ‚â†ª*e eâ‚‚â†ª*e) (mk-â‰£ e' eâ‚‚â†ª*e' eâ‚ƒâ†ª*e') with confluence eâ‚‚â†ª*e eâ‚‚â†ª*e'
... | e'' , eâ†ª*e'' , e'â†ª*e'' = mk-â‰£ e'' (â†ª*-trans eâ‚â†ª*e eâ†ª*e'') (â†ª*-trans eâ‚ƒâ†ª*e' e'â†ª*e'')

map-â‰£ :
  âˆ€ {Âµ} {Âµ'} {M}
    {f : Âµ âŠ¢ M â†’ Âµ' âŠ¢ M}
    (F : âˆ€ {e e' : Âµ âŠ¢ M} â†’ e â†ª e' â†’ f e â†ª f e')
    {e e' : Âµ âŠ¢ M}
  â†’ e â‰£ e'
  â†’ f e â‰£ f e'
map-â‰£ {f = f} F (mk-â‰£ e eâ‚â†ª*e eâ‚‚â†ª*e) = mk-â‰£ (f e) (map-â†ª* F eâ‚â†ª*e) (map-â†ª* F eâ‚‚â†ª*e)

â‰£-â†ª : e â†ª e' â†’ e â‰£ e'
â‰£-â†ª eâ†ªe' = mk-â‰£ _ (embed eâ†ªe') refl

â‰£-â†© : e' â†ª e â†’ e â‰£ e'
â‰£-â†© e'â†ªe = mk-â‰£ _ refl (embed e'â†ªe)

â‰£-Î» : e â‰£ e' â†’ Î»x e â‰£ Î»x e'
â‰£-Î» = map-â‰£ Î¾-Î»

â‰£-Â·â‚ : eâ‚ â‰£ eâ‚' â†’ eâ‚ Â· eâ‚‚ â‰£ eâ‚' Â· eâ‚‚
â‰£-Â·â‚ = map-â‰£ Î¾-Â·â‚

â‰£-Â·â‚‚ : eâ‚‚ â‰£ eâ‚‚' â†’ eâ‚ Â· eâ‚‚ â‰£ eâ‚ Â· eâ‚‚'
â‰£-Â·â‚‚ = map-â‰£ Î¾-Â·â‚‚

â‰£-âˆ€â‚ : eâ‚ â‰£ eâ‚' â†’ âˆ€[xâˆ¶ eâ‚ ] eâ‚‚ â‰£ âˆ€[xâˆ¶ eâ‚' ] eâ‚‚
â‰£-âˆ€â‚ = map-â‰£ Î¾-âˆ€â‚

â‰£-âˆ€â‚‚ : eâ‚‚ â‰£ eâ‚‚' â†’ âˆ€[xâˆ¶ eâ‚ ] eâ‚‚ â‰£ âˆ€[xâˆ¶ eâ‚ ] eâ‚‚'
â‰£-âˆ€â‚‚ = map-â‰£ Î¾-âˆ€â‚‚

--------------------------------------------------------------------------------

_â‰£Ïƒ_ : âˆ€ {Âµâ‚ Âµâ‚‚} (Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’ Set
Ïƒâ‚ â‰£Ïƒ Ïƒâ‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Ïƒâ‚ _ x â‰£ Ïƒâ‚‚ _ x

-- Are Ctx's basically Substitutions which don't weaken automatically?
-- Can we represent them as such or even generalize our substitutions?
â‰£Ïƒ-refl : âˆ€ {Âµâ‚ Âµâ‚‚} {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Ïƒ â‰£Ïƒ Ïƒ
â‰£Ïƒ-refl {m = ğ•–} x = â‰£-refl

â‰£Ïƒ-ext : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒâ‚ Ïƒâ‚‚ : Âµâ‚ â†’â‚› Âµâ‚‚} {tâ‚ tâ‚‚ : Âµâ‚‚ âŠ¢ mâ†’M m} â†’
  Ïƒâ‚ â‰£Ïƒ Ïƒâ‚‚ â†’
  tâ‚ â‰£ tâ‚‚ â†’
  (Ïƒâ‚ ,â‚› tâ‚) â‰£Ïƒ (Ïƒâ‚‚ ,â‚› tâ‚‚)
â‰£Ïƒ-ext Ïƒâ‚â‰£Ïƒâ‚‚ tâ‚â‰£tâ‚‚ (here refl) = tâ‚â‰£tâ‚‚
â‰£Ïƒ-ext Ïƒâ‚â‰£Ïƒâ‚‚ tâ‚â‰£tâ‚‚ (there x)   = Ïƒâ‚â‰£Ïƒâ‚‚ x

â‰£Ïƒ-â¦…_â¦† : âˆ€ {Âµ m} {tâ‚ tâ‚‚ : Âµ âŠ¢ mâ†’M m} â†’
  tâ‚ â‰£ tâ‚‚ â†’
  â¦… tâ‚ â¦†â‚› â‰£Ïƒ â¦… tâ‚‚ â¦†â‚›
â‰£Ïƒ-â¦… tâ‚â‰£tâ‚‚ â¦† = â‰£Ïƒ-ext (â‰£Ïƒ-refl {Ïƒ = idâ‚›}) tâ‚â‰£tâ‚‚

â‰£â†’Î£ : tâ‚ â‰£ tâ‚‚ â†’ âˆƒ[ t ] tâ‚ â†ª* t Ã— tâ‚‚ â†ª* t 
â‰£â†’Î£ (mk-â‰£ t tâ‚â†ª*t tâ‚‚â†ª*t) = t , tâ‚â†ª*t , tâ‚‚â†ª*t

â‰£Ïƒâ†’â†ª*Ïƒ : âˆ€ {Âµâ‚ Âµâ‚‚} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Ïƒ â‰£Ïƒ Ïƒ' â†’
  âˆƒ[ Ïƒ'' ] Ïƒ â†ª*Ïƒ Ïƒ'' Ã— Ïƒ' â†ª*Ïƒ Ïƒ''
â‰£Ïƒâ†’â†ª*Ïƒ Ïƒâ‰£Ïƒ' = (Î» m x â†’ projâ‚ (â‰£â†’Î£ (Ïƒâ‰£Ïƒ' x)))
          , (Î» x â†’ projâ‚ (projâ‚‚ (â‰£â†’Î£ (Ïƒâ‰£Ïƒ' x))))
          , (Î» x â†’ projâ‚‚ (projâ‚‚ (â‰£â†’Î£ (Ïƒâ‰£Ïƒ' x))))

â‰£-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ïƒ Ïƒ' : Âµâ‚ â†’â‚› Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â‰£ t' â†’
  Ïƒ â‰£Ïƒ Ïƒ' â†’
  t â‹¯â‚› Ïƒ â‰£ t' â‹¯â‚› Ïƒ'
â‰£-â‹¯â‚› (mk-â‰£ T tâ†ª*T t'â†ª*T) Ïƒâ‰£Ïƒ'
 with â‰£Ïƒâ†’â†ª*Ïƒ Ïƒâ‰£Ïƒ'
... | Ïƒ'' , Ïƒâ†ª*Ïƒ'' , Ïƒ'â†ª*Ïƒ''
 = mk-â‰£ _ (â†ª*-â‹¯â‚› tâ†ª*T Ïƒâ†ª*Ïƒ'') (â†ª*-â‹¯â‚› t'â†ª*T Ïƒ'â†ª*Ïƒ'')

--------------------------------------------------------------------------------

â†ª-â‹¯ :
  âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {Âµâ‚ Âµâ‚‚ m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª t' â†’
  t â‹¯ Ï• â†ª t' â‹¯ Ï•
â†ª-â‹¯ (Î¾-Î» tâ†ªt')  = Î¾-Î» (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ (Î¾-âˆ€â‚ tâ†ªt') = Î¾-âˆ€â‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ (Î¾-âˆ€â‚‚ tâ†ªt') = Î¾-âˆ€â‚‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ (Î¾-Â·â‚ tâ†ªt') = Î¾-Â·â‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ (Î¾-Â·â‚‚ tâ†ªt') = Î¾-Â·â‚‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Ï• = Ï•} (Î²-Î» {eâ‚ = eâ‚} {eâ‚‚ = eâ‚‚}) =
  subst (((Î»x eâ‚) Â· eâ‚‚) â‹¯ Ï• â†ª_)
        (sym (dist-â¦…â¦†â‚›-â‹¯ eâ‚ eâ‚‚ Ï•))
        (Î²-Î» {eâ‚ = eâ‚ â‹¯ (Ï• â†‘ ğ•–)} {eâ‚‚ = eâ‚‚ â‹¯ Ï•})

â†ª-â‹¯â‚› : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ï• : Âµâ‚ â†’â‚› Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª t' â†’
  t â‹¯â‚› Ï• â†ª t' â‹¯â‚› Ï•
â†ª-â‹¯â‚› = â†ª-â‹¯ where instance _ = kitâ‚›; _ = kittâ‚›; _ = ckitâ‚›â‚›; _ = ckitáµ£

â†ª-â‹¯áµ£ : âˆ€ {Âµâ‚ Âµâ‚‚ m} {Ï• : Âµâ‚ â†’áµ£ Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª t' â†’
  t â‹¯áµ£ Ï• â†ª t' â‹¯áµ£ Ï•
â†ª-â‹¯áµ£ = â†ª-â‹¯ where instance _ = kitáµ£; _ = kittáµ£; _ = ckitâ‚›áµ£; _ = ckitáµ£

â‰£-â‹¯ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {Âµâ‚ Âµâ‚‚ m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â‰£ t' â†’
  t â‹¯ Ï• â‰£ t' â‹¯ Ï•
â‰£-â‹¯ = map-â‰£ â†ª-â‹¯

_âŠ¢â‹¯_ :
  âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {e : Âµâ‚ âŠ¢ M} {t : Âµâ‚ âˆ¶âŠ¢ M} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âˆ‹*/âŠ¢*[ IK ] Ï• âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
âŠ¢` âˆ‹x      âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
âŠ¢Î» âŠ¢tâ‚ âŠ¢e  âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î» (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âˆ€ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {e = eâ‚ Â· eâ‚‚} {Ï• = Ï•} (âŠ¢Â· {tâ‚ = tâ‚} {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  Î“â‚‚ âŠ¢ eâ‚ Â· eâ‚‚ â‹¯ Ï• âˆ¶ tâ‚‚ â‹¯â‚› â¦… eâ‚‚ â¦†â‚› â‹¯ Ï•
    by subst (Î“â‚‚ âŠ¢ (eâ‚ Â· eâ‚‚) â‹¯ Ï• âˆ¶_)
             ((tâ‚‚ â‹¯ (Ï• â†‘ ğ•–)) â‹¯â‚› â¦… eâ‚‚ â‹¯ Ï• â¦†â‚› â‰¡âŸ¨ sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚‚ eâ‚‚ Ï•) âŸ©
              tâ‚‚ â‹¯â‚› â¦… eâ‚‚ â¦†â‚› â‹¯ Ï•             âˆ)
             (âŠ¢Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢â˜…         âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â˜…
âŠ¢â‰£ tâ‰£t' âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â‰£ (â‰£-â‹¯ tâ‰£t') (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)

open ITraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

--------------------------------------------------------------------------------

_â‰£*_ : âˆ€ {Âµ} (Î“â‚ Î“â‚‚ : Ctx Âµ) â†’ Set
Î“â‚ â‰£* Î“â‚‚ = âˆ€ {m} (x : _ âˆ‹ m) â†’ Î“â‚ x â‰£ Î“â‚‚ x

â‰£*-refl : âˆ€ {Âµ} {Î“ : Ctx Âµ} â†’
  Î“ â‰£* Î“
â‰£*-refl {m = ğ•–} x = â‰£-refl

â‰£*-ext : âˆ€ {Âµ} {Î“â‚ Î“â‚‚ : Ctx Âµ} {M} {tâ‚ tâ‚‚ : Âµ âŠ¢ M} â†’
  Î“â‚ â‰£* Î“â‚‚ â†’
  tâ‚ â‰£ tâ‚‚ â†’
  (Î“â‚ â–¶ tâ‚) â‰£* (Î“â‚‚ â–¶ tâ‚‚)
â‰£*-ext {M = ğ•–} Î“â‚â‰£Î“â‚‚ tâ‚â‰£tâ‚‚ (here refl) = tâ‚â‰£tâ‚‚
â‰£*-ext {M = M} Î“â‚â‰£Î“â‚‚ tâ‚â‰£tâ‚‚ (there x)   = Î“â‚â‰£Î“â‚‚ x

â‰£*-â†‘ : âˆ€ {Âµ} {Î“â‚ Î“â‚‚ : Ctx Âµ} {M} {t : Âµ âŠ¢ M} â†’
  Î“â‚ â‰£* Î“â‚‚ â†’
  (Î“â‚ â–¶ t) â‰£* (Î“â‚‚ â–¶ t)
â‰£*-â†‘ {M = ğ•–} â‰£Î“ = â‰£*-ext â‰£Î“ â‰£-refl

â†ª-wk : {tâ‚ tâ‚‚ : Âµ âŠ¢ M} â†’
  tâ‚ â†ª tâ‚‚ â†’
  wk m tâ‚ â†ª wk m tâ‚‚
â†ª-wk tâ‚â†ªtâ‚‚ = â†ª-â‹¯áµ£ tâ‚â†ªtâ‚‚

â‰£-wk : {tâ‚ tâ‚‚ : Âµ âŠ¢ M} â†’
  tâ‚ â‰£ tâ‚‚ â†’
  wk m tâ‚ â‰£ wk m tâ‚‚
â‰£-wk = map-â‰£ â†ª-wk

â‰£*-wk-telescope :
  Î“â‚ x â‰£ Î“â‚‚ x â†’
  wk-telescope Î“â‚ x â‰£ wk-telescope Î“â‚‚ x
â‰£*-wk-telescope {x = here refl} eq = â‰£-wk eq
â‰£*-wk-telescope {Î“â‚ = Î“â‚} {x = there x} {Î“â‚‚ = Î“â‚‚}  eq = â‰£-wk (â‰£*-wk-telescope {Î“â‚ = Î» x â†’ Î“â‚ (there x)}
                                                                              {Î“â‚‚ = Î» x â†’ Î“â‚‚ (there x)}
                                                                              eq)

â‰£*-pres : âˆ€ {Âµ} {Î“â‚ Î“â‚‚ : Ctx Âµ} {M} {e : Âµ âŠ¢ M} {t : Âµ âŠ¢ M} â†’
  Î“â‚ â‰£* Î“â‚‚ â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âŠ¢ e âˆ¶ t
â‰£*-pres {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} {M = ğ•–} Î“â‰£ (âŠ¢` {x = x} refl) = âŠ¢â‰£ (â‰£-sym (â‰£*-wk-telescope {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} (Î“â‰£ x))) (âŠ¢` refl)
â‰£*-pres Î“â‰£ (âŠ¢Î» âŠ¢tâ‚ âŠ¢e)  = âŠ¢Î» (â‰£*-pres Î“â‰£ âŠ¢tâ‚) (â‰£*-pres (â‰£*-â†‘ Î“â‰£) âŠ¢e)
â‰£*-pres Î“â‰£ (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚) = âŠ¢âˆ€ (â‰£*-pres Î“â‰£ âŠ¢tâ‚) (â‰£*-pres (â‰£*-â†‘ Î“â‰£) âŠ¢tâ‚‚)
â‰£*-pres Î“â‰£ (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚) = âŠ¢Â· (â‰£*-pres Î“â‰£ âŠ¢eâ‚) (â‰£*-pres Î“â‰£ âŠ¢eâ‚‚)
â‰£*-pres Î“â‰£ âŠ¢â˜…           = âŠ¢â˜…
â‰£*-pres Î“â‰£ (âŠ¢â‰£ tâ‰£t' âŠ¢e) = âŠ¢â‰£ tâ‰£t' (â‰£*-pres Î“â‰£ âŠ¢e)

--------------------------------------------------------------------------------

invert-âŠ¢Î» : âˆ€ {Âµ} {Î“ : Ctx Âµ} {e : (Âµ â–· ğ•–) âŠ¢ ğ•–} {t : Âµ âŠ¢ ğ•–} â†’
    Î“ âŠ¢ Î»x e âˆ¶ t â†’
    âˆƒ[ tâ‚ ] âˆƒ[ tâ‚‚ ]
      t â‰£ âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ Ã—
      Î“ âŠ¢ tâ‚ âˆ¶ â˜… Ã—
      Î“ â–¶ tâ‚ âŠ¢ e âˆ¶ tâ‚‚
invert-âŠ¢Î» (âŠ¢Î» âŠ¢tâ‚ âŠ¢e) = _ , _ , â‰£-refl , âŠ¢tâ‚ , âŠ¢e
invert-âŠ¢Î» (âŠ¢â‰£ tâ‰£t' âŠ¢e) with invert-âŠ¢Î» âŠ¢e
... | tâ‚ , tâ‚‚ , t'â‰£âˆ€[tâ‚]tâ‚‚ , âŠ¢tâ‚ , âŠ¢e = tâ‚ , tâ‚‚ , â‰£-trans (â‰£-sym tâ‰£t') t'â‰£âˆ€[tâ‚]tâ‚‚ , âŠ¢tâ‚ , âŠ¢e

â†ª-âˆ€-shape :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª-âˆ€-shape (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = _ , _ , refl , embed tâ‚â†ªtâ‚' , refl
â†ª-âˆ€-shape (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = _ , _ , refl , refl , embed tâ‚‚â†ªtâ‚‚'

â†ª*-âˆ€-shape :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â†ª* t â†’ 
  âˆƒ[ tâ‚' ] âˆƒ[ tâ‚‚' ] t â‰¡ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' Ã— (tâ‚ â†ª* tâ‚') Ã— (tâ‚‚ â†ª* tâ‚‚')
â†ª*-âˆ€-shape refl = _ , _ , refl , refl , refl
â†ª*-âˆ€-shape (step âˆ€â†ªt tâ†ª*t')
  with â†ª-âˆ€-shape âˆ€â†ªt
...  | tâ‚' , tâ‚‚' , refl , tâ‚â†ª*tâ‚' , tâ‚‚â†ª*tâ‚‚'
  with â†ª*-âˆ€-shape tâ†ª*t'
...  | tâ‚'' , tâ‚‚'' , refl , tâ‚'â†ª*tâ‚'' , tâ‚‚'â†ª*tâ‚‚''
  = tâ‚'' , tâ‚‚'' , refl , â†ª*-trans tâ‚â†ª*tâ‚' tâ‚'â†ª*tâ‚'' , â†ª*-trans tâ‚‚â†ª*tâ‚‚' tâ‚‚'â†ª*tâ‚‚''

invert-â‰£-Î» :
  âˆ€[xâˆ¶ tâ‚ ] tâ‚‚ â‰£ âˆ€[xâˆ¶ tâ‚' ] tâ‚‚' â†’
  tâ‚ â‰£ tâ‚' Ã— tâ‚‚ â‰£ tâ‚‚'
invert-â‰£-Î» (mk-â‰£ t âˆ€â‚â†ª*t âˆ€â‚‚â†ª*t)
  with â†ª*-âˆ€-shape âˆ€â‚â†ª*t                | â†ª*-âˆ€-shape âˆ€â‚‚â†ª*t
... | Tâ‚ , Tâ‚‚ , refl , tâ‚â†ª*Tâ‚ , tâ‚‚â†ª*Tâ‚‚ | .Tâ‚ , .Tâ‚‚ , refl , tâ‚'â†ª*Tâ‚ , tâ‚‚'â†ª*Tâ‚‚
  = mk-â‰£ Tâ‚ tâ‚â†ª*Tâ‚ tâ‚'â†ª*Tâ‚ , mk-â‰£ Tâ‚‚ tâ‚‚â†ª*Tâ‚‚ tâ‚‚'â†ª*Tâ‚‚

--------------------------------------------------------------------------------

subject-reduction :
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (âŠ¢Î» âŠ¢t âŠ¢e)             (Î¾-Î» eâ†ªe')    = âŠ¢Î» âŠ¢t (subject-reduction âŠ¢e eâ†ªe')
subject-reduction {Î“ = Î“} (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚)   (Î¾-âˆ€â‚ tâ‚â†ªtâ‚') = âŠ¢âˆ€ (subject-reduction âŠ¢tâ‚ tâ‚â†ªtâ‚')
                                                            (â‰£*-pres (â‰£*-ext (â‰£*-refl {Î“ = Î“}) (â‰£-â†ª tâ‚â†ªtâ‚')) âŠ¢tâ‚‚)
subject-reduction (âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚)           (Î¾-âˆ€â‚‚ tâ‚‚â†ªtâ‚‚') = âŠ¢âˆ€ âŠ¢tâ‚ (subject-reduction âŠ¢tâ‚‚ tâ‚‚â†ªtâ‚‚')
subject-reduction (âŠ¢Â· {eâ‚‚ = eâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) Î²-Î»           with invert-âŠ¢Î» âŠ¢eâ‚
...                                                       | tâ‚ , tâ‚‚ , âˆ€â‰£âˆ€ , âŠ¢tâ‚ , âŠ¢eâ‚
                                                       with invert-â‰£-Î» âˆ€â‰£âˆ€
...                                                       | tâ‚â‰£tâ‚' , tâ‚‚â‰£tâ‚‚'
                                                       =  âŠ¢â‰£ (â‰£-sym (â‰£-â‹¯â‚› tâ‚‚â‰£tâ‚‚' (â‰£Ïƒ-refl {Ïƒ = â¦… eâ‚‚ â¦†â‚›})))
                                                             (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢â‰£ tâ‚â‰£tâ‚' âŠ¢eâ‚‚ â¦†â‚›)
subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)           (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢â‰£ (â‰£-â‹¯â‚› (â‰£-refl {e = tâ‚‚}) â‰£Ïƒ-â¦… â‰£-â†© eâ‚‚â†ªeâ‚‚' â¦†)
                                                            (âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚'))
subject-reduction (âŠ¢â‰£ tâ‰£t' âŠ¢e)           eâ†ªe'          = âŠ¢â‰£ tâ‰£t' (subject-reduction âŠ¢e eâ†ªe')
