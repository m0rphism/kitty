module Kitty.Examples.LambdaPi-Derive.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Kitty.Examples.LambdaPi-Derive.Definitions
open import Kitty.Typing.IKit compose-traversal kit-type record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢` }
open IKit â¦ƒ â€¦ â¦„
open import Function using () renaming (_âˆ‹_ to _by_)

-- âŠ¢â†ª* :
--     t â†ª* t' â†’
--     Î“ âŠ¢ e âˆ¶ t â†’
--     Î“ âŠ¢ e âˆ¶ t'
-- âŠ¢â†ª* refl âŠ¢e = âŠ¢e
-- âŠ¢â†ª* (step tâ†ªt' t'â†ª*t'') âŠ¢e = âŠ¢â†ª* t'â†ª*t'' (âŠ¢â†ª tâ†ªt' âŠ¢e)

â†ª-â‹¯ : âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {Âµâ‚ Âµâ‚‚ m} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} {t t' : Âµâ‚ âŠ¢ m} â†’
  t â†ª t' â†’
  t â‹¯ Ï• â†ª t' â‹¯ Ï•
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•} {.(Î»x _)}       {.(Î»x _)}       (Î¾-Î» tâ†ªt')  = Î¾-Î» (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•} {.(âˆ€[xâˆ¶ _ ] _)} {.(âˆ€[xâˆ¶ _ ] _)} (Î¾-âˆ€â‚ tâ†ªt') = Î¾-âˆ€â‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•} {.(âˆ€[xâˆ¶ _ ] _)} {.(âˆ€[xâˆ¶ _ ] _)} (Î¾-âˆ€â‚‚ tâ†ªt') = Î¾-âˆ€â‚‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•} {.(_ Â· _)}      {.(_ Â· _)}      (Î¾-Â·â‚ tâ†ªt') = Î¾-Â·â‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•} {.(_ Â· _)}      {.(_ Â· _)}      (Î¾-Â·â‚‚ tâ†ªt') = Î¾-Â·â‚‚ (â†ª-â‹¯ tâ†ªt')
â†ª-â‹¯ {Âµâ‚} {Âµâ‚‚} {.ğ•–} {Ï•}
    {.((Î»x eâ‚) Â· eâ‚‚)}
    {.(eâ‚ â‹¯ â¦… eâ‚‚ â¦†â‚›)}
    (Î²-Î» {eâ‚ = eâ‚} {eâ‚‚ = eâ‚‚}) =
  subst (((Î»x eâ‚) Â· eâ‚‚) â‹¯ Ï• â†ª_)
        (sym (dist-â¦…â¦†â‚›-â‹¯ eâ‚ eâ‚‚ Ï•))
        (Î²-Î» {eâ‚ = eâ‚ â‹¯ (Ï• â†‘ ğ•–)} {eâ‚‚ = eâ‚‚ â‹¯ Ï•})

_âŠ¢â‹¯_ :
  âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
    â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
    â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
    â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {e : Âµâ‚ âŠ¢ M} {t : Âµâ‚ âˆ¶âŠ¢ M} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âˆ‹*/âŠ¢*[ IK ] Ï• âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
âŠ¢` âˆ‹x      âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
âŠ¢Î» âŠ¢tâ‚ âŠ¢e  âŠ¢â‹¯ âŠ¢Ï• = âŠ¢Î» (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
âŠ¢âˆ€ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢â‹¯ âŠ¢Ï• = âŠ¢âˆ€ (âŠ¢tâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢tâ‚‚ âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _))
_âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {e = eâ‚ Â· eâ‚‚} {Ï• = Ï•} (âŠ¢Â· {tâ‚ = tâ‚} {tâ‚‚ = tâ‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ï• =
  Î“â‚‚ âŠ¢ eâ‚ Â· eâ‚‚ â‹¯ Ï• âˆ¶ tâ‚‚ â‹¯â‚› â¦… tâ‚ â¦†â‚› â‹¯ Ï•
    by subst (Î“â‚‚ âŠ¢ (eâ‚ Â· eâ‚‚) â‹¯ Ï• âˆ¶_)
             ((tâ‚‚ â‹¯ (Ï• â†‘ ğ•–)) â‹¯â‚› â¦… tâ‚ â‹¯ Ï• â¦†â‚› â‰¡âŸ¨ sym (dist-â¦…â¦†â‚›-â‹¯ tâ‚‚ tâ‚ Ï•) âŸ©
              tâ‚‚ â‹¯â‚› â¦… tâ‚ â¦†â‚› â‹¯ Ï•             âˆ)
             (âŠ¢Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•))
âŠ¢â˜…         âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â˜…
âŠ¢â†ª tâ†ªt' âŠ¢e âŠ¢â‹¯ âŠ¢Ï• = âŠ¢â†ª (â†ª-â‹¯ tâ†ªt') (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)

open ITraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

-- subject-reduction :
--   Î“ âŠ¢ e âˆ¶ t â†’
--   e â†ª e' â†’
--   Î“ âŠ¢ e' âˆ¶ t
-- subject-reduction (âŠ¢Â· {tâ‚‚ = tâ‚‚} (âŠ¢Î» âŠ¢eâ‚) âŠ¢eâ‚‚)   Î²-Î»          = subst (_ âŠ¢ _ âˆ¶_) (wk-cancels-â¦…â¦† tâ‚‚ _) (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢eâ‚‚ â¦†)
-- subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (âŠ¢Î› âŠ¢eâ‚))         Î²-Î›          = âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢tâ‚‚ â¦†
-- subject-reduction (âŠ¢Î» âŠ¢e)                      (Î¾-Î» eâ†ªe')    = âŠ¢Î» (subject-reduction âŠ¢e eâ†ªe')
-- subject-reduction (âŠ¢Î› âŠ¢e)                      (Î¾-Î› eâ†ªe')    = âŠ¢Î› (subject-reduction âŠ¢e eâ†ªe')
-- subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚ eâ‚â†ªeâ‚') = âŠ¢Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
-- subject-reduction (âŠ¢Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚') = âŠ¢Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
-- subject-reduction (âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ âŠ¢eâ‚)             (Î¾-âˆ™â‚ eâ‚â†ªeâ‚') = âŠ¢âˆ™ âŠ¢tâ‚ âŠ¢tâ‚‚ (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚')
