module Kitty.Examples.STLC-Pat.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; cong; subst; substâ‚‚; module â‰¡-Reasoning)
open import Data.Product using (âˆƒ-syntax; Î£-syntax; _Ã—_; _,_)
open â‰¡-Reasoning
open import Kitty.Examples.STLC-Pat.Definitions
open import Function using () renaming (_âˆ‹_ to _by_)

open import Kitty.Typing.ITerms compose-traversal ctx-repr

â‰¡á¶œ-cong-âŠ¢ : âˆ€ {Âµ M} {Î“â‚ Î“â‚‚ : Ctx Âµ} {e : Âµ âŠ¢ M} {t : Âµ âˆ¶âŠ¢ M} â†’ 
  Î“â‚ â‰¡á¶œ Î“â‚‚ â†’
  Î“â‚ âŠ¢ e âˆ¶ t â†’
  Î“â‚‚ âŠ¢ e âˆ¶ t
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-` {x = x} âˆ‹x)               = âŠ¢-` (â‰¡á¶œ-cong-âˆ‹ x Î“â‚â‰¡Î“â‚‚ âˆ‹x)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-Î» âŠ¢e)                       = âŠ¢-Î» (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶ Î“â‚â‰¡Î“â‚‚ refl) âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                  = âŠ¢-Â· (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-tt                           = âŠ¢-tt
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-, âŠ¢eâ‚ âŠ¢eâ‚‚)                  = âŠ¢-, (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢eâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚ âŠ¢e)                    = âŠ¢-injâ‚ (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚‚ âŠ¢e)                    = âŠ¢-injâ‚‚ (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-match âŠ¢e âŠ¢cs ex)            = âŠ¢-match (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢e) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢cs) ex
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-clause {P = P} âŠ¢p âŠ¢e)       = âŠ¢-clause (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)
                                                          (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶â–¶ {Î“â‚' = PatTyâ†’Ctx' P} Î“â‚â‰¡Î“â‚‚ â‰¡á¶œ-refl) âŠ¢e)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-clause-[]                    = âŠ¢-clause-[]
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-clause-âˆ· âŠ¢c âŠ¢cs)            = âŠ¢-clause-âˆ· (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢c) (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢cs)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-ttáµ–                          = âŠ¢-ttáµ–
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢-`áµ–                           = âŠ¢-`áµ–
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-,áµ– {Pâ‚ = Pâ‚} âŠ¢pâ‚ âŠ¢pâ‚‚)       = âŠ¢-,áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢pâ‚) (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶â–¶ {Î“â‚' = PatTyâ†’Ctx' Pâ‚} Î“â‚â‰¡Î“â‚‚ â‰¡á¶œ-refl) âŠ¢pâ‚‚)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚áµ– âŠ¢p)                   = âŠ¢-injâ‚áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)
â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ (âŠ¢-injâ‚‚áµ– âŠ¢p)                   = âŠ¢-injâ‚‚áµ– (â‰¡á¶œ-cong-âŠ¢ Î“â‚â‰¡Î“â‚‚ âŠ¢p)

iterms : ITerms
iterms = record { _âŠ¢_âˆ¶_ = _âŠ¢_âˆ¶_ ; âŠ¢` = âŠ¢-`; â‰¡á¶œ-cong-âŠ¢ = â‰¡á¶œ-cong-âŠ¢ }
open ITerms iterms using (_âŠ¢*_âˆ¶_)

open import Kitty.Typing.IKit compose-traversal ctx-repr iterms
  
open IKit â¦ƒ â€¦ â¦„

open import Kitty.Term.MultiSub terms using (_â†‘*'_; â†‘*'~â†‘*)
mutual
  _âŠ¢â‹¯_ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {Âµâ‚ Âµâ‚‚ M} {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {e : Âµâ‚ âŠ¢ M} {t : Âµâ‚ âˆ¶âŠ¢ M} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Î“â‚ âŠ¢ e âˆ¶ t â†’
    Î“â‚‚ âˆ‹*/âŠ¢*[ IK ] Ï• âˆ¶ Î“â‚ â†’
    Î“â‚‚ âŠ¢ e â‹¯ Ï• âˆ¶ t â‹¯ Ï•
  âŠ¢-` âˆ‹x               âŠ¢â‹¯ âŠ¢Ï• = âŠ¢`/id (âŠ¢Ï• _ _ âˆ‹x)
  âŠ¢-Î» {tâ‚‚ = tâ‚‚} âŠ¢e     âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-Î» (subst (_ âŠ¢ _ âˆ¶_) (dist-â†‘-f tâ‚‚ _) (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘/âŠ¢â†‘ _)))
  âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-Â· (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-tt                 âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-tt
  âŠ¢-, âŠ¢eâ‚ âŠ¢eâ‚‚          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-, (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢eâ‚‚ âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚ âŠ¢e            âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚‚ âŠ¢e            âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚‚ (âŠ¢e âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-match âŠ¢eâ‚ âŠ¢cs ex   âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-match (âŠ¢eâ‚ âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢cs âŠ¢â‹¯ âŠ¢Ï•) (Exâ‹¯ ex)
  _âŠ¢â‹¯_ {Î“â‚‚ = Î“â‚‚} {Ï• = Ï•} (âŠ¢-clause {Âµ' = Âµ'} {P = P} {e = e} {t' = t'} âŠ¢p âŠ¢e) âŠ¢Ï• =
    âŠ¢-clause (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•)
      (â‰¡á¶œ-cong-âŠ¢ (â‰¡á¶œ-cong-â–¶â–¶ (â‰¡á¶œ-refl {Î“ = Î“â‚‚}) (PatTyâ†’Ctx'-â‹¯ P (Ï• â†‘* _)))
        (substâ‚‚ ((Î“â‚‚ â–¶â–¶ (PatTyâ†’Ctx' P â‹¯Ctx' Ï•)) âŠ¢_âˆ¶_)
          (e â‹¯ Ï• â†‘* Âµ' â‰¡âŸ¨ ~-cong-â‹¯ e (~-sym {f = Ï• â†‘*' Âµ'} {g = Ï• â†‘* Âµ'} (â†‘*'~â†‘* Âµ')) âŸ©
            e â‹¯ Ï• â†‘*' Âµ' âˆ)
          (wk* Âµ' t' â‹¯ Ï• â†‘* Âµ'        â‰¡âŸ¨ cong (_â‹¯ Ï• â†‘* Âµ') (wk*-wkâ‚–* t' Âµ') âŸ©
           t' â‹¯áµ£ wkâ‚–* Âµ' id â‹¯ Ï• â†‘* Âµ' â‰¡âŸ¨ dist-â†‘*-f t' Ï• âŸ©
           t' â‹¯ Ï• â‹¯áµ£ wkâ‚–* Âµ' id       â‰¡âŸ¨ sym (wk*-wkâ‚–* (t' â‹¯ Ï•) Âµ') âŸ©
           wk* Âµ' (t' â‹¯ Ï•)            âˆ)
          (âŠ¢e âŠ¢â‹¯ (âŠ¢Ï• âˆ‹â†‘*/âŠ¢â†‘* _))))
  âŠ¢-clause-[]          âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-clause-[]
  âŠ¢-clause-âˆ· âŠ¢c âŠ¢cs    âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-clause-âˆ· (âŠ¢c âŠ¢â‹¯ âŠ¢Ï•) (âŠ¢cs âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-ttáµ–                âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-ttáµ–
  âŠ¢-`áµ–                 âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-`áµ–
  _âŠ¢â‹¯_ {Âµâ‚} {Âµâ‚‚} {_} {Î“â‚} {Î“â‚‚} {_} {_} {Ï•} (âŠ¢-,áµ– {Âµâ‚ = Âµâ‚ƒ} {pâ‚ = pâ‚} {Pâ‚ = Pâ‚} {pâ‚‚ = pâ‚‚} {Pâ‚‚ = Pâ‚‚} âŠ¢pâ‚ âŠ¢pâ‚‚) âŠ¢Ï• =
    Î“â‚‚ âŠ¢ (pâ‚ ,áµ– pâ‚‚) â‹¯ Ï• âˆ¶ (Pâ‚ â–¶â–¶áµ– Pâ‚‚) â‹¯ Ï•
      by substâ‚‚ (Î“â‚‚ âŠ¢_âˆ¶_)

        ((pâ‚ â‹¯ Ï•) ,áµ– (pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚ƒ)  â‰¡âŸ¨ cong ((pâ‚ â‹¯ Ï•) ,áµ–_)
                                             (~-cong-â‹¯ pâ‚‚ (~-sym {f = Ï• â†‘*' Âµâ‚ƒ} {g = Ï• â†‘* Âµâ‚ƒ} (â†‘*'~â†‘* Âµâ‚ƒ))) âŸ©
         (pâ‚ â‹¯ Ï•) ,áµ– (pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚ƒ) â‰¡âŸ¨âŸ©
         (pâ‚ ,áµ– pâ‚‚) â‹¯ Ï•              âˆ)

        ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚ƒ) â‰¡âŸ¨ â–¶â–¶áµ–â‹¯ Pâ‚ Pâ‚‚ Ï• âŸ©
         (Pâ‚ â–¶â–¶áµ– Pâ‚‚) â‹¯ Ï•             âˆ)

        (
    Î“â‚‚ âŠ¢ ((pâ‚ â‹¯ Ï•) ,áµ– (pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚ƒ)) âˆ¶ ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚ƒ))
      by âŠ¢-,áµ– (âŠ¢pâ‚ âŠ¢â‹¯ âŠ¢Ï•)
              (âŠ¢pâ‚‚ âŠ¢â‹¯ â‰¡á¶œ-cong-âˆ‹*/âŠ¢* (â‰¡á¶œ-cong-â–¶â–¶ (â‰¡á¶œ-refl {Î“ = Î“â‚‚}) (PatTyâ†’Ctx'-â‹¯ Pâ‚ Ï•)) (âŠ¢Ï• âˆ‹â†‘*/âŠ¢â†‘* PatTyâ†’Ctx' Pâ‚))
    )
  âŠ¢-injâ‚áµ– âŠ¢p           âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚áµ– (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•)
  âŠ¢-injâ‚‚áµ– âŠ¢p           âŠ¢â‹¯ âŠ¢Ï• = âŠ¢-injâ‚‚áµ– (âŠ¢p âŠ¢â‹¯ âŠ¢Ï•)

  open import Data.List.Properties using (++-assoc)
  open import Kitty.Util.SubstProperties
  â–¶â–¶áµ–â‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {Âµâ‚ Âµâ‚‚ Âµâ‚ƒ Âµâ‚'} (Pâ‚ : Âµâ‚ âŠ¢ â„™ Âµâ‚‚) (Pâ‚‚ : (Âµâ‚ â–·â–· Âµâ‚‚) âŠ¢ â„™ Âµâ‚ƒ) (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚') â†’
    (Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚‚) â‰¡ (Pâ‚ â–¶â–¶áµ– Pâ‚‚) â‹¯ Ï•
  â–¶â–¶áµ–â‹¯ {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ}       {Âµâ‚'} Pâ‚ (`[_]_ {m = ğ•–} () x) Ï•
  â–¶â–¶áµ–â‹¯ {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {.[]}      {Âµâ‚'} Pâ‚ []áµ–       Ï• = refl
  â–¶â–¶áµ–â‹¯ {Âµâ‚ = Âµâ‚} {Âµâ‚‚} {Âµâ‚ƒ â–· ğ•–}   {Âµâ‚'} Pâ‚ (Pâ‚‚ â–¶áµ– t) Ï• =
    let sub = subst (_âŠ¢ ğ•¥) (sym (++-assoc Âµâ‚ƒ Âµâ‚‚ Âµâ‚)) in
    let sub' = subst (_âŠ¢ ğ•¥) (sym (++-assoc Âµâ‚ƒ Âµâ‚‚ Âµâ‚')) in
    let sub'â»Â¹ = subst (_âŠ¢ ğ•¥) (++-assoc Âµâ‚ƒ Âµâ‚‚ Âµâ‚') in
    (Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– ((Pâ‚‚ â–¶áµ– t) â‹¯ Ï• â†‘* Âµâ‚‚)                           â‰¡âŸ¨ cong ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ–_)
                                                                         (~-cong-â‹¯ (Pâ‚‚ â–¶áµ– t) (~-sym {f = Ï• â†‘*' Âµâ‚‚}
                                                                                                    {g = Ï• â†‘* Âµâ‚‚}
                                                                                                    (â†‘*'~â†‘* Âµâ‚‚))) âŸ©
    (Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– ((Pâ‚‚ â–¶áµ– t) â‹¯ Ï• â†‘*' Âµâ‚‚)                          â‰¡âŸ¨âŸ©
    (Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– ((Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚) â–¶áµ– (t â‹¯ Ï• â†‘*' Âµâ‚‚ â†‘*' Âµâ‚ƒ))      â‰¡âŸ¨âŸ©
    ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚)) â–¶áµ– sub' (t â‹¯ Ï• â†‘*' Âµâ‚‚ â†‘*' Âµâ‚ƒ) â‰¡âŸ¨ cong (Î» â–  â†’ ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚)) â–¶áµ– sub' â– )
         (t â‹¯ Ï• â†‘*' Âµâ‚‚ â†‘*' Âµâ‚ƒ              â‰¡âŸ¨ ~-cong-â‹¯ t (â†‘*'~â†‘* {Ï• = Ï• â†‘*' Âµâ‚‚} Âµâ‚ƒ) âŸ©
          t â‹¯ Ï• â†‘*' Âµâ‚‚ â†‘* Âµâ‚ƒ               â‰¡âŸ¨ ~-cong-â‹¯ t (~-cong-â†‘* {Âµ = Âµâ‚ƒ} (â†‘*'~â†‘* {Ï• = Ï•} Âµâ‚‚)) âŸ©
          t â‹¯ Ï• â†‘* Âµâ‚‚ â†‘* Âµâ‚ƒ                â‰¡âŸ¨ â‹¯-â†‘*-â–·â–· Âµâ‚‚ Âµâ‚ƒ t Ï• âŸ©
          sub'â»Â¹ (sub t â‹¯ Ï• â†‘* (Âµâ‚‚ â–·â–· Âµâ‚ƒ)) â‰¡âŸ¨ cong sub'â»Â¹ (~-cong-â‹¯ (sub t) (~-sym {f = Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)} {g = Ï• â†‘* (Âµâ‚‚ â–·â–· Âµâ‚ƒ)} (â†‘*'~â†‘* (Âµâ‚‚ â–·â–· Âµâ‚ƒ)))) âŸ©
          sub'â»Â¹ (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)) âˆ)
       âŸ©
    ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚)) â–¶áµ– sub' (sub'â»Â¹ (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)))
                                                                 â‰¡âŸ¨ cong (((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚)) â–¶áµ–_)
                                                                      (cancel-subst (_âŠ¢ ğ•¥) (++-assoc Âµâ‚ƒ Âµâ‚‚ Âµâ‚') _) âŸ©
    ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘*' Âµâ‚‚)) â–¶áµ– (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)) â‰¡âŸ¨ cong (Î» â–  â†’ ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– â– ) â–¶áµ– (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)))
                                                                         (~-cong-â‹¯ Pâ‚‚ (â†‘*'~â†‘* Âµâ‚‚)) âŸ©
    ((Pâ‚ â‹¯ Ï•) â–¶â–¶áµ– (Pâ‚‚ â‹¯ Ï• â†‘* Âµâ‚‚)) â–¶áµ– (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ))  â‰¡âŸ¨ cong (_â–¶áµ– (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ)))
                                                                         (â–¶â–¶áµ–â‹¯ Pâ‚ Pâ‚‚ Ï•) âŸ©
    ((Pâ‚ â–¶â–¶áµ– Pâ‚‚) â‹¯ Ï•) â–¶áµ– (sub t â‹¯ Ï• â†‘*' (Âµâ‚‚ â–·â–· Âµâ‚ƒ))              â‰¡âŸ¨âŸ©
    ((Pâ‚ â–¶â–¶áµ– Pâ‚‚) â–¶áµ– sub t) â‹¯ Ï•                                   â‰¡âŸ¨âŸ©
    (Pâ‚ â–¶â–¶áµ– (Pâ‚‚ â–¶áµ– t)) â‹¯ Ï•                                       âˆ

  open import Kitty.Util.List
  open import Data.List.Relation.Unary.Any using (here; there)
  PatTyâ†’Ctx'-â‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {Âµâ‚ Âµâ‚‚ Âµ'} (P : Âµâ‚ âŠ¢ â„™ Âµ') (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    (PatTyâ†’Ctx' P) â‹¯Ctx' Ï• â‰¡á¶œ PatTyâ†’Ctx' (P â‹¯ Ï•)
  PatTyâ†’Ctx'-â‹¯ (`[_]_ {m = ğ•–} () _) Ï•
  PatTyâ†’Ctx'-â‹¯ []áµ–        Ï• _ ()
  PatTyâ†’Ctx'-â‹¯ {Âµ' = Âµ' â–· m'} (Pâ‚ â–¶áµ– Pâ‚‚) Ï• m x@(here refl) =
    (PatTyâ†’Ctx' (Pâ‚ â–¶áµ– Pâ‚‚) â‹¯Ctx' Ï•) m x â‰¡âŸ¨âŸ©
    Pâ‚‚ â‹¯ (Ï• â†‘* Âµ')                      â‰¡âŸ¨ ~-cong-â‹¯ Pâ‚‚ (~-sym {f = Ï• â†‘*' Âµ'} {g = Ï• â†‘* Âµ'} (â†‘*'~â†‘* Âµ')) âŸ©
    Pâ‚‚ â‹¯ (Ï• â†‘*' Âµ')                     â‰¡âŸ¨ refl âŸ©
    (PatTyâ†’Ctx' ((Pâ‚ â–¶áµ– Pâ‚‚) â‹¯ Ï•)) m x   âˆ
  PatTyâ†’Ctx'-â‹¯ {Âµ' = Âµ' â–· m'} (Pâ‚ â–¶áµ– Pâ‚‚) Ï• m x@(there y) =
    (PatTyâ†’Ctx' (Pâ‚ â–¶áµ– Pâ‚‚) â‹¯Ctx' Ï•) m x                   â‰¡âŸ¨âŸ©
    PatTyâ†’Ctx' Pâ‚ m y â‹¯ (Ï• â†‘* drop-âˆˆ x (Âµ' â–· m'))         â‰¡âŸ¨âŸ©
    (PatTyâ†’Ctx' Pâ‚ â‹¯Ctx' Ï• â–¶' (Pâ‚‚ â‹¯ (Ï• â†‘*' _))) m x       â‰¡âŸ¨ â‰¡á¶œ-cong-â–¶' {tâ‚ = Pâ‚‚ â‹¯ (Ï• â†‘*' _)} (PatTyâ†’Ctx'-â‹¯ Pâ‚ Ï•) refl m x âŸ©
    (PatTyâ†’Ctx' (Pâ‚ â‹¯ Ï•) â–¶' (Pâ‚‚ â‹¯ (Ï• â†‘*' _))) m x         â‰¡âŸ¨âŸ©
    (PatTyâ†’Ctx' ((Pâ‚ â–¶áµ– Pâ‚‚) â‹¯ Ï•)) m x                     âˆ

  -- Canâ‹¯' :
  --   âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
  --     â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
  --     â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
  --     â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
  --     {e : Âµ âŠ¢ ğ•–} {t : Âµâ‚ âŠ¢ ğ•¥} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
  --   Canonical e t â†’
  --   Canonical e (t â‹¯ Ï•)
  -- Canâ‹¯' Ï• C-Î»             = C-Î»
  -- Canâ‹¯' Ï• C-tt            = C-tt
  -- Canâ‹¯' Ï• (C-, canâ‚ canâ‚‚) = C-, (Canâ‹¯' Ï• canâ‚) (Canâ‹¯' Ï• canâ‚‚)
  -- Canâ‹¯' Ï• (C-injâ‚ can)    = C-injâ‚ (Canâ‹¯' Ï• can)
  -- Canâ‹¯' Ï• (C-injâ‚‚ can)    = C-injâ‚‚ (Canâ‹¯' Ï• can)

  Canâ‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {e : Âµ âŠ¢ ğ•–} {t : Âµâ‚ âŠ¢ ğ•¥} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Canonical e (t â‹¯ Ï•) â†’
    Canonical e t
  Canâ‹¯ {e = e}         {`[_]_ {m = ğ•–} () x} {Ï•} can
  Canâ‹¯ {e = .(Î»x _)}   {tâ‚ `â†’ tâ‚‚} {Ï•} C-Î»             = C-Î»
  Canâ‹¯ {e = .tt}       {ğŸ™}        {Ï•} C-tt            = C-tt
  Canâ‹¯ {e = .(_ , _)}  {tâ‚ `Ã— tâ‚‚} {Ï•} (C-, canâ‚ canâ‚‚) = C-, (Canâ‹¯ canâ‚) (Canâ‹¯ canâ‚‚)
  Canâ‹¯ {e = .(injâ‚ _)} {tâ‚ `âŠ tâ‚‚} {Ï•} (C-injâ‚ can)    = C-injâ‚ (Canâ‹¯ can)
  Canâ‹¯ {e = .(injâ‚‚ _)} {tâ‚ `âŠ tâ‚‚} {Ï•} (C-injâ‚‚ can)    = C-injâ‚‚ (Canâ‹¯ can)

  Matchesâ‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {e : Âµâ‚ âŠ¢ ğ•–} {p : Âµâ‚‚ âŠ¢ ğ•¡ Âµ'} (Ï• : Âµâ‚‚ â€“[ ğ•‚ ]â†’ Âµâ‚ƒ) â†’
    Matches e p â†’
    Matches e (p â‹¯ Ï•)
  Matchesâ‹¯ Ï• M-`         = M-`
  Matchesâ‹¯ Ï• M-tt        = M-tt
  Matchesâ‹¯ Ï• (M-, mâ‚ mâ‚‚) = M-, (Matchesâ‹¯ Ï• mâ‚) (Matchesâ‹¯ (Ï• â†‘*' _) mâ‚‚)
  Matchesâ‹¯ Ï• (M-injâ‚ m)  = M-injâ‚ (Matchesâ‹¯ Ï• m)
  Matchesâ‹¯ Ï• (M-injâ‚‚ m)  = M-injâ‚‚ (Matchesâ‹¯ Ï• m)

  -- âˆˆcs-â‹¯ :
  --   âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
  --     â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
  --     â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
  --     â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
  --   {p : Âµâ‚ âŠ¢ ğ•¡ Âµ'} {e : Âµâ‚ â–·â–· Âµ' âŠ¢ ğ•–} {cs : Âµâ‚ âŠ¢ ğ•”ğ•¤} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
  --   (p â‡’ e) âˆˆcs cs â†’
  --   ((p â‹¯ Ï•) â‡’ (e â‹¯ Ï• â†‘* Âµ')) âˆˆcs (cs â‹¯ Ï•)
  -- âˆˆcs-â‹¯ = {!!}

  âˆˆcs-â‹¯ :
    âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
    {c : Âµâ‚ âŠ¢ ğ•”} {cs : Âµâ‚ âŠ¢ ğ•”ğ•¤} (Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚) â†’
    c âˆˆcs cs â†’
    (c â‹¯ Ï•) âˆˆcs (cs â‹¯ Ï•)
  âˆˆcs-â‹¯ Ï• (here refl) = here refl
  âˆˆcs-â‹¯ Ï• (there x) = there (âˆˆcs-â‹¯ Ï• x)

  Exâ‹¯ :
      âˆ€ â¦ƒ ğ•‚ : Kit â¦„ â¦ƒ K : KitT ğ•‚ â¦„ â¦ƒ Câ‚ : ComposeKit ğ•‚ kitáµ£ ğ•‚ â¦„ â¦ƒ Câ‚‚ : ComposeKit ğ•‚ ğ•‚ ğ•‚ â¦„
      â¦ƒ IK : IKit ğ•‚ K Câ‚ Câ‚‚ â¦„
      â¦ƒ Câ‚ƒ : ComposeKit kitâ‚› ğ•‚ kitâ‚› â¦„
      â¦ƒ Câ‚„ : ComposeKit ğ•‚ kitâ‚› kitâ‚› â¦„
      {cs : Âµâ‚ âŠ¢ ğ•”ğ•¤} {t : Âµâ‚ âŠ¢ ğ•¥} {Ï• : Âµâ‚ â€“[ ğ•‚ ]â†’ Âµâ‚‚} â†’
    Exhaustive cs t â†’
    Exhaustive (cs â‹¯ Ï•) (t â‹¯ Ï•)
  Exâ‹¯ {cs = cs} {t} {Ï•} ex {e = e} can with ex (Canâ‹¯ {e = e} {t = t} {Ï• = Ï•} can)
  ... | Âµ'' , p , e' , câˆˆcs , m =
    Âµ'' , p â‹¯ Ï• , e' â‹¯ (Ï• â†‘*' Âµ'') , âˆˆcs-â‹¯ Ï• câˆˆcs , Matchesâ‹¯ Ï• m

open ITraversal record { _âŠ¢â‹¯_ = _âŠ¢â‹¯_ } public hiding (_âŠ¢â‹¯_)

âŠ¢csâ†’âŠ¢c : âˆ€ {c : Âµ âŠ¢ ğ•”} {cs : Âµ âŠ¢ ğ•”ğ•¤} {tâ‚ tâ‚‚ : Âµ âŠ¢ ğ•¥} â†’
  c âˆˆcs cs â†’
  Î“ âŠ¢ cs âˆ¶ Clause tâ‚ tâ‚‚ â†’
  Î“ âŠ¢ c  âˆ¶ Clause tâ‚ tâ‚‚
âŠ¢csâ†’âŠ¢c (here refl) (âŠ¢-clause-âˆ· âŠ¢c âŠ¢cs) = âŠ¢c
âŠ¢csâ†’âŠ¢c (there x)   (âŠ¢-clause-âˆ· âŠ¢c âŠ¢cs) = âŠ¢csâ†’âŠ¢c x âŠ¢cs

âŠ¢matching-sub : âˆ€ {Âµ Âµ'} {Î“ : Ctx Âµ} {e : Âµ âŠ¢ ğ•–} {t : Âµ âŠ¢ ğ•¥} {p : Âµ âŠ¢ ğ•¡ Âµ'} {P : Âµ âŠ¢ â„™ Âµ'} â†’
  (m : Matches e p) â†’
  Î“ âŠ¢ e âˆ¶ t â†’
  Î“ âŠ¢ p âˆ¶ P â†’
  Î“ âŠ¢* matching-sub m âˆ¶ PatTyâ†’Ctx' P via idâ‚›
  -- Î“ âŠ¢* matching-sub m âˆ¶ {!Î“ â–¶â–¶ PatTyâ†’Ctx' P!}
âŠ¢matching-sub M-`         âŠ¢e âŠ¢p x _ refl = {!!}
   -- Goal : Î“ âŠ¢ x & â¦… e â¦†â‚›â‚€ âˆ¶ wk-telescope' (PatTyâ†’Ctx' P) x â‹¯ idâ‚› ,â‚– e
âŠ¢matching-sub M-tt        âŠ¢e âŠ¢p x _ refl = {!!}
âŠ¢matching-sub (M-, mâ‚ mâ‚‚) âŠ¢e âŠ¢p x _ refl = {!!}
âŠ¢matching-sub (M-injâ‚ m)  âŠ¢e âŠ¢p x _ refl = {!!}
âŠ¢matching-sub (M-injâ‚‚ m)  âŠ¢e âŠ¢p x _ refl = {!!}

subject-reduction :
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (âŠ¢-Â· {tâ‚‚ = tâ‚‚} (âŠ¢-Î» âŠ¢eâ‚) âŠ¢eâ‚‚) Î²-Î»                   = subst (_ âŠ¢ _ âˆ¶_) (wk-cancels-â¦…â¦† tâ‚‚ _) (âŠ¢eâ‚ âŠ¢â‹¯â‚› âŠ¢â¦… âŠ¢eâ‚‚ â¦†)
subject-reduction {Î“ = Î“} (âŠ¢-match âŠ¢e âŠ¢cs ex)           (Î²-match câˆˆcs m refl) with âŠ¢csâ†’âŠ¢c câˆˆcs âŠ¢cs
...                                                                   | âŠ¢-clause âŠ¢p âŠ¢e'
                                                                      -- = {!âŠ¢e' âŠ¢â‹¯â‚› (âŠ¢id âŠ¢âˆ¥â‚› {!!})!}
                                                                      = substâ‚‚ (Î“ âŠ¢_âˆ¶_) refl {!!} (âŠ¢e' âŠ¢â‹¯â‚› ({!âŠ¢idâ‚› âŠ¢âˆ¥â‚› ?!}))
-- Goal: (Î“ âŠ¢* (idâ‚› âˆ¥ (matching-sub m)) âˆ¶ Î“ â–¶â–¶ PatTyâ†’Ctx' P
-- Have: (Î“ âŠ¢* idâ‚› âˆ¥ _Ï•â‚‚)               âˆ¶ Î“ â–¶â–¶ wk*-Ctx _Âµ _Î“â‚‚
                                                                      -- = substâ‚‚ (_ âŠ¢_âˆ¶_) {!!} {!!}
                                                                      --          (âŠ¢e' âŠ¢â‹¯â‚› ({!âŠ¢id!} âŠ¢âˆ¥â‚› {!!}))
subject-reduction (âŠ¢-Î» âŠ¢e)                      (Î¾-Î» eâ†ªe')            = âŠ¢-Î» (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚ eâ‚â†ªeâ‚')         = âŠ¢-Â· (subject-reduction âŠ¢eâ‚ eâ‚â†ªeâ‚') âŠ¢eâ‚‚
subject-reduction (âŠ¢-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)                 (Î¾-Â·â‚‚ eâ‚‚â†ªeâ‚‚')         = âŠ¢-Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ‚‚â†ªeâ‚‚')
