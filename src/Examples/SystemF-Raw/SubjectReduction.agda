module Examples.SystemF-Raw.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; trans; cong; congâ‚‚; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Data.List using (List; []; _âˆ·_; drop)
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.Unit using (âŠ¤; tt)
open import Function using () renaming (_âˆ‹_ to _by_)

open import Examples.SystemF-Raw.Definitions
open Kit {{...}}

-- Soundness -------------------------------------------------------------------

postulate
  fun-ext : âˆ€ {A : Set â„“â‚} {B : A â†’ Set â„“â‚‚} {f g : (x : A) â†’ B x} â†’
    (âˆ€ (x : A) â†’ f x â‰¡ g x) â†’
    f â‰¡ g

fun-extâ‚‚ : âˆ€ {Aâ‚ : Set â„“â‚} {Aâ‚‚ : Aâ‚ â†’ Set â„“â‚‚} {B : (x : Aâ‚) â†’ Aâ‚‚ x â†’ Set â„“â‚ƒ}
             {f g : (x : Aâ‚) â†’ (y : Aâ‚‚ x) â†’ B x y} â†’
    (âˆ€ (x : Aâ‚) (y : Aâ‚‚ x) â†’ f x y â‰¡ g x y) â†’
    f â‰¡ g
fun-extâ‚‚ h = fun-ext Î» x â†’ fun-ext Î» y â†’ h x y

idâ†‘â‰¡id : âˆ€ {{K : Kit}} m Âµ â†’
  idâ‚– {Âµ = Âµ} {{K}} â†‘ m â‰¡ idâ‚– {Âµ = m âˆ· Âµ} {{K}}
idâ†‘â‰¡id m Âµ = fun-extâ‚‚ Î» where
  _ (here _)  â†’ refl
  _ (there x) â†’ wk-id/` m x

â‹¯-id : âˆ€ {{K : Kit}} (t : Term Âµ m) â†’
  t â‹¯ idâ‚– {{K}} â‰¡ t
â‹¯-id               (` x)                             = id/`/id x
â‹¯-id {Âµ = Âµ} {{K}} (Î»x t)   rewrite idâ†‘â‰¡id {{K}} ğ•§ Âµ = cong Î»x_ (â‹¯-id t)
â‹¯-id {Âµ = Âµ} {{K}} (Î›Î± t)   rewrite idâ†‘â‰¡id {{K}} ğ•¥ Âµ = cong Î›Î±_ (â‹¯-id t)
â‹¯-id {Âµ = Âµ} {{K}} (âˆ€Î± t)   rewrite idâ†‘â‰¡id {{K}} ğ•¥ Âµ = cong âˆ€Î±_ (â‹¯-id t)
â‹¯-id               (tâ‚ Â· tâ‚‚)                         = congâ‚‚ _Â·_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)
â‹¯-id               (tâ‚ âˆ™ tâ‚‚)                         = congâ‚‚ _âˆ™_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)
â‹¯-id               (tâ‚ â‡’ tâ‚‚)                         = congâ‚‚ _â‡’_ (â‹¯-id tâ‚) (â‹¯-id tâ‚‚)

â‹¯â‚œ-id : âˆ€ {{K : Kit}} (T : Type Âµ m) â†’
  T â‹¯â‚œ idâ‚– {{K}} â‰¡ T
â‹¯â‚œ-id {m = ğ•§} T = â‹¯-id T
â‹¯â‚œ-id {m = ğ•¥} T = refl

dist-lift-âˆ˜áµ£áµ£ : âˆ€ m (Ïâ‚ : Âµâ‚ â†’áµ£ Âµâ‚‚) (Ïâ‚‚ : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ) â†’
  (Ïâ‚‚ âˆ˜áµ£ Ïâ‚) â†‘ m â‰¡ (Ïâ‚‚ â†‘ m) âˆ˜áµ£ (Ïâ‚ â†‘ m)
dist-lift-âˆ˜áµ£áµ£ m Ïâ‚ Ïâ‚‚ = fun-extâ‚‚ Î» where
  _ (here px) â†’ refl
  _ (there x) â†’ refl

assoc-â‹¯áµ£-â‹¯áµ£ : (v : Term Âµâ‚ m) (Ïâ‚ : Âµâ‚ â†’áµ£ Âµâ‚‚) (Ïâ‚‚ : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ) â†’
  v â‹¯ (Ïâ‚‚ âˆ˜áµ£ Ïâ‚) â‰¡ v â‹¯ Ïâ‚ â‹¯ Ïâ‚‚
assoc-â‹¯áµ£-â‹¯áµ£ (` x)     Ïâ‚ Ïâ‚‚ = refl
assoc-â‹¯áµ£-â‹¯áµ£ (Î»x v)    Ïâ‚ Ïâ‚‚ = cong Î»x_
  (v â‹¯ (Ïâ‚‚ âˆ˜áµ£ Ïâ‚) â†‘ _         â‰¡âŸ¨ cong (v â‹¯_) (dist-lift-âˆ˜áµ£áµ£ _ Ïâ‚ Ïâ‚‚) âŸ©
   v â‹¯ ((Ïâ‚‚ â†‘ _) âˆ˜áµ£ (Ïâ‚ â†‘ _)) â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯áµ£ v (Ïâ‚ â†‘ _) (Ïâ‚‚ â†‘ _) âŸ©
   v â‹¯ Ïâ‚ â†‘ _ â‹¯ Ïâ‚‚ â†‘ _        âˆ)
assoc-â‹¯áµ£-â‹¯áµ£ (Î›Î± v)    Ïâ‚ Ïâ‚‚ = cong Î›Î±_
  (v â‹¯ (Ïâ‚‚ âˆ˜áµ£ Ïâ‚) â†‘ _         â‰¡âŸ¨ cong (v â‹¯_) (dist-lift-âˆ˜áµ£áµ£ _ Ïâ‚ Ïâ‚‚) âŸ©
   v â‹¯ ((Ïâ‚‚ â†‘ _) âˆ˜áµ£ (Ïâ‚ â†‘ _)) â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯áµ£ v (Ïâ‚ â†‘ _) (Ïâ‚‚ â†‘ _) âŸ©
   v â‹¯ Ïâ‚ â†‘ _ â‹¯ Ïâ‚‚ â†‘ _        âˆ)
assoc-â‹¯áµ£-â‹¯áµ£ (âˆ€Î± v)    Ïâ‚ Ïâ‚‚ = cong âˆ€Î±_
  (v â‹¯ (Ïâ‚‚ âˆ˜áµ£ Ïâ‚) â†‘ _         â‰¡âŸ¨ cong (v â‹¯_) (dist-lift-âˆ˜áµ£áµ£ _ Ïâ‚ Ïâ‚‚) âŸ©
   v â‹¯ ((Ïâ‚‚ â†‘ _) âˆ˜áµ£ (Ïâ‚ â†‘ _)) â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯áµ£ v (Ïâ‚ â†‘ _) (Ïâ‚‚ â†‘ _) âŸ©
   v â‹¯ Ïâ‚ â†‘ _ â‹¯ Ïâ‚‚ â†‘ _        âˆ)
assoc-â‹¯áµ£-â‹¯áµ£ (vâ‚ Â· vâ‚‚) Ïâ‚ Ïâ‚‚ = congâ‚‚ _Â·_ (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚ Ïâ‚ Ïâ‚‚) (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚‚ Ïâ‚ Ïâ‚‚)
assoc-â‹¯áµ£-â‹¯áµ£ (vâ‚ âˆ™ vâ‚‚) Ïâ‚ Ïâ‚‚ = congâ‚‚ _âˆ™_ (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚ Ïâ‚ Ïâ‚‚) (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚‚ Ïâ‚ Ïâ‚‚)
assoc-â‹¯áµ£-â‹¯áµ£ (vâ‚ â‡’ vâ‚‚) Ïâ‚ Ïâ‚‚ = congâ‚‚ _â‡’_ (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚ Ïâ‚ Ïâ‚‚) (assoc-â‹¯áµ£-â‹¯áµ£ vâ‚‚ Ïâ‚ Ïâ‚‚)

dist-lift-ren : âˆ€ (v : Term Âµâ‚ m') (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
  v â‹¯ wk â‹¯ (Ï â†‘ m) â‰¡ v â‹¯ Ï â‹¯ wk
dist-lift-ren {m = m} v Ï =
  v â‹¯ wk â‹¯ (Ï â†‘ m)  â‰¡âŸ¨ sym (assoc-â‹¯áµ£-â‹¯áµ£ v wk (Ï â†‘ m))  âŸ©
  v â‹¯ (Ï â†‘ m) âˆ˜áµ£ wk â‰¡âŸ¨ refl âŸ©
  v â‹¯ wk âˆ˜áµ£ Ï       â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯áµ£ v Ï wk âŸ©
  v â‹¯ Ï â‹¯ wk        âˆ

dist-lift-âˆ˜â‚›áµ£ : âˆ€ m (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) (Ïƒ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ) â†’
  (Ïƒ âˆ˜â‚› Ï) â†‘ m â‰¡ (Ïƒ â†‘ m) âˆ˜â‚› (Ï â†‘ m)
dist-lift-âˆ˜â‚›áµ£ m Ï Ïƒ = fun-extâ‚‚ Î» where
  _ (here px) â†’ refl
  _ (there x) â†’ refl

dist-lift-âˆ˜áµ£â‚› : âˆ€ m (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) (Ï : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ) â†’
  (Ï âˆ˜â‚› Ïƒ) â†‘ m â‰¡ (Ï â†‘ m) âˆ˜â‚› (Ïƒ â†‘ m)
dist-lift-âˆ˜áµ£â‚› m Ïƒ Ï = fun-extâ‚‚ Î» where
  _ (here px) â†’ refl
  _ (there x) â†’ sym (dist-lift-ren (Ïƒ _ x) Ï)

assoc-â‹¯áµ£-â‹¯â‚› : (v : Term Âµâ‚ m) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) (Ïƒ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ) â†’
  (v â‹¯ Ï) â‹¯ Ïƒ â‰¡ v â‹¯ (Ïƒ âˆ˜â‚› Ï)
assoc-â‹¯áµ£-â‹¯â‚› (` x)     Ï Ïƒ = refl
assoc-â‹¯áµ£-â‹¯â‚› (Î»x v)    Ï Ïƒ = cong Î»x_
  (v â‹¯ (Ï â†‘ _) â‹¯ (Ïƒ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯â‚› v (Ï â†‘ _) (Ïƒ â†‘ _) âŸ©
   v â‹¯ ((Ïƒ â†‘ _) âˆ˜â‚› (Ï â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚›áµ£ _ Ï Ïƒ)) âŸ©
   v â‹¯ ((Ïƒ âˆ˜â‚› Ï) â†‘ _)       âˆ)
assoc-â‹¯áµ£-â‹¯â‚› (Î›Î± v)    Ï Ïƒ = cong Î›Î±_
  (v â‹¯ (Ï â†‘ _) â‹¯ (Ïƒ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯â‚› v (Ï â†‘ _) (Ïƒ â†‘ _) âŸ©
   v â‹¯ ((Ïƒ â†‘ _) âˆ˜â‚› (Ï â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚›áµ£ _ Ï Ïƒ)) âŸ©
   v â‹¯ ((Ïƒ âˆ˜â‚› Ï) â†‘ _)       âˆ)
assoc-â‹¯áµ£-â‹¯â‚› (âˆ€Î± v)    Ï Ïƒ = cong âˆ€Î±_
  (v â‹¯ (Ï â†‘ _) â‹¯ (Ïƒ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯â‚› v (Ï â†‘ _) (Ïƒ â†‘ _) âŸ©
   v â‹¯ ((Ïƒ â†‘ _) âˆ˜â‚› (Ï â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚›áµ£ _ Ï Ïƒ)) âŸ©
   v â‹¯ ((Ïƒ âˆ˜â‚› Ï) â†‘ _)       âˆ)
assoc-â‹¯áµ£-â‹¯â‚› (vâ‚ Â· vâ‚‚) Ï Ïƒ = congâ‚‚ _Â·_ (assoc-â‹¯áµ£-â‹¯â‚› vâ‚ Ï Ïƒ) (assoc-â‹¯áµ£-â‹¯â‚› vâ‚‚ Ï Ïƒ)
assoc-â‹¯áµ£-â‹¯â‚› (vâ‚ âˆ™ vâ‚‚) Ï Ïƒ = congâ‚‚ _âˆ™_ (assoc-â‹¯áµ£-â‹¯â‚› vâ‚ Ï Ïƒ) (assoc-â‹¯áµ£-â‹¯â‚› vâ‚‚ Ï Ïƒ)
assoc-â‹¯áµ£-â‹¯â‚› (vâ‚ â‡’ vâ‚‚) Ï Ïƒ = congâ‚‚ _â‡’_ (assoc-â‹¯áµ£-â‹¯â‚› vâ‚ Ï Ïƒ) (assoc-â‹¯áµ£-â‹¯â‚› vâ‚‚ Ï Ïƒ)

assoc-â‹¯â‚›-â‹¯áµ£ : (v : Term Âµâ‚ m) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) (Ï : Âµâ‚‚ â†’áµ£ Âµâ‚ƒ) â†’
  (v â‹¯ Ïƒ) â‹¯ Ï â‰¡ v â‹¯ (Ï âˆ˜â‚› Ïƒ)
assoc-â‹¯â‚›-â‹¯áµ£ (` x)     Ïƒ Ï = refl
assoc-â‹¯â‚›-â‹¯áµ£ (Î»x v)    Ïƒ Ï = cong Î»x_
  (v â‹¯ (Ïƒ â†‘ _) â‹¯ (Ï â†‘ _)     â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯áµ£ v (Ïƒ â†‘ _) (Ï â†‘ _) âŸ©
   v â‹¯ ((Ï â†‘ _) âˆ˜áµ£â‚› (Ïƒ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜áµ£â‚› _ Ïƒ Ï)) âŸ©
   v â‹¯ (Ï âˆ˜â‚› Ïƒ) â†‘ _          âˆ)
assoc-â‹¯â‚›-â‹¯áµ£ (Î›Î± v)    Ïƒ Ï = cong Î›Î±_
  (v â‹¯ (Ïƒ â†‘ _) â‹¯ (Ï â†‘ _)     â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯áµ£ v (Ïƒ â†‘ _) (Ï â†‘ _) âŸ©
   v â‹¯ ((Ï â†‘ _) âˆ˜áµ£â‚› (Ïƒ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜áµ£â‚› _ Ïƒ Ï)) âŸ©
   v â‹¯ (Ï âˆ˜â‚› Ïƒ) â†‘ _          âˆ)
assoc-â‹¯â‚›-â‹¯áµ£ (âˆ€Î± v)    Ïƒ Ï = cong âˆ€Î±_
  (v â‹¯ (Ïƒ â†‘ _) â‹¯ (Ï â†‘ _)     â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯áµ£ v (Ïƒ â†‘ _) (Ï â†‘ _) âŸ©
   v â‹¯ ((Ï â†‘ _) âˆ˜áµ£â‚› (Ïƒ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜áµ£â‚› _ Ïƒ Ï)) âŸ©
   v â‹¯ (Ï âˆ˜â‚› Ïƒ) â†‘ _          âˆ)
assoc-â‹¯â‚›-â‹¯áµ£ (vâ‚ Â· vâ‚‚) Ïƒ Ï = congâ‚‚ _Â·_ (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚ Ïƒ Ï) (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚‚ Ïƒ Ï)
assoc-â‹¯â‚›-â‹¯áµ£ (vâ‚ âˆ™ vâ‚‚) Ïƒ Ï = congâ‚‚ _âˆ™_ (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚ Ïƒ Ï) (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚‚ Ïƒ Ï)
assoc-â‹¯â‚›-â‹¯áµ£ (vâ‚ â‡’ vâ‚‚) Ïƒ Ï = congâ‚‚ _â‡’_ (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚ Ïƒ Ï) (assoc-â‹¯â‚›-â‹¯áµ£ vâ‚‚ Ïƒ Ï)

-- This lemma is the reason why we can't start with assoc-â‹¯â‚›-â‹¯â‚› and derive the rest.
-- It's only needed in the â‚›â‚› case but not in áµ£-â‚›-combinations.
dist-lift-sub : âˆ€ (v : Term Âµâ‚ m') (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  v â‹¯ wk â‹¯ (Ïƒ â†‘ m) â‰¡ v â‹¯ Ïƒ â‹¯ wk
dist-lift-sub {m = m} v Ïƒ =
  v â‹¯ wk â‹¯ (Ïƒ â†‘ m)   â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯â‚› v wk (Ïƒ â†‘ m) âŸ©
  v â‹¯ (Ïƒ â†‘ m) âˆ˜â‚› wk â‰¡âŸ¨ refl âŸ©
  v â‹¯ wk âˆ˜â‚› Ïƒ       â‰¡âŸ¨ sym (assoc-â‹¯â‚›-â‹¯áµ£ v Ïƒ wk) âŸ©
  v â‹¯ Ïƒ â‹¯ wk         âˆ

dist-lift-âˆ˜â‚› : âˆ€ m (Ïƒâ‚ : Âµâ‚ â†’â‚› Âµâ‚‚) (Ïƒâ‚‚ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ) â†’
  (Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) â†‘ m â‰¡ (Ïƒâ‚‚ â†‘ m) âˆ˜â‚› (Ïƒâ‚ â†‘ m)
dist-lift-âˆ˜â‚› m Ïƒâ‚ Ïƒâ‚‚ = fun-extâ‚‚ Î» where
  m' (here px) â†’ refl
  m' (there x) â†’
    ((Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) â†‘ m) m' (there x)       â‰¡âŸ¨âŸ©
    (Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) m' x â‹¯ wk                â‰¡âŸ¨âŸ©
    Ïƒâ‚ m' x â‹¯ Ïƒâ‚‚ â‹¯ wk                   â‰¡âŸ¨ sym (dist-lift-sub (Ïƒâ‚ m' x) Ïƒâ‚‚) âŸ©
    Ïƒâ‚ m' x â‹¯ wk â‹¯ (Ïƒâ‚‚ â†‘ m)             â‰¡âŸ¨âŸ©
    (Ïƒâ‚ â†‘ m) m' (there x) â‹¯ (Ïƒâ‚‚ â†‘ m)    â‰¡âŸ¨âŸ©
    ((Ïƒâ‚‚ â†‘ m) âˆ˜â‚› (Ïƒâ‚ â†‘ m)) m' (there x) âˆ

assoc-â‹¯â‚›-â‹¯â‚› : (v : Term Âµâ‚ m) (Ïƒâ‚ : Âµâ‚ â†’â‚› Âµâ‚‚) (Ïƒâ‚‚ : Âµâ‚‚ â†’â‚› Âµâ‚ƒ) â†’
  (v â‹¯ Ïƒâ‚) â‹¯ Ïƒâ‚‚ â‰¡ v â‹¯ (Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚)
assoc-â‹¯â‚›-â‹¯â‚› (` x)    Ïƒâ‚ Ïƒâ‚‚ = refl
assoc-â‹¯â‚›-â‹¯â‚› (Î»x v)   Ïƒâ‚ Ïƒâ‚‚ = cong Î»x_
  (v â‹¯ (Ïƒâ‚ â†‘ _) â‹¯ (Ïƒâ‚‚ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯â‚› v (Ïƒâ‚ â†‘ _) (Ïƒâ‚‚ â†‘ _) âŸ©
   v â‹¯ ((Ïƒâ‚‚ â†‘ _) âˆ˜â‚› (Ïƒâ‚ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚› _ Ïƒâ‚ Ïƒâ‚‚)) âŸ©
   v â‹¯ ((Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) â†‘ _)       âˆ)
assoc-â‹¯â‚›-â‹¯â‚› (Î›Î± v)   Ïƒâ‚ Ïƒâ‚‚ = cong Î›Î±_
  (v â‹¯ (Ïƒâ‚ â†‘ _) â‹¯ (Ïƒâ‚‚ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯â‚› v (Ïƒâ‚ â†‘ _) (Ïƒâ‚‚ â†‘ _) âŸ©
   v â‹¯ ((Ïƒâ‚‚ â†‘ _) âˆ˜â‚› (Ïƒâ‚ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚› _ Ïƒâ‚ Ïƒâ‚‚)) âŸ©
   v â‹¯ ((Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) â†‘ _)       âˆ)
assoc-â‹¯â‚›-â‹¯â‚› (âˆ€Î± v)   Ïƒâ‚ Ïƒâ‚‚ = cong âˆ€Î±_
  (v â‹¯ (Ïƒâ‚ â†‘ _) â‹¯ (Ïƒâ‚‚ â†‘ _)    â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯â‚› v (Ïƒâ‚ â†‘ _) (Ïƒâ‚‚ â†‘ _) âŸ©
   v â‹¯ ((Ïƒâ‚‚ â†‘ _) âˆ˜â‚› (Ïƒâ‚ â†‘ _)) â‰¡âŸ¨ cong (v â‹¯_) (sym (dist-lift-âˆ˜â‚› _ Ïƒâ‚ Ïƒâ‚‚)) âŸ©
   v â‹¯ ((Ïƒâ‚‚ âˆ˜â‚› Ïƒâ‚) â†‘ _)       âˆ)
assoc-â‹¯â‚›-â‹¯â‚› (v Â· vâ‚) Ïƒâ‚ Ïƒâ‚‚ = congâ‚‚ _Â·_ (assoc-â‹¯â‚›-â‹¯â‚› v Ïƒâ‚ Ïƒâ‚‚) (assoc-â‹¯â‚›-â‹¯â‚› vâ‚ Ïƒâ‚ Ïƒâ‚‚)
assoc-â‹¯â‚›-â‹¯â‚› (v âˆ™ vâ‚) Ïƒâ‚ Ïƒâ‚‚ = congâ‚‚ _âˆ™_ (assoc-â‹¯â‚›-â‹¯â‚› v Ïƒâ‚ Ïƒâ‚‚) (assoc-â‹¯â‚›-â‹¯â‚› vâ‚ Ïƒâ‚ Ïƒâ‚‚)
assoc-â‹¯â‚›-â‹¯â‚› (v â‡’ vâ‚) Ïƒâ‚ Ïƒâ‚‚ = congâ‚‚ _â‡’_ (assoc-â‹¯â‚›-â‹¯â‚› v Ïƒâ‚ Ïƒâ‚‚) (assoc-â‹¯â‚›-â‹¯â‚› vâ‚ Ïƒâ‚ Ïƒâ‚‚)

sub-lift-id : (v : Term Âµâ‚ m) (v' : Term Âµâ‚‚ m') (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  v â‹¯ wk â‹¯ (Ïƒ ,â‚› v') â‰¡ v â‹¯ Ïƒ
sub-lift-id v v' Ïƒ = assoc-â‹¯áµ£-â‹¯â‚› v wk (Ïƒ ,â‚› v')

tsub-lift-id : (v : Type Âµâ‚ m) (v' : Term Âµâ‚‚ m') (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  wkt v â‹¯â‚œ (Ïƒ ,â‚› v') â‰¡ v â‹¯â‚œ Ïƒ
tsub-lift-id {m = ğ•§} v v' Ïƒ = sub-lift-id v v' Ïƒ
tsub-lift-id {m = ğ•¥} v v' Ïƒ = refl

dist-lift-tsub : âˆ€ (v : Type Âµâ‚ m') (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  v â‹¯â‚œ wk â‹¯â‚œ (Ïƒ â†‘ m) â‰¡ v â‹¯â‚œ Ïƒ â‹¯â‚œ wk
dist-lift-tsub {m' = ğ•§} v Ïƒ = dist-lift-sub v Ïƒ
dist-lift-tsub {m' = ğ•¥} v Ïƒ = refl

dist-â‹¯-â‹¯' : âˆ€ (t : Term Âµâ‚ ğ•¥) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  Ïƒ âˆ˜â‚› â¦… t â¦† â‰¡ â¦… t â‹¯ Ïƒ â¦† âˆ˜â‚› (Ïƒ â†‘ ğ•¥)
dist-â‹¯-â‹¯' t Ïƒ = fun-extâ‚‚ Î» where
  _ (here refl) â†’ refl
  _ (there x) â†’
    Ïƒ _ x                  â‰¡âŸ¨ sym (â‹¯-id (Ïƒ _ x)) âŸ©
    Ïƒ _ x â‹¯ idâ‚–            â‰¡âŸ¨ sym (assoc-â‹¯áµ£-â‹¯â‚› (Ïƒ _ x) wk (â¦… t â‹¯ Ïƒ â¦†)) âŸ©
    Ïƒ _ x â‹¯ wk â‹¯ â¦… t â‹¯ Ïƒ â¦† âˆ

dist-â‹¯-â‹¯ : âˆ€ (tâ‚‚ : Term (ğ•¥ âˆ· Âµâ‚) ğ•¥) (t : Term Âµâ‚ ğ•¥) (Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚) â†’
  tâ‚‚ â‹¯ â¦… t â¦† â‹¯ Ïƒ â‰¡ tâ‚‚ â‹¯ (Ïƒ â†‘ ğ•¥) â‹¯ â¦… t â‹¯ Ïƒ â¦†
dist-â‹¯-â‹¯ tâ‚‚ t Ïƒ =
  tâ‚‚ â‹¯ â¦… t â¦† â‹¯ Ïƒ              â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯â‚› tâ‚‚ â¦… t â¦† Ïƒ âŸ©
  tâ‚‚ â‹¯ Ïƒ âˆ˜â‚› â¦… t â¦†             â‰¡âŸ¨ cong (tâ‚‚ â‹¯_) (dist-â‹¯-â‹¯' t Ïƒ) âŸ©
  tâ‚‚ â‹¯ (â¦… t â‹¯ Ïƒ â¦† âˆ˜â‚› (Ïƒ â†‘ ğ•¥)) â‰¡âŸ¨ sym (assoc-â‹¯â‚›-â‹¯â‚› tâ‚‚ (Ïƒ â†‘ ğ•¥) (â¦… t â‹¯ Ïƒ â¦†)) âŸ©
  tâ‚‚ â‹¯ Ïƒ â†‘ ğ•¥ â‹¯ â¦… t â‹¯ Ïƒ â¦†      âˆ

-- TODO: get rid of the next two lemmas
dist-â‹¯-â‹¯áµ£' : âˆ€ (t : Term Âµâ‚ ğ•¥) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
  Ï âˆ˜â‚› â¦… t â¦† â‰¡ (â¦… t â‹¯ Ï â¦† âˆ˜â‚› (Ï â†‘ ğ•¥))
dist-â‹¯-â‹¯áµ£' t Ïƒ = fun-extâ‚‚ Î» where
  _ (here refl) â†’ refl
  _ (there x) â†’ refl

dist-â‹¯-â‹¯áµ£ : âˆ€ (tâ‚‚ : Term (ğ•¥ âˆ· Âµâ‚) ğ•¥) (t : Term Âµâ‚ ğ•¥) (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
  tâ‚‚ â‹¯ â¦… t â¦† â‹¯ Ï â‰¡ tâ‚‚ â‹¯ (Ï â†‘ ğ•¥) â‹¯ â¦… t â‹¯ Ï â¦†
dist-â‹¯-â‹¯áµ£ tâ‚‚ t Ïƒ =
  tâ‚‚ â‹¯ â¦… t â¦† â‹¯ Ïƒ              â‰¡âŸ¨ assoc-â‹¯â‚›-â‹¯áµ£ tâ‚‚ â¦… t â¦† Ïƒ âŸ©
  tâ‚‚ â‹¯ Ïƒ âˆ˜â‚› â¦… t â¦†             â‰¡âŸ¨ cong (tâ‚‚ â‹¯_) (dist-â‹¯-â‹¯áµ£' t Ïƒ) âŸ©
  tâ‚‚ â‹¯ (â¦… t â‹¯ Ïƒ â¦† âˆ˜â‚› (Ïƒ â†‘ ğ•¥)) â‰¡âŸ¨ sym (assoc-â‹¯áµ£-â‹¯â‚› tâ‚‚ (Ïƒ â†‘ ğ•¥) (â¦… t â‹¯ Ïƒ â¦†)) âŸ©
  tâ‚‚ â‹¯ Ïƒ â†‘ ğ•¥ â‹¯ â¦… t â‹¯ Ïƒ â¦†      âˆ

-- Order Preserving Embeddings (required for "weakening preserves typing")
data OPE : Âµâ‚ â†’áµ£ Âµâ‚‚ â†’ Ctx Âµâ‚ â†’ Ctx Âµâ‚‚ â†’ Set where
  ope-id : âˆ€ {Î“ : Ctx Âµ} â†’
    OPE idâ‚– Î“ Î“
  ope-keep  : âˆ€ {Ï : Âµâ‚ â†’áµ£ Âµâ‚‚} {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {T : Type Âµâ‚ m} â†’
    OPE  Ï       Î“â‚        Î“â‚‚ â†’
    OPE (Ï â†‘ m) (Î“â‚ ,, T) (Î“â‚‚ ,, (T â‹¯â‚œ Ï))
  ope-drop  : âˆ€ {Ï : Âµâ‚ â†’áµ£ Âµâ‚‚} {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {T : Type Âµâ‚‚ m} â†’
    OPE  Ï            Î“â‚  Î“â‚‚ â†’
    OPE (wk âˆ˜áµ£ Ï) Î“â‚ (Î“â‚‚ ,, T)

-- TODO: works equally well with m instead of ğ•§, but requires even more â‹¯â‚œ versions of â‹¯ lemmas...
ope-pres-telescope : âˆ€ {Ï : Âµâ‚ â†’áµ£ Âµâ‚‚} (x : Âµâ‚ âˆ‹ ğ•§) â†’
  OPE Ï Î“â‚ Î“â‚‚ â†’
  wk-drop-âˆˆ (Ï ğ•§ x) (Î“â‚‚ (Ï ğ•§ x)) â‰¡ wk-drop-âˆˆ x (Î“â‚ x) â‹¯ Ï
ope-pres-telescope x           ope-id         = sym (â‹¯-id _)
ope-pres-telescope (here refl) (ope-keep {Ï = Ï} {T = T} ope) = sym (dist-lift-ren T Ï)
ope-pres-telescope (there x)   (ope-keep {Ï = Ï} {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} ope) =
  wk-drop-âˆˆ (Ï _ x) (Î“â‚‚ (Ï _ x)) â‹¯ wk â‰¡âŸ¨ cong (_â‹¯ wk) (ope-pres-telescope x ope) âŸ©
  wk-drop-âˆˆ x (Î“â‚ x) â‹¯ Ï â‹¯ wk         â‰¡âŸ¨ sym (dist-lift-ren (wk-drop-âˆˆ x (Î“â‚ x)) Ï) âŸ©
  wk-drop-âˆˆ x (Î“â‚ x) â‹¯ wk â‹¯ Ï â†‘ _     âˆ
ope-pres-telescope x           (ope-drop {Ï = Ï} {Î“â‚ = Î“â‚} {Î“â‚‚ = Î“â‚‚} ope) =
  wk-drop-âˆˆ (Ï _ x) (Î“â‚‚ (Ï _ x)) â‹¯â‚œ wk â‰¡âŸ¨ cong (_â‹¯â‚œ wk) (ope-pres-telescope x ope) âŸ©
  wk-drop-âˆˆ x (Î“â‚ x) â‹¯â‚œ Ï        â‹¯â‚œ wk â‰¡âŸ¨ sym (assoc-â‹¯áµ£-â‹¯áµ£ (wk-drop-âˆˆ x (Î“â‚ x)) Ï wk) âŸ©
  wk-drop-âˆˆ x (Î“â‚ x) â‹¯â‚œ wk âˆ˜áµ£ Ï        âˆ

ope-pres-âŠ¢ : âˆ€ {v : Term Âµâ‚ m} {t : Type Âµâ‚ m} {Ï : Âµâ‚ â†’áµ£ Âµâ‚‚} â†’
  OPE Ï Î“â‚ Î“â‚‚ â†’
  Î“â‚ âŠ¢ v     âˆ¶ t â†’
  Î“â‚‚ âŠ¢ v â‹¯ Ï âˆ¶ t â‹¯â‚œ Ï
ope-pres-âŠ¢               {Ï = Ï} ope (Ï„-` refl)                 = Ï„-` (ope-pres-telescope _ ope)
ope-pres-âŠ¢ {t = tâ‚ â‡’ tâ‚‚} {Ï = Ï} ope (Ï„-Î» âŠ¢v)                   = Ï„-Î» (subst (_ âŠ¢ _ âˆ¶_) (dist-lift-ren tâ‚‚ Ï) (ope-pres-âŠ¢ (ope-keep ope) âŠ¢v))
ope-pres-âŠ¢                       ope (Ï„-Î› âŠ¢v)                   = Ï„-Î› (ope-pres-âŠ¢ (ope-keep ope) âŠ¢v)
ope-pres-âŠ¢                       ope (Ï„-Â· âŠ¢vâ‚ âŠ¢vâ‚‚)              = Ï„-Â· (ope-pres-âŠ¢ ope âŠ¢vâ‚) (ope-pres-âŠ¢ ope âŠ¢vâ‚‚)
ope-pres-âŠ¢               {Ï = Ï} ope (Ï„-âˆ™ {tâ‚‚ = tâ‚‚} {t = t} âŠ¢v) = subst (_ âŠ¢ _ âˆ¶_) (sym (dist-â‹¯-â‹¯áµ£ tâ‚‚ t Ï)) (Ï„-âˆ™ (ope-pres-âŠ¢ ope âŠ¢v))
ope-pres-âŠ¢                       ope Ï„-ğ•¥                        = Ï„-ğ•¥

wk-pres-âŠ¢ : âˆ€ {m'} {v : Term Âµ m} {t : Type Âµ m} (T : Type Âµ m') â†’
  Î“â‚‚        âŠ¢ v      âˆ¶ t â†’
  (Î“â‚‚ ,, T) âŠ¢ v â‹¯ wk âˆ¶ wkt t
wk-pres-âŠ¢ T âŠ¢v =  ope-pres-âŠ¢ (ope-drop ope-id) âŠ¢v

lift-âŠ¢* : âˆ€ {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} (T : Type Âµâ‚ m) â†’
  Î“â‚‚               âŠ¢*  Ïƒ      âˆ¶ Î“â‚ â†’
  (Î“â‚‚ ,, (T â‹¯â‚œ Ïƒ)) âŠ¢* (Ïƒ â†‘ m) âˆ¶ (Î“â‚ ,, T)
lift-âŠ¢* {m = ğ•§} {Ïƒ = Ïƒ} T âŠ¢Ïƒ (here refl) = Ï„-` (sym (dist-lift-sub T Ïƒ))
lift-âŠ¢* {m = ğ•¥} {Ïƒ = Ïƒ} T âŠ¢Ïƒ (here refl) = Ï„-ğ•¥
lift-âŠ¢* {m = m} {Î“â‚‚ = Î“â‚‚} {Î“â‚ = Î“â‚} {Ïƒ = Ïƒ} T âŠ¢Ïƒ (there x) =
  subst ((Î“â‚‚ ,, (T â‹¯â‚œ Ïƒ)) âŠ¢ (Ïƒ _ x â‹¯ wk) âˆ¶_)
        (sym (wk-drop-âˆˆ x (Î“â‚ x) â‹¯â‚œ wk â‹¯â‚œ (Ïƒ â†‘ m) â‰¡âŸ¨ dist-lift-tsub _ Ïƒ âŸ©
              wk-drop-âˆˆ x (Î“â‚ x) â‹¯â‚œ Ïƒ â‹¯â‚œ wk       âˆ))
        (wk-pres-âŠ¢ (T â‹¯â‚œ Ïƒ) (âŠ¢Ïƒ x))

sub-pres-âŠ¢ : âˆ€ {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {v : Term Âµâ‚ m} {t : Type Âµâ‚ m} {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Î“â‚ âŠ¢ v âˆ¶ t â†’
  Î“â‚‚ âŠ¢* Ïƒ âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ v â‹¯ Ïƒ âˆ¶ t â‹¯â‚œ Ïƒ
sub-pres-âŠ¢ {m = ğ•¥}         âŠ¢v                 âŠ¢Ïƒ = Ï„-ğ•¥
sub-pres-âŠ¢ {m = ğ•§}         (Ï„-` {x = x} refl) âŠ¢Ïƒ = âŠ¢Ïƒ x
sub-pres-âŠ¢ {m = ğ•§} {Ïƒ = Ïƒ} (Ï„-Î» {tâ‚‚ = tâ‚‚} âŠ¢e) âŠ¢Ïƒ = Ï„-Î» (subst (_ âŠ¢ _ âˆ¶_) (dist-lift-sub tâ‚‚ Ïƒ) (sub-pres-âŠ¢ âŠ¢e (lift-âŠ¢* _ âŠ¢Ïƒ)) )
sub-pres-âŠ¢ {m = ğ•§}         (Ï„-Î› âŠ¢e)           âŠ¢Ïƒ = Ï„-Î› (sub-pres-âŠ¢ âŠ¢e (lift-âŠ¢* _ âŠ¢Ïƒ))
sub-pres-âŠ¢ {m = ğ•§}         (Ï„-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)      âŠ¢Ïƒ = Ï„-Â· (sub-pres-âŠ¢ âŠ¢eâ‚ âŠ¢Ïƒ) (sub-pres-âŠ¢ âŠ¢eâ‚‚ âŠ¢Ïƒ)
sub-pres-âŠ¢ {m = ğ•§} {Ïƒ = Ïƒ} (Ï„-âˆ™ {e = e} {tâ‚‚ = tâ‚‚} {t = t} âŠ¢e) âŠ¢Ïƒ =
  _ âŠ¢ e âˆ™ t â‹¯ Ïƒ âˆ¶ tâ‚‚ â‹¯ â¦… t â¦† â‹¯ Ïƒ              by subst (_ âŠ¢ e âˆ™ t â‹¯ Ïƒ âˆ¶_) (sym (dist-â‹¯-â‹¯ tâ‚‚ t Ïƒ)) (
  _ âŠ¢ e âˆ™ t â‹¯ Ïƒ âˆ¶ tâ‚‚ â‹¯ (Ïƒ â†‘ ğ•¥) â‹¯ â¦… t â‹¯ Ïƒ â¦†    by Ï„-âˆ™ (sub-pres-âŠ¢ âŠ¢e âŠ¢Ïƒ))

_,*_ : âˆ€ {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} {T : Type Âµâ‚ mâ‚} â†’
  Î“â‚‚ âŠ¢* Ïƒ âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢  v âˆ¶ T â‹¯â‚œ Ïƒ â†’
  Î“â‚‚ âŠ¢* Ïƒ ,â‚› v âˆ¶ Î“â‚ ,, T
_,*_ {Î“â‚‚ = Î“â‚‚} {v = v} {Ïƒ = Ïƒ} âŠ¢Ïƒ âŠ¢v (here refl) = subst (Î“â‚‚ âŠ¢ v âˆ¶_)     (sym (tsub-lift-id _ _ _)) âŠ¢v
_,*_ {Î“â‚‚ = Î“â‚‚} {v = v} {Ïƒ = Ïƒ} âŠ¢Ïƒ âŠ¢v (there x)   = subst (Î“â‚‚ âŠ¢ Ïƒ _ x âˆ¶_) (sym (tsub-lift-id _ _ _)) (âŠ¢Ïƒ x)

âŠ¢*-id : âˆ€ {Î“ : Ctx Âµ} â†’
  Î“ âŠ¢* idâ‚– âˆ¶ Î“
âŠ¢*-id {Âµ = m âˆ· Âµ} {Î“ = Î“} {ğ•¥} x = Ï„-ğ•¥
âŠ¢*-id {Âµ = m âˆ· Âµ} {Î“ = Î“} {ğ•§} x rewrite â‹¯-id {{K = kitâ‚›}} (wk-telescope Î“ x) = Ï„-`  refl 

subâ‚-pres-âŠ¢ : âˆ€ {Î“ : Ctx Âµ} {Eâ‚ : Term (mâ‚‚ âˆ· Âµ) mâ‚} {Eâ‚‚ : Âµ âŠ¢ mâ‚‚} {Tâ‚‚ : Type (mâ‚‚ âˆ· Âµ) mâ‚} {Tâ‚ : Type Âµ mâ‚‚} â†’
  Î“ ,, Tâ‚ âŠ¢ Eâ‚ âˆ¶ Tâ‚‚ â†’
  Î“ âŠ¢ Eâ‚‚ âˆ¶ Tâ‚ â†’
  Î“ âŠ¢ Eâ‚ â‹¯ â¦… Eâ‚‚ â¦† âˆ¶ Tâ‚‚ â‹¯â‚œ â¦… Eâ‚‚ â¦†
subâ‚-pres-âŠ¢ {Î“ = Î“} {Eâ‚‚ = Eâ‚‚} âŠ¢Eâ‚ âŠ¢Eâ‚‚ = sub-pres-âŠ¢ âŠ¢Eâ‚ (âŠ¢*-id ,* subst (Î“ âŠ¢ Eâ‚‚ âˆ¶_) (sym (â‹¯â‚œ-id _)) âŠ¢Eâ‚‚)

wk-cancels-â¦…â¦†â‚› : âˆ€ (e : Âµ âŠ¢ m) (e' : Âµ âŠ¢ m') â†’
  e â‹¯áµ£ wk â‹¯â‚› â¦… e' â¦† â‰¡ e
wk-cancels-â¦…â¦†â‚› e e' =
  e â‹¯áµ£ wk â‹¯â‚› â¦… e' â¦†   â‰¡âŸ¨ assoc-â‹¯áµ£-â‹¯â‚› e wk â¦… e' â¦† âŸ©
  e â‹¯â‚› (â¦… e' â¦† âˆ˜â‚› wk) â‰¡âŸ¨ refl âŸ©
  e â‹¯â‚› idâ‚›            â‰¡âŸ¨ â‹¯-id e âŸ©
  e                   âˆ

subject-reduction :
  Î“ âŠ¢ e âˆ¶ t â†’
  e â†ª e' â†’
  Î“ âŠ¢ e' âˆ¶ t
subject-reduction (Ï„-Â· (Ï„-Î» âŠ¢eâ‚) âŠ¢eâ‚‚)  Î²-Î»        = subst (_ âŠ¢ _ âˆ¶_) (wk-cancels-â¦…â¦†â‚› _ _) (subâ‚-pres-âŠ¢ âŠ¢eâ‚ âŠ¢eâ‚‚)
subject-reduction (Ï„-âˆ™ (Ï„-Î› âŠ¢e))       Î²-Î›        = subâ‚-pres-âŠ¢ âŠ¢e Ï„-ğ•¥
subject-reduction (Ï„-Î» âŠ¢e)            (Î¾-Î»  eâ†ªe') = Ï„-Î» (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (Ï„-Î› âŠ¢e)            (Î¾-Î›  eâ†ªe') = Ï„-Î› (subject-reduction âŠ¢e eâ†ªe')
subject-reduction (Ï„-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)       (Î¾-Â·â‚ eâ†ªe') = Ï„-Â· (subject-reduction âŠ¢eâ‚ eâ†ªe') âŠ¢eâ‚‚
subject-reduction (Ï„-Â· âŠ¢eâ‚ âŠ¢eâ‚‚)       (Î¾-Â·â‚‚ eâ†ªe') = Ï„-Â· âŠ¢eâ‚ (subject-reduction âŠ¢eâ‚‚ eâ†ªe')
subject-reduction (Ï„-âˆ™ âŠ¢e)            (Î¾-âˆ™  eâ†ªe') = Ï„-âˆ™ (subject-reduction âŠ¢e eâ†ªe')
