module Examples.LambdaPi-Kits.SubjectReduction where

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; sym; trans; cong; congâ‚‚; subst; module â‰¡-Reasoning)
open â‰¡-Reasoning
open import Examples.LambdaPi-Kits.Definitions
open import Examples.LambdaPi-Kits.EvalLemmas
open import Data.List.Relation.Unary.Any using (here; there)
open import Data.List using (_++_; [])
open import Data.Product renaming (_,_ to _,Ã—_)

infixr 1 _by_
_by_ : (T : Set) â†’ T â†’ T
T by t = t

âŠ¢*id :
  Î“ âŠ¢* idâ‚› âˆ¶ Î“
âŠ¢*id {Î“ = Î“} x =
  wk-telescope Î“ x ,Ã—
  (subst (_â‡“ wk-telescope Î“ x) (sym (â‹¯-idâ‚› âŸ¦ wk-telescope Î“ x âŸ§)) (â‡“-refl-val _)) ,Ã—
  Ï„-` refl

âŠ¢*-ext : {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Î“â‚‚ âŠ¢* Ïƒ âˆ¶ Î“â‚ â†’
  Î“â‚‚ âŠ¢ e âˆ¶ Ï„ â†’
  âŸ¦ Ï„' âŸ§ â‹¯ Ïƒ â‡“ Ï„ â†’
  Î“â‚‚ âŠ¢* Ïƒ ,â‚– e âˆ¶ Î“â‚ ,, Ï„'
âŠ¢*-ext {e = e} {Ï„ = Ï„} {Ï„' = Ï„'} {Î“â‚ = Î“â‚} {Ïƒ = Ïƒ} âŠ¢Ïƒ âŠ¢e Ï„'Ïƒâ‡“Ï„ (here refl) =
  let Î“xâ‹¯Ïƒâ‡“Ï„ =
        âŸ¦ wk-telescope (Î“â‚ ,, Ï„') (here refl) âŸ§ â‹¯ (Ïƒ ,â‚– e) â‡“ Ï„
          by
        âŸ¦ Ï„' â‹¯áµ¥ wk âŸ§ â‹¯ (Ïƒ ,â‚› e) â‡“ Ï„
          by subst (Î» h â†’ h â‹¯ (Ïƒ ,â‚– e) â‡“ Ï„) (â‹¯-âŸ¦âŸ§-comm Ï„' wk) (
        âŸ¦ Ï„' âŸ§ â‹¯ wk â‹¯ (Ïƒ ,â‚› e) â‡“ Ï„
          by subst (_â‡“ Ï„) (sym (wk-cancels-,â‚› âŸ¦ Ï„' âŸ§ Ïƒ e)) (
        âŸ¦ Ï„' âŸ§ â‹¯ Ïƒ  â‡“ Ï„
          by Ï„'Ïƒâ‡“Ï„))
  in Ï„ ,Ã— Î“xâ‹¯Ïƒâ‡“Ï„ ,Ã— âŠ¢e
âŠ¢*-ext {e = e} {Ï„ = Ï„} {Ï„' = Ï„'} {Î“â‚ = Î“â‚} {Ïƒ = Ïƒ} âŠ¢Ïƒ âŠ¢e Ï„'Ïƒâ‡“Ï„ (there x) with âŠ¢Ïƒ x
âŠ¢*-ext {e = e} {Ï„ = Ï„} {Ï„' = Ï„'} {Î“â‚ = Î“â‚} {Ïƒ = Ïƒ} âŠ¢Ïƒ âŠ¢e Ï„'Ïƒâ‡“Ï„ (there x) | Ï„â‚' ,Ã— â‡“Ï„â‚' ,Ã— âŠ¢' =
  let Î“xâ‹¯Ïƒâ‡“Ï„ =
        âŸ¦ wk-telescope (Î“â‚ ,, Ï„') (there x) âŸ§ â‹¯ (Ïƒ ,â‚› e) â‡“ Ï„â‚'
          by
        âŸ¦ ValueSubst.wk-drop-âˆˆ x (Î“â‚ x) â‹¯áµ¥ wk âŸ§ â‹¯ (Ïƒ ,â‚› e) â‡“ Ï„â‚'
          by subst (Î» h â†’ h â‹¯ (Ïƒ ,â‚– e) â‡“ Ï„â‚') (â‹¯-âŸ¦âŸ§-comm (ValueSubst.wk-drop-âˆˆ x (Î“â‚ x)) wk) (
        âŸ¦ ValueSubst.wk-drop-âˆˆ x (Î“â‚ x) âŸ§ â‹¯ wk â‹¯ (Ïƒ ,â‚› e) â‡“ Ï„â‚'
          by subst (_â‡“ Ï„â‚') (sym (wk-cancels-,â‚› âŸ¦ ValueSubst.wk-drop-âˆˆ x (Î“â‚ x) âŸ§ Ïƒ e)) (
        âŸ¦ ValueSubst.wk-drop-âˆˆ x (Î“â‚ x) âŸ§ â‹¯ Ïƒ â‡“ Ï„â‚'
          by
        â‡“Ï„â‚'))
  in Ï„â‚' ,Ã— Î“xâ‹¯Ïƒâ‡“Ï„ ,Ã— âŠ¢'

ren-pres-â‡“ : (Ï : Âµâ‚ â†’áµ£ Âµâ‚‚) â†’
  e     â‡“ v â†’
  e â‹¯ Ï â‡“ v â‹¯áµ¥ Ï
ren-pres-â‡“ Ï (â‡“-Î» eâ‡“v)              rewrite sym â†‘â‰¡ = â‡“-Î» (ren-pres-â‡“ (Ï â†‘ ğ•¥) eâ‡“v)
ren-pres-â‡“ Ï (â‡“-Î  eâ‚â‡“vâ‚ eâ‚‚â‡“vâ‚‚)      rewrite sym â†‘â‰¡ = â‡“-Î  (ren-pres-â‡“ Ï eâ‚â‡“vâ‚) (ren-pres-â‡“ (Ï â†‘ ğ•¥) eâ‚‚â‡“vâ‚‚)
ren-pres-â‡“ Ï â‡“-`                    = â‡“-`
ren-pres-â‡“ {v = v} Ï (â‡“-Â·áµ¥ {vâ‚ = vâ‚} {vâ‚‚ = vâ‚‚} eâ‚â‡“vâ‚ eâ‚‚â‡“vâ‚‚ eâ‡“v) =
  let X = âŸ¦ vâ‚ â‹¯áµ¥ Ï â†‘áµ¥ ğ•¥ âŸ§ â‹¯ â¦… âŸ¦ vâ‚‚ â‹¯áµ¥ Ï âŸ§ â¦† â‡“ v â‹¯áµ¥ Ï
            by subst (Î» â–  â†’ â–  â‹¯ â¦… âŸ¦ vâ‚‚ â‹¯áµ¥ Ï âŸ§ â¦† â‡“ v â‹¯áµ¥ Ï) (â‹¯-âŸ¦âŸ§-comm vâ‚ (Ï â†‘áµ¥ ğ•¥)) (
          âŸ¦ vâ‚ âŸ§ â‹¯ Ï â†‘áµ¥ ğ•¥ â‹¯ â¦… âŸ¦ vâ‚‚ â‹¯áµ¥ Ï âŸ§ â¦† â‡“ v â‹¯áµ¥ Ï
            by subst (Î» â–  â†’ âŸ¦ vâ‚ âŸ§ â‹¯ Ï â†‘áµ¥ ğ•¥ â‹¯ â¦… â–  â¦† â‡“ v â‹¯áµ¥ Ï) (â‹¯-âŸ¦âŸ§-comm vâ‚‚ Ï) (
          âŸ¦ vâ‚ âŸ§ â‹¯ Ï â†‘áµ¥ ğ•¥ â‹¯â‚› â¦… âŸ¦ vâ‚‚ âŸ§ â‹¯ Ï â¦† â‡“ v â‹¯áµ¥ Ï
            by subst (Î» â–  â†’ âŸ¦ vâ‚ âŸ§ â‹¯ â–  Ï ğ•¥ â‹¯â‚› â¦… âŸ¦ vâ‚‚ âŸ§ â‹¯ Ï â¦† â‡“ v â‹¯áµ¥ Ï) â†‘â‰¡ (
          âŸ¦ vâ‚ âŸ§ â‹¯ Ï â†‘ ğ•¥ â‹¯â‚› â¦… âŸ¦ vâ‚‚ âŸ§ â‹¯ Ï â¦† â‡“ v â‹¯áµ¥ Ï
            by subst (Î» â–  â†’ â–  â‡“ v â‹¯áµ¥ Ï) (dist-â¦…â¦†â‚›-â‹¯áµ£ âŸ¦ vâ‚ âŸ§ âŸ¦ vâ‚‚ âŸ§ Ï) (
          âŸ¦ vâ‚ âŸ§ â‹¯ â¦… âŸ¦ vâ‚‚ âŸ§ â¦† â‹¯ Ï â‡“ v â‹¯áµ¥ Ï
            by ren-pres-â‡“ Ï eâ‡“v))))
  in â‡“-Â·áµ¥ (ren-pres-â‡“ Ï eâ‚â‡“vâ‚) (ren-pres-â‡“ Ï eâ‚‚â‡“vâ‚‚) X
ren-pres-â‡“ Ï (â‡“-Â·â‚™ eâ‚â‡“nâ‚ eâ‚‚â‡“vâ‚‚)     = â‡“-Â·â‚™ (ren-pres-â‡“ Ï eâ‚â‡“nâ‚) (ren-pres-â‡“ Ï eâ‚‚â‡“vâ‚‚)
ren-pres-â‡“ Ï â‡“-â˜…                    = â‡“-â˜…

ren-pres-âŠ¢ : {Ï : Âµâ‚ â†’áµ£ Âµâ‚‚} {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} â†’
  OPE Ï Î“â‚ Î“â‚‚ â†’
  Î“â‚ âŠ¢ e âˆ¶ Ï„ â†’
  Î“â‚‚ âŠ¢ e â‹¯ Ï âˆ¶ Ï„ â‹¯áµ¥ Ï
ren-pres-âŠ¢ ope âŠ¢e = {!!}

âŠ¢*-â†‘ : {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  âŸ¦ Ï„â‚ âŸ§ â‹¯ Ïƒ â‡“ Ï„â‚‚ â†’
  Î“â‚‚       âŠ¢* Ïƒ      âˆ¶ Î“â‚       â†’
  Î“â‚‚ ,, Ï„â‚‚ âŠ¢* Ïƒ â†‘â‚› m âˆ¶ Î“â‚ ,, Ï„â‚
âŠ¢*-â†‘ {Ï„â‚ = Ï„â‚} {Ï„â‚‚ = Ï„â‚‚} {Ïƒ = Ïƒ} Ï„â‚Ïƒâ‡“Ï„â‚‚ âŠ¢Ïƒ (here refl) =
  let X =
        âŸ¦ Ï„â‚ â‹¯áµ¥ wk âŸ§ â‹¯ Ïƒ â†‘â‚› ğ•¥ â‡“ Ï„â‚‚ â‹¯áµ¥ wk
          by subst (Î» â–  â†’ â–  â‹¯ Ïƒ â†‘â‚› ğ•¥ â‡“ Ï„â‚‚ â‹¯áµ¥ wk) (â‹¯-âŸ¦âŸ§-comm Ï„â‚ wk) (
        âŸ¦ Ï„â‚ âŸ§ â‹¯ wk â‹¯ Ïƒ â†‘â‚› ğ•¥ â‡“ Ï„â‚‚ â‹¯áµ¥ wk
          by subst (Î» â–  â†’ â–  â‡“ Ï„â‚‚ â‹¯áµ¥ wk) (sym (dist-â†‘-sub âŸ¦ Ï„â‚ âŸ§ Ïƒ)) (
        âŸ¦ Ï„â‚ âŸ§ â‹¯ Ïƒ â‹¯ wk â‡“ Ï„â‚‚ â‹¯áµ¥ wk
          by ren-pres-â‡“ wk (
        âŸ¦ Ï„â‚ âŸ§ â‹¯ Ïƒ â‡“ Ï„â‚‚
          by Ï„â‚Ïƒâ‡“Ï„â‚‚)))
  in Ï„â‚‚ â‹¯áµ¥ wk ,Ã— X ,Ã— Ï„-` refl
âŠ¢*-â†‘ {Ï„â‚ = Ï„â‚} {Ï„â‚‚ = Ï„â‚‚} Ï„â‚Ïƒâ‡“Ï„â‚‚ âŠ¢Ïƒ (there x) with âŠ¢Ïƒ x
âŠ¢*-â†‘ {Ï„â‚ = Ï„â‚} {Ï„â‚‚ = Ï„â‚‚} Ï„â‚Ïƒâ‡“Ï„â‚‚ âŠ¢Ïƒ (there x) | Ï„ ,Ã— â‡“Ï„ ,Ã— âŠ¢Ïƒx = {!!} ,Ã— {!!} ,Ã— {!ren-pres-ty!}

subst-pres-ty : {Î“â‚ : Ctx Âµâ‚} {Î“â‚‚ : Ctx Âµâ‚‚} {Ïƒ : Âµâ‚ â†’â‚› Âµâ‚‚} â†’
  Î“â‚ âŠ¢ eâ‚ âˆ¶ Ï„â‚ â†’
  Î“â‚‚ âŠ¢* Ïƒ âˆ¶ Î“â‚ â†’
  âŸ¦ Ï„â‚ âŸ§ â‹¯ Ïƒ â‡“ Ï„ â†’
  Î“â‚‚ âŠ¢ eâ‚ â‹¯ Ïƒ âˆ¶ Ï„
subst-pres-ty (Ï„-` {x = x} refl) âŠ¢Ïƒ Ï„â‚Ïƒâ‡“Ï„ with âŠ¢Ïƒ x
subst-pres-ty (Ï„-` {x = _} refl) âŠ¢Ïƒ Ï„â‚Ïƒâ‡“Ï„ | Ï„ ,Ã— â‡“Ï„ ,Ã— âŠ¢Ïƒx with â‡“-deterministic â‡“Ï„ Ï„â‚Ïƒâ‡“Ï„
subst-pres-ty (Ï„-` {x = _} refl) âŠ¢Ïƒ Ï„â‚Ïƒâ‡“Ï„ | Ï„ ,Ã— â‡“Ï„ ,Ã— âŠ¢Ïƒx | refl = âŠ¢Ïƒx
subst-pres-ty (Ï„-Î» {tâ‚ = tâ‚} âŠ¢tâ‚ tâ‚â‡“Ï„â‚ âŠ¢e) âŠ¢Ïƒ (â‡“-Î  Ï„â‚Ïƒâ‡“Ï„ Ï„â‚Ïƒâ‡“Ï„â‚) =
  Ï„-Î» (subst-pres-ty âŠ¢tâ‚ âŠ¢Ïƒ â‡“-â˜…)
      (eval-subst-evalâ‚— tâ‚ Ï„â‚Ïƒâ‡“Ï„ tâ‚â‡“Ï„â‚)
      (subst-pres-ty âŠ¢e (âŠ¢*-â†‘ Ï„â‚Ïƒâ‡“Ï„ âŠ¢Ïƒ) Ï„â‚Ïƒâ‡“Ï„â‚)
subst-pres-ty (Ï„-Â· âŠ¢eâ‚ âŠ¢eâ‚‚ Ï„â‚ƒeâ‚‚â‡“Ï„â‚‚) âŠ¢Ïƒ Ï„â‚Ïƒâ‡“Ï„ = Ï„-Â· (subst-pres-ty âŠ¢eâ‚ âŠ¢Ïƒ {!!}) {!subst-pres-ty âŠ¢eâ‚‚ âŠ¢Ïƒ!} {!!}
subst-pres-ty (Ï„-Î  x âŠ¢eâ‚ âŠ¢eâ‚‚) âŠ¢Ïƒ Ï„â‚Ïƒâ‡“Ï„ = {!!}
subst-pres-ty Ï„-â˜… âŠ¢Ïƒ â‡“-â˜… = Ï„-â˜…

subst-pres-tyâ‚ : {Î“ : Ctx Âµ} â†’
  Î“ ,, Ï„â‚‚ âŠ¢ eâ‚ âˆ¶ Ï„â‚ â†’
  Î“ âŠ¢ eâ‚‚ âˆ¶ Ï„â‚‚ â†’
  âŸ¦ Ï„â‚ âŸ§ â‹¯ â¦… eâ‚‚ â¦† â‡“ Ï„ â†’
  Î“ âŠ¢ eâ‚ â‹¯ â¦… eâ‚‚ â¦† âˆ¶ Ï„
subst-pres-tyâ‚ {Ï„â‚‚ = Ï„â‚‚} {Ï„â‚ = Ï„â‚} {eâ‚‚ = eâ‚‚} {Î“ = Î“} âŠ¢eâ‚ âŠ¢eâ‚‚ Ï„â‚eâ‚‚â‡“Ï„ =
  let âŠ¢* = âŠ¢*-ext âŠ¢*id âŠ¢eâ‚‚ (subst (_â‡“ Ï„â‚‚) (sym (â‹¯-idâ‚› âŸ¦ Ï„â‚‚ âŸ§)) (â‡“-refl-val Ï„â‚‚))
  in subst-pres-ty âŠ¢eâ‚ âŠ¢* Ï„â‚eâ‚‚â‡“Ï„

subject-reduction :
  Î“ âŠ¢ e âˆ¶ Ï„ â†’
  e â‡“ v â†’
  Î“ âŠ¢ âŸ¦ v âŸ§ âˆ¶ Ï„
subject-reduction (Ï„-Î» âŠ¢tâ‚ tâ‚â‡“Ï„â‚ âŠ¢e) (â‡“-Î» eâ‡“v) =
  Ï„-Î» âŠ¢tâ‚ tâ‚â‡“Ï„â‚ (subject-reduction âŠ¢e eâ‡“v )
subject-reduction (Ï„-Î  tâ‚â‡“Ï„â‚ƒ âŠ¢tâ‚ âŠ¢tâ‚‚) (â‡“-Î  tâ‚â‡“Ï„â‚ tâ‚‚â‡“Ï„â‚‚)
    with â‡“-deterministic tâ‚â‡“Ï„â‚ tâ‚â‡“Ï„â‚ƒ
... | refl =
  Ï„-Î  (â‡“-refl-val _) (subject-reduction âŠ¢tâ‚ tâ‚â‡“Ï„â‚) (subject-reduction âŠ¢tâ‚‚ tâ‚‚â‡“Ï„â‚‚)
subject-reduction âŠ¢e â‡“-` = âŠ¢e
subject-reduction (Ï„-Â· {Ï„â‚‚ = Ï„â‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚ Ï„â‚‚eâ‚‚â‡“Ï„) (â‡“-Â·áµ¥ eâ‚â‡“Î»vâ‚ eâ‚‚â‡“vâ‚‚ vâ‚vâ‚‚â‡“v)
    with subject-reduction âŠ¢eâ‚ eâ‚â‡“Î»vâ‚ | subject-reduction âŠ¢eâ‚‚ eâ‚‚â‡“vâ‚‚
... | Ï„-Î» âŠ¢tâ‚ tâ‚â‡“Ï„â‚ âŠ¢vâ‚ | âŠ¢vâ‚‚ =
  subject-reduction (subst-pres-tyâ‚ âŠ¢vâ‚ âŠ¢vâ‚‚ (eval-subst-evalâ‚ âŸ¦ Ï„â‚‚ âŸ§ Ï„â‚‚eâ‚‚â‡“Ï„ eâ‚‚â‡“vâ‚‚)) vâ‚vâ‚‚â‡“v
subject-reduction (Ï„-Â· {Ï„â‚‚ = Ï„â‚‚} âŠ¢eâ‚ âŠ¢eâ‚‚ Ï„â‚‚eâ‚‚â‡“Ï„) (â‡“-Â·â‚™ eâ‚â‡“n eâ‚‚â‡“vâ‚‚) =
  Ï„-Â· (subject-reduction âŠ¢eâ‚ eâ‚â‡“n) (subject-reduction âŠ¢eâ‚‚ eâ‚‚â‡“vâ‚‚) (eval-subst-evalâ‚ âŸ¦ Ï„â‚‚ âŸ§ Ï„â‚‚eâ‚‚â‡“Ï„ eâ‚‚â‡“vâ‚‚)
subject-reduction âŠ¢e â‡“-â˜… = âŠ¢e
